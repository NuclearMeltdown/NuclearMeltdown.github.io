<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta
      name="theme-color"
      content="#f2f2f7"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#000000"
      media="(prefers-color-scheme: dark)"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="default"
    />
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit" />
    <link
      rel="apple-touch-icon"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="apple-touch-startup-image"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://NuclearMeltdown.github.io/favicon.png"
    />
    <meta name="application-name" content="Arbeitszeitrechner" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="msapplication-TileImage"
      content="https://NuclearMeltdown.github.io/mstile-144x144.png"
    />

    <title>Arbeitszeitrechner</title>

    <script>
      // --- Constants ---
      const SECONDS_PER_MINUTE = 60;
      const SECONDS_PER_HOUR = 3600;
      const PC_BOOKING_BONUS_SECONDS = Math.round(0.13 * SECONDS_PER_HOUR); // 468 seconds
      const BREAK_THRESHOLD_1_SECONDS = 6 * SECONDS_PER_HOUR; // 21600 seconds
      const BREAK_DURATION_1_SECONDS = 30 * SECONDS_PER_MINUTE; // 1800 seconds
      const BREAK_THRESHOLD_2_SECONDS = 9 * SECONDS_PER_HOUR; // 32400 seconds
      const BREAK_DURATION_2_SECONDS = 45 * SECONDS_PER_MINUTE; // 2700 seconds
      const EZA_DEDUCTION_DECIMAL = 0.4; // EZA deduction for U/S in decimal hours
      const EZA_DEDUCTION_SECONDS = Math.round(
        EZA_DEDUCTION_DECIMAL * SECONDS_PER_HOUR
      ); // 1440 seconds

      // --- Global Variables ---
      let kommenZeit = null; // Original Kommen-Zeit (Date Objekt, lokal)
      let gehenZeit = null; // Gehen-Zeit (Date Objekt, lokal)
      let currentWeekYear = null,
        currentWeekNo = null;
      let currentMonthYear = null,
        currentMonth = null;
      let currentView = "main"; // main, history, month, stats, options
      let balanceMarkers = []; // Array für { datum: "YYYY-MM-DD", kontostand: "12.34" } (decimal hours)

      // --- Global Settings (loaded from Local Storage) ---
      let settings = {
        wochenarbeitszeit: 38, // Decimal hours
        bundesland: "NATIONAL",
        allowWochenende: false,
        allowNachtarbeit: false,
        ezaActive: false,
        ezaKontoStand: 0, // Decimal hours
      };

      // --- Utility Functions ---
      const $ = (id) => document.getElementById(id);
      const pad = (num) => num.toString().padStart(2, "0");

      // --- Local Storage Helpers ---
      function storeToLS(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.error("Error saving to localStorage", e);
          alert(
            "Fehler beim Speichern der Daten. Möglicherweise ist der Speicher voll."
          );
        }
      }

      function getFromLS(key, defaultVal = null) {
        try {
          const val = localStorage.getItem(key);
          return val !== null ? val : defaultVal;
        } catch (e) {
          console.error("Error reading from localStorage", e);
          return defaultVal;
        }
      }

      // --- Time Parsing and Formatting ---

      // Parses hh:mm string and returns a local Date object
      function parseTime(str) {
        if (!str) return null;
        const match = str.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        const now = new Date(); // Use current date as base
        now.setHours(hh, mm, 0, 0); // Set local time
        return now;
      }

      // Formats a Date object as hh:mm in the local timezone
      function formatTime(date) {
        if (!date || isNaN(date.getTime())) return "--:--";
        const hours = date.getHours(); // Local hours
        const minutes = date.getMinutes(); // Local minutes
        return `${pad(hours)}:${pad(minutes)}`;
      }

      // Formats total seconds into hh:mm string (truncates/floors minutes)
      function formatSecondsToTime(totalSeconds) {
        if (isNaN(totalSeconds)) return "0:00";
        const sign = totalSeconds < 0 ? "-" : "";
        const absSeconds = Math.abs(totalSeconds);
        // Use Math.floor to truncate towards zero minutes
        const totalMinutes = Math.floor(absSeconds / SECONDS_PER_MINUTE);
        const hh = Math.floor(totalMinutes / 60);
        const mm = totalMinutes % 60;
        return `${sign}${hh}:${pad(mm)}`;
      }

      // Converts total seconds to decimal hours, truncating (not rounding)
      function formatSecondsToDecimal(totalSeconds, digits = 2) {
        if (isNaN(totalSeconds)) return 0;
        const decimalHours = totalSeconds / SECONDS_PER_HOUR;
        const multiplier = Math.pow(10, digits);
        // Use Math.trunc for truncation towards zero
        return Math.trunc(decimalHours * multiplier) / multiplier;
      }

      // Converts decimal hours to integer seconds
      function decimalHoursToSeconds(decimalH) {
        if (isNaN(decimalH)) return 0;
        // Round to nearest second to avoid floating point issues during conversion
        return Math.round(decimalH * SECONDS_PER_HOUR);
      }

      // Parses pause input (hh:mm or h.hh) and returns seconds
      function parsePauseInputToSeconds(inputId) {
        const val = $(inputId).value;
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        let decimalHours = 0;
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          decimalHours = hh + mm / 60;
        } else {
          decimalHours = parseFloat(cleanedVal);
          if (isNaN(decimalHours)) decimalHours = 0;
        }
        return decimalHoursToSeconds(decimalHours);
      }

      // Formats a Date object to a local ISO-like string (YYYY-MM-DDTHH:mm:ss)
      function formatLocalDateTimeString(date) {
        if (!date || isNaN(date.getTime())) return null;
        const YYYY = date.getFullYear();
        const MM = pad(date.getMonth() + 1);
        const DD = pad(date.getDate());
        const hh = pad(date.getHours());
        const mm = pad(date.getMinutes());
        const ss = pad(date.getSeconds());
        return `${YYYY}-${MM}-${DD}T${hh}:${mm}:${ss}`; // No 'Z' or offset
      }

      // Formats EZA balance (decimal hours) into Days + Hours string
      function formatEzaKonto(totalHoursDecimal) {
        if (isNaN(totalHoursDecimal)) return "0 Tage + 0.0h";
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        if (sollProTagDecimal <= 0)
          return `(${totalHoursDecimal.toFixed(1)}h)`;

        const sign = totalHoursDecimal < 0 ? "-" : "";
        const absHours = Math.abs(totalHoursDecimal);

        const fullDays = Math.floor(absHours / sollProTagDecimal);
        // Use toFixed(1) for remaining hours display
        const remainingHours = (absHours % sollProTagDecimal).toFixed(1);

        return `${sign}${fullDays} Tag${
          fullDays !== 1 ? "e" : ""
        } + ${remainingHours}h`;
      }

      // --- History and Marker Management ---

      function getHistory() {
        const history = JSON.parse(getFromLS("history", "[]"));
        history.forEach((entry) => {
          entry.datum = entry.datum || "1970-01-01";
          // Ensure differenzSeconds exists, default to 0 if missing (backward compatibility)
          entry.differenzSeconds = parseInt(entry.differenzSeconds || "0", 10);
          // Stundenkonto is stored as decimal, ensure it's a string
          entry.stundenkonto = String(entry.stundenkonto || "0.00");
          entry.kommen = entry.kommen || null;
          entry.gehen = entry.gehen || null;
          entry.urlaub = entry.urlaub || false;
          entry.krank = entry.krank || false;
          entry.schulung = entry.schulung || false;
          entry.glaz = entry.glaz || false;
          entry.pcBuchung = entry.pcBuchung || false;
          entry.buero = entry.buero || false;
          entry.isEzaTag = entry.isEzaTag || false;
          entry.ezaActiveDuringBooking =
            entry.ezaActiveDuringBooking || false;
          entry.zusatzPause = entry.zusatzPause || "";
          // Ensure historical target times exist (fallback to current settings if needed)
          entry.usedWochenarbeitszeit =
            entry.usedWochenarbeitszeit || settings.wochenarbeitszeit;
          entry.usedSollProTag =
            entry.usedSollProTag || entry.usedWochenarbeitszeit / 5;

          // Add temporary Date object for sorting
          const datePart = entry.datum || "1970-01-01";
          entry.dateObj = new Date(datePart + "T12:00:00Z"); // UTC for consistency
        });
        // Sort by date
        history.sort((a, b) => a.dateObj - b.dateObj);
        // Remove temporary object
        history.forEach((entry) => delete entry.dateObj);
        return history;
      }

      function getBalanceMarkers() {
        const markers = JSON.parse(getFromLS("balanceMarkers", "[]"));
        // Ensure kontostand is a string (decimal hours)
        markers.forEach(
          (m) => (m.kontostand = String(m.kontostand || "0.00"))
        );
        markers.sort((a, b) => a.datum.localeCompare(b.datum)); // Sort by date
        return markers;
      }

      function storeBalanceMarkers(markers) {
        markers.sort((a, b) => a.datum.localeCompare(b.datum)); // Always store sorted
        storeToLS("balanceMarkers", JSON.stringify(markers));
      }

      // --- Feiertagslogik (Unchanged) ---
      const holidays = {
        NATIONAL: {
          "01-01": "Neujahr",
          "05-01": "Tag der Arbeit",
          "10-03": "Tag der Deutschen Einheit",
          "12-25": "1. Weihnachtstag",
          "12-26": "2. Weihnachtstag",
        },
        BW: { "01-06": "Heilige Drei Könige", "11-01": "Allerheiligen" },
        BY: {
          "01-06": "Heilige Drei Könige",
          "08-15": "Mariä Himmelfahrt",
          "11-01": "Allerheiligen",
        },
        BE: { "03-08": "Internationaler Frauentag" },
        BB: { "10-31": "Reformationstag" },
        HB: { "10-31": "Reformationstag" },
        HH: { "10-31": "Reformationstag" },
        HE: {},
        MV: { "10-31": "Reformationstag" },
        NI: { "10-31": "Reformationstag" },
        NW: { "11-01": "Allerheiligen" },
        RP: { "11-01": "Allerheiligen" },
        SL: { "08-15": "Mariä Himmelfahrt", "11-01": "Allerheiligen" },
        SN: { "10-31": "Reformationstag" },
        ST: { "01-06": "Heilige Drei Könige", "10-31": "Reformationstag" },
        SH: { "10-31": "Reformationstag" },
        TH: { "09-20": "Weltkindertag", "10-31": "Reformationstag" },
      };
      const regionalMovableHolidays = {
        BW: ["fronleichnam"],
        BY: ["fronleichnam"],
        HE: ["fronleichnam"],
        NW: ["fronleichnam"],
        RP: ["fronleichnam"],
        SL: ["fronleichnam"],
        SN: ["bussbettag"],
      };
      function getEasterSunday(year) {
        const a = year % 19,
          b = Math.floor(year / 100),
          c = year % 100;
        const d = Math.floor(b / 4),
          e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4),
          k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31);
        const day = ((h + l - 7 * m + 114) % 31) + 1;
        return new Date(Date.UTC(year, month - 1, day));
      }
      function getHolidayName(date, bundesland) {
        if (!date || isNaN(date.getTime())) return null;
        const year = date.getUTCFullYear();
        const month = date.getUTCMonth() + 1;
        const day = date.getUTCDate();
        const mmdd = `${pad(month)}-${pad(day)}`;

        if (holidays.NATIONAL[mmdd]) return holidays.NATIONAL[mmdd];
        const regionalFixed = holidays[bundesland] || {};
        if (regionalFixed[mmdd]) return regionalFixed[mmdd];

        const easterSunday = getEasterSunday(year);
        const movableHolidays = {};

        const goodFriday = new Date(easterSunday);
        goodFriday.setUTCDate(easterSunday.getUTCDate() - 2);
        movableHolidays[
          `${pad(goodFriday.getUTCMonth() + 1)}-${pad(goodFriday.getUTCDate())}`
        ] = "Karfreitag";

        const easterMonday = new Date(easterSunday);
        easterMonday.setUTCDate(easterSunday.getUTCDate() + 1);
        movableHolidays[
          `${pad(easterMonday.getUTCMonth() + 1)}-${pad(
            easterMonday.getUTCDate()
          )}`
        ] = "Ostermontag";

        const ascensionDay = new Date(easterSunday);
        ascensionDay.setUTCDate(easterSunday.getUTCDate() + 39);
        movableHolidays[
          `${pad(ascensionDay.getUTCMonth() + 1)}-${pad(
            ascensionDay.getUTCDate()
          )}`
        ] = "Christi Himmelfahrt";

        const whitMonday = new Date(easterSunday);
        whitMonday.setUTCDate(easterSunday.getUTCDate() + 50);
        movableHolidays[
          `${pad(whitMonday.getUTCMonth() + 1)}-${pad(whitMonday.getUTCDate())}`
        ] = "Pfingstmontag";

        if (regionalMovableHolidays[bundesland]?.includes("fronleichnam")) {
          const corpusChristi = new Date(easterSunday);
          corpusChristi.setUTCDate(easterSunday.getUTCDate() + 60);
          movableHolidays[
            `${pad(corpusChristi.getUTCMonth() + 1)}-${pad(
              corpusChristi.getUTCDate()
            )}`
          ] = "Fronleichnam";
        }
        if (regionalMovableHolidays[bundesland]?.includes("bussbettag")) {
          const nov23 = new Date(Date.UTC(year, 10, 23)); // November 23rd UTC
          const dayOfWeekNov23 = nov23.getUTCDay(); // 0=Sun, 1=Mon, ..., 3=Wed, ...
          const daysToSubtract = (dayOfWeekNov23 + 4) % 7;
          const bussBettag = new Date(nov23);
          bussBettag.setUTCDate(nov23.getUTCDate() - daysToSubtract);
          movableHolidays[
            `${pad(bussBettag.getUTCMonth() + 1)}-${pad(
              bussBettag.getUTCDate()
            )}`
          ] = "Buß- und Bettag";
        }
        return movableHolidays[mmdd] || null;
      }
      // --- END Feiertagslogik ---

      // --- Settings Management ---
      function loadSettings() {
        settings.wochenarbeitszeit = parseFloat(
          getFromLS("wochenarbeitszeitValue", "38")
        );
        settings.bundesland = getFromLS("bundesland", "NATIONAL");
        settings.allowWochenende = getFromLS("allowWochenende") === "true";
        settings.allowNachtarbeit = getFromLS("allowNachtarbeit") === "true";
        settings.ezaActive = getFromLS("ezaActive") === "true";
        settings.ezaKontoStand = parseFloat(getFromLS("ezaKontoStand", "0"));
        $("wochenarbeitszeit").value = settings.wochenarbeitszeit.toFixed(1); // Display decimal hours
      }

      function saveSettings() {
        storeToLS(
          "wochenarbeitszeitValue",
          settings.wochenarbeitszeit.toString()
        );
        storeToLS("bundesland", settings.bundesland);
        storeToLS(
          "allowWochenende",
          settings.allowWochenende ? "true" : "false"
        );
        storeToLS(
          "allowNachtarbeit",
          settings.allowNachtarbeit ? "true" : "false"
        );
        storeToLS("ezaActive", settings.ezaActive ? "true" : "false");
        $("wochenarbeitszeit").value = settings.wochenarbeitszeit.toFixed(1);
        // EZA stand is saved separately via saveEzaKonto()
        if (currentView === "options") loadOptions(); // Refresh options view
        // Note: saveAndReload is triggered elsewhere if needed (e.g., wochenarbeitszeit change)
      }

      function saveEzaKonto() {
        const inputVal = $("eza-konto-input").value;
        const newStandDecimal = parseFloat(inputVal);

        if (isNaN(newStandDecimal)) {
          alert("Bitte einen gültigen Zahlenwert für das EZA-Konto eingeben.");
          $("eza-konto-input").value = settings.ezaKontoStand.toFixed(2);
          return;
        }

        settings.ezaKontoStand = newStandDecimal; // Store as decimal hours
        storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
        updateEzaKontoDisplay();
        alert("EZA-Kontostand gespeichert.");
        // Changing EZA balance doesn't require full history recalculation immediately
      }

      function updateEzaKontoDisplay() {
        const displayField = $("eza-konto-display");
        if (displayField) {
          // formatEzaKonto expects decimal hours
          displayField.value = formatEzaKonto(settings.ezaKontoStand);
        }
        const inputField = $("eza-konto-input");
        if (inputField) {
          // Input field also shows decimal hours
          if (document.activeElement !== inputField) {
            inputField.value = settings.ezaKontoStand.toFixed(2);
          }
        }
      }

      // --- Core Time Calculation Logic (using Seconds) ---

      // Calculates presence time between two Date objects, returns integer seconds
      function calculatePresenceSeconds(start, end) {
        if (!start || !end || isNaN(start.getTime()) || isNaN(end.getTime()))
          return 0;
        let endAdjusted = new Date(end.getTime());
        // Handle overnight work
        if (endAdjusted < start) {
          endAdjusted.setDate(endAdjusted.getDate() + 1);
        }
        const diffMs = endAdjusted - start;
        if (diffMs < 0) return 0;
        return Math.round(diffMs / 1000); // Return seconds
      }

      // Calculates statutory break time based on presence duration, returns integer seconds
      function calculateStatutoryBreakSeconds(presenceSeconds) {
        if (presenceSeconds > BREAK_THRESHOLD_2_SECONDS) {
          return BREAK_DURATION_2_SECONDS; // 45 min
        } else if (presenceSeconds > BREAK_THRESHOLD_1_SECONDS) {
          return BREAK_DURATION_1_SECONDS; // 30 min
        } else {
          return 0; // 0 min
        }
      }

      // Calculates net working time, returns integer seconds
      function calculateNetArbeitszeitSeconds(
        start, // Date object
        end, // Date object
        additionalPauseSeconds, // integer seconds
        isPcBuchung // boolean
      ) {
        const presenceSeconds = calculatePresenceSeconds(start, end);
        if (presenceSeconds <= 0) return 0;

        const statutoryBreakSeconds =
          calculateStatutoryBreakSeconds(presenceSeconds);
        const pcBonusSeconds = isPcBuchung ? PC_BOOKING_BONUS_SECONDS : 0;

        // Net time = Presence - Statutory Break - Additional Pause + PC Bonus
        const netSeconds =
          presenceSeconds -
          statutoryBreakSeconds -
          additionalPauseSeconds +
          pcBonusSeconds;

        return Math.max(0, netSeconds); // Ensure non-negative
      }

      // Calculates end time based on desired net time (iterative approach using seconds)
      function calculateEndTimeFixpoint(
        desiredNetSeconds, // integer seconds
        start, // Date object
        additionalPauseSeconds, // integer seconds
        isPcBuchung // boolean
      ) {
        if (!start || isNaN(start.getTime()) || isNaN(desiredNetSeconds))
          return "--:--";

        // Initial guess for required presence: desired net + typical max break + additional pause
        let requiredPresenceSeconds =
          desiredNetSeconds + BREAK_DURATION_2_SECONDS + additionalPauseSeconds;
        requiredPresenceSeconds = Math.max(0, requiredPresenceSeconds); // Ensure non-negative start

        let calculatedNetSeconds = 0;
        let tempEndDate = new Date(start.getTime());

        // Iterate to find the correct end time (max 15 iterations for safety)
        for (let i = 0; i < 15; i++) {
          // Calculate end time based on current required presence guess
          tempEndDate = new Date(start.getTime());
          tempEndDate.setSeconds(
            tempEndDate.getSeconds() + requiredPresenceSeconds
          );

          // Calculate the net time for this potential end time
          calculatedNetSeconds = calculateNetArbeitszeitSeconds(
            start,
            tempEndDate,
            additionalPauseSeconds,
            isPcBuchung
          );

          // Calculate the difference
          const diffSeconds = desiredNetSeconds - calculatedNetSeconds;

          // If difference is small enough (e.g., less than 1 minute), we're done
          if (Math.abs(diffSeconds) < SECONDS_PER_MINUTE) {
            break;
          }

          // Adjust required presence based on the difference
          // Add the difference: if we worked too little (diff > 0), increase presence.
          // If we worked too much (diff < 0), decrease presence.
          requiredPresenceSeconds += diffSeconds;
          requiredPresenceSeconds = Math.max(0, requiredPresenceSeconds); // Ensure non-negative
        }

        // Calculate final end time based on the refined required presence
        const finalEndTime = new Date(start.getTime());
        finalEndTime.setSeconds(
          finalEndTime.getSeconds() + requiredPresenceSeconds
        );

        return formatTime(finalEndTime); // Format the result
      }

      // --- UI Update and Interaction Logic ---

      function updateEndTimes() {
        const start = kommenZeit; // Date object
        const isPc = $("pc-buchung").checked;
        const addPauseSeconds = parsePauseInputToSeconds("zusatzliche-pause");

        if (!start) {
          ["soll", "4h", "6h", "9h", "10h"].forEach((id) => {
            const el = $(`end-time-${id}`);
            if (el) el.value = "";
          });
          return;
        }

        // Calculate end times for fixed durations (convert hours to seconds)
        [4, 6, 9, 10].forEach((h) => {
          const el = $(`end-time-${h}h`);
          if (el) {
            const desiredNetSeconds = decimalHoursToSeconds(h);
            el.value = calculateEndTimeFixpoint(
              desiredNetSeconds,
              start,
              addPauseSeconds,
              isPc
            );
          }
        });

        // Calculate end time for target daily hours (Sollzeit)
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        const sollProTagSeconds = decimalHoursToSeconds(sollProTagDecimal);
        const outS = calculateEndTimeFixpoint(
          sollProTagSeconds,
          start,
          addPauseSeconds,
          isPc
        );
        const elSoll = $("end-time-soll");
        if (elSoll) {
          // Display Sollzeit in decimal and the calculated end time
          elSoll.value = `(${sollProTagDecimal.toFixed(
            2
          )}h): ${outS}`;
        }
      }

      // Updates calculations and display on the main page
      function updateCalculations() {
        const start = kommenZeit; // Date object
        const end = gehenZeit; // Date object
        const isPc = $("pc-buchung").checked;
        const additionalPauseSeconds = parsePauseInputToSeconds(
          "zusatzliche-pause"
        );

        // Calculate core values in seconds
        const presenceSeconds = calculatePresenceSeconds(start, end);
        const netArbeitszeitSeconds = calculateNetArbeitszeitSeconds(
          start,
          end,
          additionalPauseSeconds,
          isPc
        );

        // Calculate implied total break time in seconds (using calculated values)
        const pcBonusSeconds = isPc ? PC_BOOKING_BONUS_SECONDS : 0;
        const impliedTotalBreakSeconds = Math.max(
          0,
          presenceSeconds - netArbeitszeitSeconds + pcBonusSeconds
        );

        // Calculate target daily work time in seconds
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        const sollProTagSeconds = decimalHoursToSeconds(sollProTagDecimal);

        // Calculate difference in seconds
        const diffSeconds =
          netArbeitszeitSeconds > 0
            ? netArbeitszeitSeconds - sollProTagSeconds
            : 0;

        // Get current account balance (stored as decimal hours) and convert to seconds
        const aktKontoDecimal =
          parseFloat(getFromLS("aktuellesStundenkonto", "0")) || 0;
        const aktKontoSeconds = decimalHoursToSeconds(aktKontoDecimal);

        // Calculate projected new balance in seconds
        const newKtoSeconds = aktKontoSeconds + diffSeconds;

        // --- Update Display Fields (Convert seconds back using TRUNCATING formatters) ---
        $("aktuelles-konto").value = aktKontoDecimal.toFixed(2); // Display decimal
        $("aktuelles-konto-time").value = formatSecondsToTime(aktKontoSeconds); // Display hh:mm (truncated)

        // Use truncating formatters for presence, pause, net time display
        $("anwesend-zeit").value = `${formatSecondsToTime(
          presenceSeconds // Truncated hh:mm
        )} (${formatSecondsToDecimal(presenceSeconds).toFixed(2)}h)`; // Truncated decimal
        $("pausenzeit").value = `${Math.floor( // Floor minutes for display
          impliedTotalBreakSeconds / SECONDS_PER_MINUTE
        )} Min (${formatSecondsToDecimal(impliedTotalBreakSeconds).toFixed(
          2
        )}h)`; // Truncated decimal
        $("arbeitszeit").value = `${formatSecondsToTime(
          netArbeitszeitSeconds // Truncated hh:mm
        )} (${formatSecondsToDecimal(netArbeitszeitSeconds).toFixed(2)}h)`; // Truncated decimal

        // Sollzeit display remains precise
        $("sollarbeitszeit-display").value = `${formatSecondsToTime(
          sollProTagSeconds // Truncated hh:mm for consistency
        )} (${sollProTagDecimal.toFixed(2)}h)`; // Precise decimal

        // Difference and New Balance display (use truncated formatters)
        $("differenz").value = formatSecondsToDecimal(diffSeconds).toFixed(2); // Truncated decimal
        $("differenz-time").value = formatSecondsToTime(diffSeconds); // Truncated hh:mm
        $("neues-konto").value = formatSecondsToDecimal(newKtoSeconds).toFixed(
          2
        ); // Truncated decimal
        $("neues-konto-time").value = formatSecondsToTime(newKtoSeconds); // Truncated hh:mm

        // --- Color Coding (based on decimal values for consistency) ---
        const fieldsToColor = [
          { id: "differenz", value: formatSecondsToDecimal(diffSeconds) },
          { id: "differenz-time", value: formatSecondsToDecimal(diffSeconds) },
          { id: "neues-konto", value: formatSecondsToDecimal(newKtoSeconds) },
          {
            id: "neues-konto-time",
            value: formatSecondsToDecimal(newKtoSeconds),
          },
          { id: "aktuelles-konto", value: aktKontoDecimal },
          { id: "aktuelles-konto-time", value: aktKontoDecimal },
        ];
        fieldsToColor.forEach((item) => {
          const el = $(item.id);
          if (!el) return;
          el.classList.remove("positive-value", "negative-value", "zero-value");
          // Use a small tolerance for zero check
          if (item.value > 0.001) el.classList.add("positive-value");
          else if (item.value < -0.001) el.classList.add("negative-value");
          else el.classList.add("zero-value");
        });

        // --- Violation Checks ---
        let hinweisText = "";
        let showKommenMoon = false,
          showGehenMoon = false,
          showArbeitszeitMoon = false;
        const kommenField = $("kommen-display");
        const gehenField = $("gehen-display");
        kommenField.classList.remove("invalid-time");
        gehenField.classList.remove("invalid-time");
        $("kommen-moon").style.display = "none";
        $("gehen-moon").style.display = "none";
        $("arbeitszeit-moon").style.display = "none";

        // Pass net time in seconds to checkViolations
        const violations = checkViolations(start, end, netArbeitszeitSeconds);
        if (violations.arbeitszeit && netArbeitszeitSeconds > 0) {
          if (settings.allowNachtarbeit) showArbeitszeitMoon = true;
          else hinweisText += "Achtung: Arbeitszeit außerhalb 4-10h!<br>";
        }
        if (violations.kommen) {
          if (settings.allowNachtarbeit) showKommenMoon = true;
          else {
            hinweisText += "Achtung: Kommen außerhalb 06:00-16:00!<br>";
            kommenField.classList.add("invalid-time");
          }
        }
        if (violations.gehen) {
          if (settings.allowNachtarbeit) showGehenMoon = true;
          else {
            hinweisText += "Achtung: Gehen nach 20:00!<br>";
            gehenField.classList.add("invalid-time");
          }
        }
        const hinweis = $("hinweis");
        hinweis.innerHTML = hinweisText;
        hinweis.style.display = hinweisText ? "block" : "none";
        if (showKommenMoon) $("kommen-moon").style.display = "inline";
        if (showGehenMoon) $("gehen-moon").style.display = "inline";
        if (showArbeitszeitMoon) $("arbeitszeit-moon").style.display = "inline";

        updateEndTimes(); // Update calculated end times display
      }

      // Checks for violations based on times and net duration (in seconds)
      function checkViolations(kommenDate, gehenDate, netArbeitszeitSeconds) {
        const violations = {
          kommen: false,
          gehen: false,
          arbeitszeit: false,
          any: false,
        };
        if (
          !kommenDate ||
          !gehenDate ||
          isNaN(kommenDate.getTime()) ||
          isNaN(gehenDate.getTime())
        )
          return violations;

        let gehenAdjusted = new Date(gehenDate.getTime());
        if (gehenAdjusted < kommenDate)
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);

        const kommenStunde =
          kommenDate.getHours() + kommenDate.getMinutes() / 60;
        const gehenStunde =
          gehenAdjusted.getHours() + gehenAdjusted.getMinutes() / 60;
        const netArbeitszeitDecimal = netArbeitszeitSeconds / SECONDS_PER_HOUR;

        // Check time ranges
        if (kommenStunde < 6 || kommenStunde > 16) {
          violations.kommen = true;
          violations.any = true;
        }
        if (gehenStunde > 20) {
          violations.gehen = true;
          violations.any = true;
        }
        // Check duration range (4h to 10h)
        if (
          netArbeitszeitSeconds > 0 &&
          (netArbeitszeitDecimal < 4 || netArbeitszeitDecimal > 10)
        ) {
          violations.arbeitszeit = true;
          violations.any = true;
        }
        return violations;
      }

      // Saves the current day's data to history
      function saveDay() {
        updateCalculations(); // Ensure calculations are fresh
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0=Sun, 6=Sat

        // Check weekend restriction
        if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) {
          alert("Speichern am Wochenende ist in den Optionen deaktiviert.");
          return;
        }

        const datum = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(
          today.getDate()
        )}`;
        const holidayName = getHolidayName(today, settings.bundesland);

        // Check holiday restriction
        if (holidayName) {
          alert(`Speichern am Feiertag (${holidayName}) nicht möglich.`);
          return;
        }

        const originalKommenDate = kommenZeit; // Date object
        const currentGehenDate = gehenZeit; // Date object
        const isPcBuchung = $("pc-buchung").checked;
        const additionalPauseValue = $("zusatzliche-pause").value || ""; // String hh:mm or h.hh
        const additionalPauseSeconds = parsePauseInputToSeconds(
          "zusatzliche-pause"
        );
        const isBuero = $("buero-toggle").checked;

        // Check if times are set
        if (!originalKommenDate || !currentGehenDate) {
          alert("Bitte Kommen- und Gehen-Zeit für die Speicherung angeben.");
          return;
        }

        // Check if end time is before start time (on the same day)
        let gehenCheck = new Date(currentGehenDate.getTime());
        if (gehenCheck < originalKommenDate) {
          // Allow overnight wrap, but check if it's *still* before start after wrap
          gehenCheck.setDate(gehenCheck.getDate() + 1);
          if (gehenCheck < originalKommenDate) {
            alert("Gehen-Zeit liegt vor der Kommen-Zeit!");
            return;
          }
        }

        // Calculate net time in seconds
        const netArbeitszeitSeconds = calculateNetArbeitszeitSeconds(
          originalKommenDate,
          currentGehenDate,
          additionalPauseSeconds,
          isPcBuchung
        );

        // Check for violations
        const violations = checkViolations(
          originalKommenDate,
          gehenCheck, // Use the potentially adjusted date for check
          netArbeitszeitSeconds
        );
        if (violations.any && !settings.allowNachtarbeit) {
          if (
            !confirm(
              "Es liegt ein Verstoß gegen die Gleitzeitregeln vor. Trotzdem speichern?"
            )
          ) {
            return;
          }
        }

        // Use current settings for target work time for this entry
        const currentWochenAZ = settings.wochenarbeitszeit;
        const currentSollProTagDecimal = currentWochenAZ / 5;
        const currentSollProTagSeconds = decimalHoursToSeconds(
          currentSollProTagDecimal
        );

        // Calculate difference in seconds
        const differenzSeconds = netArbeitszeitSeconds - currentSollProTagSeconds;

        // Format times for storage
        const kommenLocalISO = formatLocalDateTimeString(originalKommenDate);
        const gehenLocalISO = formatLocalDateTimeString(currentGehenDate);

        let history = getHistory();
        const displayDate = today.toLocaleDateString("de-DE");
        const existingIndex = history.findIndex((e) => e.datum === datum);

        // Prepare data object for history
        const dayData = {
          datum: datum,
          differenzSeconds: differenzSeconds, // Store difference in seconds
          stundenkonto: "0.00", // Placeholder, calculated by saveAndReload
          kommen: kommenLocalISO,
          gehen: gehenLocalISO,
          urlaub: false,
          krank: false,
          schulung: false,
          glaz: false,
          isEzaTag: false,
          ezaActiveDuringBooking: settings.ezaActive, // Store EZA status at time of booking
          pcBuchung: isPcBuchung,
          buero: isBuero,
          zusatzPause: additionalPauseValue, // Store original input string
          // Store the target work time settings used for this entry
          usedWochenarbeitszeit: currentWochenAZ,
          usedSollProTag: currentSollProTagDecimal,
        };

        if (existingIndex !== -1) {
          // Entry for today already exists
          if (
            !confirm(
              `Für heute (${displayDate}) existiert bereits ein Eintrag. Überschreiben?`
            )
          ) {
            return;
          }
          // Overwrite existing entry
          history[existingIndex] = dayData;
        } else {
          // Add new entry
          history.push(dayData);
        }

        // Save history and recalculate all balances
        saveAndReload(history);
        alert("Der Tag wurde gespeichert.");
      }

      // --- Week/Month Navigation and Display Logic ---

      // Gets ISO week number and year for a given Date object
      function getWeekNumber(d) {
        const target = new Date(d.valueOf());
        const dayNr = (target.getDay() + 6) % 7; // ISO day (Mon=0..Sun=6 -> Mon=0..Sun=6) -> (Sun=0..Sat=6 -> Mon=0..Sun=6)
        target.setDate(target.getDate() - dayNr + 3); // Go to Thursday of the week
        const firstThursday = new Date(target.getFullYear(), 0, 4); // First Thursday of year
        // Adjust to Thursday of week 1
        firstThursday.setDate(
          firstThursday.getDate() + 3 - ((firstThursday.getDay() + 6) % 7)
        );
        // Calculate week number
        const weekNo =
          1 + Math.round(((target - firstThursday) / 86400000 - 3) / 7);
        return [target.getFullYear(), weekNo];
      }

      // Gets the UTC Date of the Monday of a given ISO week and year
      function getDateOfISOWeek(w, y) {
        // Jan 4th is always in week 1. Calculate date for Thursday of week w.
        const simple = new Date(Date.UTC(y, 0, 4 + (w - 1) * 7));
        const dow = simple.getUTCDay() || 7; // Day of week (Sun=0 -> 7)
        const ISOweekStart = new Date(simple);
        // Go back to Monday (dow=1)
        ISOweekStart.setUTCDate(simple.getUTCDate() - dow + 1);
        return ISOweekStart;
      }

      function switchView(viewId) {
        currentView = viewId;
        ["main", "history", "month", "stats", "options"].forEach((id) => {
          const page = $(`${id}-page`);
          const navItem = $(`nav-${id}`);
          if (page) page.style.display = id === viewId ? "block" : "none";
          if (navItem) navItem.classList.toggle("active", id === viewId);
        });

        // Load data specific to the view
        if (viewId === "history") loadHistory();
        else if (viewId === "month") loadMonthData();
        else if (viewId === "stats") calculateAndDisplayStats();
        else if (viewId === "options") loadOptions();
      }

      // Loads data and renders the options page
      function loadOptions() {
        $("bundesland-select").value = settings.bundesland;
        $("wochenarbeitszeit-setting").value =
          settings.wochenarbeitszeit.toFixed(1);
        $("wochenende-toggle").checked = settings.allowWochenende;
        $("nachtarbeit-toggle").checked = settings.allowNachtarbeit;
        $("eza-toggle").checked = settings.ezaActive;
        $("eza-konto-input").value = settings.ezaKontoStand.toFixed(2); // Input uses decimal
        updateEzaKontoDisplay(); // Update formatted display
        renderBalanceMarkers(); // Display the list of markers
      }

      // Renders the list of balance markers in the options page
      function renderBalanceMarkers() {
        const listElement = $("balance-marker-list");
        listElement.innerHTML = ""; // Clear previous list
        balanceMarkers = getBalanceMarkers(); // Ensure current and sorted

        if (balanceMarkers.length === 0) {
          listElement.innerHTML = "<li>Keine Marker gesetzt.</li>";
          return;
        }

        balanceMarkers.forEach((marker) => {
          const li = document.createElement("li");
          // Display date in German locale
          const displayDate = new Date(
            marker.datum + "T12:00:00Z"
          ).toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
          // Marker kontostand is stored as decimal string
          const kontostandNum = parseFloat(marker.kontostand);
          const kontostandSeconds = decimalHoursToSeconds(kontostandNum);
          // Use truncating formatter for hh:mm display of balance marker
          const kontostandFormattedTime = formatSecondsToTime(kontostandSeconds);
          const kontostandClass =
            kontostandNum > 0.001
              ? "positive-value"
              : kontostandNum < -0.001
              ? "negative-value"
              : "zero-value";

          li.innerHTML = `
              <span>Ab <strong>${displayDate}</strong>: <span class="diff-badge ${kontostandClass}">${kontostandFormattedTime} (${kontostandNum.toFixed(
            2
          )}h)</span></span>
              <button class="delete-button" onclick="deleteBalanceMarker('${
                marker.datum
              }')">×</button>
          `;
          listElement.appendChild(li);
        });
      }

      // Loads and displays the history for the current week
      function loadHistory() {
        const historyList = $("history-list");
        historyList.innerHTML = ""; // Clear previous list
        let history = getHistory(); // Already sorted by date

        // Determine week start and end dates
        const weekStartDateUTC = getDateOfISOWeek(currentWeekNo, currentWeekYear);
        const daysToShow = settings.allowWochenende ? 6 : 4; // 0=Mon..4=Fri or 0=Mon..6=Sun
        const weekEndDate = new Date(weekStartDateUTC);
        weekEndDate.setUTCDate(weekStartDateUTC.getUTCDate() + daysToShow);

        // Format dates for display
        const optionsDate = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          timeZone: "Europe/Berlin", // Display in local German time
        };
        const weekRange = `${weekStartDateUTC.toLocaleDateString(
          "de-DE",
          optionsDate
        )} - ${weekEndDate.toLocaleDateString("de-DE", optionsDate)}`;
        $("week-info").textContent = `KW ${currentWeekNo} / ${currentWeekYear}`;
        $("week-range").textContent = weekRange;
        const optionsWeekday = { weekday: "long", timeZone: "Europe/Berlin" };

        let weeklyTotalDiffSeconds = 0;

        // Loop through days of the week
        for (let dayOffset = 0; dayOffset <= daysToShow; dayOffset++) {
          const currentDateUTC = new Date(weekStartDateUTC.getTime());
          currentDateUTC.setUTCDate(weekStartDateUTC.getUTCDate() + dayOffset);
          const currentDateStr = `${currentDateUTC.getUTCFullYear()}-${pad(
            currentDateUTC.getUTCMonth() + 1
          )}-${pad(currentDateUTC.getUTCDate())}`;
          const displayDate = currentDateUTC.toLocaleDateString(
            "de-DE",
            optionsDate
          );
          const weekdayName = currentDateUTC.toLocaleDateString(
            "de-DE",
            optionsWeekday
          );

          const entry = history.find((e) => e.datum === currentDateStr);
          const holidayName = getHolidayName(currentDateUTC, settings.bundesland);

          const li = document.createElement("li");
          li.classList.add("history-item");
          const entryContentDiv = document.createElement("div");
          entryContentDiv.classList.add("history-entry-content");
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("history-actions");

          if (holidayName) {
            // Display holiday
            entryContentDiv.classList.add("holiday-day");
            entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div>${holidayName}</div>`;
            // No actions for holidays
          } else if (entry) {
            // Display existing entry
            let locationEmoji = entry.buero ? "🏢" : "🏠";
            let specialDayText = "";
            let bgColorClass = "";
            let textColorVar = "--special-day-text"; // Default text color for special days

            // Determine if it's a special day type
            if (entry.urlaub) {
              specialDayText = "Urlaub";
              bgColorClass = "special-day-urlaub-bg";
            } else if (entry.krank) {
              specialDayText = "Krank";
              bgColorClass = "special-day-krank-bg";
              textColorVar = "--special-day-krank-text";
            } else if (entry.schulung) {
              specialDayText = "Schulung";
              bgColorClass = "special-day-schulung-bg";
              textColorVar = "--special-day-schulung-text";
            } else if (entry.isEzaTag) {
              specialDayText = "EZA-Tag";
              bgColorClass = "special-day-eza-bg";
              textColorVar = "--special-day-eza-text";
            } else if (entry.glaz) {
              specialDayText = "GLAZ";
              bgColorClass = "special-day-glaz-bg";
              textColorVar = "--special-day-glaz-text";
            }

            // Use stored difference in seconds
            const diffSeconds = entry.differenzSeconds;
            weeklyTotalDiffSeconds += diffSeconds;
            const diffDecimal = formatSecondsToDecimal(diffSeconds); // For coloring
            // Use truncating formatter for hh:mm display of difference
            const diffFormattedTime = formatSecondsToTime(diffSeconds);
            const diffClass =
              diffDecimal > 0.001
                ? "positive-value"
                : diffDecimal < -0.001
                ? "negative-value"
                : "zero-value";

            // Indicators for EZA status changes
            let ezaIndicatorClass = "",
              ezaTagIndicatorClass = "";
            if (entry.ezaActiveDuringBooking && !settings.ezaActive) {
              // EZA was active when booked, but is now inactive
              if (entry.urlaub || entry.schulung)
                ezaIndicatorClass = "eza-related-diff inactive";
              else if (entry.isEzaTag)
                ezaTagIndicatorClass = "eza-tag-label inactive";
            }

            if (specialDayText) {
              // Render special day entry
              entryContentDiv.classList.add("special-day", bgColorClass);
              entryContentDiv.style.color = `var(${textColorVar})`;
              // Show difference only for relevant special days (U, S, GLAZ)
              const diffDisplay =
                entry.glaz || entry.urlaub || entry.schulung
                  ? `<span class="diff-badge ${diffClass} ${ezaIndicatorClass}" style="margin-left: 8px;">${diffFormattedTime}</span>`
                  : "";
              const tagLabelClass = entry.isEzaTag ? ezaTagIndicatorClass : "";
              entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div><span class="${tagLabelClass}">${specialDayText}</span> ${locationEmoji} ${diffDisplay}</div>`;
            } else {
              // Render normal work day entry
              const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
              const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
              // Recalculate net time from stored data for violation check consistency
              const netSecondsRecalculated =
                calculateNetArbeitszeitSecondsFromEntryData(entry);
              const violations = checkViolations(
                kommenLokal,
                gehenLokal,
                netSecondsRecalculated
              );
              let violationMark = "",
                moonMark = "";
              if (violations.any) {
                if (settings.allowNachtarbeit) {
                  // Show moon if night work allowed and violation occurred
                  if (
                    violations.kommen ||
                    violations.gehen ||
                    violations.arbeitszeit
                  )
                    moonMark = ' <span class="moon-mark">🌙</span>';
                } else {
                  // Show exclamation mark if night work not allowed
                  violationMark = ' <span class="violation-mark">!</span>';
                  entryContentDiv.classList.add("violation-day");
                }
              }
              // Add outline if booked under EZA rules
              if (entry.ezaActiveDuringBooking)
                entryContentDiv.classList.add("eza-booked-outline-history");

              const kommenTimeToDisplayStr = formatTime(kommenLokal);
              const gehenTimeToDisplayStr = formatTime(gehenLokal);
              const pcBuchungHinweis = entry.pcBuchung ? " (PC)" : "";

              entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div>${kommenTimeToDisplayStr}${pcBuchungHinweis} - ${gehenTimeToDisplayStr} ${locationEmoji}<span class="diff-badge ${diffClass}" style="margin-left: 8px;">${diffFormattedTime}</span>${violationMark}${moonMark}</div>`;
            }
            // Add action buttons for existing entries
            actionsDiv.innerHTML = `<button class="inline-button" onclick="showDayDetails('${entry.datum}')">i</button><button class="delete-button" onclick="deleteEntryByDate('${entry.datum}')">×</button>`;
          } else {
            // Render placeholder for days with no entry
            entryContentDiv.classList.add("no-data");
            entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div>Kein Eintrag</div>`;
            // Add button to add an entry for this day
            actionsDiv.innerHTML = `<button class="inline-button add-button" onclick="showAddDayModal('${currentDateStr}')">+</button>`;
          }

          li.appendChild(entryContentDiv);
          li.appendChild(actionsDiv);
          historyList.appendChild(li);
        }

        // Display weekly summary (use truncating formatter for hh:mm)
        const weeklyTotalDiffDecimal = formatSecondsToDecimal(
          weeklyTotalDiffSeconds
        );
        const diffClassSummary =
          weeklyTotalDiffDecimal > 0.001
            ? "positive-value"
            : weeklyTotalDiffDecimal < -0.001
            ? "negative-value"
            : "zero-value";
        $("weekly-summary-content").innerHTML =
          `Gesamtdifferenz: <span class="diff-badge ${diffClassSummary}">${formatSecondsToTime( // Truncated hh:mm
            weeklyTotalDiffSeconds
          )} (${weeklyTotalDiffDecimal.toFixed(2)}h)</span>`; // Truncated decimal

        updateWeekNavigation(); // Update prev/next week buttons
      }

      // Parses pause string (hh:mm or h.hh) and returns seconds
      function parsePauseInputFromStringToSeconds(val) {
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        let decimalHours = 0;
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          decimalHours = hh + mm / 60;
        } else {
          decimalHours = parseFloat(cleanedVal);
          if (isNaN(decimalHours)) decimalHours = 0;
        }
        return decimalHoursToSeconds(decimalHours);
      }

      // Calculates net work time in seconds directly from a history entry object
      function calculateNetArbeitszeitSecondsFromEntryData(entry) {
        // Return 0 for special days or if times are missing
        if (
          !entry ||
          !entry.kommen ||
          !entry.gehen ||
          entry.urlaub ||
          entry.krank ||
          entry.schulung ||
          entry.glaz ||
          entry.isEzaTag
        ) {
          return 0;
        }
        // Parse stored times
        const kommenLokal = new Date(entry.kommen);
        const gehenLokal = new Date(entry.gehen);
        // Parse stored additional pause string to seconds
        const additionalPauseSeconds = parsePauseInputFromStringToSeconds(
          entry.zusatzPause || ""
        );
        const isPcBuchung = entry.pcBuchung;

        // Use the main calculation function
        return calculateNetArbeitszeitSeconds(
          kommenLokal,
          gehenLokal,
          additionalPauseSeconds,
          isPcBuchung
        );
      }

      // Deletes a history entry by date after confirmation
      function deleteEntryByDate(dateStr) {
        let history = getHistory();
        const index = history.findIndex((e) => e.datum === dateStr);
        if (index !== -1) {
          const displayDate = new Date(
            dateStr + "T12:00:00Z"
          ).toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
          if (
            confirm(
              `Möchten Sie den Eintrag für ${displayDate} wirklich löschen?`
            )
          ) {
            history.splice(index, 1);
            saveAndReload(history); // Recalculate balances after deletion
          }
        }
      }

      // Updates the previous/next week navigation buttons
      function updateWeekNavigation() {
        const pagination = $("pagination");
        pagination.innerHTML = ""; // Clear existing buttons
        const createButton = (text, onClick) => {
          const btn = document.createElement("button");
          btn.textContent = text;
          btn.onclick = onClick;
          btn.classList.add("inline-button");
          return btn;
        };
        // Previous week button
        const prevWeekBtn = createButton("‹", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() - 7); // Go back 7 days
          [currentWeekYear, currentWeekNo] = getWeekNumber(d); // Recalculate week/year
          loadHistory(); // Reload history view
        });
        // Next week button
        const nextWeekBtn = createButton("›", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() + 7); // Go forward 7 days
          const [newYear, newWeek] = getWeekNumber(d);
          currentWeekYear = newYear;
          currentWeekNo = newWeek;
          loadHistory(); // Reload history view
        });
        pagination.appendChild(prevWeekBtn);
        pagination.appendChild(nextWeekBtn);
      }

      // Shows the modal for adding or editing a day's entry
      function showAddDayModal(dateStr) {
        const dateVal = new Date(dateStr + "T12:00:00Z"); // Use UTC noon for date logic
        const displayDate = dateVal.toLocaleDateString("de-DE", {
          timeZone: "Europe/Berlin",
        });
        const weekdayName = dateVal.toLocaleDateString("de-DE", {
          weekday: "long",
          timeZone: "Europe/Berlin",
        });
        const holidayName = getHolidayName(dateVal, settings.bundesland);

        // Prevent booking on holidays
        if (holidayName) {
          alert(`Buchung am Feiertag (${holidayName}) nicht möglich.`);
          return;
        }
        const dayOfWeek = dateVal.getUTCDay(); // 0=Sun, 6=Sat
        // Prevent booking on weekends if disallowed
        if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) {
          alert("Buchung am Wochenende ist in den Optionen deaktiviert.");
          return;
        }

        const history = getHistory();
        const entry = history.find((e) => e.datum === dateStr);

        // Set modal title
        $("add-day-modal-title").textContent = entry
          ? `Buchung ändern: ${weekdayName}, ${displayDate}`
          : `Buchung hinzufügen: ${weekdayName}, ${displayDate}`;

        // Reset special day toggles
        $("urlaub-toggle").checked = false;
        $("krank-toggle").checked = false;
        $("schulung-toggle").checked = false;
        $("glaz-toggle").checked = false;
        $("eza-tag-toggle").checked = false;

        // Populate fields if editing an existing entry
        if (entry) {
          $("add-day-kommen").value = entry.kommen
            ? formatTime(new Date(entry.kommen))
            : "";
          $("add-day-gehen").value = entry.gehen
            ? formatTime(new Date(entry.gehen))
            : "";
          $("add-day-zusatzliche-pause").value = entry.zusatzPause || "";
          $("pc-buchung-add-day").checked = entry.pcBuchung || false;
          $("buero-add-day").checked = entry.buero || false;
          // Set special day toggles based on entry
          $("urlaub-toggle").checked = entry.urlaub || false;
          $("krank-toggle").checked = entry.krank || false;
          $("schulung-toggle").checked = entry.schulung || false;
          $("glaz-toggle").checked = entry.glaz || false;
          $("eza-tag-toggle").checked = entry.isEzaTag || false;
          // Disable time fields if it's a special day entry
          const isSpecial =
            entry.urlaub ||
            entry.krank ||
            entry.schulung ||
            entry.glaz ||
            entry.isEzaTag;
          toggleTimeFieldsDisabled(isSpecial);
        } else {
          // Set defaults for a new entry
          $("add-day-kommen").value = "";
          $("add-day-gehen").value = "";
          $("add-day-zusatzliche-pause").value = "";
          // Default PC/Buero toggles based on main page settings
          $("pc-buchung-add-day").checked = $("pc-buchung").checked;
          $("buero-add-day").checked = $("buero-toggle").checked;
          toggleTimeFieldsDisabled(false); // Enable time fields by default
        }

        // Store the date being edited/added in the modal's data attribute
        $("add-day-modal").setAttribute("data-date", dateStr);
        // Show the modal
        $("add-day-modal").style.display = "flex";
      }

      // Handles toggling of special day types in the add/edit modal
      function toggleSpecialDay(type) {
        const types = ["urlaub", "krank", "schulung", "glaz", "ezaTag"];
        const currentToggleId = type.replace("Tag", "-tag") + "-toggle";
        const isChecked = $(currentToggleId).checked;

        // If a toggle is checked, uncheck all others
        if (isChecked) {
          types.forEach((t) => {
            const toggleId = t.replace("Tag", "-tag") + "-toggle";
            if (toggleId !== currentToggleId) {
              $(toggleId).checked = false;
            }
          });
        }

        // Check if any special day toggle is active
        const anySpecialChecked = types.some(
          (t) => $(t.replace("Tag", "-tag") + "-toggle").checked
        );
        // Disable/enable time input fields based on whether it's a special day
        toggleTimeFieldsDisabled(anySpecialChecked);
      }

      // Enables/disables time-related input fields in the add/edit modal
      function toggleTimeFieldsDisabled(disabled) {
        $("add-day-kommen").disabled = disabled;
        $("add-day-gehen").disabled = disabled;
        $("add-day-zusatzliche-pause").disabled = disabled;
        $("pc-buchung-add-day").disabled = disabled;
      }

      // Parses hh:mm time string and sets it on a given Date object (local time)
      function parseTimeForDate(timeStr, targetLocalDate) {
        if (!timeStr || !targetLocalDate || isNaN(targetLocalDate.getTime()))
          return null;
        const match = timeStr.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        // Create a new Date object based on the target date
        const resultDate = new Date(targetLocalDate.getTime());
        // Set the hours and minutes (local time)
        resultDate.setHours(hh, mm, 0, 0);
        return resultDate;
      }

      // Adds or updates a day's entry from the manual modal
      function addManualDay() {
        const dateValStr = $("add-day-modal").getAttribute("data-date"); // YYYY-MM-DD
        if (!dateValStr) {
          alert("Kein gültiges Datum im Modal gefunden!");
          return;
        }

        // Create Date objects for local time and UTC noon (for date logic)
        const realDateLocal = new Date(dateValStr + "T00:00:00"); // Local midnight
        const realDateUTC = new Date(dateValStr + "T12:00:00Z"); // UTC noon

        // --- Pre-checks ---
        const holidayName = getHolidayName(realDateUTC, settings.bundesland);
        if (holidayName) {
          alert(`Speichern am Feiertag (${holidayName}) nicht möglich.`);
          closeAddDayModal();
          return;
        }
        const dayOfWeek = realDateUTC.getUTCDay(); // 0=Sun, 6=Sat
        if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) {
          alert("Speichern am Wochenende ist deaktiviert.");
          closeAddDayModal();
          return;
        }

        // --- Get Data from Modal ---
        const isUrlaub = $("urlaub-toggle").checked,
          isKrank = $("krank-toggle").checked,
          isSchulung = $("schulung-toggle").checked,
          isGlaz = $("glaz-toggle").checked,
          isEzaTag = $("eza-tag-toggle").checked;
        const isBueroAddDay = $("buero-add-day").checked,
          isPcBuchungAddDay = $("pc-buchung-add-day").checked;
        const additionalPauseManualValue = $("add-day-zusatzliche-pause").value; // String
        const additionalPauseManualSeconds = parsePauseInputFromStringToSeconds(
          additionalPauseManualValue
        );

        let history = getHistory();
        const existingIndex = history.findIndex((e) => e.datum === dateValStr);
        const displayDate = realDateLocal.toLocaleDateString("de-DE");

        // Use current settings for target work time
        const currentWochenAZ = settings.wochenarbeitszeit;
        const currentSollProTagDecimal = currentWochenAZ / 5;
        const currentSollProTagSeconds = decimalHoursToSeconds(
          currentSollProTagDecimal
        );
        const currentEzaActive = settings.ezaActive;

        let mainDifferenceSeconds = 0;
        let ezaDifferenceSeconds = 0; // Difference affecting EZA balance directly

        // --- Calculate Differences for Special Days ---
        if (isUrlaub || isKrank || isSchulung || isGlaz || isEzaTag) {
          if (currentEzaActive) {
            // EZA rules apply
            if (isUrlaub || isSchulung) {
              mainDifferenceSeconds = -EZA_DEDUCTION_SECONDS; // -0.4h in seconds
            } else if (isKrank) {
              // Krank affects EZA balance directly under EZA rules
              ezaDifferenceSeconds = -EZA_DEDUCTION_SECONDS; // -0.4h in seconds
            } else if (isGlaz) {
              mainDifferenceSeconds = -currentSollProTagSeconds; // Full day deduction
            } else if (isEzaTag) {
              // EZA Tag logic
              const neededSeconds = currentSollProTagSeconds;
              const availableEzaDecimal = settings.ezaKontoStand; // Current EZA balance (decimal)
              const availableEzaSeconds =
                decimalHoursToSeconds(availableEzaDecimal);

              if (availableEzaSeconds >= neededSeconds) {
                // Enough EZA balance to cover the day
                ezaDifferenceSeconds = -neededSeconds;
              } else if (availableEzaSeconds > 0) {
                // Partial coverage from EZA balance
                ezaDifferenceSeconds = -availableEzaSeconds; // Use up available EZA
                mainDifferenceSeconds = -(neededSeconds - availableEzaSeconds); // Remainder affects main balance
              } else {
                // No EZA balance, full deduction from main balance
                mainDifferenceSeconds = -neededSeconds;
              }
            }
          } else {
            // EZA rules NOT active
            if (isUrlaub || isKrank || isSchulung || isEzaTag) {
              mainDifferenceSeconds = 0; // No time difference
            } else if (isGlaz) {
              mainDifferenceSeconds = -currentSollProTagSeconds; // Full day deduction
            }
          }

          // Update EZA balance immediately if affected
          if (ezaDifferenceSeconds !== 0) {
            // Convert EZA diff back to decimal hours to update the stored balance
            const ezaDiffDecimal = formatSecondsToDecimal(ezaDifferenceSeconds);
            settings.ezaKontoStand += ezaDiffDecimal;
            storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
            updateEzaKontoDisplay(); // Refresh display
          }
        }

        // --- Prepare Base Data Object ---
        let dayData = {
          datum: dateValStr,
          differenzSeconds: 0, // Will be set below
          stundenkonto: "0.00", // Placeholder, calculated by saveAndReload
          kommen: null,
          gehen: null,
          urlaub: isUrlaub,
          krank: isKrank,
          schulung: isSchulung,
          glaz: isGlaz,
          isEzaTag: isEzaTag,
          ezaActiveDuringBooking: currentEzaActive, // Store EZA status at booking time
          pcBuchung: false, // Will be set for normal days
          buero: isBueroAddDay,
          zusatzPause: "", // Will be set for normal days
          // Store target work time settings used for this entry
          usedWochenarbeitszeit: currentWochenAZ,
          usedSollProTag: currentSollProTagDecimal,
        };

        // --- Handle Special Day Case ---
        if (isUrlaub || isKrank || isSchulung || isGlaz || isEzaTag) {
          dayData.differenzSeconds = mainDifferenceSeconds; // Set calculated difference
          let label = isUrlaub
            ? "Urlaub"
            : isKrank
            ? "Krank"
            : isSchulung
            ? "Schulung"
            : isGlaz
            ? "GLAZ"
            : "EZA-Tag";

          // Update or add the entry in history
          if (existingIndex !== -1) {
            history[existingIndex] = dayData;
          } else {
            history.push(dayData);
          }
          saveAndReload(history); // Save and recalculate balances
          alert(`${label} für ${displayDate} gespeichert.`);
          closeAddDayModal();
          return; // Done for special days
        }

        // --- Handle Normal Work Day Case ---
        const kommenVal = $("add-day-kommen").value,
          gehenVal = $("add-day-gehen").value;
        if (!kommenVal || !gehenVal) {
          alert("Für einen normalen Arbeitstag bitte Kommen- und Gehen-Zeit angeben!");
          return;
        }

        // Parse times using the date of the entry
        const kommenDateManual = parseTimeForDate(kommenVal, realDateLocal);
        const gehenDateManual = parseTimeForDate(gehenVal, realDateLocal);

        if (!kommenDateManual || !gehenDateManual) {
          alert("Ungültige Zeitformate (hh:mm erwartet)!");
          return;
        }

        // Handle overnight wrap for manual entry
        if (gehenDateManual < kommenDateManual) {
          gehenDateManual.setDate(gehenDateManual.getDate() + 1);
        }

        // Calculate net time in seconds for the manual entry
        const netManualSeconds = calculateNetArbeitszeitSeconds(
          kommenDateManual,
          gehenDateManual,
          additionalPauseManualSeconds,
          isPcBuchungAddDay
        );

        // Check for violations
        const violations = checkViolations(
          kommenDateManual,
          gehenDateManual,
          netManualSeconds
        );
        if (violations.any && !settings.allowNachtarbeit) {
          if (!confirm("Die eingegebenen Zeiten verstoßen gegen die Regeln. Trotzdem speichern?")) {
            return;
          }
        }

        // Calculate difference for the normal work day
        mainDifferenceSeconds = netManualSeconds - currentSollProTagSeconds;

        // Update dayData object for the normal work day
        dayData.differenzSeconds = mainDifferenceSeconds;
        dayData.kommen = formatLocalDateTimeString(kommenDateManual);
        dayData.gehen = formatLocalDateTimeString(gehenDateManual);
        dayData.pcBuchung = isPcBuchungAddDay;
        dayData.zusatzPause = additionalPauseManualValue; // Store original string

        // Update or add the entry in history
        if (existingIndex !== -1) {
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }

        saveAndReload(history); // Save and recalculate balances
        alert(`Arbeitstag für ${displayDate} gespeichert.`);
        closeAddDayModal();
      }

      // Recalculates all account balances based on history and markers
      function saveAndReload(history) {
        // 1. Sort history by date (just in case, though usually pre-sorted)
        history.forEach((entry) => {
          const datePart = entry.datum || "1970-01-01";
          entry.dateObj = new Date(datePart + "T12:00:00Z"); // UTC for sorting
        });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj); // Clean up temp object

        // 2. Load and sort balance markers
        const sortedMarkers = getBalanceMarkers(); // Already sorted

        // 3. Recalculate balances, operating in SECONDS internally
        let currentMarkerIndex = -1;
        // Get initial balance (stored as decimal hours) and convert to seconds
        let baseKontoSeconds = decimalHoursToSeconds(
          parseFloat(getFromLS("initialKontoValue", "0"))
        );

        // Check if the first marker applies *before* the first history entry
        if (
          history.length > 0 &&
          sortedMarkers.length > 0 &&
          sortedMarkers[0].datum < history[0].datum
        ) {
          // Find the *last* marker that occurs before the first history entry
          let initialMarkerIndex = -1;
          for (let k = 0; k < sortedMarkers.length; k++) {
            if (sortedMarkers[k].datum < history[0].datum) {
              initialMarkerIndex = k;
            } else {
              break; // Markers are sorted
            }
          }
          if (initialMarkerIndex !== -1) {
            // Apply this marker as the starting balance
            baseKontoSeconds = decimalHoursToSeconds(
              parseFloat(sortedMarkers[initialMarkerIndex].kontostand)
            );
            currentMarkerIndex = initialMarkerIndex; // Remember which marker we used
          }
        }

        // Iterate through history entries to calculate running balance
        for (let i = 0; i < history.length; i++) {
          const entry = history[i];
          let currentBaseKontoSeconds; // Starting balance for *this* day in seconds

          // Check if a NEW marker applies from this day onwards
          // Use >= comparison so marker applies *on* the specified date
          if (
            currentMarkerIndex + 1 < sortedMarkers.length &&
            entry.datum >= sortedMarkers[currentMarkerIndex + 1].datum
          ) {
            currentMarkerIndex++; // Move to the next marker
            // This marker sets the starting balance for this day
            // Convert marker's decimal hour value to seconds
            currentBaseKontoSeconds = decimalHoursToSeconds(
              parseFloat(sortedMarkers[currentMarkerIndex].kontostand)
            );
          } else if (i > 0) {
            // No new marker, use the *end* balance (in seconds) of the previous day
            // Convert previous day's stored decimal balance back to seconds
            currentBaseKontoSeconds = decimalHoursToSeconds(
              parseFloat(history[i - 1].stundenkonto || "0.00")
            );
          } else {
            // First entry in history, and no earlier marker applied
            currentBaseKontoSeconds = baseKontoSeconds; // Use the determined initial balance
          }

          // Get the stored difference for the day (already in seconds)
          const diffSeconds = entry.differenzSeconds || 0;

          // Calculate the new balance in seconds
          let newKontoSeconds = currentBaseKontoSeconds + diffSeconds;

          // Store the end-of-day balance back as DECIMAL HOURS string in the history entry
          // Use the truncating decimal formatter here for consistency
          entry.stundenkonto = formatSecondsToDecimal(
            newKontoSeconds,
            2
          ).toFixed(2);
        }

        // 4. Store the updated history (with recalculated stundenkonto)
        // Remove differenz and differenzTime if they exist from old format before saving
        const historyToStore = history.map(entry => {
            const { differenz, differenzTime, ...rest } = entry;
            return rest;
        });
        storeToLS("history", JSON.stringify(historyToStore));


        // 5. Determine the latest overall account balance
        const latestEntry = history.length > 0 ? history[history.length - 1] : null;
        let latestCalculatedKontoDecimal;

        if (latestEntry) {
          // Use the balance from the last history entry (already decimal)
          latestCalculatedKontoDecimal = parseFloat(
            latestEntry.stundenkonto || "0.00"
          );
        } else {
          // History is empty, use the last marker's value or the initial value
          if (sortedMarkers.length > 0) {
            latestCalculatedKontoDecimal = parseFloat(
              sortedMarkers[sortedMarkers.length - 1].kontostand
            );
          } else {
            latestCalculatedKontoDecimal = parseFloat(
              getFromLS("initialKontoValue", "0")
            );
          }
        }
        // Store the final overall balance as decimal hours for the main UI display
        storeToLS(
          "aktuellesStundenkonto",
          latestCalculatedKontoDecimal.toFixed(2)
        );

        // 6. Refresh UI elements
        updateCalculations(); // Update main page display
        closeAddDayModal();
        closeDetailModal();
        closeBulkModal();
        closeAddMarkerModal();
        closeLegendModal();
        // Reload view-specific data if the current view requires it
        if (currentView === "history") loadHistory();
        if (currentView === "month") loadMonthData();
        if (currentView === "stats") calculateAndDisplayStats();
        if (currentView === "options") loadOptions(); // Reload options to show updated marker list etc.
      }

      // Closes the Add/Edit Day modal
      function closeAddDayModal() {
        const modal = $("add-day-modal");
        if (modal) modal.style.display = "none";
      }

      // Shows the details modal for a specific date
      function showDayDetails(dateStr) {
        const history = getHistory();
        const entry = history.find((e) => e.datum === dateStr);
        if (!entry) return;

        const entryDateUTC = new Date(dateStr + "T12:00:00Z");
        const dispDate = entryDateUTC.toLocaleDateString("de-DE", {
          timeZone: "Europe/Berlin",
        });
        const weekdayName = entryDateUTC.toLocaleDateString("de-DE", {
          weekday: "long",
          timeZone: "Europe/Berlin",
        });
        $("detail-modal-title").textContent = `Details: ${weekdayName}, ${dispDate}`;

        let detailsHTML = "",
          pausenLabel = "N/A",
          anwesenheitLabel = "N/A",
          nettoLabel = "N/A";

        let bueroEmoji = entry.buero ? "🏢 Büro" : "🏠 Homeoffice";
        // Use stored difference in seconds
        const diffSeconds = entry.differenzSeconds;
        const diffDecimal = formatSecondsToDecimal(diffSeconds); // For coloring
        // Use truncating formatter for hh:mm display of difference
        const diffFormattedTime = formatSecondsToTime(diffSeconds);
        const diffClass =
          diffDecimal > 0.001
            ? "positive-value"
            : diffDecimal < -0.001
            ? "negative-value"
            : "zero-value";

        // Stundenkonto is stored as decimal string
        const kontoDecimal = parseFloat(entry.stundenkonto || "0.00");
        const kontoSeconds = decimalHoursToSeconds(kontoDecimal);
        // Use truncating formatter for hh:mm display of balance
        const kontoFormattedTime = formatSecondsToTime(kontoSeconds);

        const holidayName = getHolidayName(entryDateUTC, settings.bundesland);

        // Get the target work time used for this entry (stored as decimal)
        const usedSollDecimal = entry.usedSollProTag
          ? parseFloat(entry.usedSollProTag)
          : null;
        const usedSollSeconds = usedSollDecimal
          ? decimalHoursToSeconds(usedSollDecimal)
          : null;
        const usedSollFormatted =
          usedSollSeconds !== null
            ? `${formatSecondsToTime( // Truncated hh:mm
                usedSollSeconds
              )} (${usedSollDecimal.toFixed(2)}h)` // Precise decimal
            : "N/A (alt)";
        // Show target time only if it's not a holiday
        const sollZeile = holidayName
          ? ""
          : `<p><strong>Soll-AZ (damals):</strong> ${usedSollFormatted}</p>`;

        // EZA inactive indicator logic
        let ezaIndicatorClass = "",
          ezaTagIndicatorClass = "";
        if (entry.ezaActiveDuringBooking && !settings.ezaActive) {
          if (entry.urlaub || entry.schulung)
            ezaIndicatorClass = "eza-related-diff inactive";
          else if (entry.isEzaTag)
            ezaTagIndicatorClass = "eza-tag-label inactive";
        }

        if (holidayName) {
          // Display holiday details
          detailsHTML = `<p><strong>Datum:</strong> ${dispDate}</p><p><strong>Status:</strong> ${holidayName} (Feiertag)</p>`;
          $("detail-edit-button").style.display = "none"; // Cannot edit/delete holiday placeholder
          $("detail-delete-button").style.display = "none";
        } else if (
          entry.urlaub ||
          entry.krank ||
          entry.schulung ||
          entry.glaz ||
          entry.isEzaTag
        ) {
          // Display special day details
          const statusText = entry.urlaub
            ? "Urlaub"
            : entry.krank
            ? "Krank"
            : entry.schulung
            ? "Schulung"
            : entry.glaz
            ? "GLAZ"
            : "EZA-Tag";
          const tagLabelClass = entry.isEzaTag ? ezaTagIndicatorClass : "";
          // Show difference only for relevant special days
          const diffDisplay =
            entry.glaz || entry.urlaub || entry.schulung
              ? `<span class="diff-badge ${diffClass} ${ezaIndicatorClass}">${diffFormattedTime} (${diffDecimal.toFixed( // Truncated decimal
                  2
                )}h)</span>`
              : "";
          detailsHTML = `<p><strong>Status:</strong> <span class="${tagLabelClass}">${statusText}</span> ${bueroEmoji}</p><p><strong>Kommen:</strong> --:--</p><p><strong>Gehen:</strong> --:--</p>${sollZeile}<p><strong>Differenz:</strong> ${diffDisplay}</p><p><strong>Stundenkonto danach:</strong> ${kontoFormattedTime} (${kontoDecimal.toFixed( // Truncated decimal
            2
          )}h)</p>`;
          $("detail-edit-button").style.display = "block"; // Can edit/delete special days
          $("detail-delete-button").style.display = "block";
        } else {
          // Display normal work day details
          const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
          const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
          const kommenFormatted = formatTime(kommenLokal);
          const gehenFormatted = formatTime(gehenLokal);
          const isPcBuchung = entry.pcBuchung;
          const pcBuchungHinweis = isPcBuchung ? " (PC-Buchung aktiv)" : "";
          const additionalPauseSavedSeconds =
            parsePauseInputFromStringToSeconds(entry.zusatzPause || "");

          // Calculate values in seconds for display (use truncating formatters)
          const presenceSeconds = calculatePresenceSeconds(
            kommenLokal,
            gehenLokal
          );
          anwesenheitLabel = `${formatSecondsToTime( // Truncated hh:mm
            presenceSeconds
          )} (${formatSecondsToDecimal(presenceSeconds).toFixed(2)}h)`; // Truncated decimal

          // Recalculate net time from entry data
          const netCalculatedSeconds =
            calculateNetArbeitszeitSecondsFromEntryData(entry);
          nettoLabel = `${formatSecondsToTime( // Truncated hh:mm
            netCalculatedSeconds
          )} (${formatSecondsToDecimal(netCalculatedSeconds).toFixed(2)}h)`; // Truncated decimal

          // Calculate implied total break
          const pcBonusSecondsDetail = isPcBuchung
            ? PC_BOOKING_BONUS_SECONDS
            : 0;
          const impliedTotalBreakSecondsDetail = Math.max(
            0,
            presenceSeconds - netCalculatedSeconds + pcBonusSecondsDetail
          );
          pausenLabel =
            impliedTotalBreakSecondsDetail > 0
              ? `${Math.floor( // Floor minutes for display
                  impliedTotalBreakSecondsDetail / SECONDS_PER_MINUTE
                )} Min (${formatSecondsToDecimal( // Truncated decimal
                  impliedTotalBreakSecondsDetail
                ).toFixed(2)}h)`
              : "0 Min";
          // Add note about manually entered pause
          if (additionalPauseSavedSeconds > 0) {
            pausenLabel += ` (davon ${formatSecondsToTime( // Truncated hh:mm
              additionalPauseSavedSeconds
            )} manuell)`;
          }

          // Check violations for moon/warning display
          const violations = checkViolations(
            kommenLokal,
            gehenLokal,
            netCalculatedSeconds
          );
          let kommenMoon =
            violations.kommen && settings.allowNachtarbeit
              ? ' <span class="moon-mark">🌙</span>'
              : "";
          let gehenMoon =
            violations.gehen && settings.allowNachtarbeit
              ? ' <span class="moon-mark">🌙</span>'
              : "";
          let nettoMoon =
            violations.arbeitszeit &&
            netCalculatedSeconds > 0 &&
            settings.allowNachtarbeit
              ? ' <span class="moon-mark">🌙</span>'
              : "";
          const ezaBookedHint = entry.ezaActiveDuringBooking
            ? ' <span class="eza-hint-inline" title="EZA-Regel bei Buchung aktiv">(E)</span>'
            : "";

          detailsHTML = `<p><strong>Ort:</strong> ${bueroEmoji}</p><p><strong>Kommen:</strong> ${kommenFormatted}${pcBuchungHinweis}${kommenMoon}</p><p><strong>Gehen:</strong> ${gehenFormatted}${gehenMoon}</p><p><strong>Anwesenheit:</strong> ${anwesenheitLabel}</p><p><strong>Pause/Freeze:</strong> ${pausenLabel}</p><p><strong>Netto-Arbeitszeit:</strong> ${nettoLabel}${nettoMoon}</p>${sollZeile}<p><strong>Differenz:</strong> <span class="diff-badge ${diffClass}">${diffFormattedTime} (${diffDecimal.toFixed( // Truncated decimal
            2
          )}h)</span>${ezaBookedHint}</p><p><strong>Stundenkonto danach:</strong> ${kontoFormattedTime} (${kontoDecimal.toFixed( // Truncated decimal
            2
          )}h)</p>`;
          $("detail-edit-button").style.display = "block"; // Can edit/delete work days
          $("detail-delete-button").style.display = "block";
        }

        $("detail-content").innerHTML = detailsHTML;
        // Set up button actions
        const editBtn = $("detail-edit-button");
        const deleteBtn = $("detail-delete-button");
        editBtn.onclick = () => {
          closeDetailModal();
          showAddDayModal(dateStr); // Open edit modal
        };
        deleteBtn.onclick = () => {
          closeDetailModal();
          deleteEntryByDate(dateStr); // Trigger delete action
        };
        $("detail-modal").style.display = "flex"; // Show the modal
      }

      // Closes the details modal
      function closeDetailModal() {
        const modal = $("detail-modal");
        if (modal) modal.style.display = "none";
      }

      // --- Bulk Booking Logic ---

      function showBulkModal() {
        $("bulk-modal-start-date").value = "";
        $("bulk-modal-end-date").value = "";
        $("bulk-modal-special-day-type").value = ""; // Reset selection
        $("bulk-booking-modal").style.display = "flex";
      }

      function closeBulkModal() {
        const modal = $("bulk-booking-modal");
        if (modal) modal.style.display = "none";
      }

      // Applies bulk booking or deletion action
      function applyBulkBooking() {
        const startDateStr = $("bulk-modal-start-date").value,
          endDateStr = $("bulk-modal-end-date").value,
          specialType = $("bulk-modal-special-day-type").value;

        // --- Input Validation ---
        if (!startDateStr || !endDateStr || !specialType) {
          alert("Bitte Startdatum, Enddatum und Aktionstyp auswählen.");
          return;
        }
        const startDate = new Date(startDateStr + "T12:00:00Z"), // Use UTC noon
          endDate = new Date(endDateStr + "T12:00:00Z");
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
          alert("Ungültiges Datumformat.");
          return;
        }
        if (endDate < startDate) {
          alert("Das Enddatum darf nicht vor dem Startdatum liegen.");
          return;
        }

        // --- Confirmation ---
        const typeLabel = {
          urlaub: "Urlaub",
          krank: "Krank",
          schulung: "Schulung",
          glaz: "GLAZ",
          ezaTag: "EZA-Tag",
          delete: "Löschen",
        }[specialType];
        if (
          !confirm(
            `Möchten Sie wirklich für den Zeitraum ${startDate.toLocaleDateString(
              "de-DE",
              { timeZone: "UTC" }
            )} bis ${endDate.toLocaleDateString("de-DE", {
              timeZone: "UTC",
            })} die Aktion "${typeLabel}" für alle Werktage (Mo-Fr, keine Feiertage) durchführen?\n\nACHTUNG: Bestehende Einträge in diesem Zeitraum werden überschrieben oder gelöscht!`
          )
        ) {
          return;
        }

        // --- Processing ---
        let history = getHistory();
        // Use a Map for efficient lookup and modification
        const historyMap = new Map(history.map((entry) => [entry.datum, entry]));
        let modified = false,
          skippedDays = 0,
          processedCount = 0;
        let currentDate = new Date(startDate.getTime()); // Start iteration

        // Get current settings for calculations
        const currentWochenAZ = settings.wochenarbeitszeit;
        const currentSollProTagDecimal = currentWochenAZ / 5;
        const currentSollProTagSeconds = decimalHoursToSeconds(
          currentSollProTagDecimal
        );
        const currentEzaActive = settings.ezaActive;
        // Use a temporary EZA balance for the bulk operation simulation
        let tempEzaStandDecimal = settings.ezaKontoStand;

        // Iterate through each day in the selected range
        while (currentDate <= endDate) {
          const dayOfWeek = currentDate.getUTCDay(); // 0=Sun, 6=Sat
          const holidayName = getHolidayName(currentDate, settings.bundesland);
          const currentDateStr = `${currentDate.getUTCFullYear()}-${pad(
            currentDate.getUTCMonth() + 1
          )}-${pad(currentDate.getUTCDate())}`;

          // Process only weekdays (Mon-Fri) that are not holidays
          if (dayOfWeek >= 1 && dayOfWeek <= 5 && !holidayName) {
            if (specialType === "delete") {
              // --- Deletion Action ---
              if (historyMap.has(currentDateStr)) {
                historyMap.delete(currentDateStr);
                modified = true;
                processedCount++;
              } else {
                skippedDays++; // Day was eligible but had no entry to delete
              }
            } else {
              // --- Booking Action (Urlaub, Krank, etc.) ---
              let mainDifferenceSeconds = 0,
                ezaDifferenceSeconds = 0;
              let isUrlaub = false,
                isKrank = false,
                isSchulung = false,
                isGlaz = false,
                isEzaTag = false;

              // Set boolean flag for the selected type
              switch (specialType) {
                case "urlaub": isUrlaub = true; break;
                case "krank": isKrank = true; break;
                case "schulung": isSchulung = true; break;
                case "glaz": isGlaz = true; break;
                case "ezaTag": isEzaTag = true; break;
              }

              // Calculate differences based on EZA rules (similar to addManualDay)
              if (currentEzaActive) {
                if (isUrlaub || isSchulung) mainDifferenceSeconds = -EZA_DEDUCTION_SECONDS;
                else if (isKrank) ezaDifferenceSeconds = -EZA_DEDUCTION_SECONDS;
                else if (isGlaz) mainDifferenceSeconds = -currentSollProTagSeconds;
                else if (isEzaTag) {
                  const neededSeconds = currentSollProTagSeconds;
                  const availableEzaSeconds = decimalHoursToSeconds(tempEzaStandDecimal);
                  if (availableEzaSeconds >= neededSeconds) ezaDifferenceSeconds = -neededSeconds;
                  else if (availableEzaSeconds > 0) {
                    ezaDifferenceSeconds = -availableEzaSeconds;
                    mainDifferenceSeconds = -(neededSeconds - availableEzaSeconds);
                  } else mainDifferenceSeconds = -neededSeconds;
                }
              } else { // EZA not active
                if (isUrlaub || isKrank || isSchulung || isEzaTag) mainDifferenceSeconds = 0;
                else if (isGlaz) mainDifferenceSeconds = -currentSollProTagSeconds;
              }

              // Update the temporary EZA balance for the next day's calculation
              tempEzaStandDecimal += formatSecondsToDecimal(ezaDifferenceSeconds);

              // Get existing entry to potentially reuse 'buero' status
              const existingEntry = historyMap.get(currentDateStr);
              const defaultBuero = $("buero-toggle") ? $("buero-toggle").checked : false;

              // Create the new/updated entry data
              const dayData = {
                datum: currentDateStr,
                differenzSeconds: mainDifferenceSeconds,
                stundenkonto: "0.00", // Placeholder
                kommen: null, gehen: null, // Null for special days
                urlaub: isUrlaub, krank: isKrank, schulung: isSchulung, glaz: isGlaz, isEzaTag: isEzaTag,
                ezaActiveDuringBooking: currentEzaActive,
                pcBuchung: false, // False for special days
                // Keep original location if editing, else use main page default
                buero: existingEntry ? existingEntry.buero : defaultBuero,
                zusatzPause: "", // Empty for special days
                usedWochenarbeitszeit: currentWochenAZ,
                usedSollProTag: currentSollProTagDecimal,
              };
              // Add or update the entry in the map
              historyMap.set(currentDateStr, dayData);
              modified = true;
              processedCount++;
            }
          } else {
            // Skip weekends and holidays
            skippedDays++;
          }
          // Move to the next day
          currentDate.setUTCDate(currentDate.getUTCDate() + 1);
        }

        // --- Finalization ---
        if (modified) {
          // If changes were made, update the actual EZA balance
          settings.ezaKontoStand = tempEzaStandDecimal;
          storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
          updateEzaKontoDisplay();

          // Convert the map back to an array for saving
          const updatedHistory = Array.from(historyMap.values());
          saveAndReload(updatedHistory); // Save changes and recalculate balances

          alert(
            `Bulk-Aktion "${typeLabel}" erfolgreich für ${processedCount} Tage angewendet.${
              skippedDays > 0 ? ` (${skippedDays} Tage übersprungen)` : ""
            }`
          );
          closeBulkModal();
        } else {
          alert(
            `Keine Einträge zum ${
              specialType === "delete" ? "Löschen" : "Buchen"
            } im ausgewählten Zeitraum gefunden (Mo-Fr, keine Feiertage).`
          );
          closeBulkModal();
        }
      }

      // --- Statistics Calculation ---
      function calculateAndDisplayStats() {
        const period = $("stats-period").value;
        const history = getHistory(); // Already sorted
        const today = new Date();
        let startDate, endDate;
        today.setHours(12, 0, 0, 0); // Use local noon for date comparisons

        // Determine start and end dates based on selected period
        switch (period) {
          case "current_month":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 12, 0, 0, 0); // Last day of current month
            break;
          case "last_month":
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0, 12, 0, 0, 0); // Last day of previous month
            break;
          case "current_year":
            startDate = new Date(today.getFullYear(), 0, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), 11, 31, 12, 0, 0, 0);
            break;
          case "last_year":
            startDate = new Date(today.getFullYear() - 1, 0, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear() - 1, 11, 31, 12, 0, 0, 0);
            break;
          case "all_time":
          default:
            if (history.length === 0) {
              startDate = new Date(today); // Default to today if no history
              endDate = new Date(today);
            } else {
              // Use first and last entry dates
              startDate = new Date(history[0].datum + "T12:00:00Z");
              endDate = new Date(history[history.length - 1].datum + "T12:00:00Z");
            }
            break;
        }

        // Get UTC timestamps for filtering
        const startDateMs = Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate());
        const endDateMs = Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate());

        // Filter history entries within the selected date range
        const filteredHistory = history.filter((entry) => {
          const entryDate = new Date(entry.datum + "T12:00:00Z");
          const entryDateMs = Date.UTC(entryDate.getUTCFullYear(), entryDate.getUTCMonth(), entryDate.getUTCDate());
          return entryDateMs >= startDateMs && entryDateMs <= endDateMs;
        });

        // Initialize statistics counters
        let totalNetSeconds = 0,
          totalDiffSeconds = 0,
          workDays = 0,
          officeDays = 0,
          homeDays = 0,
          vacationDays = 0,
          sickDays = 0,
          trainingDays = 0,
          glazDays = 0,
          ezaDays = 0,
          holidayCount = 0;

        // Iterate through the date range to count holidays accurately
        let currentDate = new Date(startDateMs);
        const endCheckDateMs = endDateMs;
        const dateMap = new Map(filteredHistory.map((e) => [e.datum, e])); // Map for quick lookup

        while (currentDate.getTime() <= endCheckDateMs) {
            const currentDateStr = `${currentDate.getUTCFullYear()}-${pad(currentDate.getUTCMonth() + 1)}-${pad(currentDate.getUTCDate())}`;
            const entry = dateMap.get(currentDateStr);
            const dayOfWeek = currentDate.getUTCDay(); // 0=Sun, 6=Sat
            const holidayName = getHolidayName(currentDate, settings.bundesland);

            // Count holidays that fall on weekdays
            if (holidayName && dayOfWeek >= 1 && dayOfWeek <= 5) {
                holidayCount++;
            }

            // Process entry if it exists for this date
            if (entry) {
                totalDiffSeconds += entry.differenzSeconds || 0; // Sum stored difference

                // Count day types
                if (entry.urlaub) vacationDays++;
                else if (entry.krank) sickDays++;
                else if (entry.schulung) trainingDays++;
                else if (entry.glaz) glazDays++;
                else if (entry.isEzaTag) ezaDays++;
                else if (entry.kommen && entry.gehen) { // Count as work day only if times exist
                    workDays++;
                    // Recalculate net time for accuracy in stats
                    const netSeconds = calculateNetArbeitszeitSecondsFromEntryData(entry);
                    totalNetSeconds += netSeconds;
                    // Count location
                    if (entry.buero) officeDays++;
                    else homeDays++;
                }
            }
            // Move to the next day
            currentDate.setUTCDate(currentDate.getUTCDate() + 1);
        }


        // Calculate average daily hours
        const avgDailySeconds = workDays > 0 ? totalNetSeconds / workDays : 0;

        // --- Display Statistics (Use truncating formatters) ---
        const statsContent = $("stats-content");
        if (filteredHistory.length === 0 && holidayCount === 0) {
          statsContent.innerHTML = `<li>Keine Daten für ausgewählten Zeitraum vorhanden.</li>`;
          return;
        }

        // Convert seconds back to display formats using truncating formatters
        const totalNetDecimal = formatSecondsToDecimal(totalNetSeconds);
        const totalNetTime = formatSecondsToTime(totalNetSeconds); // Truncated hh:mm
        const avgDailyDecimal = formatSecondsToDecimal(avgDailySeconds);
        const avgDailyTime = formatSecondsToTime(avgDailySeconds); // Truncated hh:mm
        const totalDiffDecimal = formatSecondsToDecimal(totalDiffSeconds);
        const totalDiffTime = formatSecondsToTime(totalDiffSeconds); // Truncated hh:mm
        const diffClass = totalDiffDecimal > 0.001 ? "positive-value" : totalDiffDecimal < -0.001 ? "negative-value" : "zero-value";

        statsContent.innerHTML = `
          <li>Gesamt Netto: <span>${totalNetTime} (${totalNetDecimal.toFixed(2)}h)</span></li>
          <li>Ø Netto / Tag: <span>${avgDailyTime} (${avgDailyDecimal.toFixed(2)}h)</span></li>
          <li>Gesamt Diff: <span class="diff-badge ${diffClass}">${totalDiffTime} (${totalDiffDecimal.toFixed(2)}h)</span></li>
          <li>Arbeitstage: <span>${workDays}</span></li>
          <li>&nbsp;&nbsp;&nbsp;Büro: <span>${officeDays}</span></li>
          <li>&nbsp;&nbsp;&nbsp;Home: <span>${homeDays}</span></li>
          <li>Urlaub: <span>${vacationDays}</span></li>
          <li>Krank: <span>${sickDays}</span></li>
          <li>Schulung: <span>${trainingDays}</span></li>
          <li>GLAZ: <span>${glazDays}</span></li>
          <li>EZA-Tage: <span>${ezaDays}</span></li>
          <li>Feiertage (Mo-Fr): <span>${holidayCount}</span></li>
        `;
      }

      // --- Import / Export ---

      function exportHistoryToJson() {
        const history = getHistory(); // Contains differenzSeconds, stundenkonto (decimal) etc.
        const markers = getBalanceMarkers(); // Markers store kontostand (decimal)
        const initialKonto = getFromLS("initialKontoValue", "0"); // Initial value (decimal)

        if (history.length === 0 && markers.length === 0) {
          alert("Keine Daten zum Export vorhanden.");
          return;
        }

        // Prepare history for export (remove temporary fields if any)
        const exportHistory = history.map((entry) => {
          const { dateObj, ...rest } = entry; // Exclude temporary fields
          // Ensure differenzSeconds is included, remove old decimal/time diffs if present
          delete rest.differenz;
          delete rest.differenzTime;
          return rest;
        });

        // Structure the export data
        const exportData = {
          version: 2, // Indicate new format using seconds internally
          settings: {
            // Export relevant settings
            wochenarbeitszeit: settings.wochenarbeitszeit, // decimal
            bundesland: settings.bundesland,
            allowWochenende: settings.allowWochenende,
            allowNachtarbeit: settings.allowNachtarbeit,
            ezaActive: settings.ezaActive,
            ezaKontoStand: settings.ezaKontoStand, // decimal
            initialKontoValue: parseFloat(initialKonto), // decimal as number
          },
          balanceMarkers: markers, // Export markers (kontostand is decimal string)
          history: exportHistory, // Export history (differenzSeconds, stundenkonto decimal)
        };

        // Create and trigger download
        const jsonData = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const todayStr = new Date().toISOString().split("T")[0];
        a.href = url;
        a.download = `arbeitszeit_export_v2_${todayStr}.json`; // Indicate version in filename
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Verlauf, Marker & Optionen exportiert (Format v2).");
      }

      function importHistoryFromJson() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.style.display = "none";

        input.onchange = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();

          reader.onload = (e) => {
            let importedHistory = [],
              importedSettings = null,
              importedMarkers = [],
              initialKontoValue = 0,
              importVersion = 1; // Assume old format initially

            try {
              const importedJson = JSON.parse(e.target.result);

              // --- Detect Import Format ---
              if (
                typeof importedJson === "object" &&
                importedJson !== null &&
                Array.isArray(importedJson.history)
              ) {
                // New format (object with history, settings, markers)
                importedHistory = importedJson.history;
                importedSettings = importedJson.settings || {};
                importedMarkers = importedJson.balanceMarkers || [];
                initialKontoValue = parseFloat(
                  importedSettings.initialKontoValue || "0"
                );
                importVersion = importedJson.version || 1; // Check for version number
              } else if (Array.isArray(importedJson)) {
                // Old format (just history array)
                importedHistory = importedJson;
                alert(
                  "Altes Exportformat (v1) erkannt. Differenzen werden aus Dezimalwerten berechnet. Einstellungen, Marker und Initialwert werden nicht importiert und auf Standard zurückgesetzt."
                );
                // Reset settings, markers, initial value for old format import
                importedSettings = {}; // Use defaults
                importedMarkers = [];
                initialKontoValue = 0;
                importVersion = 1;
              } else {
                throw new Error("Unbekanntes oder ungültiges Importformat.");
              }

              // --- Validate Data Structure (Basic Checks) ---
              if (
                importedHistory.length > 0 &&
                importedHistory[0].datum === undefined
              ) {
                throw new Error(
                  "Ungültige Verlaufsdaten im Import ('datum' fehlt)."
                );
              }
              if (
                importedMarkers.length > 0 &&
                (importedMarkers[0].datum === undefined ||
                  importedMarkers[0].kontostand === undefined)
              ) {
                throw new Error(
                  "Ungültige Markerdaten im Import ('datum' oder 'kontostand' fehlt)."
                );
              }

              // --- Sanitize and Prepare Data ---
              const sanitizedHistory = importedHistory.map((entry) => {
                let diffSeconds = 0;
                if (importVersion >= 2 && entry.differenzSeconds !== undefined) {
                  // Use stored seconds difference if available (v2+)
                  diffSeconds = parseInt(entry.differenzSeconds || "0", 10);
                } else if (entry.differenz !== undefined) {
                  // Calculate seconds from old decimal difference (v1)
                  diffSeconds = decimalHoursToSeconds(
                    parseFloat(entry.differenz || "0")
                  );
                }

                // Determine default Sollzeit based on import version or current settings
                const defaultWochenAZ = parseFloat(importedSettings?.wochenarbeitszeit || settings.wochenarbeitszeit || 38);
                const defaultSollProTag = (entry.usedWochenarbeitszeit || defaultWochenAZ) / 5;


                return {
                  datum: entry.datum,
                  differenzSeconds: diffSeconds, // Store difference in seconds
                  stundenkonto: "0.00", // Reset, will be recalculated
                  kommen: entry.kommen || null,
                  gehen: entry.gehen || null,
                  urlaub: entry.urlaub || false,
                  krank: entry.krank || false,
                  schulung: entry.schulung || false,
                  glaz: entry.glaz || false,
                  isEzaTag: entry.isEzaTag || false,
                  ezaActiveDuringBooking: entry.ezaActiveDuringBooking || false,
                  pcBuchung: entry.pcBuchung || false,
                  buero: entry.buero || false,
                  zusatzPause: entry.zusatzPause || "",
                  // Use stored target times, or fall back to defaults
                  usedWochenarbeitszeit: entry.usedWochenarbeitszeit || defaultWochenAZ,
                  usedSollProTag: entry.usedSollProTag || defaultSollProTag,
                };
              });

              // Sanitize markers (ensure kontostand is decimal string)
              const sanitizedMarkers = importedMarkers.map((marker) => ({
                datum: marker.datum,
                kontostand: String(marker.kontostand || "0.00"),
              }));

              // --- Confirmation ---
              let confirmationMessage = `Möchten Sie wirklich ${sanitizedHistory.length} Einträge`;
              if (sanitizedMarkers.length > 0)
                confirmationMessage += ` und ${sanitizedMarkers.length} Marker`;
              confirmationMessage += ` importieren (Format v${importVersion})? \n\nACHTUNG: Alle vorhandenen Daten werden überschrieben!`;
              if (
                importVersion >= 2 &&
                importedSettings &&
                Object.keys(importedSettings).length > 0
              ) {
                confirmationMessage +=
                  "\n\nGespeicherte Einstellungen werden ebenfalls übernommen.";
              }

              if (confirm(confirmationMessage)) {
                // --- Apply Imported Data ---

                // Apply settings only if importing new format
                if (importVersion >= 2) {
                  settings.wochenarbeitszeit = parseFloat(
                    importedSettings.wochenarbeitszeit || 38
                  );
                  settings.bundesland =
                    importedSettings.bundesland || "NATIONAL";
                  settings.allowWochenende = !!importedSettings.allowWochenende;
                  settings.allowNachtarbeit =
                    !!importedSettings.allowNachtarbeit;
                  settings.ezaActive = !!importedSettings.ezaActive;
                  settings.ezaKontoStand = parseFloat(
                    importedSettings.ezaKontoStand || 0
                  );
                  saveSettings(); // Save applied settings
                  storeToLS("ezaKontoStand", settings.ezaKontoStand.toString()); // Save EZA separately
                  updateEzaKontoDisplay();
                } else {
                  // Reset settings if importing old format
                  loadSettings(); // Load defaults or previously saved values
                  saveSettings();
                }

                // Apply initial value and markers
                storeToLS("initialKontoValue", initialKontoValue.toString());
                storeBalanceMarkers(sanitizedMarkers); // Save sanitized markers

                // Apply history and trigger recalculation
                saveAndReload(sanitizedHistory);

                alert("Daten erfolgreich importiert.");
                switchView("main"); // Go back to main view
              }
            } catch (error) {
              console.error("Importfehler:", error);
              alert(`Import fehlgeschlagen: ${error.message}`);
            } finally {
              document.body.removeChild(input); // Clean up file input element
            }
          };

          reader.onerror = (e) => {
            console.error("Fehler beim Lesen der Datei:", e);
            alert("Fehler beim Lesen der Datei.");
            document.body.removeChild(input);
          };

          reader.readAsText(file); // Read the selected file
        };

        document.body.appendChild(input);
        input.click(); // Trigger file selection dialog
      }

      // --- Legend Modal ---
      function showLegendModal() {
        const modal = $("legend-modal");
        if (modal) modal.style.display = "flex";
      }

      function closeLegendModal() {
        const modal = $("legend-modal");
        if (modal) modal.style.display = "none";
      }

      // --- Balance Marker Modal Logic ---
      function showAddMarkerModal() {
        $("marker-date").value = ""; // Clear fields
        $("marker-balance").value = "";
        $("add-marker-modal").style.display = "flex"; // Show modal
      }

      function closeAddMarkerModal() {
        const modal = $("add-marker-modal");
        if (modal) modal.style.display = "none";
      }

      function saveBalanceMarker() {
        const dateStr = $("marker-date").value; // YYYY-MM-DD
        const balanceStr = $("marker-balance").value; // Decimal hours string

        // --- Input Validation ---
        if (!dateStr) {
          alert("Bitte ein Datum für den Marker auswählen.");
          return;
        }
        const newBalanceDecimal = parseFloat(balanceStr);
        if (balanceStr === "" || isNaN(newBalanceDecimal)) {
          alert(
            "Bitte einen gültigen Kontostand (als Dezimalzahl, z.B. 15.75) eingeben."
          );
          return;
        }

        const displayDate = new Date(
          dateStr + "T12:00:00Z"
        ).toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });

        balanceMarkers = getBalanceMarkers(); // Get current markers
        const existingIndex = balanceMarkers.findIndex(
          (m) => m.datum === dateStr
        );

        // --- Add or Update Marker ---
        if (existingIndex !== -1) {
          // Marker for this date already exists
          if (
            !confirm(
              `Für ${displayDate} existiert bereits ein Marker (${
                balanceMarkers[existingIndex].kontostand
              }h).\nSoll dieser überschrieben werden mit ${newBalanceDecimal.toFixed(
                2
              )}h?`
            )
          ) {
            return; // User cancelled overwrite
          }
          // Update existing marker (kontostand is stored as decimal string)
          balanceMarkers[existingIndex].kontostand =
            newBalanceDecimal.toFixed(2);
        } else {
          // Add new marker
          balanceMarkers.push({
            datum: dateStr,
            kontostand: newBalanceDecimal.toFixed(2), // Store as decimal string
          });
        }

        // --- Save and Update ---
        storeBalanceMarkers(balanceMarkers); // Save sorted markers
        renderBalanceMarkers(); // Update marker list display in options
        saveAndReload(getHistory()); // Recalculate history with the new/updated marker
        alert(
          `Marker für ${displayDate} mit ${newBalanceDecimal.toFixed(
            2
          )}h gespeichert.`
        );
        closeAddMarkerModal(); // Close the modal
      }

      function deleteBalanceMarker(dateStr) {
        balanceMarkers = getBalanceMarkers(); // Get current markers
        const markerIndex = balanceMarkers.findIndex((m) => m.datum === dateStr);
        if (markerIndex === -1) return; // Should not happen if called correctly

        const displayDate = new Date(
          dateStr + "T12:00:00Z"
        ).toLocaleDateString("de-DE", { timeZone: "Europe/Berlin" });
        const markerValue = balanceMarkers[markerIndex].kontostand; // Decimal value

        // --- Confirmation ---
        if (
          confirm(
            `Soll der Marker für ${displayDate} (${markerValue}h) wirklich gelöscht werden?`
          )
        ) {
          // --- Delete and Update ---
          balanceMarkers.splice(markerIndex, 1); // Remove marker from array
          storeBalanceMarkers(balanceMarkers); // Save updated marker list
          renderBalanceMarkers(); // Update display in options
          saveAndReload(getHistory()); // Recalculate history without the marker
          alert(`Marker für ${displayDate} gelöscht.`);
        }
      }

      // --- Initialization ---

      // Restores input field values from local storage on page load
      function restoreInputsFromLocalStorage() {
        const storedKommen = getFromLS("kommenZeitValue");
        const storedGehen = getFromLS("gehenZeitValue");
        if (storedKommen) {
          $("kommen-display").value = storedKommen;
          kommenZeit = parseTime(storedKommen); // Parse to Date object
        }
        if (storedGehen) {
          $("gehen-display").value = storedGehen;
          gehenZeit = parseTime(storedGehen); // Parse to Date object
        }
        $("pc-buchung").checked = getFromLS("pcBuchungChecked") === "true";
        $("buero-toggle").checked = getFromLS("bueroChecked") === "true";
        const storedPause = getFromLS("zusatzlichePauseValue");
        if (storedPause) $("zusatzliche-pause").value = storedPause;
      }

      // Stores current input field values to local storage
      function storeInputsToLocalStorage() {
        storeToLS("kommenZeitValue", $("kommen-display").value);
        storeToLS("gehenZeitValue", $("gehen-display").value);
        storeToLS(
          "pcBuchungChecked",
          $("pc-buchung").checked ? "true" : "false"
        );
        storeToLS(
          "bueroChecked",
          $("buero-toggle").checked ? "true" : "false"
        );
        storeToLS("zusatzlichePauseValue", $("zusatzliche-pause").value);
      }

      // Sets Kommen or Gehen time to now
      function setZeit(type) {
        const now = new Date();
        if (type === "kommen") {
          kommenZeit = now; // Store Date object
          $("kommen-display").value = formatTime(kommenZeit); // Update display
        } else {
          gehenZeit = now; // Store Date object
          $("gehen-display").value = formatTime(gehenZeit); // Update display
        }
        storeInputsToLocalStorage(); // Persist input value
        updateCalculations(); // Recalculate and update UI
      }

      // Handles input changes in time fields, etc.
      function onInputChange() {
        // Re-parse time inputs into Date objects
        kommenZeit = parseTime($("kommen-display").value);
        gehenZeit = parseTime($("gehen-display").value);
        storeInputsToLocalStorage(); // Persist input values
        updateCalculations(); // Recalculate and update UI
      }

      // Sets up all event listeners
      function setupEventListeners() {
        // Navigation
        $("nav-main").addEventListener("click", () => switchView("main"));
        $("nav-history").addEventListener("click", () => switchView("history"));
        $("nav-month").addEventListener("click", () => switchView("month"));
        $("nav-stats").addEventListener("click", () => switchView("stats"));
        $("nav-options").addEventListener("click", () => switchView("options"));

        // Main page inputs
        $("kommen-display").oninput = onInputChange;
        $("gehen-display").oninput = onInputChange;
        $("pc-buchung").onchange = onInputChange;
        $("buero-toggle").onchange = onInputChange;
        $("zusatzliche-pause").oninput = onInputChange;

        // Modal close buttons
        document.querySelectorAll(".close-button").forEach((btn) => {
          btn.onclick = () => {
            const modal = btn.closest(".modal");
            if (modal) modal.style.display = "none";
            // Specific close handlers if needed (e.g., for cleanup)
            if (modal && modal.id === "add-marker-modal") closeAddMarkerModal();
            if (modal && modal.id === "add-day-modal") closeAddDayModal();
            if (modal && modal.id === "detail-modal") closeDetailModal();
            if (modal && modal.id === "bulk-booking-modal") closeBulkModal();
            if (modal && modal.id === "legend-modal") closeLegendModal();
          };
        });

        // Stats page period selector
        $("stats-period").onchange = () => calculateAndDisplayStats();

        // Add/Edit Day Modal Toggles
        $("urlaub-toggle").onchange = () => toggleSpecialDay("urlaub");
        $("krank-toggle").onchange = () => toggleSpecialDay("krank");
        $("schulung-toggle").onchange = () => toggleSpecialDay("schulung");
        $("glaz-toggle").onchange = () => toggleSpecialDay("glaz");
        $("eza-tag-toggle").onchange = () => toggleSpecialDay("ezaTag");

        // Bulk Modal Buttons
        $("open-bulk-modal-button").addEventListener("click", showBulkModal);
        $("apply-bulk-modal-button").addEventListener("click", applyBulkBooking);

        // Options Page Settings
        $("bundesland-select").onchange = (e) => {
          settings.bundesland = e.target.value;
          saveSettings();
          // Update views that depend on holiday display
          if (currentView === "history") loadHistory();
          if (currentView === "month") loadMonthData();
          if (currentView === "stats") calculateAndDisplayStats();
        };
        $("wochenarbeitszeit-setting").onchange = (e) => {
          const val = parseFloat(e.target.value);
          if (!isNaN(val) && val > 0) {
            settings.wochenarbeitszeit = val;
            saveSettings(); // Save new value
            // Recalculate history as target times might change retroactively if not stored per entry
            // saveAndReload handles recalculation based on stored usedSollProTag
            saveAndReload(getHistory());
            updateCalculations(); // Update main page display immediately
          } else {
            // Reset to previous valid value on invalid input
            e.target.value = settings.wochenarbeitszeit.toFixed(1);
          }
        };
        $("wochenende-toggle").onchange = (e) => {
          settings.allowWochenende = e.target.checked;
          saveSettings();
          // Update views that show weekends
          if (currentView === "history") loadHistory();
          if (currentView === "month") loadMonthData();
        };
        $("nachtarbeit-toggle").onchange = (e) => {
          settings.allowNachtarbeit = e.target.checked;
          saveSettings();
          // Update views that show violation/moon indicators
          updateCalculations(); // Main page warnings
          if (currentView === "history") loadHistory();
          if (currentView === "month") loadMonthData();
        };
        $("eza-toggle").onchange = (e) => {
          settings.ezaActive = e.target.checked;
          saveSettings();
          // EZA status change affects calculations, trigger reload
          saveAndReload(getHistory());
          updateCalculations(); // Update main page display
        };
        $("eza-konto-speichern-button").addEventListener("click", saveEzaKonto);

        // Import/Export/Legend/Marker Buttons
        $("export-button-options").addEventListener("click", exportHistoryToJson);
        $("import-button-options").addEventListener("click", importHistoryFromJson);
        $("show-legend-button").addEventListener("click", showLegendModal);
        $("add-marker-button").addEventListener("click", showAddMarkerModal);
      }

      // Main initialization function called on DOMContentLoaded
      function init() {
        loadSettings(); // Load settings from LS
        balanceMarkers = getBalanceMarkers(); // Load markers from LS
        restoreInputsFromLocalStorage(); // Restore main page inputs

        // Set initial week/month view dates
        const heute = new Date();
        [currentWeekYear, currentWeekNo] = getWeekNumber(heute);
        currentMonthYear = heute.getFullYear();
        currentMonth = heute.getMonth();

        // Load or calculate initial account balance
        let lastKontoValueDecimal = 0;
        const lastKontoStored = getFromLS("aktuellesStundenkonto"); // Stored as decimal string
        if (lastKontoStored !== null) {
          lastKontoValueDecimal = parseFloat(lastKontoStored);
        } else {
          // No balance stored, force recalculation from history and markers
          console.log("No initial balance found, recalculating from history/markers...");
          const history = getHistory();
          saveAndReload(history); // This calculates and stores the latest balance
          // Re-read the calculated balance
          lastKontoValueDecimal = parseFloat(getFromLS("aktuellesStundenkonto", "0"));
        }

        // Update main page balance display (use truncating formatter for hh:mm)
        $("aktuelles-konto").value = lastKontoValueDecimal.toFixed(2);
        $("aktuelles-konto-time").value = formatSecondsToTime(
          decimalHoursToSeconds(lastKontoValueDecimal)
        );

        updateEzaKontoDisplay(); // Update EZA display
        updateCalculations(); // Perform initial calculation for main page
        switchView("main"); // Show the main page initially
        setupEventListeners(); // Attach all event listeners

        // Ensure modals are closed on startup
        closeAddDayModal();
        closeDetailModal();
        closeBulkModal();
        closeLegendModal();
        closeAddMarkerModal();
      }

      // --- Global Event Listener ---
      document.addEventListener("DOMContentLoaded", init);
    </script>

    <style>
      /* CSS (largely unchanged) */
      :root {
        /* Light Mode */
        --system-background-light: #f2f2f7;
        --system-secondary-background-light: #ffffff;
        --system-tertiary-background-light: #e5e5ea; /* Used for marker list bg */
        --text-color-light: #000000;
        --secondary-text-color-light: rgba(60, 60, 67, 0.6);
        --readonly-text-color-light: rgba(0, 0, 0, 0.75);
        --separator-color-light: rgba(60, 60, 67, 0.29);
        --input-border-color-light: rgba(60, 60, 67, 0.2);
        --system-blue-light: #007aff; /* Positiv */
        --system-green-light: #34c759; /* Null Saldo */
        --system-red-light: #ff3b30; /* Krank / Delete */
        --system-orange-light: #ff9500; /* Negativ */
        --system-yellow-light: #ffcc00; /* GLAZ */
        --system-teal-light: #5ac8fa; /* Urlaub */
        --system-purple-light: #af52de;
        --system-indigo-light: #5856d6; /* Holiday */
        --system-pink-light: #ff2d55; /* EZA-Tag */
        --system-pastel-green-light: #a1e8b5; /* Schulung */
        --system-gray-light: #8e8e93;
        --system-gray2-light: #aeaeb2;

        /* Dark Mode */
        --system-background-dark: #000000;
        --system-secondary-background-dark: #1c1c1e;
        --system-tertiary-background-dark: #2c2c2e; /* Used for marker list bg */
        --text-color-dark: #ffffff;
        --secondary-text-color-dark: rgba(235, 235, 245, 0.6);
        --readonly-text-color-dark: rgba(255, 255, 255, 0.75);
        --separator-color-dark: rgba(84, 84, 88, 0.65);
        --input-border-color-dark: rgba(84, 84, 88, 0.5);
        --system-blue-dark: #0a84ff; /* Positiv */
        --system-green-dark: #30d158; /* Null Saldo */
        --system-red-dark: #ff453a; /* Krank / Delete */
        --system-orange-dark: #ff9f0a; /* Negativ */
        --system-yellow-dark: #ffd60a; /* GLAZ */
        --system-teal-dark: #64d2ff; /* Urlaub */
        --system-purple-dark: #bf5af2;
        --system-indigo-dark: #5e5ce6; /* Holiday */
        --system-pink-dark: #ff375f; /* EZA-Tag */
        --system-pastel-green-dark: #4f8a61; /* Schulung */
        --system-gray-dark: #8e8e93;
        --system-gray2-dark: #3a3a3c;

        /* Semantic Colors */
        --background-color: var(--system-background-light);
        --card-background-color: var(--system-secondary-background-light);
        --input-background-color: var(--system-tertiary-background-light);
        --text-color: var(--text-color-light);
        --secondary-text-color: var(--secondary-text-color-light);
        --readonly-text-color: var(--readonly-text-color-light);
        --separator-color: var(--separator-color-light);
        --input-border-color: var(--input-border-color-light);
        --button-background-color: var(--system-blue-light);
        --button-text-color: #ffffff;
        --positive-value-bg: var(--system-blue-light);
        --negative-value-bg: var(--system-orange-light);
        --zero-value-bg: var(--system-green-light);
        --hint-color: var(--system-red-light);
        --delete-button-bg: var(--system-red-light);
        --special-day-urlaub-bg: var(--system-teal-light);
        --special-day-krank-bg: var(--system-red-light);
        --special-day-glaz-bg: var(--system-yellow-light);
        --special-day-schulung-bg: var(--system-pastel-green-light);
        --special-day-eza-bg: var(--system-pink-light);
        --holiday-bg: var(--system-indigo-light);
        --special-day-text: #000000;
        --special-day-krank-text: #ffffff;
        --special-day-glaz-text: #000000;
        --special-day-schulung-text: #000000;
        --special-day-eza-text: #ffffff;
        --holiday-text: #ffffff;
        --nav-background: var(--system-secondary-background-light);
        --nav-icon-color: var(--system-gray-light);
        --nav-icon-active-color: var(--system-blue-light);
        --slider-bg-color: var(--system-gray2-light);
        --slider-checked-bg-color: var(--system-green-light);
        --outline-color: var(--secondary-text-color-light);
        --inactive-indicator-color: var(--secondary-text-color-light);
        --marker-list-bg: var(--system-tertiary-background-light);

        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        --safe-area-left: env(safe-area-inset-left, 0px);
        --safe-area-right: env(safe-area-inset-right, 0px);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: var(--system-background-dark);
          --card-background-color: var(--system-secondary-background-dark);
          --input-background-color: var(--system-tertiary-background-dark);
          --text-color: var(--text-color-dark);
          --secondary-text-color: var(--secondary-text-color-dark);
          --readonly-text-color: var(--readonly-text-color-dark);
          --separator-color: var(--separator-color-dark);
          --input-border-color: var(--input-border-color-dark);
          --button-background-color: var(--system-blue-dark);
          --positive-value-bg: var(--system-blue-dark);
          --negative-value-bg: var(--system-orange-dark);
          --zero-value-bg: var(--system-green-dark);
          --hint-color: var(--system-red-dark);
          --delete-button-bg: var(--system-red-dark);
          --special-day-urlaub-bg: var(--system-teal-dark);
          --special-day-krank-bg: var(--system-red-dark);
          --special-day-glaz-bg: var(--system-yellow-dark);
          --special-day-schulung-bg: var(--system-pastel-green-dark);
          --special-day-eza-bg: var(--system-pink-dark);
          --holiday-bg: var(--system-indigo-dark);
          --special-day-text: #000000;
          --special-day-krank-text: #ffffff;
          --special-day-glaz-text: #000000;
          --special-day-schulung-text: #ffffff;
          --special-day-eza-text: #ffffff;
          --holiday-text: #ffffff;
          --nav-background: var(--system-secondary-background-dark);
          --nav-icon-color: var(--system-gray-dark);
          --nav-icon-active-color: var(--system-blue-dark);
          --slider-bg-color: var(--system-gray2-dark);
          --slider-checked-bg-color: var(--system-green-dark);
          --outline-color: var(--secondary-text-color-dark);
          --inactive-indicator-color: var(--secondary-text-color-dark);
          --marker-list-bg: var(--system-tertiary-background-dark);
        }
      }

      html, body {
        background-color: var(--background-color); color: var(--text-color);
        margin: 0; padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        -webkit-text-size-adjust: 100%; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        height: 100%; overflow: hidden;
      }
      #app-container { display: flex; flex-direction: column; height: 100vh; }
      .page {
        flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        padding: var(--safe-area-top) calc(15px + var(--safe-area-left)) calc(60px + var(--safe-area-bottom)) calc(15px + var(--safe-area-right)); /* Adjusted bottom padding for nav */
        display: none;
      }
      .page.active { display: block; }
      .container { max-width: 600px; margin: 0 auto; padding-bottom: 0; }
      h1 { font-size: 34px; font-weight: 700; margin: 10px 0 20px 0; }
      h2 { font-size: 22px; font-weight: 600; margin: 25px 0 15px 0; border-bottom: 1px solid var(--separator-color); padding-bottom: 8px; }
      h3 { font-size: 17px; font-weight: 600; margin: 0 0 10px 0; color: var(--secondary-text-color); text-transform: uppercase; }
      label { font-size: 15px; font-weight: 400; color: var(--secondary-text-color); display: block; margin-bottom: 5px; }
      p { font-size: 17px; line-height: 1.4; margin: 5px 0 15px 0; }
      .section { background-color: var(--card-background-color); border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      @media (prefers-color-scheme: dark) { .section { box-shadow: none; } }
      .button, .inline-button, .delete-button, .add-button, .link-button {
        background-color: var(--button-background-color); color: var(--button-text-color);
        border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
        box-sizing: border-box; line-height: 1.2em; text-align: center;
        transition: background-color 0.1s ease-in-out; -webkit-appearance: none; appearance: none;
      }
      .button { width: 100%; padding: 12px 15px; font-size: 17px; min-height: 44px; margin-bottom: 10px; }
      .inline-button, .delete-button, .add-button { font-size: 15px; padding: 8px 12px; min-height: 36px; }
      .delete-button { background-color: var(--delete-button-bg); }
      .add-button { background-color: var(--system-green-light); }
      @media (prefers-color-scheme: dark) { .add-button { background-color: var(--system-green-dark); } }
      .link-button { background: none; color: var(--button-background-color); padding: 5px 0; font-size: 15px; text-decoration: none; display: inline-block; margin-top: 10px; }
      .button:active, .inline-button:active, .delete-button:active, .add-button:active, .link-button:active { filter: brightness(0.85); }
      input[type="time"], input[type="number"], input[type="text"], input[type="date"], select {
        width: 100%; padding: 12px 15px; font-size: 17px; border: 1px solid var(--input-border-color);
        border-radius: 8px; margin-bottom: 10px; background-color: var(--input-background-color);
        color: var(--text-color); box-sizing: border-box; -webkit-appearance: none; appearance: none;
        line-height: 1.2em; min-height: 44px;
      }
      #eza-konto-input, #eza-konto-display, #marker-date, #marker-balance { height: 44px; box-sizing: border-box; } /* Ensure consistent height */
      input:read-only { background-color: var(--card-background-color); color: var(--readonly-text-color); cursor: default; border: 1px solid var(--input-border-color); }
      input:disabled { background-color: var(--system-tertiary-background-light); color: var(--secondary-text-color); opacity: 0.7; cursor: not-allowed; }
      @media (prefers-color-scheme: dark) { input:disabled { background-color: var(--system-tertiary-background-dark); } }
      input[type="time"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { display: none; -webkit-appearance: none; }
      .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
      .column { flex: 1; }
      .column-auto { flex: 0 0 auto; margin-bottom: 10px; } /* Adjusted margin */
      .time-button-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; position: relative; }
      .time-button-row input[type="time"], .time-button-row .button { flex: 1; margin-bottom: 0; }
      .time-button-row input[type="time"] { text-align: center; }
      .time-button-row .button { padding: 12px 15px; }
      .moon-indicator { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 18px; display: none; pointer-events: none; }
      .moon-mark { font-size: 1em; vertical-align: baseline; }
      .moon-mark-calendar { font-size: 0.7em; vertical-align: super; margin-left: 1px; }
      .switch-container { display: flex; align-items: center; margin-bottom: 15px; min-height: 44px; }
      .switch-container span { margin-left: 10px; font-size: 17px; flex-grow: 1; } /* Allow text wrap */
      .switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0; } /* iOS Standard Size */
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--slider-bg-color); transition: .4s; border-radius: 15.5px; }
      .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
      input:checked + .slider { background-color: var(--slider-checked-bg-color); }
      input:checked + .slider:before { transform: translateX(20px); } /* 51 - 27 - 2*2 = 20 */
      .diff-badge { padding: 3px 6px; border-radius: 5px; font-size: 15px; font-weight: 500; display: inline-block; vertical-align: middle; }
      input[readonly].positive-value, input[readonly].negative-value, input[readonly].zero-value { font-size: 17px; }
      .positive-value { background-color: var(--positive-value-bg) !important; color: var(--button-text-color) !important; }
      .negative-value { background-color: var(--negative-value-bg) !important; color: #000000 !important; }
      .zero-value { background-color: var(--zero-value-bg) !important; color: #000000 !important; }
      #hinweis { color: var(--hint-color); font-weight: 500; font-size: 15px; display: none; margin-top: 10px; padding: 10px; background-color: rgba(255, 59, 48, 0.1); border-radius: 8px; }
      .invalid-time { border-color: var(--hint-color) !important; background-color: rgba(255, 59, 48, 0.1) !important; }
      #history-list { list-style-type: none; padding: 0; margin: 0; background-color: var(--card-background-color); border-radius: 10px; overflow: hidden; }
      .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; min-height: 60px; border-bottom: 1px solid var(--separator-color); gap: 10px; }
      .history-item:last-child { border-bottom: none; }
      .history-entry-content { flex-grow: 1; padding: 5px; border-radius: 6px; background-color: transparent; border-left: 3px solid transparent; transition: background-color 0.2s ease; }
      .history-entry-content.holiday-day { background-color: var(--holiday-bg); color: var(--holiday-text); }
      .history-entry-content.special-day.special-day-urlaub-bg { background-color: var(--special-day-urlaub-bg); }
      .history-entry-content.special-day.special-day-krank-bg { background-color: var(--special-day-krank-bg); }
      .history-entry-content.special-day.special-day-schulung-bg { background-color: var(--special-day-schulung-bg); }
      .history-entry-content.special-day.special-day-eza-bg { background-color: var(--special-day-eza-bg); }
      .history-entry-content.special-day.special-day-glaz-bg { background-color: var(--special-day-glaz-bg); }
      .history-entry-content.special-day[style*="--special-day-text"] { color: var(--special-day-text); }
      .history-entry-content.special-day[style*="--special-day-krank-text"] { color: var(--special-day-krank-text); }
      .history-entry-content.special-day[style*="--special-day-glaz-text"] { color: var(--special-day-glaz-text); }
      .history-entry-content.special-day[style*="--special-day-schulung-text"] { color: var(--special-day-schulung-text); }
      .history-entry-content.special-day[style*="--special-day-eza-text"] { color: var(--special-day-eza-text); }
      .history-entry-content.holiday-day div:last-child { color: var(--holiday-text); }
      .history-entry-content.violation-day { border-left: 3px solid var(--hint-color); background-color: rgba(255, 59, 48, 0.05); }
      .history-entry-content.no-data { color: var(--secondary-text-color); }
      .history-entry-content div:first-child { font-weight: 500; }
      .history-entry-content div:last-child { font-size: 15px; color: var(--secondary-text-color); margin-top: 4px; }
      /* Ensure special day text colors override secondary text color */
      .history-entry-content.special-day[style*="--special-day-text"] div:last-child,
      .history-entry-content.special-day[style*="--special-day-krank-text"] div:last-child,
      .history-entry-content.special-day[style*="--special-day-glaz-text"] div:last-child,
      .history-entry-content.special-day[style*="--special-day-schulung-text"] div:last-child,
      .history-entry-content.special-day[style*="--special-day-eza-text"] div:last-child {
          color: inherit; /* Inherit from parent .special-day */
      }
      .history-entry-content.holiday-day div:last-child { color: var(--holiday-text); }
      .violation-mark { color: var(--hint-color); font-weight: bold; }
      .history-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
      .history-actions .inline-button, .history-actions .delete-button { font-size: 20px; padding: 5px 8px; } /* Adjust size */
      .eza-related-diff.inactive, .eza-tag-label.inactive { opacity: 0.6; font-style: italic; }
      .eza-tag-label.inactive::after { content: " (i)"; font-size: 0.8em; vertical-align: super; opacity: 0.8; }
      .eza-hint-inline { font-size: 0.9em; color: var(--secondary-text-color); cursor: help; }
      .history-entry-content.eza-booked-outline-history { outline: 1px solid var(--outline-color); outline-offset: -2px; }
      #weekly-summary, #month-summary { padding: 15px; background-color: var(--card-background-color); border-radius: 10px; margin-top: 20px; text-align: center; font-size: 17px; font-weight: 500; }
      #pagination, #month-pagination { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
      .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
      .modal-content { background-color: var(--card-background-color); border-radius: 14px; padding: 20px; max-width: 400px; width: 90%; margin: auto; color: var(--text-color); box-sizing: border-box; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
      .modal-content h3 { margin-top: 0; margin-bottom: 15px; }
      .close-button { position: absolute; top: 10px; right: 10px; background: var(--system-gray2-light); border: none; color: var(--secondary-text-color); font-size: 14px; font-weight: bold; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; line-height: 1; padding: 0; }
      @media (prefers-color-scheme: dark) { .close-button { background: var(--system-gray2-dark); } }
      .close-button:active { filter: brightness(0.85); }
      #detail-modal-actions .button { font-size: 17px; }
      #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
      .calendar-header { text-align: center; font-size: 13px; font-weight: 500; color: var(--secondary-text-color); padding-bottom: 10px; }
      .calendar-day { display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1; font-size: 16px; position: relative; cursor: default; }
      .calendar-day.empty { visibility: hidden; }
      .calendar-day.weekend .calendar-day-content { color: var(--secondary-text-color); }
      .calendar-day.no-entry { cursor: pointer; }
      .calendar-day.has-entry { cursor: pointer; }
      .calendar-day.holiday { cursor: help; }
      .calendar-day-content { display: flex; justify-content: center; align-items: center; width: 85%; height: 85%; border-radius: 50%; transition: transform 0.1s ease; position: relative; box-sizing: border-box; }
      .calendar-day-content.positive-value { color: var(--button-text-color); }
      .calendar-day-content.negative-value { color: #000000; }
      .calendar-day-content.zero-value { color: #000000; }
      .calendar-day-content.special-day-urlaub-bg { background-color: var(--special-day-urlaub-bg); color: var(--special-day-text) !important; }
      .calendar-day-content.special-day-krank-bg { background-color: var(--special-day-krank-bg); color: var(--special-day-krank-text) !important; }
      .calendar-day-content.special-day-schulung-bg { background-color: var(--special-day-schulung-bg); color: var(--special-day-schulung-text) !important; }
      .calendar-day-content.special-day-eza-bg { background-color: var(--special-day-eza-bg); color: var(--special-day-eza-text) !important; }
      .calendar-day-content.special-day-glaz-bg { background-color: var(--special-day-glaz-bg); color: var(--special-day-glaz-text) !important; }
      .calendar-day-content.holiday-day { background-color: var(--holiday-bg); color: var(--holiday-text) !important; }
      .calendar-day-content.today { font-weight: bold; border: 2px solid var(--button-background-color); }
      .calendar-day.has-entry .calendar-day-content.today { border: 2px solid var(--text-color); }
      .calendar-day:active .calendar-day-content { transform: scale(0.95); }
      .calendar-day-content.eza-booked-outline { box-shadow: inset 0 0 0 3px var(--outline-color); }
      #stats-content { list-style: none; padding: 0; margin: 0; background-color: var(--card-background-color); border-radius: 10px; overflow: hidden; }
      #stats-content li { display: flex; justify-content: space-between; padding: 12px 15px; font-size: 17px; border-bottom: 1px solid var(--separator-color); }
      #stats-content li:last-child { border-bottom: none; }
      #stats-content li span:last-child { font-weight: 500; color: var(--secondary-text-color); }
      .import-export-buttons { display: flex; gap: 10px; margin-top: 20px; }
      .import-export-buttons .button { margin-bottom: 0; }
      #legend-modal .modal-content { max-width: 450px; }
      .legend-list { list-style: none; padding: 0; margin: 0; }
      .legend-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 15px; }
      .legend-color-dot { width: 18px; height: 18px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.1); }
      .legend-outline-indicator { width: 18px; height: 18px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; border: 3px solid var(--outline-color); box-sizing: border-box; background-color: var(--card-background-color); }
      .legend-text { flex-grow: 1; }
      #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(50px + var(--safe-area-bottom)); background-color: var(--nav-background); border-top: 0.5px solid var(--separator-color); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 5px; padding-bottom: var(--safe-area-bottom); z-index: 1000; }
      .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: var(--nav-icon-color); text-decoration: none; font-size: 10px; cursor: pointer; padding: 0 2px; text-align: center; height: 45px; box-sizing: border-box; }
      .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; fill: currentColor; }
      .nav-item.active { color: var(--nav-icon-active-color); }

      /* Styling for Marker List in Options */
      .marker-list {
        list-style: none;
        padding: 0;
        margin: 0;
        background-color: var(--marker-list-bg); /* Slightly different background */
        border-radius: 8px;
        padding: 10px;
      }
      .marker-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 5px;
        font-size: 15px;
        border-bottom: 1px solid var(--separator-color);
      }
      .marker-list li:last-child { border-bottom: none; }
      .marker-list li span { flex-grow: 1; margin-right: 10px; }
      .marker-list li span .diff-badge { margin-left: 5px; }
      .marker-list .delete-button {
        flex-shrink: 0; /* Prevent shrinking */
        padding: 4px 8px; /* Smaller buttons */
        font-size: 14px;
        min-height: auto;
      }

      /* Styling for Add Marker Modal */
      #add-marker-modal .modal-content {
        max-width: 350px; /* Slightly narrower */
      }
      /* Small text style */
      .small-text {
          font-size: 14px;
          color: var(--secondary-text-color);
          margin-top: 0px;
          margin-bottom: 15px; /* Consistent spacing */
      }

    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- Main Page -->
      <div id="main-page" class="page active">
        <div class="container">
          <h1>Arbeitszeit</h1>

          <div class="section">
            <h3>Zeiterfassung</h3>
            <div class="time-button-row">
              <input type="time" id="kommen-display" oninput="onInputChange()" />
              <span id="kommen-moon" class="moon-indicator">🌙</span>
              <button class="button" onclick="setZeit('kommen')">Kommen</button>
            </div>
            <div class="time-button-row">
              <input type="time" id="gehen-display" oninput="onInputChange()" />
              <span id="gehen-moon" class="moon-indicator">🌙</span>
              <button class="button" onclick="setZeit('gehen')">Gehen</button>
            </div>
            <div class="switch-container" style="margin-top: 15px">
              <label class="switch">
                <input type="checkbox" id="pc-buchung" onchange="onInputChange()" />
                <span class="slider"></span>
              </label>
              <span>PC-Buchung (+0.13h)</span>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="buero-toggle" onchange="onInputChange()" />
                <span class="slider"></span>
              </label>
              <span>Im Büro</span>
            </div>
            <p id="hinweis"></p>
          </div>

          <div class="section">
            <h3>Übersicht (Aktuell)</h3>
            <div class="row">
              <div class="column">
                <label for="wochenarbeitszeit">Wochen-AZ (Std):</label>
                <input type="number" id="wochenarbeitszeit" readonly />
              </div>
              <div class="column">
                <label for="zusatzliche-pause">Zus. Pause (hh:mm / h.hh):</label>
                <input type="text" id="zusatzliche-pause" placeholder="z.B. 0:15 oder 0.25" oninput="onInputChange()" />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label for="aktuelles-konto">Aktuelles Konto (Std):</label>
                <input type="text" id="aktuelles-konto" value="0.00" readonly />
              </div>
              <div class="column">
                <label>Konto (Zeit):</label>
                <input type="text" id="aktuelles-konto-time" readonly />
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Zeitenübersicht (Heute)</h3>
            <div class="row">
              <div class="column">
                <label>Anwesenheit:</label>
                <input type="text" id="anwesend-zeit" readonly />
              </div>
              <div class="column">
                <label>Gesamtpause (Gesetzl.+Zus.):</label>
                <input type="text" id="pausenzeit" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column" style="position: relative">
                <label>Netto-Arbeitszeit:</label>
                <input type="text" id="arbeitszeit" readonly />
                <span id="arbeitszeit-moon" class="moon-indicator" style="right: 15px">🌙</span>
              </div>
              <div class="column">
                <label>Soll-Arbeitszeit:</label>
                <input type="text" id="sollarbeitszeit-display" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Differenz (Std):</label>
                <input type="text" id="differenz" readonly />
              </div>
              <div class="column">
                <label>Differenz (Zeit):</label>
                <input type="text" id="differenz-time" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Neues Konto (Std):</label>
                <input type="text" id="neues-konto" readonly />
              </div>
              <div class="column">
                <label>Neues Konto (Zeit):</label>
                <input type="text" id="neues-konto-time" readonly />
              </div>
            </div>
            <button class="button" onclick="saveDay()">Tag speichern</button>
          </div>

          <div class="section">
            <h3>Ausstempelzeiten (Prognose)</h3>
            <div class="row">
              <div class="column">
                <label>Soll:</label>
                <input type="text" id="end-time-soll" readonly />
              </div>
              <div class="column">
                <label>10h (Max):</label>
                <input type="text" id="end-time-10h" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>4h (Min):</label>
                <input type="text" id="end-time-4h" readonly />
              </div>
              <div class="column">
                <label>6h (+Pause):</label>
                <input type="text" id="end-time-6h" readonly />
              </div>
              <div class="column">
                <label>9h (+Pause):</label>
                <input type="text" id="end-time-9h" readonly />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- History Page -->
      <div id="history-page" class="page">
        <div class="container">
          <h1>Verlauf</h1>
          <h2 id="week-info"></h2>
          <p id="week-range" style="text-align: center; color: var(--secondary-text-color); margin-top: -10px; margin-bottom: 15px;"></p>
          <div id="pagination"></div>
          <ul id="history-list"></ul>
          <div id="weekly-summary">
            <span id="weekly-summary-content">Gesamtdifferenz: --</span>
          </div>
        </div>
      </div>

      <!-- Month Page -->
      <div id="month-page" class="page">
        <div class="container">
          <h1>Monatsübersicht</h1>
          <div id="month-pagination" style="align-items: center">
            <button id="prev-month" class="inline-button">‹</button>
            <h2 id="month-year-display" style="margin: 0; border: none; text-align: center"></h2>
            <button id="next-month" class="inline-button">›</button>
          </div>
          <div id="calendar-grid"></div>
          <div id="month-summary">
            <span id="month-summary-content">Monatsdifferenz: --</span>
          </div>
          <div style="text-align: center">
            <button id="show-legend-button" class="link-button">Legende anzeigen</button>
          </div>
          <button id="open-bulk-modal-button" class="button" style="margin-top: 20px">Bulk-Buchung / Löschen</button>
        </div>
      </div>

      <!-- Stats Page -->
      <div id="stats-page" class="page">
        <div class="container">
          <h1>Statistik</h1>
          <div class="section">
            <label for="stats-period">Zeitraum:</label>
            <select id="stats-period">
              <option value="current_month">Aktueller Monat</option>
              <option value="last_month">Letzter Monat</option>
              <option value="current_year">Aktuelles Jahr</option>
              <option value="last_year">Letztes Jahr</option>
              <option value="all_time" selected>Gesamter Zeitraum</option>
            </select>
          </div>
          <ul id="stats-content">
            <li>Lade Statistik...</li>
          </ul>
        </div>
      </div>

      <!-- Options Page -->
      <div id="options-page" class="page">
        <div class="container">
          <h1>Optionen</h1>
          <div class="section">
            <h3>Allgemein</h3>
            <div style="margin-bottom: 15px">
              <label for="wochenarbeitszeit-setting">Wochenarbeitszeit (Std):</label>
              <input type="number" id="wochenarbeitszeit-setting" step="0.1" />
            </div>
            <div style="margin-bottom: 15px">
              <label for="bundesland-select">Bundesland (für Feiertage):</label>
              <select id="bundesland-select">
                <option value="NATIONAL">Bundesweit</option>
                <option value="BW">Baden-Württemberg</option>
                <option value="BY">Bayern</option>
                <option value="BE">Berlin</option>
                <option value="BB">Brandenburg</option>
                <option value="HB">Bremen</option>
                <option value="HH">Hamburg</option>
                <option value="HE">Hessen</option>
                <option value="MV">Mecklenburg-Vorpommern</option>
                <option value="NI">Niedersachsen</option>
                <option value="NW">Nordrhein-Westfalen</option>
                <option value="RP">Rheinland-Pfalz</option>
                <option value="SL">Saarland</option>
                <option value="SN">Sachsen</option>
                <option value="ST">Sachsen-Anhalt</option>
                <option value="SH">Schleswig-Holstein</option>
                <option value="TH">Thüringen</option>
              </select>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="wochenende-toggle" />
                <span class="slider"></span>
              </label>
              <span>Wochenendarbeit erlauben (Sa/So anzeigen & buchen)</span>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="nachtarbeit-toggle" />
                <span class="slider"></span>
              </label>
              <span>Nacht-/Randzeiten tolerieren (keine Warnung, 🌙 statt !)</span>
            </div>
          </div>

          <div class="section">
            <h3>EZA-Regelung</h3>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="eza-toggle" />
                <span class="slider"></span>
              </label>
              <span>EZA-Regelung aktiv (-0.4h bei U/S, EZA-Konto)</span>
            </div>
            <div class="row">
              <div class="column">
                <label for="eza-konto-input">EZA-Konto (Std):</label>
                <input type="number" id="eza-konto-input" step="0.1" />
              </div>
              <div class="column">
                <label>EZA-Konto (Tage):</label>
                <input type="text" id="eza-konto-display" readonly />
              </div>
              <div class="column-auto">
                <button id="eza-konto-speichern-button" class="inline-button" style="min-height: 44px">Setzen</button>
              </div>
            </div>
            <p class="small-text">
              Aktuellen Stand des EZA-Kontos in Stunden eingeben und setzen.
            </p>
          </div>

          <div class="section">
            <h3>Kontostand-Marker</h3>
            <p class="small-text">
              Setze Ankerpunkte (Datum + Kontostand), ab denen der Kontostand neu berechnet wird. Nützlich zur Korrektur oder Initialisierung.
            </p>
            <ul id="balance-marker-list" class="marker-list">
              <!-- Marker werden hier per JS eingefügt -->
              <li>Keine Marker gesetzt.</li>
            </ul>
            <button id="add-marker-button" class="button" style="margin-top: 15px">
              Marker hinzufügen / ändern
            </button>
          </div>


          <div class="section">
            <h3>Daten</h3>
            <div class="import-export-buttons">
              <button id="export-button-options" class="button">Export</button>
              <button id="import-button-options" class="button">Import</button>
            </div>
            <p class="small-text" style="margin-top: 10px;">
              Beim Import werden alle vorhandenen Daten überschrieben. Der Export enthält den Verlauf, Marker und die aktuellen Einstellungen (Format v2).
            </p>
          </div>
        </div>
      </div>

      <!-- Detail-Modal -->
      <div id="detail-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">×</button>
          <h3 id="detail-modal-title">Details</h3>
          <div id="detail-content"></div>
          <div id="detail-modal-actions" style="display: flex; gap: 10px; margin-top: 20px">
            <button id="detail-edit-button" class="button">Ändern</button>
            <button id="detail-delete-button" class="button delete-button">Löschen</button>
          </div>
        </div>
      </div>

      <!-- Add Day Modal -->
      <div id="add-day-modal" class="modal" data-date="" style="display: none">
        <div class="modal-content">
          <button class="close-button">×</button>
          <h3 id="add-day-modal-title">Manuelle Buchung</h3>
          <div class="row">
            <div class="column">
              <label for="add-day-kommen">Kommen:</label>
              <input type="time" id="add-day-kommen" />
            </div>
            <div class="column">
              <label for="add-day-gehen">Gehen:</label>
              <input type="time" id="add-day-gehen" />
            </div>
          </div>
          <div style="margin-top: 10px">
            <label for="add-day-zusatzliche-pause">Zus. Pause (hh:mm / h.hh):</label>
            <input type="text" id="add-day-zusatzliche-pause" placeholder="z.B. 0:15 oder 0.25" />
          </div>
          <div class="switch-container" style="margin-top: 15px">
            <label class="switch">
              <input type="checkbox" id="pc-buchung-add-day" />
              <span class="slider"></span>
            </label>
            <span>PC-Buchung (+0.13h)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="buero-add-day" />
              <span class="slider"></span>
            </label>
            <span>Im Büro</span>
          </div>
          <h3 style="margin-top: 20px">Sondertag?</h3>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="urlaub-toggle" onchange="toggleSpecialDay('urlaub')" />
              <span class="slider"></span>
            </label>
            <span>Urlaub</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="krank-toggle" onchange="toggleSpecialDay('krank')" />
              <span class="slider"></span>
            </label>
            <span>Krank</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="schulung-toggle" onchange="toggleSpecialDay('schulung')" />
              <span class="slider"></span>
            </label>
            <span>Schulung</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="glaz-toggle" onchange="toggleSpecialDay('glaz')" />
              <span class="slider"></span>
            </label>
            <span>GLAZ (Gleitzeitabbau)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="eza-tag-toggle" onchange="toggleSpecialDay('ezaTag')" />
              <span class="slider"></span>
            </label>
            <span>EZA-Tag</span>
          </div>
          <button class="button" onclick="addManualDay()" style="margin-top: 20px">Speichern</button>
        </div>
      </div>

      <!-- Bulk Booking Modal -->
      <div id="bulk-booking-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">×</button>
          <h3 id="bulk-modal-title">Bulk-Buchung / Löschen</h3>
          <p class="small-text">
            Aktion für Mo-Fr (keine Feiertage). Bestehende Einträge im Zeitraum werden überschrieben oder gelöscht. EZA-Logik wird angewendet, falls global aktiv. Die zum Zeitpunkt der Bulk-Buchung gültige Soll-Arbeitszeit wird verwendet.
          </p>
          <div class="row">
            <div class="column">
              <label for="bulk-modal-start-date">Von:</label>
              <input type="date" id="bulk-modal-start-date" />
            </div>
            <div class="column">
              <label for="bulk-modal-end-date">Bis:</label>
              <input type="date" id="bulk-modal-end-date" />
            </div>
          </div>
          <div style="margin-bottom: 15px">
            <label for="bulk-modal-special-day-type">Aktion / Typ:</label>
            <select id="bulk-modal-special-day-type">
              <option value="" disabled selected>Aktion auswählen...</option>
              <option value="urlaub">Urlaub buchen</option>
              <option value="krank">Krank buchen</option>
              <option value="schulung">Schulung buchen</option>
              <option value="glaz">GLAZ buchen</option>
              <option value="ezaTag">EZA-Tag buchen</option>
              <option value="delete" style="color: var(--hint-color)">Einträge löschen</option>
            </select>
          </div>
          <button id="apply-bulk-modal-button" class="button" style="margin-top: 10px">Aktion anwenden</button>
        </div>
      </div>

      <!-- Legend Modal -->
      <div id="legend-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">×</button>
          <h3>Legende (Monatsansicht)</h3>
          <ul class="legend-list">
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--special-day-urlaub-bg)"></span><span class="legend-text">Urlaub</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--special-day-krank-bg)"></span><span class="legend-text">Krank</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--special-day-schulung-bg)"></span><span class="legend-text">Schulung</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--special-day-eza-bg)"></span><span class="legend-text">EZA-Tag</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--special-day-glaz-bg)"></span><span class="legend-text">GLAZ</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--positive-value-bg)"></span><span class="legend-text">Positiver Saldo (Arbeitstag)</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--negative-value-bg)"></span><span class="legend-text">Negativer Saldo (Arbeitstag)</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--zero-value-bg)"></span><span class="legend-text">Null-Saldo (Arbeitstag)</span></li>
            <li class="legend-item"><span class="legend-color-dot" style="background-color: var(--holiday-bg)"></span><span class="legend-text">Feiertag</span></li>
            <li class="legend-item"><span class="legend-outline-indicator"></span><span class="legend-text">EZA-Regel bei Buchung aktiv</span></li>
            <li class="legend-item"><span class="moon-mark-calendar" style="font-size: 1.2em; margin-right: 10px; display: inline-block;">🌙</span><span class="legend-text">Nacht-/Randzeit (wenn toleriert)</span></li>
          </ul>
        </div>
      </div>

      <!-- Add/Edit Marker Modal -->
      <div id="add-marker-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">×</button> <!-- Uses generic close handler -->
          <h3 id="add-marker-modal-title">Kontostand-Marker hinzufügen/ändern</h3>
          <div style="margin-bottom: 15px">
            <label for="marker-date">Datum:</label>
            <input type="date" id="marker-date" />
          </div>
          <div style="margin-bottom: 15px">
            <label for="marker-balance">Neuer Kontostand (Std) ab Datum:</label>
            <input type="number" id="marker-balance" step="0.01" placeholder="z.B. 15.75 oder -2.5" />
          </div>
          <button class="button" onclick="saveBalanceMarker()" style="margin-top: 10px">
            Marker speichern
          </button>
        </div>
      </div>


      <!-- Bottom Navigation -->
      <nav id="bottom-nav">
        <a id="nav-main" class="nav-item active">
          <svg viewBox="0 0 24 24"><path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg>
          <span>Rechner</span>
        </a>
        <a id="nav-history" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z"/></svg>
          <span>Verlauf</span>
        </a>
        <a id="nav-month" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg>
          <span>Monat</span>
        </a>
        <a id="nav-stats" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>
          <span>Statistik</span>
        </a>
        <a id="nav-options" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
          <span>Optionen</span>
        </a>
      </nav>
    </div>
  </body>
</html>
