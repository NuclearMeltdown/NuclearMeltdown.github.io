<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#f2f2f7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Arbeitszeitrechner">

  <!-- Icons optimiert -->
  <link rel="apple-touch-icon" href="https://NuclearMeltdown.github.io/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon.png">
  <meta name="application-name" content="Arbeitszeitrechner"/>
  <meta name="msapplication-TileColor" content="#000000" />
  <meta name="msapplication-TileImage" content="https://NuclearMeltdown.github.io/mstile-144x144.png" />
  
  <title>Arbeitszeitrechner</title>

  <script>
    // Globale Variablen
    let kommenZeit = null, gehenZeit = null, currentWeekYear = null, currentWeekNo = null;

    // Hilfsfunktionen
    const $ = id => document.getElementById(id);
    const pad = num => num.toString().padStart(2, "0");
    
    function parseTime(str) {
      if (!str) return null;
      const [hh, mm] = str.split(":").map(Number);
      const now = new Date();
      now.setHours(hh, mm, 0, 0);
      return now;
    }
    
    function formatTime(date) {
      if (!date) return "--:--";
      return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }
    
    function formatDecimalToTime(decimalH) {
      const absVal = Math.abs(decimalH);
      const hh = Math.floor(absVal);
      const mm = Math.round((absVal - hh) * 60);
      return `${decimalH < 0 ? "-" : ""}${hh}:${pad(mm)}`;
    }

    // LocalStorage Funktionen
    function storeToLS(key, value) {
      localStorage.setItem(key, value);
    }
    
    function getFromLS(key, defaultVal = null) {
      const val = localStorage.getItem(key);
      return val !== null ? val : defaultVal;
    }

    // Init beim Laden
    function init() {
      restoreInputsFromLocalStorage();
      const heute = new Date();
      [currentWeekYear, currentWeekNo] = getWeekNumber(heute);
      updateCalculations();
    }
    
    function restoreInputsFromLocalStorage() {
      const storedKommen = getFromLS('kommenZeitValue');
      const storedGehen = getFromLS('gehenZeitValue');
      
      if (storedKommen) {
        $('kommen-display').value = storedKommen;
        kommenZeit = parseTime(storedKommen);
      }
      
      if (storedGehen) {
        $('gehen-display').value = storedGehen;
        gehenZeit = parseTime(storedGehen);
      }
      
      $('pc-buchung').checked = getFromLS('pcBuchungChecked') === 'true';
      $('buero-toggle').checked = getFromLS('bueroChecked') === 'true';
      
      const storedPause = getFromLS('zusatzlichePauseValue');
      if (storedPause) $('zusatzliche-pause').value = storedPause;
      
      const storedWochenAZ = getFromLS('wochenarbeitszeitValue');
      if (storedWochenAZ) $('wochenarbeitszeit').value = storedWochenAZ;
      
      const storedAktKonto = getFromLS('aktuellesKontoValue');
      if (storedAktKonto) $('aktuelles-konto').value = storedAktKonto;
    }
    
    function storeInputsToLocalStorage() {
      storeToLS('kommenZeitValue', $('kommen-display').value);
      storeToLS('gehenZeitValue', $('gehen-display').value);
      storeToLS('pcBuchungChecked', $('pc-buchung').checked ? 'true' : 'false');
      storeToLS('bueroChecked', $('buero-toggle').checked ? 'true' : 'false');
      storeToLS('zusatzlichePauseValue', $('zusatzliche-pause').value);
      storeToLS('wochenarbeitszeitValue', $('wochenarbeitszeit').value);
      storeToLS('aktuellesKontoValue', $('aktuelles-konto').value);
    }

    // Kommen/Gehen Buttons
    function setZeit(type) {
      const now = new Date();
      if (type === 'kommen') {
        kommenZeit = now;
        $('kommen-display').value = formatTime(kommenZeit);
      } else {
        gehenZeit = now;
        $('gehen-display').value = formatTime(gehenZeit);
      }
      storeInputsToLocalStorage();
      updateCalculations();
    }

    // Input-Events
    function onInputChange() {
      kommenZeit = parseTime($('kommen-display').value);
      gehenZeit = parseTime($('gehen-display').value);
      storeInputsToLocalStorage();
      updateCalculations();
    }

    // Arbeitszeit-Berechnungen
    function parseAdditionalPause() {
      const val = $('zusatzliche-pause').value;
      if (!val) return 0;
      const [hh, mm] = val.split(":").map(Number);
      return (hh || 0) + ((mm || 0) / 60);
    }
    
    function getAdjustedKommenZeit() {
      if (!kommenZeit) return null;
      const adjusted = new Date(kommenZeit.getTime());
      if ($('pc-buchung').checked) {
        adjusted.setMinutes(adjusted.getMinutes() - 8);
      }
      return adjusted;
    }
    
    function calculateWorkingTime() {
      const ak = getAdjustedKommenZeit();
      if (!ak || !gehenZeit) return { hours: 0, minutes: 0 };
      
      const diffMs = gehenZeit - ak;
      if (diffMs < 0) return { hours: 0, minutes: 0 };
      
      const hh = Math.floor(diffMs / (1000 * 60 * 60));
      const mm = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
      return { hours: hh, minutes: mm };
    }
    
    function calculateArbeitszeit() {
      const wTime = calculateWorkingTime();
      const totalH = wTime.hours + (wTime.minutes / 60);
      
      let net = totalH;
      for (let i = 0; i < 20; i++) {
        const prev = net;
        let pausen = parseAdditionalPause();
        if (prev > 9) pausen += 0.75;
        else if (prev > 6) pausen += 0.5;
        
        const neu = totalH - pausen;
        if (Math.abs(neu - net) < 1e-9) {
          net = neu;
          break;
        }
        net = neu;
      }
      return net;
    }
    
    function calculatePausenForWorkTime(totalHours) {
      let net = totalHours;
      for (let i = 0; i < 20; i++) {
        const prev = net;
        let pausen = parseAdditionalPause();
        if (prev > 9) pausen += 0.75;
        else if (prev > 6) pausen += 0.5;
        
        const neu = totalHours - pausen;
        if (Math.abs(neu - net) < 1e-9) return pausen;
        net = neu;
      }
      
      // Falls nicht konvergiert
      let pausen = parseAdditionalPause();
      if (net > 9) pausen += 0.75;
      else if (net > 6) pausen += 0.5;
      return pausen;
    }

    // Ausstempeln
    function calculateEndTimeFixpoint(desiredNet) {
      const ak = getAdjustedKommenZeit();
      if (!ak) return "--:--";
      
      let presence = desiredNet;
      for (let i = 0; i < 20; i++) {
        const prev = presence;
        let pausen = parseAdditionalPause();
        if (prev > 9) pausen += 0.75;
        else if (prev > 6) pausen += 0.5;
        
        const presenceNeu = desiredNet + pausen;
        if (Math.abs(presenceNeu - presence) < 1e-9) {
          presence = presenceNeu;
          break;
        }
        presence = presenceNeu;
      }
      
      const endTime = new Date(ak.getTime());
      endTime.setMinutes(endTime.getMinutes() + (presence * 60));
      return formatTime(endTime);
    }
    
    function updateEndTimes() {
      if (!kommenZeit) {
        ['soll', '4h', '6h', '9h', '10h'].forEach(id => {
          $(`end-time-${id}`).value = "";
        });
        return;
      }
      
      [4, 6, 9, 10].forEach(d => {
        $(`end-time-${d}h`).value = calculateEndTimeFixpoint(d);
      });
      
      const wAZ = parseFloat($('wochenarbeitszeit').value) || 38;
      const sollProTag = wAZ / 5;
      const outS = calculateEndTimeFixpoint(sollProTag);
      $('end-time-soll').value = `(${sollProTag.toFixed(2)}h): ${outS}`;
    }

    // UI-Updates
    function updateCalculations() {
      const netArbeitszeit = calculateArbeitszeit();
      const wAZ = parseFloat($('wochenarbeitszeit').value) || 38;
      const sollProTag = wAZ / 5;
      
      let diff = parseFloat((netArbeitszeit - sollProTag).toFixed(2));
      const aktKontoVal = parseFloat($('aktuelles-konto').value) || 0;
      let newKto = parseFloat((aktKontoVal + diff).toFixed(2));
      
      // Anwesenheitszeit
      const wTime = calculateWorkingTime();
      const totalH = wTime.hours + (wTime.minutes / 60);
      
      let pausen = parseAdditionalPause();
      if (netArbeitszeit > 9) pausen += 0.75;
      else if (netArbeitszeit > 6) pausen += 0.5;
      const pausenMin = Math.round(pausen * 60);
      
      // UI-Aktualisierung
      $('anwesend-zeit').value = `${wTime.hours}:${pad(wTime.minutes)} (${totalH.toFixed(2)}h)`;
      $('pausenzeit').value = `${pausenMin} Min`;
      $('arbeitszeit').value = `${formatDecimalToTime(netArbeitszeit)} (${netArbeitszeit.toFixed(2)}h)`;
      $('sollarbeitszeit-display').value = `${formatDecimalToTime(sollProTag)} (${sollProTag.toFixed(2)}h)`;
      
      $('differenz').value = diff.toFixed(2);
      $('differenz-time').value = formatDecimalToTime(diff);
      $('neues-konto').value = newKto.toFixed(2);
      $('neues-konto-time').value = formatDecimalToTime(newKto);
      $('aktuelles-konto-time').value = formatDecimalToTime(aktKontoVal);
      
      // Einf√§rben
      const fields = ['differenz', 'differenz-time', 'neues-konto', 'neues-konto-time'];
      fields.forEach(id => {
        const el = $(id);
        el.classList.remove('positive-value', 'negative-value', 'zero-value');
        
        if (diff > 0) el.classList.add('positive-value');
        else if (diff < 0) el.classList.add('negative-value');
        else el.classList.add('zero-value');
      });
      
      // Hinweis
      let hinweisText = "";
      const ak = getAdjustedKommenZeit();
      const kommenField = $('kommen-display');
      const gehenField = $('gehen-display');
      
      kommenField.classList.remove('invalid-time');
      gehenField.classList.remove('invalid-time');
      
      if (netArbeitszeit < 4 || netArbeitszeit > 10) {
        hinweisText += "Achtung: Arbeitszeit au√üerhalb 4-10h!<br>";
      }
      
      if (ak) {
        const kStunde = ak.getHours() + (ak.getMinutes() / 60);
        if (kStunde < 6 || kStunde > 16) {
          hinweisText += "Achtung: Kommen vor 06:00 oder nach 16:00!<br>";
          kommenField.classList.add('invalid-time');
        }
        if (netArbeitszeit >= 4 && kStunde > 16) {
          hinweisText += "Achtung: 4h-Mindestzeit => Kommen nicht nach 16:00!<br>";
          kommenField.classList.add('invalid-time');
        }
      }
      
      if (gehenZeit) {
        const gStunde = gehenZeit.getHours() + (gehenZeit.getMinutes() / 60);
        if (gStunde > 20) {
          hinweisText += "Achtung: Gehen nach 20:00!<br>";
          gehenField.classList.add('invalid-time');
        }
      }
      
      const hinweis = $('hinweis');
      hinweis.innerHTML = hinweisText;
      hinweis.style.display = hinweisText ? 'block' : 'none';
      
      updateEndTimes();
    }

    // Tag speichern
    function checkViolations(kommenDate, gehenDate, arbeitszeit) {
      const kommenStunde = kommenDate.getHours() + (kommenDate.getMinutes() / 60);
      const gehenStunde = gehenDate.getHours() + (gehenDate.getMinutes() / 60);
      return (kommenStunde < 6 || kommenStunde > 16 || gehenStunde > 20 || arbeitszeit < 4);
    }
    
    function saveDay() {
      updateCalculations();
      
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0=So,6=Sa
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        alert("Samstag und Sonntag sind nicht zul√§ssig!");
        return;
      }
      
      const adjustedKommen = getAdjustedKommenZeit();
      if (adjustedKommen && gehenZeit) {
        const diffMs = gehenZeit - adjustedKommen;
        if (diffMs < 0) {
          alert("Gehen vor Kommen!");
          return;
        }
        
        const hourMs = 3600000;
        const totalH = Math.floor(diffMs / hourMs) + ((Math.floor(diffMs % hourMs / (1000 * 60))) / 60);
        const pausen = calculatePausenForWorkTime(totalH);
        const net = totalH - pausen;
        
        if (checkViolations(adjustedKommen, gehenZeit, net)) {
          if (!confirm("Versto√ü gegen Gleitzeit. Trotzdem speichern?")) {
            return;
          }
        }
      }
      
      const diffVal = parseFloat($('differenz').value) || 0;
      const diffTime = $('differenz-time').value || "0:00";
      const newVal = parseFloat($('neues-konto').value) || 0;
      
      const datum = today.toISOString().split('T')[0];
      const kommenStr = adjustedKommen ? adjustedKommen.toISOString() : null;
      const gehenStr = gehenZeit ? gehenZeit.toISOString() : null;
      const isBuero = $('buero-toggle').checked;
      
      let history = JSON.parse(getFromLS('history', '[]'));
      const displayDate = (new Date(datum)).toLocaleDateString('de-DE');
      const existingIndex = history.findIndex(e => e.datum === datum);
      
      const dayData = {
        datum: datum,
        differenz: diffVal.toFixed(2),
        differenzTime: diffTime,
        stundenkonto: newVal.toFixed(2),
        kommen: kommenStr,
        gehen: gehenStr,
        urlaub: false,
        krank: false,
        schulung: false,
        pcBuchung: $('pc-buchung').checked,
        buero: isBuero
      };
      
      if (existingIndex !== -1) {
        if (!confirm(`F√ºr den Tag ${displayDate} existiert bereits ein Eintrag. Ersetzen?`)) {
          return;
        }
        history[existingIndex] = dayData;
      } else {
        history.push(dayData);
      }
      
      storeToLS('history', JSON.stringify(history));
      $('aktuelles-konto').value = newVal.toFixed(2);
      storeToLS('aktuellesStundenkonto', newVal.toFixed(2));
      
      storeInputsToLocalStorage();
      updateCalculations();
      alert("Der Tag wurde gespeichert.");
    }

    // KW-Funktionen
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return [d.getUTCFullYear(), weekNo];
    }
    
    function getDateOfISOWeek(w, y) {
      const simple = new Date(Date.UTC(y, 0, 4 + (w - 1) * 7));
      const dow = simple.getDay();
      const ISOweekStart = new Date(simple);
      ISOweekStart.setDate(simple.getDate() - ((dow + 6) % 7));
      return ISOweekStart;
    }

    // Verlauf-Funktionen
    function showHistory() {
      $('main-page').style.display = 'none';
      $('history-page').style.display = 'block';
      loadHistory();
    }
    
    function showMainPage() {
      $('history-page').style.display = 'none';
      $('main-page').style.display = 'block';
    }
    
    function calcArbeitszeitFromEntry(entry) {
      if (!entry.kommen || !entry.gehen) return 0;
      const k = new Date(entry.kommen);
      const g = new Date(entry.gehen);
      const diffMs = g - k;
      if (diffMs < 0) return 0;
      
      const hourMs = 3600000;
      const hh = Math.floor(diffMs / hourMs);
      const mm = Math.floor((diffMs % hourMs) / (1000 * 60));
      const total = hh + (mm / 60);
      
      let net = total;
      for (let i = 0; i < 20; i++) {
        const prev = net;
        let pausen = parseAdditionalPause();
        if (prev > 9) pausen += 0.75;
        else if (prev > 6) pausen += 0.5;
        
        const neu = total - pausen;
        if (Math.abs(neu - net) < 1e-9) {
          net = neu;
          break;
        }
        net = neu;
      }
      return net;
    }
    
    function checkEntryViolationsForHistory(entry) {
      if (!entry.kommen || !entry.gehen) return false;
      const k = new Date(entry.kommen);
      const g = new Date(entry.gehen);
      const net = calcArbeitszeitFromEntry(entry);
      return checkViolations(k, g, net);
    }
    
    function deleteEntryByDate(dateStr) {
      let history = JSON.parse(getFromLS('history', '[]'));
      const index = history.findIndex(e => e.datum === dateStr);
      if (index !== -1) {
        const displayDate = (new Date(dateStr)).toLocaleDateString('de-DE');
        if (confirm(`M√∂chten Sie den Eintrag f√ºr ${displayDate} wirklich l√∂schen?`)) {
          history.splice(index, 1);
          storeToLS('history', JSON.stringify(history));
          loadHistory();
        }
      }
    }
    
    function loadHistory() {
      const historyList = $('history-list');
      historyList.innerHTML = '';
      
      let history = JSON.parse(getFromLS('history', '[]'));
      
      const weekStartDate = getDateOfISOWeek(currentWeekNo, currentWeekYear);
      const weekEndDate = new Date(weekStartDate);
      weekEndDate.setDate(weekStartDate.getDate() + 4);
      const weekRange = `${weekStartDate.toLocaleDateString('de-DE')} - ${weekEndDate.toLocaleDateString('de-DE')}`;
      
      $('week-info').textContent = `KW ${currentWeekNo} (${weekRange})`;
      
      const weekdays = [1, 2, 3, 4, 5];
      const weekdayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
      
      let totalDiff = 0;
      
      weekdays.forEach((wd, idx) => {
        const entry = history.find(e => {
          const d = new Date(e.datum);
          const [y2, w2] = getWeekNumber(d);
          return y2 === currentWeekYear && w2 === currentWeekNo && d.getDay() === wd;
        });
        
        const li = document.createElement('li');
        li.classList.add('history-item');
        
        if (entry) {
          let locationEmoji = entry.buero ? "üè¢" : "üè†";
          let bgColor, textColor, content;
          
          if (entry.urlaub || entry.krank || entry.schulung) {
            bgColor = entry.krank ? "#ffd900" : "#30d158";
            textColor = "#000";
            content = `
              <div class="history-entry" style="flex:1; background-color:${bgColor};color:${textColor};border-radius:8px;padding:5px;">
                <div><strong>${weekdayNames[idx]}</strong> (${(new Date(entry.datum)).toLocaleDateString('de-DE')})</div>
                <div>${entry.urlaub ? "Urlaub" : (entry.krank ? "Krank" : "Schulung")} ${locationEmoji}</div>
              </div>
            `;
          } else {
            const diffVal = parseFloat(entry.differenz) || 0;
            totalDiff += diffVal;
            const diffClass = diffVal > 0 ? "positive-value" : (diffVal < 0 ? "negative-value" : "zero-value");
            const dispDate = (new Date(entry.datum)).toLocaleDateString('de-DE');
            const viol = checkEntryViolationsForHistory(entry);
            
            let style = "flex:1;";
            if (viol) {
              style += "background-color:#ff3b30;color:#fff;border-radius:8px;padding:5px;";
            }
            const violMarks = viol ? " !!!" : "";
            const diffSpan = viol ? "" : diffClass;
            
            content = `
              <div class="history-entry" style="${style}">
                <div><strong>${weekdayNames[idx]}</strong> (${dispDate})</div>
                <div>Differenz: <span class="${diffSpan}">${entry.differenz}h (${entry.differenzTime})${violMarks} ${locationEmoji}</span></div>
              </div>
            `;
          }
          
          li.innerHTML = `
            ${content}
            <div style="display:flex;align-items:center;justify-content:flex-end;gap:5px;">
              <button class="inline-button" onclick="showDayDetails('${entry.datum}')">Details</button>
              <button class="delete-button" onclick="deleteEntryByDate('${entry.datum}')">L√∂schen</button>
            </div>
          `;
        } else {
          // Kein Eintrag
          li.innerHTML = `
            <div class="history-entry" style="flex:1;">
              <div><strong>${weekdayNames[idx]}</strong></div>
              <div>Keine Daten vorhanden</div>
            </div>
            <div style="display:flex;align-items:center;justify-content:flex-end;gap:5px;">
              <button class="inline-button" onclick="showAddDayModal(${wd},${idx})">Manuelle Buchung</button>
            </div>
          `;
        }
        historyList.appendChild(li);
      });
      
      const diffClass = totalDiff > 0 ? "positive-value" : (totalDiff < 0 ? "negative-value" : "zero-value");
      $('weekly-summary').innerHTML = `
        <h3>W√∂chentliche Zusammenfassung</h3>
        <p>Gesamte Differenz:
           <span class="${diffClass}">${totalDiff.toFixed(2)}h (${formatDecimalToTime(totalDiff)})</span>
        </p>
      `;
      
      updateWeekNavigation();
    }
    
    function updateWeekNavigation() {
      const pagination = $('pagination');
      pagination.innerHTML = '';
      
      const navContainer = document.createElement('div');
      navContainer.classList.add('nav-container');
      
      // Year Navigation
      const prevYearBtn = document.createElement('button');
      prevYearBtn.textContent = '¬´';
      prevYearBtn.onclick = () => {
        currentWeekYear--;
        loadHistory();
      };
      
      // Week Navigation
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '‚Äπ';
      prevBtn.onclick = () => {
        const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
        d.setDate(d.getDate() - 7);
        [currentWeekYear, currentWeekNo] = getWeekNumber(d);
        loadHistory();
      };
      
      // Week Select
      const weekSelect = document.createElement('select');
      weekSelect.id = 'week-select';
      for (let i = 1; i <= 53; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        const st = getDateOfISOWeek(i, currentWeekYear);
        opt.textContent = `KW ${i} (${st.toLocaleDateString('de-DE')})`;
        if (i === currentWeekNo) {
          opt.selected = true;
        }
        weekSelect.appendChild(opt);
      }
      weekSelect.onchange = () => {
        currentWeekNo = parseInt(weekSelect.value);
        loadHistory();
      };
      
      // Next buttons
      const nextBtn = document.createElement('button');
      nextBtn.textContent = '‚Ä∫';
      nextBtn.onclick = () => {
        const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
        d.setDate(d.getDate() + 7);
        [currentWeekYear, currentWeekNo] = getWeekNumber(d);
        loadHistory();
      };
      
      const nextYearBtn = document.createElement('button');
      nextYearBtn.textContent = '¬ª';
      nextYearBtn.onclick = () => {
        currentWeekYear++;
        loadHistory();
      };
      
      [prevYearBtn, prevBtn, weekSelect, nextBtn, nextYearBtn].forEach(el => navContainer.appendChild(el));
      pagination.appendChild(navContainer);
    }

    // Manuelle Buchung
    function showAddDayModal(weekday, index) {
      const dateVal = new Date(getDateOfISOWeek(currentWeekNo, currentWeekYear));
      dateVal.setDate(dateVal.getDate() + (weekday - 1));
      const displayDate = dateVal.toLocaleDateString('de-DE');
      
      $('add-day-modal-title').textContent = `Manuelle Buchung f√ºr ${displayDate}`;
      $('add-day-kommen').value = "";
      $('add-day-gehen').value = "";
      $('pc-buchung-add-day').checked = false;
      $('buero-add-day').checked = false;
      
      $('urlaub-toggle').checked = false;
      $('krank-toggle').checked = false;
      $('schulung-toggle').checked = false;
      
      $('add-day-modal').setAttribute('data-date', dateVal.toISOString().split('T')[0]);
      $('add-day-modal').style.display = 'block';
    }
    
    function toggleSpecialDay(type) {
      const types = ['urlaub', 'krank', 'schulung'];
      types.forEach(t => {
        if (t !== type) $(t + '-toggle').checked = false;
      });
    }
    
    function addManualDay() {
      const dateVal = $('add-day-modal').getAttribute('data-date');
      if (!dateVal) {
        alert("Kein g√ºltiges Datum f√ºr die Buchung!");
        return;
      }
      
      const realDate = new Date(dateVal);
      const dayOfWeek = realDate.getDay();
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        alert("Samstag und Sonntag sind nicht zul√§ssig!");
        return;
      }
      
      const isUrlaub = $('urlaub-toggle').checked;
      const isKrank = $('krank-toggle').checked;
      const isSchulung = $('schulung-toggle').checked;
      const isBueroAddDay = $('buero-add-day').checked;
      
      let history = JSON.parse(getFromLS('history', '[]'));
      const existingIndex = history.findIndex(e => e.datum === dateVal);
      const displayDate = (new Date(dateVal)).toLocaleDateString('de-DE');
      
      // Urlaub / Krank / Schulung => Zeit ignorieren
      if (isUrlaub || isKrank || isSchulung) {
        const aktKto = parseFloat($('aktuelles-konto').value) || 0;
        let label = isUrlaub ? "Urlaub" : (isKrank ? "Krank" : "Schulung");
        
        const dayData = {
          datum: dateVal,
          differenz: "0.00",
          differenzTime: "0:00",
          stundenkonto: aktKto.toFixed(2),
          kommen: null,
          gehen: null,
          urlaub: isUrlaub,
          krank: isKrank,
          schulung: isSchulung,
          pcBuchung: false,
          buero: isBueroAddDay
        };
        
        if (existingIndex !== -1) {
          if (!confirm(`F√ºr den Tag ${displayDate} existiert bereits ein Eintrag. Ersetzen?`)) {
            return;
          }
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }
        
        storeToLS('history', JSON.stringify(history));
        storeToLS('aktuellesStundenkonto', aktKto.toFixed(2));
        updateCalculations();
        closeAddDayModal();
        loadHistory();
        alert(`${label} eingetragen.`);
        return;
      }
      
      // Normale Buchung
      const kommenVal = $('add-day-kommen').value;
      const gehenVal = $('add-day-gehen').value;
      
      if (!kommenVal || !gehenVal) {
        alert("Bitte Kommen- und Gehen-Zeit angeben oder Urlaub/Krank/Schulung w√§hlen!");
        return;
      }
      
      const isPcBuchungAddDay = $('pc-buchung-add-day').checked;
      const wAZ = parseFloat($('wochenarbeitszeit').value) || 38;
      const sollProTag = wAZ / 5;
      const aktKto = parseFloat($('aktuelles-konto').value) || 0;
      
      const kommenDate = parseTime(kommenVal);
      const gehenDate = parseTime(gehenVal);
      
      if (!kommenDate || !gehenDate) {
        alert("Ung√ºltige Zeiten!");
        return;
      }
      
      if (gehenDate < kommenDate) {
        alert("Gehen-Zeit liegt vor Kommen-Zeit!");
        return;
      }
      
      const diffMs = gehenDate - kommenDate;
      const hourMs = 3600000;
      const totalH = Math.floor(diffMs / hourMs) + ((Math.floor(diffMs % hourMs / (1000 * 60))) / 60);
      
      let adjustedKommen = new Date(kommenDate.getTime());
      if (isPcBuchungAddDay) {
        adjustedKommen.setMinutes(adjustedKommen.getMinutes() - 8);
      }
      
      // Fixpunkt Netto
      let net = totalH;
      for (let i = 0; i < 20; i++) {
        const prev = net;
        let pausen = parseAdditionalPause();
        if (prev > 9) pausen += 0.75;
        else if (prev > 6) pausen += 0.5;
        
        const neu = totalH - pausen;
        if (Math.abs(neu - net) < 1e-9) {
          net = neu;
          break;
        }
        net = neu;
      }
      
      // Gleitzeit check
      if (checkViolations(adjustedKommen, gehenDate, net)) {
        if (!confirm("Versto√ü gegen Gleitzeitregeln. Trotzdem speichern?")) {
          return;
        }
      }
      
      let diffVal = parseFloat((net - sollProTag).toFixed(2));
      let newKto = parseFloat((aktKto + diffVal).toFixed(2));
      const diffTime = formatDecimalToTime(diffVal);
      
      const dayData = {
        datum: dateVal,
        differenz: diffVal.toFixed(2),
        differenzTime: diffTime,
        stundenkonto: newKto.toFixed(2),
        kommen: adjustedKommen.toISOString(),
        gehen: gehenDate.toISOString(),
        urlaub: false,
        krank: false,
        schulung: false,
        pcBuchung: isPcBuchungAddDay,
        buero: isBueroAddDay
      };
      
      if (existingIndex !== -1) {
        if (!confirm(`F√ºr den Tag ${displayDate} existiert bereits ein Eintrag. Ersetzen?`)) {
          return;
        }
        history[existingIndex] = dayData;
      } else {
        history.push(dayData);
      }
      
      storeToLS('history', JSON.stringify(history));
      $('aktuelles-konto').value = newKto.toFixed(2);
      storeToLS('aktuellesStundenkonto', newKto.toFixed(2));
      
      updateCalculations();
      closeAddDayModal();
      loadHistory();
      alert("Der Tag wurde nachgetragen.");
    }
    
    function closeAddDayModal() {
      $('add-day-modal').style.display = 'none';
    }

    // Detail-Anzeige
    function showDayDetails(dateStr) {
      const history = JSON.parse(getFromLS('history', '[]'));
      const entry = history.find(e => e.datum === dateStr);
      if (!entry) return;
      
      const dispDate = (new Date(dateStr)).toLocaleDateString('de-DE');
      const pcSwitch = $('detail-pc-buchung');
      pcSwitch.checked = !!entry.pcBuchung;
      pcSwitch.disabled = true;
      
      let pausenLabel = "--";
      
      if (entry.urlaub || entry.krank || entry.schulung) {
        const statusText = entry.urlaub ? "Urlaub" : (entry.krank ? "Krank" : "Schulung");
        $('detail-date').textContent = dispDate;
        $('detail-kommen').textContent = "--:--";
        $('detail-gehen').textContent = "--:--";
        $('detail-differenz').textContent = statusText;
        pausenLabel = "n/a";
      } else {
        const kommen = entry.kommen ? new Date(entry.kommen) : null;
        const gehen = entry.gehen ? new Date(entry.gehen) : null;
        
        $('detail-date').textContent = dispDate;
        $('detail-kommen').textContent = kommen ? formatTime(kommen) : "--:--";
        $('detail-gehen').textContent = gehen ? formatTime(gehen) : "--:--";
        $('detail-differenz').textContent = `${entry.differenz}h (${entry.differenzTime})`;
        
        if (kommen && gehen) {
          const diffMs = gehen - kommen;
          if (diffMs >= 0) {
            const hourMs = 3600000;
            const totH = Math.floor(diffMs / hourMs) + ((Math.floor(diffMs % hourMs / (1000 * 60))) / 60);
            const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
            const sollTag = wAZ / 5;
            const net = parseFloat(entry.differenz) || 0;
            const realNet = net + sollTag;
            const pausenVal = totH - realNet;
            
            pausenLabel = pausenVal > 0 ? `${Math.round(pausenVal * 60)} Min` : "0 Min";
          }
        }
      }
      
      $('detail-pausen').textContent = pausenLabel;
      $('detail-modal').style.display = 'block';
    }
    
    function closeDetailModal() {
      $('detail-modal').style.display = 'none';
    }
  </script>

  <style>
    :root {
      --background-color: #f2f2f7;
      --text-color: #000000;
      --card-background-color: #ffffff;
      --input-background-color: #ffffff;
      --input-border-color: #c7c7cc;
      --button-background-color: #007aff;
      --button-text-color: #ffffff;
      --hint-color: #ff3b30;
      --positive-background-color: #007aff;
      --negative-background-color: #ff9500;
      --zero-background-color: #34c759;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #000000;
        --text-color: #ffffff;
        --card-background-color: #1c1c1e;
        --input-background-color: #2c2c2e;
        --input-border-color: #3a3a3c;
        --button-background-color: #0a84ff;
        --hint-color: #ff453a;
      }
    }

    html, body {
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0; padding: 0;
      font-family: -apple-system, system-ui, sans-serif;
    }
    
    body::before, body::after {
      content: "";
      position: fixed;
      left: 0; right: 0;
      background-color: var(--background-color);
    }
    
    body::before {
      top: 0;
      height: env(safe-area-inset-top);
    }
    
    body::after {
      bottom: 0;
      height: env(safe-area-inset-bottom);
    }

    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    
    h1, h2, h3 {
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    h1 { font-size: 28px; }
    h2 { font-size: 24px; }
    h3 { font-size: 20px; margin-bottom: 10px; }
    
    .section { margin-bottom: 30px; }

    .button, .inline-button, .delete-button {
      background-color: var(--button-background-color);
      color: var(--button-text-color);
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      box-sizing: border-box;
      line-height: 1.2em;
    }
    
    .button {
      width: 100%;
      padding: 15px;
      font-size: 17px;
      margin-bottom: 10px;
      height: 56px;
    }
    
    .inline-button, .delete-button {
      font-size: 15px;
      padding: 10px 15px;
    }
    
    .delete-button {
      background-color: var(--hint-color);
    }
    
    .button:active, .inline-button:active {
      opacity: 0.8;
    }

    input, select {
      width: 100%;
      padding: 15px;
      font-size: 17px;
      border: none;
      border-radius: 12px;
      margin-bottom: 10px;
      background-color: var(--input-background-color);
      color: var(--text-color);
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      line-height: 1.2em;
      height: 56px;
    }
    
    input:read-only {
      border: none;
    }
    
    input[type=time]::-webkit-calendar-picker-indicator {
      display: none;
    }

    #hinweis {
      color: var(--hint-color);
      font-weight: 600;
      font-size: 15px;
      display: none;
      margin-top: 10px;
    }

    ul {
      list-style-type: none;
      padding-left: 0;
      margin: 0;
    }
    
    li {
      font-size: 17px;
      padding: 5px 0;
      border-bottom: 1px solid var(--input-border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .history-item { min-height: 70px; }
    .history-entry { flex: 1; margin-right: 10px; }
    p { font-size: 17px; margin: 5px 0; }

    .positive-value,
    .negative-value,
    .zero-value {
      padding: 2px 4px;
      border-radius: 5px;
      color: #fff !important;
    }
    
    .positive-value { background-color: var(--positive-background-color) !important; }
    .negative-value { background-color: var(--negative-background-color) !important; }
    .zero-value { background-color: var(--zero-background-color) !important; }
    
    .invalid-time {
      background-color: var(--hint-color) !important;
      color: #fff !important;
    }

    #history-page { display: none; }
    
    .nav-button {
      width: auto;
      padding: 10px 20px;
      margin-bottom: 20px;
    }
    
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .column {
      flex: 1;
      margin-right: 10px;
      display: flex;
      flex-direction: column;
    }
    
    .column:last-child { margin-right: 0; }

    #pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    
    #pagination .nav-container {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    
    #pagination button,
    #pagination select {
      background-color: var(--button-background-color);
      color: var(--button-text-color);
      border: none;
      border-radius: 12px;
      padding: 12px;
      margin: 5px;
      cursor: pointer;
      font-size: 16px;
      height: auto;
    }
    
    #pagination select {
      width: auto;
      max-width: 200px;
      flex: 1;
    }

    .switch-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
      margin-right: 10px;
    }
    
    .switch input { opacity: 0; width: 0; height: 0; }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 14px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px; width: 22px;
      left: 3px; top: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--button-background-color);
    }
    
    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: var(--card-background-color);
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
      margin: 50px auto;
      color: var(--text-color);
      box-sizing: border-box;
    }
    
    .close-button {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 20px;
      font-weight: bold;
      float: right;
      cursor: pointer;
    }
  </style>
</head>
<body onload="init()">
  <div id="main-page">
    <div class="container">
      <h1>Arbeitszeitrechner</h1>
      <button class="button nav-button" onclick="showHistory()">Verlauf anzeigen</button>

      <!-- Kommen / Gehen + PC + B√ºro -->
      <div class="section">
        <div class="row">
          <div class="column">
            <input type="time" id="kommen-display" oninput="onInputChange()">
          </div>
          <div class="column">
            <button class="button" onclick="setZeit('kommen')">Kommen (Jetzt)</button>
          </div>
        </div>

        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="pc-buchung" onchange="onInputChange()">
            <span class="slider"></span>
          </label>
          <span>PC-Buchung</span>

          <label class="switch" style="margin-left:15px;">
            <input type="checkbox" id="buero-toggle" onchange="onInputChange()">
            <span class="slider"></span>
          </label>
          <span>B√ºro</span>
        </div>

        <div class="row">
          <div class="column">
            <input type="time" id="gehen-display" oninput="onInputChange()">
          </div>
          <div class="column">
            <button class="button" onclick="setZeit('gehen')">Gehen (Jetzt)</button>
          </div>
        </div>
        <p id="hinweis"></p>
      </div>

      <!-- Wochenarbeitszeit + Zusatzpause -->
      <div class="section">
        <div class="row">
          <div class="column">
            <label for="wochenarbeitszeit">Wochenarbeitszeit (Std.):</label>
            <input type="number" id="wochenarbeitszeit" value="38" onchange="onInputChange()">
          </div>
          <div class="column">
            <label for="zusatzliche-pause">Zus. Pausen (z.B. 0:15):</label>
            <input type="text" id="zusatzliche-pause" onchange="onInputChange()">
          </div>
        </div>
      </div>

      <!-- Zeiten√ºbersicht -->
      <div class="section">
        <h3>Zeiten√ºbersicht</h3>
        <div class="row">
          <div class="column">
            <label>Anwesenheitszeit:</label>
            <input type="text" id="anwesend-zeit" readonly>
          </div>
          <div class="column">
            <label>Pausen:</label>
            <input type="text" id="pausenzeit" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>Arbeitszeit:</label>
            <input type="text" id="arbeitszeit" readonly>
          </div>
          <div class="column">
            <label>Sollarbeitszeit:</label>
            <input type="text" id="sollarbeitszeit-display" readonly>
          </div>
        </div>
      </div>

      <!-- Stundenkonto -->
      <div class="section">
        <h3>Stundenkonto</h3>
        <div class="row">
          <div class="column">
            <label>Aktuelles Stundenkonto:</label>
            <input type="number" id="aktuelles-konto" value="0" onchange="onInputChange()">
          </div>
          <div class="column">
            <label>In Zeit:</label>
            <input type="text" id="aktuelles-konto-time" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>Differenz:</label>
            <input type="text" id="differenz" readonly>
          </div>
          <div class="column">
            <label>In Zeit:</label>
            <input type="text" id="differenz-time" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>Neues Stundenkonto:</label>
            <input type="text" id="neues-konto" readonly>
          </div>
          <div class="column">
            <label>In Zeit:</label>
            <input type="text" id="neues-konto-time" readonly>
          </div>
        </div>
        <button class="button" onclick="saveDay()">Tag speichern</button>
      </div>

      <!-- Ausstempelzeiten -->
      <div class="section">
        <h3>Berechnete Ausstempelzeiten (inkl. Pausen):</h3>
        <div class="row">
          <div class="column">
            <label>Sollarbeitszeit:</label>
            <input type="text" id="end-time-soll" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>4h:</label>
            <input type="text" id="end-time-4h" readonly>
          </div>
          <div class="column">
            <label>6h:</label>
            <input type="text" id="end-time-6h" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>9h:</label>
            <input type="text" id="end-time-9h" readonly>
          </div>
          <div class="column">
            <label>10h:</label>
            <input type="text" id="end-time-10h" readonly>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div id="history-page">
    <div class="container">
      <h1>Verlauf</h1>
      <button class="button nav-button" onclick="showMainPage()">Zur√ºck</button>
      <h2 id="week-info"></h2>
      <ul id="history-list"></ul>
      <div id="weekly-summary"></div>
      <div id="pagination"></div>
    </div>
  </div>

  <!-- Detail-Modal -->
  <div id="detail-modal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="closeDetailModal()">√ó</button>
      <h3>Details f√ºr <span id="detail-date"></span></h3>
      <p>Kommen: <span id="detail-kommen"></span></p>
      <p>Gehen: <span id="detail-gehen"></span></p>
      <p>Differenz: <span id="detail-differenz"></span></p>

      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="detail-pc-buchung">
          <span class="slider"></span>
        </label>
        <span>PC-Buchung (readonly)</span>
      </div>
      <p>Pausen: <span id="detail-pausen"></span></p>
    </div>
  </div>

  <!-- Add Day Modal -->
  <div id="add-day-modal" class="modal" data-date="">
    <div class="modal-content">
      <button class="close-button" onclick="closeAddDayModal()">√ó</button>
      <h3 id="add-day-modal-title">Manuelle Buchung</h3>
      <div class="row">
        <div class="column">
          <label for="add-day-kommen">Kommen:</label>
          <input type="time" id="add-day-kommen">
        </div>
        <div class="column">
          <label for="add-day-gehen">Gehen:</label>
          <input type="time" id="add-day-gehen">
        </div>
      </div>

      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="pc-buchung-add-day">
          <span class="slider"></span>
        </label>
        <span>PC-Buchung</span>
      </div>

      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="buero-add-day">
          <span class="slider"></span>
        </label>
        <span>B√ºro</span>
      </div>

      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="urlaub-toggle" onchange="toggleSpecialDay('urlaub')">
          <span class="slider"></span>
        </label>
        <span>Urlaub</span>
      </div>
      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="krank-toggle" onchange="toggleSpecialDay('krank')">
          <span class="slider"></span>
        </label>
        <span>Krank</span>
      </div>
      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="schulung-toggle" onchange="toggleSpecialDay('schulung')">
          <span class="slider"></span>
        </label>
        <span>Schulung</span>
      </div>

      <button class="button" onclick="addManualDay()">Speichern</button>
    </div>
  </div>
</body>
</html>
