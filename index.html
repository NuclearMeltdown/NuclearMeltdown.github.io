<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta
      name="theme-color"
      content="#f2f2f7"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#000000"
      media="(prefers-color-scheme: dark)"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="default"
    />
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit" />
    <link
      rel="apple-touch-icon"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="apple-touch-startup-image"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://NuclearMeltdown.github.io/favicon.png"
    />
    <meta name="application-name" content="Arbeitszeitrechner" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="msapplication-TileImage"
      content="https://NuclearMeltdown.github.io/mstile-144x144.png"
    />

    <title>Arbeitszeitrechner</title>

    <script>
      // Globale Variablen
      let kommenZeit = null,
        gehenZeit = null;
      let currentWeekYear = null,
        currentWeekNo = null;
      let currentMonthYear = null,
        currentMonth = null;
      let currentView = "main"; // main, history, month, stats

      // Hilfsfunktionen
      const $ = (id) => document.getElementById(id);
      const pad = (num) => num.toString().padStart(2, "0");

      function parseTime(str) {
        if (!str) return null;
        const match = str.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        const now = new Date();
        now.setHours(hh, mm, 0, 0);
        return now;
      }

      function formatTime(date) {
        if (!date || isNaN(date.getTime())) return "--:--";
        const hours = date.getHours();
        const minutes = date.getMinutes();
        return `${pad(hours)}:${pad(minutes)}`;
      }

      function formatDecimalToTime(decimalH) {
        if (isNaN(decimalH)) return "0:00";
        const absVal = Math.abs(decimalH);
        const hh = Math.floor(absVal);
        const mm = Math.round((absVal - hh) * 60);
        return `${decimalH < 0 ? "-" : ""}${hh}:${pad(mm)}`;
      }

      function storeToLS(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.error("Error saving to localStorage", e);
          alert(
            "Fehler beim Speichern der Daten. M√∂glicherweise ist der Speicher voll."
          );
        }
      }

      function getFromLS(key, defaultVal = null) {
        try {
          const val = localStorage.getItem(key);
          return val !== null ? val : defaultVal;
        } catch (e) {
          console.error("Error reading from localStorage", e);
          return defaultVal;
        }
      }

      function getHistory() {
        const history = JSON.parse(getFromLS("history", "[]"));
        history.forEach((entry) => {
          entry.dateObj = new Date(entry.datum + "T00:00:00");
        });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj);
        return history;
      }

      function init() {
        restoreInputsFromLocalStorage();
        const heute = new Date();
        [currentWeekYear, currentWeekNo] = getWeekNumber(heute);
        currentMonthYear = heute.getFullYear();
        currentMonth = heute.getMonth();

        const lastKonto = getFromLS("aktuellesStundenkonto");
        if (lastKonto) {
          $("aktuelles-konto").value = parseFloat(lastKonto).toFixed(2);
        } else {
          const history = getHistory();
          if (history.length > 0) {
            const lastEntry = history[history.length - 1];
            if (lastEntry.stundenkonto) {
              $("aktuelles-konto").value = parseFloat(
                lastEntry.stundenkonto
              ).toFixed(2);
              storeToLS("aktuellesStundenkonto", lastEntry.stundenkonto);
            }
          }
        }

        updateCalculations();
        switchView("main");
        setupEventListeners();
        closeAddDayModal();
        closeDetailModal();
      }

      function setupEventListeners() {
        $("nav-main").addEventListener("click", () => switchView("main"));
        $("nav-history").addEventListener("click", () => switchView("history"));
        $("nav-month").addEventListener("click", () => switchView("month"));
        $("nav-stats").addEventListener("click", () => switchView("stats"));

        $("kommen-display").oninput = onInputChange;
        $("gehen-display").oninput = onInputChange;
        $("pc-buchung").onchange = onInputChange;
        $("buero-toggle").onchange = onInputChange;
        $("wochenarbeitszeit").onchange = onInputChange;
        $("zusatzliche-pause").oninput = onInputChange;
        $("aktuelles-konto").onchange = onInputChange;

        document.querySelectorAll(".close-button").forEach((btn) => {
          btn.onclick = () => (btn.closest(".modal").style.display = "none");
        });

        $("stats-period").onchange = () => calculateAndDisplayStats();

        $("export-button").addEventListener("click", exportHistoryToJson);
        $("import-button").addEventListener("click", importHistoryFromJson);
      }

      function restoreInputsFromLocalStorage() {
        const storedKommen = getFromLS("kommenZeitValue");
        const storedGehen = getFromLS("gehenZeitValue");
        if (storedKommen) {
          $("kommen-display").value = storedKommen;
          kommenZeit = parseTime(storedKommen);
        }
        if (storedGehen) {
          $("gehen-display").value = storedGehen;
          gehenZeit = parseTime(storedGehen);
        }
        $("pc-buchung").checked = getFromLS("pcBuchungChecked") === "true";
        $("buero-toggle").checked = getFromLS("bueroChecked") === "true";
        const storedPause = getFromLS("zusatzlichePauseValue");
        if (storedPause) $("zusatzliche-pause").value = storedPause;
        const storedWochenAZ = getFromLS("wochenarbeitszeitValue");
        if (storedWochenAZ) $("wochenarbeitszeit").value = storedWochenAZ;
      }

      function storeInputsToLocalStorage() {
        storeToLS("kommenZeitValue", $("kommen-display").value);
        storeToLS("gehenZeitValue", $("gehen-display").value);
        storeToLS("pcBuchungChecked", $("pc-buchung").checked ? "true" : "false");
        storeToLS("bueroChecked", $("buero-toggle").checked ? "true" : "false");
        storeToLS("zusatzlichePauseValue", $("zusatzliche-pause").value);
        storeToLS("wochenarbeitszeitValue", $("wochenarbeitszeit").value);
        storeToLS("aktuellesStundenkonto", $("aktuelles-konto").value);
      }

      function setZeit(type) {
        const now = new Date();
        if (type === "kommen") {
          kommenZeit = now;
          $("kommen-display").value = formatTime(kommenZeit);
        } else {
          gehenZeit = now;
          $("gehen-display").value = formatTime(gehenZeit);
        }
        storeInputsToLocalStorage();
        updateCalculations();
      }

      function onInputChange() {
        kommenZeit = parseTime($("kommen-display").value);
        gehenZeit = parseTime($("gehen-display").value);
        storeInputsToLocalStorage();
        updateCalculations();
      }

      // --- HILFSFUNKTION: Parse Pausen-Input von Hauptseite ---
      function parseAdditionalPause() {
        const val = $("zusatzliche-pause").value;
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          return hh + mm / 60;
        } else {
          const decimalHours = parseFloat(cleanedVal);
          return isNaN(decimalHours) ? 0 : decimalHours;
        }
      }

      // --- NEUE HILFSFUNKTION: Parse Pausen-Input vom Modal ---
      function parseManualPauseInput(val) {
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          return hh + mm / 60;
        } else {
          const decimalHours = parseFloat(cleanedVal);
          return isNaN(decimalHours) ? 0 : decimalHours;
        }
      }

      function getAdjustedKommenZeit() {
        if (!kommenZeit) return null;
        const adjusted = new Date(kommenZeit.getTime());
        if ($("pc-buchung").checked) {
          adjusted.setMinutes(adjusted.getMinutes() - 8);
        }
        return adjusted;
      }

      function calculateWorkingTime() {
        const ak = getAdjustedKommenZeit();
        if (!ak || !gehenZeit)
          return { hours: 0, minutes: 0, totalHours: 0 };
        let gehenAdjusted = new Date(gehenZeit.getTime());
        if (gehenAdjusted < ak) {
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
        }
        const diffMs = gehenAdjusted - ak;
        if (diffMs < 0) return { hours: 0, minutes: 0, totalHours: 0 };
        const totalMinutes = Math.floor(diffMs / (1000 * 60));
        const hh = Math.floor(totalMinutes / 60);
        const mm = totalMinutes % 60;
        const totalH = totalMinutes / 60;
        return { hours: hh, minutes: mm, totalHours: totalH };
      }

      // --- MODIFIZIERT: Akzeptiert optionale zus√§tzliche Pausenstunden ---
      function calculatePausenForWorkTime(totalHours, additionalPauseHours = null) {
        let additionalPause = 0;
        // Nutze den √ºbergebenen Wert, wenn er g√ºltig ist
        if (additionalPauseHours !== null && !isNaN(additionalPauseHours) && additionalPauseHours >= 0) {
            additionalPause = additionalPauseHours;
        } else {
            // Fallback: Lese vom Hauptseiten-Input, wenn kein g√ºltiger Wert √ºbergeben wurde
            // (oder wenn die Funktion ohne 2. Argument aufgerufen wird)
            additionalPause = parseAdditionalPause();
        }

        let pausen = additionalPause; // Beginne mit der ermittelten zus√§tzlichen Pause

        // Gesetzliche Pausen h√§ngen von der *Anwesenheitszeit* (totalHours) ab
        if (totalHours > 9) pausen += 0.75; // 45 min
        else if (totalHours > 6) pausen += 0.5; // 30 min

        return pausen; // Gib die berechnete Pause in Stunden zur√ºck
      }

      function calculateArbeitszeit() {
        const wTime = calculateWorkingTime();
        if (wTime.totalHours <= 0) return 0;
        // Rufe calculatePausenForWorkTime ohne 2. Argument auf,
        // damit es den Wert vom Hauptseiten-Input nimmt
        const pausen = calculatePausenForWorkTime(wTime.totalHours);
        const netArbeitszeit = wTime.totalHours - pausen;
        return Math.max(0, netArbeitszeit);
      }

      function calculateEndTimeFixpoint(desiredNet) {
        const ak = getAdjustedKommenZeit();
        if (!ak) return "--:--";
        let presence = desiredNet;
        for (let i = 0; i < 5; i++) {
          const prevPresence = presence;
          // Hier verwenden wir die Hauptseiten-Pause f√ºr die Endzeitberechnung
          const additionalPauseFromMain = parseAdditionalPause();
          let pausen = additionalPauseFromMain;
          if (prevPresence > 9) pausen += 0.75;
          else if (prevPresence > 6) pausen += 0.5;
          presence = desiredNet + pausen;
          if (Math.abs(presence - prevPresence) < 1e-9) break;
        }
        const endTime = new Date(ak.getTime());
        endTime.setMinutes(endTime.getMinutes() + Math.round(presence * 60));
        return formatTime(endTime);
      }

      function updateEndTimes() {
        if (!kommenZeit) {
          ["soll", "4h", "6h", "9h", "10h"].forEach((id) => {
            const el = $(`end-time-${id}`);
            if (el) el.value = "";
          });
          return;
        }
        [4, 6, 9, 10].forEach((d) => {
          const el = $(`end-time-${d}h`);
          if (el) el.value = calculateEndTimeFixpoint(d);
        });
        const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
        const sollProTag = wAZ / 5;
        const outS = calculateEndTimeFixpoint(sollProTag);
        const elSoll = $("end-time-soll");
        if (elSoll) elSoll.value = `(${sollProTag.toFixed(2)}h): ${outS}`;
      }

      function updateCalculations() {
        const netArbeitszeit = calculateArbeitszeit();
        const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
        const sollProTag = wAZ / 5;
        let diff =
          netArbeitszeit > 0
            ? parseFloat((netArbeitszeit - sollProTag).toFixed(2))
            : 0;
        const aktKontoVal = parseFloat($("aktuelles-konto").value) || 0;
        let newKto = parseFloat((aktKontoVal + diff).toFixed(2));
        const wTime = calculateWorkingTime();
        // Hier auch die Hauptseiten-Pause f√ºr die Anzeige verwenden
        const pausen = calculatePausenForWorkTime(wTime.totalHours);
        const pausenMin = Math.round(pausen * 60);
        $("anwesend-zeit").value = `${wTime.hours}:${pad(wTime.minutes)} (${wTime.totalHours.toFixed(2)}h)`;
        $("pausenzeit").value = `${pausenMin} Min (${pausen.toFixed(2)}h)`;
        $("arbeitszeit").value = `${formatDecimalToTime(netArbeitszeit)} (${netArbeitszeit.toFixed(2)}h)`;
        $("sollarbeitszeit-display").value = `${formatDecimalToTime(sollProTag)} (${sollProTag.toFixed(2)}h)`;
        $("differenz").value = diff.toFixed(2);
        $("differenz-time").value = formatDecimalToTime(diff);
        $("neues-konto").value = newKto.toFixed(2);
        $("neues-konto-time").value = formatDecimalToTime(newKto);
        $("aktuelles-konto-time").value = formatDecimalToTime(aktKontoVal);
        const fieldsToColor = [
          { id: "differenz", value: diff },
          { id: "differenz-time", value: diff },
          { id: "neues-konto", value: newKto },
          { id: "neues-konto-time", value: newKto },
          { id: "aktuelles-konto-time", value: aktKontoVal },
        ];
        fieldsToColor.forEach((item) => {
          const el = $(item.id);
          if (!el) return;
          el.classList.remove("positive-value", "negative-value", "zero-value");
          if (item.value > 0.001) el.classList.add("positive-value");
          else if (item.value < -0.001) el.classList.add("negative-value");
          else el.classList.add("zero-value");
        });
        let hinweisText = "";
        const ak = getAdjustedKommenZeit();
        const kommenField = $("kommen-display");
        const gehenField = $("gehen-display");
        kommenField.classList.remove("invalid-time");
        gehenField.classList.remove("invalid-time");
        if (netArbeitszeit > 0 && (netArbeitszeit < 4 || netArbeitszeit > 10)) {
          hinweisText += "Achtung: Arbeitszeit au√üerhalb 4-10h!<br>";
        }
        if (ak) {
          const kStunde = ak.getHours() + ak.getMinutes() / 60;
          if (kStunde < 6 || kStunde > 16) {
            hinweisText += "Achtung: Kommen au√üerhalb 06:00-16:00!<br>";
            kommenField.classList.add("invalid-time");
          }
        }
        if (gehenZeit) {
          let gehenAdjusted = new Date(gehenZeit.getTime());
          if (ak && gehenAdjusted < ak) {
            gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
          }
          const gStunde = gehenAdjusted.getHours() + gehenAdjusted.getMinutes() / 60;
          if (gStunde > 20) {
            hinweisText += "Achtung: Gehen nach 20:00!<br>";
            gehenField.classList.add("invalid-time");
          }
        }
        const hinweis = $("hinweis");
        hinweis.innerHTML = hinweisText;
        hinweis.style.display = hinweisText ? "block" : "none";
        updateEndTimes();
      }

      function checkViolations(kommenDate, gehenDate, arbeitszeit) {
        if (!kommenDate || !gehenDate) return false;
        let gehenAdjusted = new Date(gehenDate.getTime());
        if (gehenAdjusted < kommenDate) {
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
        }
        const kommenStunde = kommenDate.getHours() + kommenDate.getMinutes() / 60;
        const gehenStunde =
          gehenAdjusted.getHours() + gehenAdjusted.getMinutes() / 60;
        return (
          kommenStunde < 6 ||
          kommenStunde > 16 ||
          gehenStunde > 20 ||
          (arbeitszeit > 0 && arbeitszeit < 4) ||
          arbeitszeit > 10
        );
      }

      function saveDay() {
        updateCalculations();
        const today = new Date();
        const dayOfWeek = today.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          alert("Speichern am Wochenende nicht vorgesehen.");
          return;
        }
        const adjustedKommen = getAdjustedKommenZeit();
        const netArbeitszeit = calculateArbeitszeit();
        const currentGehen = gehenZeit ? new Date(gehenZeit.getTime()) : null;
        if (adjustedKommen && currentGehen) {
          let gehenCheck = new Date(currentGehen.getTime());
          if (gehenCheck < adjustedKommen) {
            gehenCheck.setDate(gehenCheck.getDate() + 1);
          }
          if (gehenCheck < adjustedKommen) {
            alert(
              "Gehen-Zeit liegt vor der (ggf. angepassten) Kommen-Zeit!"
            );
            return;
          }
          if (checkViolations(adjustedKommen, gehenCheck, netArbeitszeit)) {
            if (
              !confirm(
                "Es liegt ein Versto√ü gegen die Gleitzeitregeln vor. Trotzdem speichern?"
              )
            ) {
              return;
            }
          }
        } else if (!adjustedKommen || !currentGehen) {
          alert(
            "Bitte Kommen- und Gehen-Zeit f√ºr die Speicherung angeben."
          );
          return;
        }
        const diffVal = parseFloat($("differenz").value) || 0;
        const diffTime = $("differenz-time").value || "0:00";
        const newVal = parseFloat($("neues-konto").value) || 0;
        const datum = today.toISOString().split("T")[0];
        const kommenStr = adjustedKommen ? adjustedKommen.toISOString() : null;
        const gehenStr = currentGehen ? currentGehen.toISOString() : null;
        const isBuero = $("buero-toggle").checked;
        const isPcBuchung = $("pc-buchung").checked;
        let history = getHistory();
        const displayDate = today.toLocaleDateString("de-DE");
        const existingIndex = history.findIndex((e) => e.datum === datum);
        const dayData = {
          datum: datum,
          differenz: diffVal.toFixed(2),
          differenzTime: diffTime,
          stundenkonto: newVal.toFixed(2),
          kommen: kommenStr,
          gehen: gehenStr,
          urlaub: false,
          krank: false,
          schulung: false,
          pcBuchung: isPcBuchung,
          buero: isBuero,
          // Speichere die zus√§tzliche Pause f√ºr diesen Tag (optional)
          zusatzPause: parseAdditionalPause() || 0,
        };
        if (existingIndex !== -1) {
          if (
            !confirm(
              `F√ºr heute (${displayDate}) existiert bereits ein Eintrag. √úberschreiben?`
            )
          ) {
            return;
          }
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }
        saveAndReload(history);
        alert("Der Tag wurde gespeichert.");
      }

      function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return [d.getUTCFullYear(), weekNo];
      }
      function getDateOfISOWeek(w, y) {
        const simple = new Date(Date.UTC(y, 0, 4 + (w - 1) * 7));
        const dow = simple.getUTCDay() || 7;
        const ISOweekStart = new Date(simple);
        ISOweekStart.setUTCDate(simple.getUTCDate() - dow + 1);
        return ISOweekStart;
      }

      function switchView(viewId) {
        currentView = viewId;
        ["main", "history", "month", "stats"].forEach((id) => {
          const page = $(`${id}-page`);
          const navItem = $(`nav-${id}`);
          if (page) page.style.display = id === viewId ? "block" : "none";
          if (navItem) navItem.classList.toggle("active", id === viewId);
        });
        if (viewId === "history") loadHistory();
        else if (viewId === "month") loadMonthData();
        else if (viewId === "stats") calculateAndDisplayStats();
      }

      function loadHistory() {
        const historyList = $("history-list");
        historyList.innerHTML = "";
        let history = getHistory();
        const weekStartDateUTC = getDateOfISOWeek(currentWeekNo, currentWeekYear);
        const weekEndDate = new Date(weekStartDateUTC);
        weekEndDate.setUTCDate(weekStartDateUTC.getUTCDate() + 4);
        const optionsDate = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          timeZone: "Europe/Berlin",
        };
        const weekRange = `${weekStartDateUTC.toLocaleDateString("de-DE", optionsDate)} - ${weekEndDate.toLocaleDateString("de-DE", optionsDate)}`;
        $("week-info").textContent = `KW ${currentWeekNo} / ${currentWeekYear}`;
        $("week-range").textContent = weekRange;
        const weekdays = [0, 1, 2, 3, 4];
        const optionsWeekday = { weekday: "long", timeZone: "Europe/Berlin" };
        let weeklyTotalDiff = 0;
        weekdays.forEach((dayOffset) => {
          const currentDateUTC = new Date(weekStartDateUTC.getTime());
          currentDateUTC.setUTCDate(weekStartDateUTC.getUTCDate() + dayOffset);
          const currentDateStr = currentDateUTC.toISOString().split("T")[0];
          const displayDate = currentDateUTC.toLocaleDateString(
            "de-DE",
            optionsDate
          );
          const weekdayName = currentDateUTC.toLocaleDateString(
            "de-DE",
            optionsWeekday
          );
          const entry = history.find((e) => e.datum === currentDateStr);
          const li = document.createElement("li");
          li.classList.add("history-item");
          const entryContentDiv = document.createElement("div");
          entryContentDiv.classList.add("history-entry-content");
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("history-actions");
          if (entry) {
            let locationEmoji = entry.buero ? "üè¢" : "üè†";
            let specialDayText = entry.urlaub
              ? "Urlaub"
              : entry.krank
                ? "Krank"
                : entry.schulung
                  ? "Schulung"
                  : "";
            if (specialDayText) {
              let bgColor = entry.krank
                ? "var(--special-day-krank-bg)"
                : "var(--special-day-urlaub-bg)";
              entryContentDiv.classList.add("special-day");
              entryContentDiv.style.backgroundColor = bgColor;
              entryContentDiv.style.color = "var(--special-day-text)";
              entryContentDiv.innerHTML = `
                <div><strong>${weekdayName}</strong> (${displayDate})</div>
                <div>${specialDayText} ${locationEmoji}</div>`;
            } else {
              const diffVal = parseFloat(entry.differenz) || 0;
              weeklyTotalDiff += diffVal;
              const diffClass =
                diffVal > 0.001
                  ? "positive-value"
                  : diffVal < -0.001
                    ? "negative-value"
                    : "zero-value";
              const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
              const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
              // Verwende die gespeicherte Zusatzpause, falls vorhanden
              const netTime = calculateNetArbeitszeitFromEntryData(
                kommenLokal,
                gehenLokal,
                entry.zusatzPause // √úbergib gespeicherte Pause
              );
              const isViolation = checkViolations(kommenLokal, gehenLokal, netTime);
              const violationMark = isViolation
                ? ' <span class="violation-mark">!</span>'
                : "";
              if (isViolation) entryContentDiv.classList.add("violation-day");
              entryContentDiv.innerHTML = `
                <div><strong>${weekdayName}</strong> (${displayDate})</div>
                <div>
                  ${formatTime(kommenLokal)} - ${formatTime(gehenLokal)} ${locationEmoji}
                  <span class="diff-badge ${diffClass}" style="margin-left: 8px;">${entry.differenzTime}</span>
                  ${violationMark}
                </div>`;
            }
            actionsDiv.innerHTML = `
              <button class="inline-button" onclick="showDayDetails('${entry.datum}')">i</button>
              <button class="delete-button" onclick="deleteEntryByDate('${entry.datum}')">√ó</button>`;
          } else {
            entryContentDiv.classList.add("no-data");
            entryContentDiv.innerHTML = `
              <div><strong>${weekdayName}</strong> (${displayDate})</div>
              <div>Kein Eintrag</div>`;
            actionsDiv.innerHTML = `
               <button class="inline-button add-button" onclick="showAddDayModal('${currentDateStr}')">+</button>`;
          }
          li.appendChild(entryContentDiv);
          li.appendChild(actionsDiv);
          historyList.appendChild(li);
        });
        const diffClassSummary =
          weeklyTotalDiff > 0.001
            ? "positive-value"
            : weeklyTotalDiff < -0.001
              ? "negative-value"
              : "zero-value";
        $("weekly-summary-content").innerHTML = `
        Gesamtdifferenz:
           <span class="diff-badge ${diffClassSummary}">${formatDecimalToTime(weeklyTotalDiff)} (${weeklyTotalDiff.toFixed(2)}h)</span>`;
        updateWeekNavigation();
      }

      // --- MODIFIZIERT: Akzeptiert optionale gespeicherte Zusatzpause ---
      function calculateNetArbeitszeitFromEntryData(kommenLokal, gehenLokal, zusatzPause = 0) {
        if (!kommenLokal || !gehenLokal) return 0;
        let gehenAdjusted = new Date(gehenLokal.getTime());
        if (gehenAdjusted < kommenLokal) {
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
        }
        const diffMs = gehenAdjusted - kommenLokal;
        if (diffMs < 0) return 0;
        const totalH = diffMs / (1000 * 60 * 60);
        // Verwende die gespeicherte Zusatzpause (oder 0) f√ºr die Pausenberechnung
        const pausen = calculatePausenForWorkTime(totalH, zusatzPause);
        return Math.max(0, totalH - pausen);
      }

      function deleteEntryByDate(dateStr) {
        let history = getHistory();
        const index = history.findIndex((e) => e.datum === dateStr);
        if (index !== -1) {
          const displayDate = new Date(
            dateStr + "T00:00:00"
          ).toLocaleDateString("de-DE");
          if (
            confirm(
              `M√∂chten Sie den Eintrag f√ºr ${displayDate} wirklich l√∂schen?`
            )
          ) {
            history.splice(index, 1);
            saveAndReload(history);
          }
        }
      }

      function updateWeekNavigation() {
        const pagination = $("pagination");
        pagination.innerHTML = "";
        const createButton = (text, onClick) => {
          const btn = document.createElement("button");
          btn.textContent = text;
          btn.onclick = onClick;
          btn.classList.add("inline-button"); // Einheitlicher Style
          return btn;
        };
        const prevWeekBtn = createButton("‚Äπ Vorige KW", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() - 7);
          [currentWeekYear, currentWeekNo] = getWeekNumber(d);
          loadHistory();
        });
        const nextWeekBtn = createButton("N√§chste KW ‚Ä∫", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() + 7);
          [currentWeekYear, currentWeekNo] = getWeekNumber(d);
          loadHistory();
        });
        pagination.appendChild(prevWeekBtn);
        pagination.appendChild(nextWeekBtn);
      }

      // --- MODIFIZIERT: Leert das neue Pausenfeld ---
      function showAddDayModal(dateStr) {
        const dateVal = new Date(dateStr + "T00:00:00");
        const displayDate = dateVal.toLocaleDateString("de-DE");
        const weekdayName = dateVal.toLocaleDateString("de-DE", {
          weekday: "long",
        });
        $("add-day-modal-title").textContent = `Buchung f√ºr ${weekdayName}, ${displayDate}`;
        $("add-day-kommen").value = "";
        $("add-day-gehen").value = "";
        $("pc-buchung-add-day").checked =
          getFromLS("pcBuchungChecked") === "true";
        $("buero-add-day").checked = getFromLS("bueroChecked") === "true";
        $("urlaub-toggle").checked = false;
        $("krank-toggle").checked = false;
        $("schulung-toggle").checked = false;

        $("add-day-zusatzliche-pause").value = ""; // --- NEU: Feld leeren ---
        toggleTimeFieldsDisabled(false); // Enable time fields initially

        $("add-day-modal").setAttribute("data-date", dateStr); // Store YYYY-MM-DD
        $("add-day-modal").style.display = "flex"; // Use flex for centering
      }

      function toggleSpecialDay(type) {
        const types = ["urlaub", "krank", "schulung"];
        const isChecked = $(type + "-toggle").checked;
        types.forEach((t) => {
          if (t !== type && isChecked) $(t + "-toggle").checked = false;
        });
        toggleTimeFieldsDisabled(
          $("urlaub-toggle").checked ||
            $("krank-toggle").checked ||
            $("schulung-toggle").checked
        );
      }

      // --- MODIFIZIERT: Deaktiviert/Aktiviert auch das Pausenfeld ---
      function toggleTimeFieldsDisabled(disabled) {
        $("add-day-kommen").disabled = disabled;
        $("add-day-gehen").disabled = disabled;
        $("pc-buchung-add-day").disabled = disabled;
        $("add-day-zusatzliche-pause").disabled = disabled; // --- NEU ---
        // Keep Buero/Homeoffice enabled even for special days
      }

      // --- MODIFIZIERT: Ber√ºcksichtigt die manuelle Pause ---
      function addManualDay() {
        const dateVal = $("add-day-modal").getAttribute("data-date");
        if (!dateVal) {
          alert("Kein g√ºltiges Datum f√ºr die Buchung!");
          return;
        }
        const realDate = new Date(dateVal + "T00:00:00");
        const dayOfWeek = realDate.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          alert("Samstag und Sonntag sind nicht zul√§ssig!");
          return;
        }
        const isUrlaub = $("urlaub-toggle").checked;
        const isKrank = $("krank-toggle").checked;
        const isSchulung = $("schulung-toggle").checked;
        const isBueroAddDay = $("buero-add-day").checked;
        const isPcBuchungAddDay = $("pc-buchung-add-day").checked;
        let history = getHistory();
        const existingIndex = history.findIndex((e) => e.datum === dateVal);
        const displayDate = realDate.toLocaleDateString("de-DE");
        let dayData = {
          datum: dateVal,
          differenz: "0.00",
          differenzTime: "0:00",
          stundenkonto: "0.00",
          kommen: null,
          gehen: null,
          urlaub: isUrlaub,
          krank: isKrank,
          schulung: isSchulung,
          pcBuchung: false,
          buero: isBueroAddDay,
          zusatzPause: 0, // Standardwert f√ºr Zusatzpause
        };

        // --- Special Day Handling ---
        if (isUrlaub || isKrank || isSchulung) {
          const lastKonto = findLastKontoBeforeDate(
            history,
            dateVal,
            existingIndex
          );
          dayData.stundenkonto = lastKonto.toFixed(2);
          let label = isUrlaub
            ? "Urlaub"
            : isKrank
              ? "Krank"
              : "Schulung";
          if (existingIndex !== -1) {
            if (
              !confirm(
                `Eintrag f√ºr ${displayDate} existiert. Mit ${label} √ºberschreiben?`
              )
            )
              return;
            history[existingIndex] = dayData;
          } else {
            history.push(dayData);
          }
          saveAndReload(history);
          alert(`${label} f√ºr ${displayDate} eingetragen.`);
          return;
        }

        // --- Normal Work Day Handling ---
        const kommenVal = $("add-day-kommen").value;
        const gehenVal = $("add-day-gehen").value;
        if (!kommenVal || !gehenVal) {
          alert(
            "Bitte Kommen- und Gehen-Zeit angeben oder Urlaub/Krank/Schulung w√§hlen!"
          );
          return;
        }
        const kommenDateManual = parseTimeForDate(kommenVal, realDate);
        const gehenDateManual = parseTimeForDate(gehenVal, realDate);
        if (!kommenDateManual || !gehenDateManual) {
          alert("Ung√ºltige Zeitformate!");
          return;
        }
        if (gehenDateManual < kommenDateManual) {
          gehenDateManual.setDate(gehenDateManual.getDate() + 1);
        }
        let adjustedKommenManual = new Date(kommenDateManual.getTime());
        if (isPcBuchungAddDay) {
          adjustedKommenManual.setMinutes(
            adjustedKommenManual.getMinutes() - 8
          );
        }
        const diffMsManual = gehenDateManual - adjustedKommenManual;
        if (diffMsManual < 0) {
          alert(
            "Angepasste Kommen-Zeit (PC-Buchung) liegt nach der Gehen-Zeit!"
          );
          return;
        }
        const totalHManual = diffMsManual / (1000 * 60 * 60);

        // --- NEU: Lese und parse die manuelle Pause aus dem Modal-Input ---
        const pauseValStr = $('add-day-zusatzliche-pause').value;
        const parsedManualPause = parseManualPauseInput(pauseValStr);
        // --- Ende NEU ---

        // --- MODIFIZIERT: √úbergib die geparste manuelle Pause an die Funktion ---
        const pausenManual = calculatePausenForWorkTime(totalHManual, parsedManualPause);
        const netManual = Math.max(0, totalHManual - pausenManual);

        if (checkViolations(adjustedKommenManual, gehenDateManual, netManual)) {
          if (
            !confirm(
              "Die eingegebenen Zeiten versto√üen gegen die Gleitzeitregeln. Trotzdem speichern?"
            )
          ) {
            return;
          }
        }
        const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
        const sollProTag = wAZ / 5;
        const diffValManual = parseFloat((netManual - sollProTag).toFixed(2));
        const lastKonto = findLastKontoBeforeDate(
          history,
          dateVal,
          existingIndex
        );
        const newKtoManual = parseFloat((lastKonto + diffValManual).toFixed(2));
        const diffTimeManual = formatDecimalToTime(diffValManual);
        dayData.differenz = diffValManual.toFixed(2);
        dayData.differenzTime = diffTimeManual;
        dayData.stundenkonto = newKtoManual.toFixed(2);
        dayData.kommen = adjustedKommenManual.toISOString();
        dayData.gehen = gehenDateManual.toISOString();
        dayData.pcBuchung = isPcBuchungAddDay;
        dayData.urlaub = false;
        dayData.krank = false;
        dayData.schulung = false;
        dayData.zusatzPause = parsedManualPause; // Speichere die eingegebene Pause

        if (existingIndex !== -1) {
          if (!confirm(`Eintrag f√ºr ${displayDate} existiert. √úberschreiben?`))
            return;
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }
        saveAndReload(history);
        alert(`Arbeitstag f√ºr ${displayDate} gespeichert.`);
      }

      function parseTimeForDate(timeStr, targetDate) {
        if (!timeStr || !targetDate) return null;
        const match = timeStr.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        const resultDate = new Date(targetDate.getTime());
        resultDate.setHours(hh, mm, 0, 0);
        return resultDate;
      }

      function findLastKontoBeforeDate(history, dateStr, excludeIndex = -1) {
        const targetDate = new Date(dateStr + "T00:00:00");
        const relevantHistory = history
          .filter(
            (entry, index) =>
              index !== excludeIndex &&
              new Date(entry.datum + "T00:00:00") < targetDate
          )
          .sort((a, b) => new Date(b.datum) - new Date(a.datum));
        if (
          relevantHistory.length > 0 &&
          relevantHistory[0].stundenkonto !== undefined
        ) {
          return parseFloat(relevantHistory[0].stundenkonto) || 0;
        }
        return parseFloat(getFromLS("aktuellesStundenkonto", "0")) || 0;
      }

      function saveAndReload(history) {
        history.forEach((entry) => {
          entry.dateObj = new Date(entry.datum + "T00:00:00");
        });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj);
        storeToLS("history", JSON.stringify(history));
        const latestEntry = history.length > 0 ? history[history.length - 1] : null;
        const latestKonto = latestEntry
          ? parseFloat(latestEntry.stundenkonto || 0)
          : 0;
        $("aktuelles-konto").value = latestKonto.toFixed(2);
        storeToLS("aktuellesStundenkonto", latestKonto.toFixed(2));
        updateCalculations();
        closeAddDayModal();
        if (currentView === "history") loadHistory();
        if (currentView === "month") loadMonthData();
        if (currentView === "stats") calculateAndDisplayStats();
      }

      function closeAddDayModal() {
        const modal = $("add-day-modal");
        if (modal) modal.style.display = "none";
      }

      // --- MODIFIZIERT: Zeigt gespeicherte Zusatzpause an ---
      function showDayDetails(dateStr) {
        const history = getHistory();
        const entry = history.find((e) => e.datum === dateStr);
        if (!entry) return;
        const entryDate = new Date(dateStr + "T00:00:00");
        const dispDate = entryDate.toLocaleDateString("de-DE");
        const weekdayName = entryDate.toLocaleDateString("de-DE", {
          weekday: "long",
        });
        $("detail-modal-title").textContent = `Details: ${weekdayName}, ${dispDate}`;
        let detailsHTML = "";
        let pausenLabel = "N/A";
        let anwesenheitLabel = "N/A";
        let nettoLabel = "N/A";
        let pcBuchungChecked = !!entry.pcBuchung;
        let bueroEmoji = entry.buero ? "üè¢ B√ºro" : "üè† Homeoffice";
        if (entry.urlaub || entry.krank || entry.schulung) {
          const statusText = entry.urlaub
            ? "Urlaub"
            : entry.krank
              ? "Krank"
              : "Schulung";
          detailsHTML = `
          <p><strong>Status:</strong> ${statusText} ${bueroEmoji}</p>
          <p><strong>Kommen:</strong> --:--</p>
          <p><strong>Gehen:</strong> --:--</p>
          <p><strong>Differenz:</strong> 0.00h (0:00)</p>`;
          pcBuchungChecked = false;
        } else {
          const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
          const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
          const kommenFormatted = formatTime(kommenLokal);
          const gehenFormatted = formatTime(gehenLokal);
          const diffVal = parseFloat(entry.differenz) || 0;
          const diffClass =
            diffVal > 0.001
              ? "positive-value"
              : diffVal < -0.001
                ? "negative-value"
                : "zero-value";
          if (kommenLokal && gehenLokal) {
            let gehenAdjusted = new Date(gehenLokal.getTime());
            if (gehenAdjusted < kommenLokal) {
              gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
            }
            const diffMs = gehenAdjusted - kommenLokal;
            if (diffMs >= 0) {
              const totalH = diffMs / (1000 * 60 * 60);
              anwesenheitLabel = `${Math.floor(totalH)}:${pad(Math.round((totalH % 1) * 60))} (${totalH.toFixed(2)}h)`;
              // Verwende gespeicherte Zusatzpause f√ºr Netto-Berechnung
              const netCalculated = calculateNetArbeitszeitFromEntryData(
                kommenLokal,
                gehenLokal,
                entry.zusatzPause // √úbergib gespeicherte Pause
              );
              nettoLabel = `${formatDecimalToTime(netCalculated)} (${netCalculated.toFixed(2)}h)`;
              // Berechne Gesamtpause (gesetzlich + gespeichert)
              const gesamtPauseVal = calculatePausenForWorkTime(totalH, entry.zusatzPause);
              pausenLabel =
                gesamtPauseVal > 0
                  ? `${Math.round(gesamtPauseVal * 60)} Min (${gesamtPauseVal.toFixed(2)}h)`
                  : "0 Min";
            }
          }
          detailsHTML = `
          <p><strong>Ort:</strong> ${bueroEmoji}</p>
          <p><strong>Kommen:</strong> ${kommenFormatted} ${pcBuchungChecked ? "(PC-Buchung aktiv)" : ""}</p>
          <p><strong>Gehen:</strong> ${gehenFormatted}</p>
          <p><strong>Anwesenheit:</strong> ${anwesenheitLabel}</p>
          <p><strong>Pause (Gesamt):</strong> ${pausenLabel}</p>
          <p><strong>Netto-Arbeitszeit:</strong> ${nettoLabel}</p>
          <p><strong>Differenz:</strong> <span class="diff-badge ${diffClass}">${entry.differenzTime} (${entry.differenz}h)</span></p>
          <p><strong>Stundenkonto danach:</strong> ${formatDecimalToTime(parseFloat(entry.stundenkonto || 0))} (${parseFloat(entry.stundenkonto || 0).toFixed(2)}h)</p>`;
        }
        $("detail-content").innerHTML = detailsHTML;
        $("detail-modal").style.display = "flex";
      }

      function closeDetailModal() {
        const modal = $("detail-modal");
        if (modal) modal.style.display = "none";
      }

      const monthNames = [
        "Januar",
        "Februar",
        "M√§rz",
        "April",
        "Mai",
        "Juni",
        "Juli",
        "August",
        "September",
        "Oktober",
        "November",
        "Dezember",
      ];
      function getFirstDayOfMonth(year, month) {
        return new Date(year, month, 1).getDay();
      }
      function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
      }
      function loadMonthData() {
        const history = getHistory();
        const monthData = history.filter((entry) => {
          const entryDate = new Date(entry.datum + "T00:00:00");
          return (
            entryDate.getFullYear() === currentMonthYear &&
            entryDate.getMonth() === currentMonth
          );
        });
        renderCalendar(monthData);
        updateMonthNavigation();
      }
      function renderCalendar(monthData) {
        const calendarGrid = $("calendar-grid");
        calendarGrid.innerHTML = "";
        $("month-year-display").textContent = `${monthNames[currentMonth]} ${currentMonthYear}`;
        const daysInMonth = getDaysInMonth(currentMonthYear, currentMonth);
        let firstDayIndex = getFirstDayOfMonth(currentMonthYear, currentMonth);
        firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
        const weekdays = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
        weekdays.forEach((wd) => {
          const headerCell = document.createElement("div");
          headerCell.classList.add("calendar-header");
          headerCell.textContent = wd;
          calendarGrid.appendChild(headerCell);
        });
        for (let i = 0; i < firstDayIndex; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.classList.add("calendar-day", "empty");
          calendarGrid.appendChild(emptyCell);
        }
        let monthlyTotalDiff = 0;
        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.classList.add("calendar-day");
          const cellContent = document.createElement("div");
          cellContent.classList.add("calendar-day-content");
          cellContent.textContent = day;
          cell.appendChild(cellContent);
          const currentDateStr = `${currentMonthYear}-${pad(currentMonth + 1)}-${pad(day)}`;
          const currentDateObj = new Date(currentMonthYear, currentMonth, day);
          const dayOfWeek = currentDateObj.getDay();
          const entry = monthData.find((e) => e.datum === currentDateStr);
          if (entry) {
            cell.classList.add("has-entry");
            const diffVal = parseFloat(entry.differenz) || 0;
            monthlyTotalDiff += diffVal;
            let diffClass = "";
            if (entry.urlaub || entry.krank || entry.schulung) {
              diffClass = entry.krank
                ? "special-day-krank-bg"
                : "special-day-urlaub-bg";
              cellContent.title = entry.urlaub
                ? "Urlaub"
                : entry.krank
                  ? "Krank"
                  : "Schulung";
            } else {
              if (diffVal > 0.001) diffClass = "positive-value";
              else if (diffVal < -0.001) diffClass = "negative-value";
              else diffClass = "zero-value";
              cellContent.title = `Differenz: ${entry.differenzTime}`;
            }
            cellContent.classList.add(diffClass);
            cell.onclick = () => showDayDetails(currentDateStr);
          } else if (dayOfWeek === 0 || dayOfWeek === 6) {
            cell.classList.add("weekend");
            cellContent.classList.add("weekend-text");
          } else {
            cell.classList.add("no-entry");
            cell.onclick = () => showAddDayModal(currentDateStr);
            cellContent.title = "Klicken zum Hinzuf√ºgen";
          }
          const today = new Date();
          if (
            currentDateObj.getFullYear() === today.getFullYear() &&
            currentDateObj.getMonth() === today.getMonth() &&
            currentDateObj.getDate() === today.getDate()
          ) {
            cellContent.classList.add("today");
          }
          calendarGrid.appendChild(cell);
        }
        const diffClassSummary =
          monthlyTotalDiff > 0.001
            ? "positive-value"
            : monthlyTotalDiff < -0.001
              ? "negative-value"
              : "zero-value";
        $("month-summary-content").innerHTML = `
            Monatsdifferenz: <span class="diff-badge ${diffClassSummary}">${formatDecimalToTime(monthlyTotalDiff)} (${monthlyTotalDiff.toFixed(2)}h)</span>`;
      }
      function updateMonthNavigation() {
        $("prev-month").onclick = () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentMonthYear--;
          }
          loadMonthData();
        };
        $("next-month").onclick = () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentMonthYear++;
          }
          loadMonthData();
        };
      }

      function calculateAndDisplayStats() {
        const period = $("stats-period").value;
        const history = getHistory();
        const today = new Date();
        let startDate, endDate;
        today.setHours(12, 0, 0, 0);
        switch (period) {
          case "current_month":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 12, 0, 0, 0);
            break;
          case "last_month":
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0, 12, 0, 0, 0);
            break;
          case "current_year":
            startDate = new Date(today.getFullYear(), 0, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), 11, 31, 12, 0, 0, 0);
            break;
          case "last_year":
            startDate = new Date(today.getFullYear() - 1, 0, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear() - 1, 11, 31, 12, 0, 0, 0);
            break;
          case "all_time":
          default:
            if (history.length === 0) {
              startDate = new Date(today);
              endDate = new Date(today);
            } else {
              startDate = new Date(history[0].datum + "T12:00:00");
              endDate = new Date(history[history.length - 1].datum + "T12:00:00");
            }
            break;
        }
        const filteredHistory = history.filter((entry) => {
          const entryDate = new Date(entry.datum + "T12:00:00");
          return (
            entryDate.setHours(0, 0, 0, 0) >= startDate.setHours(0, 0, 0, 0) &&
            entryDate.setHours(0, 0, 0, 0) <= endDate.setHours(0, 0, 0, 0)
          );
        });
        let totalNetHours = 0;
        let totalDiff = 0;
        let workDays = 0;
        let officeDays = 0;
        let homeDays = 0;
        let vacationDays = 0;
        let sickDays = 0;
        let trainingDays = 0;
        filteredHistory.forEach((entry) => {
          if (entry.urlaub) vacationDays++;
          else if (entry.krank) sickDays++;
          else if (entry.schulung) trainingDays++;
          else if (entry.kommen && entry.gehen) {
            workDays++;
            const kommenLokal = new Date(entry.kommen);
            const gehenLokal = new Date(entry.gehen);
            // Verwende gespeicherte Zusatzpause f√ºr Statistik
            const netHours = calculateNetArbeitszeitFromEntryData(
              kommenLokal,
              gehenLokal,
              entry.zusatzPause // √úbergib gespeicherte Pause
            );
            totalNetHours += netHours;
            totalDiff += parseFloat(entry.differenz || 0);
            if (entry.buero) officeDays++;
            else homeDays++;
          }
        });
        const avgDailyHours = workDays > 0 ? totalNetHours / workDays : 0;
        const statsContent = $("stats-content");
        if (filteredHistory.length === 0) {
          statsContent.innerHTML = `<li>Keine Daten f√ºr den ausgew√§hlten Zeitraum vorhanden.</li>`;
          return;
        }
        statsContent.innerHTML = `
            <li>Gesamt Netto-Arbeitszeit: <span>${formatDecimalToTime(totalNetHours)} (${totalNetHours.toFixed(2)}h)</span></li>
            <li>Durchschnittl. t√§gl. Arbeitszeit: <span>${formatDecimalToTime(avgDailyHours)} (${avgDailyHours.toFixed(2)}h)</span></li>
            <li>Gesamte Differenz: <span class="diff-badge ${totalDiff > 0.001 ? "positive-value" : totalDiff < -0.001 ? "negative-value" : "zero-value"}">${formatDecimalToTime(totalDiff)} (${totalDiff.toFixed(2)}h)</span></li>
            <li>Arbeitstage gesamt: <span>${workDays}</span></li>
            <li>&nbsp;&nbsp;&nbsp;davon B√ºro: <span>${officeDays}</span></li>
            <li>&nbsp;&nbsp;&nbsp;davon Homeoffice: <span>${homeDays}</span></li>
            <li>Urlaubstage: <span>${vacationDays}</span></li>
            <li>Krankheitstage: <span>${sickDays}</span></li>
            <li>Schulungstage: <span>${trainingDays}</span></li>`;
      }

      function exportHistoryToJson() {
        const history = getHistory();
        if (history.length === 0) {
          alert("Keine Daten zum Exportieren vorhanden.");
          return;
        }
        const jsonData = JSON.stringify(history, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const todayStr = new Date().toISOString().split("T")[0];
        a.href = url;
        a.download = `arbeitszeit_export_${todayStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Verlauf wurde als JSON-Datei exportiert.");
      }

      function importHistoryFromJson() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.style.display = "none";
        input.onchange = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (!Array.isArray(importedData)) {
                throw new Error("Importierte Datei ist kein g√ºltiges JSON-Array.");
              }
              // Einfache Pr√ºfung auf erwartete Struktur
              if (
                importedData.length > 0 &&
                (importedData[0].datum === undefined ||
                  importedData[0].stundenkonto === undefined)
              ) {
                throw new Error(
                  "Struktur der importierten Daten scheint ung√ºltig zu sein."
                );
              }
              // F√ºge fehlende Felder hinzu (z.B. zusatzPause), falls n√∂tig
              importedData.forEach(entry => {
                  if (entry.zusatzPause === undefined) {
                      entry.zusatzPause = 0; // Standardwert
                  }
              });

              if (
                confirm(
                  `M√∂chten Sie wirklich ${importedData.length} Eintr√§ge importieren? ACHTUNG: Alle vorhandenen Daten werden √ºberschrieben!`
                )
              ) {
                saveAndReload(importedData);
                alert("Verlauf erfolgreich importiert.");
              }
            } catch (error) {
              console.error("Fehler beim Importieren:", error);
              alert(`Import fehlgeschlagen: ${error.message}`);
            } finally {
              document.body.removeChild(input);
            }
          };
          reader.onerror = (e) => {
            console.error("Fehler beim Lesen der Datei:", e);
            alert("Fehler beim Lesen der Datei.");
            document.body.removeChild(input);
          };
          reader.readAsText(file);
        };
        document.body.appendChild(input);
        input.click();
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>

    <style>
      :root {
        /* Light Mode */
        --system-background-light: #f2f2f7;
        --system-secondary-background-light: #ffffff;
        --system-tertiary-background-light: #e5e5ea;
        --text-color-light: #000000;
        --secondary-text-color-light: rgba(60, 60, 67, 0.6);
        --readonly-text-color-light: rgba(0, 0, 0, 0.75);
        --separator-color-light: rgba(60, 60, 67, 0.29);
        --input-border-color-light: rgba(60, 60, 67, 0.2);
        --system-blue-light: #007aff;
        --system-green-light: #34c759;
        --system-red-light: #ff3b30;
        --system-orange-light: #ff9500;
        --system-yellow-light: #ffcc00;
        --system-teal-light: #5ac8fa;
        --system-gray-light: #8e8e93;
        --system-gray2-light: #aeaeb2;

        /* Dark Mode */
        --system-background-dark: #000000;
        --system-secondary-background-dark: #1c1c1e;
        --system-tertiary-background-dark: #2c2c2e;
        --text-color-dark: #ffffff;
        --secondary-text-color-dark: rgba(235, 235, 245, 0.6);
        --readonly-text-color-dark: rgba(255, 255, 255, 0.75);
        --separator-color-dark: rgba(84, 84, 88, 0.65);
        --input-border-color-dark: rgba(84, 84, 88, 0.5);
        --system-blue-dark: #0a84ff;
        --system-green-dark: #30d158;
        --system-red-dark: #ff453a;
        --system-orange-dark: #ff9f0a;
        --system-yellow-dark: #ffd60a;
        --system-teal-dark: #64d2ff;
        --system-gray-dark: #8e8e93;
        --system-gray2-dark: #3a3a3c;

        /* Semantic Colors */
        --background-color: var(--system-background-light);
        --card-background-color: var(--system-secondary-background-light);
        --input-background-color: var(--system-tertiary-background-light);
        --text-color: var(--text-color-light);
        --secondary-text-color: var(--secondary-text-color-light);
        --readonly-text-color: var(--readonly-text-color-light);
        --separator-color: var(--separator-color-light);
        --input-border-color: var(--input-border-color-light);
        --button-background-color: var(--system-blue-light);
        --button-text-color: #ffffff;
        --positive-value-bg: var(--system-blue-light);
        --negative-value-bg: var(--system-orange-light);
        --zero-value-bg: var(--system-green-light);
        --hint-color: var(--system-red-light);
        --special-day-urlaub-bg: var(--system-teal-light);
        --special-day-krank-bg: var(--system-yellow-light);
        --special-day-text: #000000; /* Dunkler Text f√ºr helle Hintergr√ºnde */
        --nav-background: var(--system-secondary-background-light);
        --nav-icon-color: var(--system-gray-light);
        --nav-icon-active-color: var(--system-blue-light);
        --slider-bg-color: var(--system-gray2-light);
        --slider-checked-bg-color: var(--system-green-light);

        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        --safe-area-left: env(safe-area-inset-left, 0px);
        --safe-area-right: env(safe-area-inset-right, 0px);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: var(--system-background-dark);
          --card-background-color: var(--system-secondary-background-dark);
          --input-background-color: var(--system-tertiary-background-dark);
          --text-color: var(--text-color-dark);
          --secondary-text-color: var(--secondary-text-color-dark);
          --readonly-text-color: var(--readonly-text-color-dark);
          --separator-color: var(--separator-color-dark);
          --input-border-color: var(--input-border-color-dark);
          --button-background-color: var(--system-blue-dark);
          --positive-value-bg: var(--system-blue-dark);
          --negative-value-bg: var(--system-orange-dark);
          --zero-value-bg: var(--system-green-dark);
          --hint-color: var(--system-red-dark);
          --special-day-urlaub-bg: var(--system-teal-dark);
          --special-day-krank-bg: var(--system-yellow-dark);
          --special-day-text: #000000; /* Bleibt dunkel f√ºr gute Lesbarkeit */
          --nav-background: var(--system-secondary-background-dark);
          --nav-icon-color: var(--system-gray-dark);
          --nav-icon-active-color: var(--system-blue-dark);
          --slider-bg-color: var(--system-gray2-dark);
          --slider-checked-bg-color: var(--system-green-dark);
        }
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 17px;
        line-height: 1.4;
        overscroll-behavior-y: none; /* Verhindert Bounce-Effekt auf Body */
      }

      #app-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        overflow: hidden; /* Verhindert Scrollen des Hauptcontainers */
      }

      .page {
        flex-grow: 1; /* Nimmt verf√ºgbaren Platz ein */
        overflow-y: auto; /* Macht Inhalt scrollbar */
        -webkit-overflow-scrolling: touch; /* iOS smooth scrolling */
        /* --- ANGEPASST: Gr√∂√üerer Abstand unten --- */
        padding: var(--safe-area-top) calc(15px + var(--safe-area-left))
          calc(105px + var(--safe-area-bottom)) /* Gr√∂√üerer Puffer */
          calc(15px + var(--safe-area-right));
        display: none; /* Standardm√§√üig ausgeblendet */
      }

      .page.active {
        display: block; /* Aktive Seite anzeigen */
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 0; /* Kein extra Padding unten im Container */
      }

      h1,
      h2,
      h3 {
        margin-bottom: 15px;
        color: var(--text-color);
      }
      h1 {
        font-size: 28px;
        font-weight: bold;
        margin-top: 10px;
      }
      h2 {
        font-size: 22px;
        font-weight: bold;
        margin-top: 25px;
        border-bottom: 1px solid var(--separator-color);
        padding-bottom: 5px;
      }
      h3 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--secondary-text-color);
        font-size: 15px;
      }

      input[type="time"],
      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 15px;
        border: 1px solid var(--input-border-color);
        border-radius: 8px;
        background-color: var(--input-background-color);
        color: var(--text-color);
        font-size: 17px;
        min-height: 44px; /* iOS Tappable Area */
        appearance: none; /* Remove default styling */
        -webkit-appearance: none;
      }
      input[type="time"]::-webkit-calendar-picker-indicator {
        display: none; /* Hide default time picker icon */
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--system-blue-light);
        box-shadow: 0 0 0 1px var(--system-blue-light);
      }
      input[readonly] {
        background-color: var(--card-background-color);
        color: var(--readonly-text-color);
        border: 1px solid var(--input-border-color); /* Border f√ºr Readonly */
        cursor: default;
      }
      input[readonly]:focus {
        border-color: var(--input-border-color); /* Kein blauer Rand bei Fokus */
        box-shadow: none;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .input-group > div {
        flex: 1; /* Gleiche Breite f√ºr Elemente in der Gruppe */
      }
      .input-group > div > input {
        margin-bottom: 0; /* Kein doppelter Margin */
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        background-color: var(--button-background-color);
        color: var(--button-text-color);
        font-size: 17px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        min-height: 44px; /* iOS Tappable Area */
        width: 100%; /* Volle Breite f√ºr Hauptbuttons */
        margin-top: 5px;
      }
      button:hover,
      button:active {
        filter: brightness(0.9);
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .button-group button {
        flex: 1; /* Gleiche Breite f√ºr Buttons in der Gruppe */
        margin-top: 0;
      }

      /* Inline Buttons (kleiner, f√ºr Aktionen in Listen etc.) */
      .inline-button {
        padding: 5px 10px;
        font-size: 15px;
        min-height: 30px;
        width: auto; /* Nicht volle Breite */
        margin: 0 5px;
        background-color: var(--input-background-color);
        color: var(--system-blue-light);
        border: 1px solid var(--separator-color);
      }
      @media (prefers-color-scheme: dark) {
        .inline-button {
          color: var(--system-blue-dark);
        }
      }
      .inline-button.add-button {
        font-size: 20px;
        padding: 2px 10px;
      }
      .delete-button {
        background-color: transparent;
        color: var(--system-red-light);
        border: none;
        font-size: 20px;
        padding: 5px;
        width: auto;
        min-height: 30px;
        margin-left: 5px;
      }
      @media (prefers-color-scheme: dark) {
        .delete-button {
          color: var(--system-red-dark);
        }
      }

      /* Switch Toggle (iOS Style) */
      .switch-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        min-height: 44px; /* Tappable Area */
      }
      .switch-container span {
        margin-left: 10px;
        font-size: 17px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 51px; /* Standard iOS Breite */
        height: 31px;
        flex-shrink: 0; /* Verhindert Schrumpfen im Flex-Layout */
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--slider-bg-color);
        transition: 0.4s;
        border-radius: 15.5px; /* Halbe H√∂he */
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 27px; /* Kleiner als H√∂he */
        width: 27px;
        /* --- ANGEPASST: Slider Knob Position --- */
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input:checked + .slider {
        background-color: var(--slider-checked-bg-color);
      }
      input:checked + .slider:before {
        /* --- ANGEPASST: Slider Knob Translation --- */
        /* 51px (Breite) - 27px (Knob) - 2px (linker Abstand) - 2px (rechter Abstand) = 20px */
        /* Deine Anpassung: 30px */
        transform: translateX(30px);
      }

      /* Farbige Werte */
      .positive-value {
        color: var(--system-blue-light);
        font-weight: 500;
      }
      .negative-value {
        color: var(--system-orange-light);
        font-weight: 500;
      }
      .zero-value {
        color: var(--system-green-light);
        font-weight: 500;
      }
      @media (prefers-color-scheme: dark) {
        .positive-value { color: var(--system-blue-dark); }
        .negative-value { color: var(--system-orange-dark); }
        .zero-value { color: var(--system-green-dark); }
      }
      /* F√ºr Readonly-Felder */
      input[readonly].positive-value { color: var(--system-blue-light); }
      input[readonly].negative-value { color: var(--system-orange-light); }
      input[readonly].zero-value { color: var(--system-green-light); }
      @media (prefers-color-scheme: dark) {
        input[readonly].positive-value { color: var(--system-blue-dark); }
        input[readonly].negative-value { color: var(--system-orange-dark); }
        input[readonly].zero-value { color: var(--system-green-dark); }
      }

      /* Hinweis Box */
      #hinweis {
        margin-top: 15px;
        padding: 10px;
        background-color: rgba(255, 59, 48, 0.1); /* Leicht roter Hintergrund */
        border: 1px solid var(--hint-color);
        color: var(--hint-color);
        border-radius: 8px;
        font-size: 15px;
        display: none; /* Standardm√§√üig ausblenden */
      }
      .invalid-time {
        border-color: var(--hint-color) !important;
        box-shadow: 0 0 0 1px var(--hint-color) !important;
      }

      /* Bottom Navigation */
      #bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        /* --- ANGEPASST: H√∂he der Navigationsleiste --- */
        height: calc(30px + var(--safe-area-bottom)); /* Kleinere Basish√∂he */
        background-color: var(--nav-background);
        border-top: 0.5px solid var(--separator-color);
        display: flex;
        justify-content: space-around;
        align-items: flex-start; /* Icons obenb√ºndig */
        padding-top: 5px; /* Abstand Icons nach oben */
        padding-bottom: var(--safe-area-bottom); /* Abstand f√ºr Home Bar */
        z-index: 1000;
      }
      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start; /* Inhalt oben starten */
        color: var(--nav-icon-color);
        font-size: 10px;
        text-decoration: none;
        flex: 1;
        padding-top: 2px; /* Kleiner Abstand f√ºr Icon */
        background: none;
        border: none;
        cursor: pointer;
      }
      .nav-item svg {
        width: 24px;
        height: 24px;
        margin-bottom: 1px;
        fill: currentColor;
      }
      .nav-item.active {
        color: var(--nav-icon-active-color);
      }

      /* History Page */
      #history-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .history-item {
        background-color: var(--card-background-color);
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--separator-color);
      }
      .history-entry-content {
        flex-grow: 1;
        margin-right: 10px;
      }
      .history-entry-content div:first-child {
        font-weight: 500;
        margin-bottom: 3px;
      }
      .history-entry-content div:last-child {
        font-size: 15px;
        color: var(--secondary-text-color);
      }
      .history-entry-content.no-data div:last-child {
        font-style: italic;
      }
      .history-entry-content.special-day {
        border-radius: 6px;
        padding: 5px 8px;
        margin: -5px 0; /* Adjust padding */
      }
      .history-entry-content.violation-day {
         /* Optional: Add visual cue for violation days */
         /* border-left: 3px solid var(--system-red-light); */
      }
      .violation-mark {
          color: var(--system-red-light);
          font-weight: bold;
          font-size: 18px;
          margin-left: 4px;
      }
      @media (prefers-color-scheme: dark) {
        .violation-mark { color: var(--system-red-dark); }
      }
      .history-actions {
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }
      .diff-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        color: var(--button-text-color); /* Wei√üer Text */
        margin-left: 5px;
        vertical-align: middle;
      }
      .diff-badge.positive-value { background-color: var(--positive-value-bg); }
      .diff-badge.negative-value { background-color: var(--negative-value-bg); }
      .diff-badge.zero-value { background-color: var(--zero-value-bg); }

      #week-navigation, #month-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: var(--card-background-color);
        border-radius: 8px;
        border: 1px solid var(--separator-color);
      }
      #week-navigation > div, #month-navigation > div {
        text-align: center;
        flex-grow: 1;
      }
      #week-info, #month-year-display {
        font-weight: 600;
        font-size: 18px;
      }
      #week-range {
        font-size: 14px;
        color: var(--secondary-text-color);
      }
      #pagination button, #month-navigation button {
         flex-grow: 0; /* Buttons nicht strecken */
         width: auto;
         padding: 8px 15px;
         background-color: var(--input-background-color);
         color: var(--system-blue-light);
         border: 1px solid var(--separator-color);
      }
      @media (prefers-color-scheme: dark) {
        #pagination button, #month-navigation button {
          color: var(--system-blue-dark);
        }
      }

      #weekly-summary, #month-summary {
        margin-top: 15px;
        padding: 10px 15px;
        background-color: var(--card-background-color);
        border-radius: 8px;
        border: 1px solid var(--separator-color);
        font-weight: 500;
      }

      /* Modal Styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1500; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
      .modal-content {
        background-color: var(--background-color);
        padding: 25px;
        border-radius: 14px;
        width: 100%;
        max-width: 400px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--separator-color);
      }
      .modal-header h2 {
        margin: 0;
        font-size: 20px;
        border-bottom: none;
        padding-bottom: 0;
      }
      .close-button {
        background: none;
        border: none;
        font-size: 28px;
        font-weight: 300;
        color: var(--secondary-text-color);
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        position: absolute;
        top: 15px;
        right: 15px;
      }
      .modal-content label {
        font-size: 16px;
        margin-top: 10px;
      }
      .modal-content input[type="time"],
      .modal-content input[type="text"] {
        margin-bottom: 10px;
      }
      .modal-content .button-group {
        margin-top: 25px;
      }
      #detail-content p {
        margin-bottom: 8px;
        font-size: 16px;
      }
      #detail-content strong {
        color: var(--secondary-text-color);
        margin-right: 5px;
      }

      /* Month View (Calendar) */
      #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
      }
      .calendar-header {
        text-align: center;
        font-weight: 500;
        font-size: 14px;
        color: var(--secondary-text-color);
        padding-bottom: 5px;
      }
      .calendar-day {
        aspect-ratio: 1 / 1; /* Make cells square */
        background-color: var(--card-background-color);
        border-radius: 6px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        border: 1px solid var(--separator-color);
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .calendar-day.empty {
        background-color: transparent;
        border: none;
        cursor: default;
      }
      .calendar-day.weekend {
         /* background-color: var(--system-tertiary-background-light); */
         /* Optional: leicht anderer Hintergrund f√ºr Wochenende */
      }
      .calendar-day-content {
        font-size: 15px;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 6px; /* Match parent */
      }
      .calendar-day-content.weekend-text {
        color: var(--secondary-text-color);
      }
      .calendar-day.no-entry:hover {
        background-color: var(--input-background-color);
      }
      .calendar-day-content.today {
        border: 2px solid var(--system-red-light);
      }
      @media (prefers-color-scheme: dark) {
        .calendar-day-content.today { border-color: var(--system-red-dark); }
      }
      /* Color classes for calendar days */
      .calendar-day-content.positive-value { background-color: var(--positive-value-bg); color: var(--button-text-color); }
      .calendar-day-content.negative-value { background-color: var(--negative-value-bg); color: var(--button-text-color); }
      .calendar-day-content.zero-value { background-color: var(--zero-value-bg); color: var(--button-text-color); }
      .calendar-day-content.special-day-urlaub-bg { background-color: var(--special-day-urlaub-bg); color: var(--special-day-text); }
      .calendar-day-content.special-day-krank-bg { background-color: var(--special-day-krank-bg); color: var(--special-day-text); }

      /* Stats Page */
      #stats-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
      }
      #stats-controls label {
        margin-bottom: 0;
        flex-shrink: 0;
      }
      #stats-controls select {
        margin-bottom: 0;
        flex-grow: 1;
      }
      #stats-content {
        list-style: none;
        padding: 15px;
        margin: 0;
        background-color: var(--card-background-color);
        border-radius: 8px;
        border: 1px solid var(--separator-color);
      }
      #stats-content li {
        padding: 8px 0;
        border-bottom: 1px solid var(--separator-color);
        display: flex;
        justify-content: space-between;
        font-size: 16px;
      }
      #stats-content li:last-child {
        border-bottom: none;
      }
      #stats-content li span {
        font-weight: 500;
        text-align: right;
      }
      #stats-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      #stats-actions button {
        flex: 1;
      }

    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- Main Page -->
      <div id="main-page" class="page">
        <div class="container">
          <h1>Arbeitszeitrechner</h1>

          <div class="input-group">
            <div>
              <label for="kommen-display">Kommen:</label>
              <input type="time" id="kommen-display" />
            </div>
            <div>
              <label for="gehen-display">Gehen:</label>
              <input type="time" id="gehen-display" />
            </div>
          </div>

          <div class="button-group">
            <button onclick="setZeit('kommen')">Jetzt Kommen</button>
            <button onclick="setZeit('gehen')">Jetzt Gehen</button>
          </div>

          <div class="switch-container" style="margin-top: 20px">
            <label class="switch">
              <input type="checkbox" id="pc-buchung" />
              <span class="slider"></span>
            </label>
            <span>PC-Buchung (-8 Min)</span>
          </div>

          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="buero-toggle" />
              <span class="slider"></span>
            </label>
            <span>Im B√ºro (sonst Homeoffice)</span>
          </div>

          <h2>Einstellungen</h2>
          <label for="wochenarbeitszeit">Wochenarbeitszeit (Std):</label>
          <input
            type="number"
            id="wochenarbeitszeit"
            value="38"
            step="0.5"
          />

          <label for="zusatzliche-pause">Zus. Pause (hh:mm / h.hh):</label>
          <input type="text" id="zusatzliche-pause" placeholder="z.B. 0:15 oder 0.25" />

          <label for="aktuelles-konto">Aktuelles Stundenkonto (Dezimal):</label>
          <input type="number" id="aktuelles-konto" value="0.00" step="0.01" />
          <input type="text" id="aktuelles-konto-time" readonly />


          <h2>Berechnung</h2>
          <label>Anwesenheitszeit:</label>
          <input type="text" id="anwesend-zeit" readonly />
          <label>Pausenzeit (Gesetzlich + Zus.):</label>
          <input type="text" id="pausenzeit" readonly />
          <label>Netto-Arbeitszeit:</label>
          <input type="text" id="arbeitszeit" readonly />
          <label>Sollarbeitszeit (pro Tag):</label>
          <input type="text" id="sollarbeitszeit-display" readonly />

          <div class="input-group">
            <div>
              <label>Differenz (Dezimal):</label>
              <input type="text" id="differenz" readonly />
            </div>
            <div>
              <label>Differenz (Zeit):</label>
              <input type="text" id="differenz-time" readonly />
            </div>
          </div>

          <div class="input-group">
            <div>
              <label>Neues Stundenkonto (Dezimal):</label>
              <input type="text" id="neues-konto" readonly />
            </div>
            <div>
              <label>Neues Stundenkonto (Zeit):</label>
              <input type="text" id="neues-konto-time" readonly />
            </div>
          </div>

          <div id="hinweis"></div>

          <button onclick="saveDay()" style="margin-top: 20px">
            Heutigen Tag speichern
          </button>

          <h2>Voraussichtliche Endzeiten</h2>
          <label>F√ºr Soll-AZ:</label>
          <input type="text" id="end-time-soll" readonly />
          <label>F√ºr 4 Stunden Netto:</label>
          <input type="text" id="end-time-4h" readonly />
          <label>F√ºr 6 Stunden Netto:</label>
          <input type="text" id="end-time-6h" readonly />
          <label>F√ºr 9 Stunden Netto:</label>
          <input type="text" id="end-time-9h" readonly />
          <label>F√ºr 10 Stunden Netto:</label>
          <input type="text" id="end-time-10h" readonly />

        </div>
      </div>

      <!-- History Page -->
      <div id="history-page" class="page">
        <div class="container">
          <h1>Verlauf</h1>
          <div id="week-navigation">
             <button id="prev-week" class="inline-button">‚Äπ</button>
             <div>
                 <div id="week-info">KW XX / YYYY</div>
                 <div id="week-range">TT.MM.YYYY - TT.MM.YYYY</div>
             </div>
             <button id="next-week" class="inline-button">‚Ä∫</button>
          </div>
          <div id="pagination" style="text-align: center; margin-bottom: 15px;">
             <!-- Buttons werden per JS eingef√ºgt -->
          </div>
          <ul id="history-list">
            <!-- Eintr√§ge werden per JS geladen -->
          </ul>
          <div id="weekly-summary">
             <span id="weekly-summary-content">Gesamtdifferenz: 0:00 (0.00h)</span>
          </div>
        </div>
      </div>

      <!-- Month Page -->
      <div id="month-page" class="page">
        <div class="container">
          <h1>Monats√ºbersicht</h1>
          <div id="month-navigation">
            <button id="prev-month" class="inline-button">‚Äπ</button>
            <div id="month-year-display">Monat Jahr</div>
            <button id="next-month" class="inline-button">‚Ä∫</button>
          </div>
          <div id="calendar-grid">
            <!-- Kalender wird per JS gef√ºllt -->
          </div>
           <div id="month-summary">
             <span id="month-summary-content">Monatsdifferenz: 0:00 (0.00h)</span>
          </div>
        </div>
      </div>

      <!-- Stats Page -->
      <div id="stats-page" class="page">
        <div class="container">
          <h1>Statistik</h1>
          <div id="stats-controls">
             <label for="stats-period">Zeitraum:</label>
             <select id="stats-period">
                 <option value="current_month">Aktueller Monat</option>
                 <option value="last_month">Letzter Monat</option>
                 <option value="current_year">Aktuelles Jahr</option>
                 <option value="last_year">Letztes Jahr</option>
                 <option value="all_time" selected>Gesamter Zeitraum</option>
             </select>
          </div>
          <ul id="stats-content">
             <!-- Statistik wird per JS geladen -->
             <li>L√§dt...</li>
          </ul>
          <div id="stats-actions">
              <button id="export-button">Verlauf exportieren (JSON)</button>
              <button id="import-button">Verlauf importieren (JSON)</button>
          </div>
        </div>
      </div>

      <!-- Bottom Navigation Bar -->
      <nav id="bottom-nav">
        <button id="nav-main" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg>
          <span>Rechner</span>
        </button>
        <button id="nav-history" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z"/></svg>
          <span>Verlauf</span>
        </button>
         <button id="nav-month" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zM5 8V6h14v2H5z"/></svg>
          <span>Monat</span>
        </button>
        <button id="nav-stats" class="nav-item">
           <svg viewBox="0 0 24 24"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>
          <span>Statistik</span>
        </button>
      </nav>
    </div>

    <!-- Add Day Modal -->
    <div id="add-day-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="add-day-modal-title">Buchung hinzuf√ºgen</h2>
          <button class="close-button">&times;</button>
        </div>
        <label for="add-day-kommen">Kommen:</label>
        <input type="time" id="add-day-kommen" />
        <label for="add-day-gehen">Gehen:</label>
        <input type="time" id="add-day-gehen" />

        <div class="switch-container" style="margin-top: 15px">
          <label class="switch">
            <input type="checkbox" id="pc-buchung-add-day" />
            <span class="slider"></span>
          </label>
          <span>PC-Buchung (-8 Min)</span>
        </div>

        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="buero-add-day" />
            <span class="slider"></span>
          </label>
          <span>Im B√ºro (sonst Homeoffice)</span>
        </div>

        <!-- Hinzugef√ºgtes Pausenfeld -->
        <div style="margin-top: 15px;">
          <label for="add-day-zusatzliche-pause">Zus. Pause (hh:mm / h.hh):</label>
          <input type="text" id="add-day-zusatzliche-pause" placeholder="z.B. 0:15 oder 0.25">
        </div>
        <!-- Ende Hinzuf√ºgung -->


        <h3 style="margin-top: 20px;">Sondertag?</h3>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="urlaub-toggle" onchange="toggleSpecialDay('urlaub')" />
            <span class="slider"></span>
          </label>
          <span>Urlaub</span>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="krank-toggle" onchange="toggleSpecialDay('krank')" />
            <span class="slider"></span>
          </label>
          <span>Krank</span>
        </div>
         <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="schulung-toggle" onchange="toggleSpecialDay('schulung')" />
            <span class="slider"></span>
          </label>
          <span>Schulung</span>
        </div>

        <div class="button-group">
          <button onclick="addManualDay()">Speichern</button>
          <button
            onclick="closeAddDayModal()"
            style="background-color: var(--system-gray-light)"
          >
            Abbrechen
          </button>
        </div>
      </div>
    </div>

     <!-- Detail Modal -->
    <div id="detail-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="detail-modal-title">Details</h2>
          <button class="close-button">&times;</button>
        </div>
        <div id="detail-content">
            <!-- Details werden per JS geladen -->
        </div>
         <div class="button-group">
          <button onclick="closeDetailModal()">Schlie√üen</button>
        </div>
      </div>
    </div>
  </body>
</html>
