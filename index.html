<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#f2f2f7" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Arbeitszeit" />
  <link rel="apple-touch-icon" href="https://NuclearMeltdown.github.io/apple-touch-icon.png" />
  <link rel="apple-touch-startup-image" href="https://NuclearMeltdown.github.io/apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon.png" />
  <meta name="application-name" content="Arbeitszeitrechner" />
  <meta name="msapplication-TileColor" content="#000000" />
  <meta name="msapplication-TileImage" content="https://NuclearMeltdown.github.io/mstile-144x144.png" />

  <title>Arbeitszeitrechner</title>

  <script>
    // Globale Variablen
    const app = {
      zeit: { kommen: null, gehen: null },
      view: { current: "main" },
      dates: {
        weekYear: null,
        weekNo: null,
        monthYear: null,
        month: null
      },
      balanceMarkers: []
    };

    // Globale Einstellungen (werden aus LS geladen)
    const settings = {
      wochenarbeitszeit: 38,
      bundesland: "NATIONAL",
      allowWochenende: false,
      allowNachtarbeit: false,
      ezaActive: false,
      ezaKontoStand: 0,
      ezaKontoStandMs: 0,
    };

    // Hilfsfunktionen
    const $ = (id) => document.getElementById(id);
    const pad = (num) => num.toString().padStart(2, "0");

    // Helper function to convert decimal hours to milliseconds
    const decimalHToMs = (h) => Math.round(h * 3600_000);
    // Helper constant
    const MS_PER_HOUR = 3600_000;

    // Parst hh:mm und gibt ein lokales Date-Objekt zurück
    function parseTime(str) {
      if (!str) return null;
      const match = str.match(/^(\d{2}):(\d{2})$/);
      if (!match) return null;
      const hh = parseInt(match[1], 10);
      const mm = parseInt(match[2], 10);
      if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
        return null;
      const now = new Date(); // Lokales Datum
      now.setHours(hh, mm, 0, 0); // Setzt lokale Zeit
      return now;
    }

    // Formatiert ein Date-Objekt als hh:mm in der lokalen Zeitzone
    function formatTime(date) {
      if (!date || isNaN(date.getTime())) return "--:--";
      const hours = date.getHours(); // Lokale Stunden
      const minutes = date.getMinutes(); // Lokale Minuten
      return `${pad(hours)}:${pad(minutes)}`;
    }

    // Formatiert ein Date-Objekt als lokalen ISO-ähnlichen String
    function formatLocalDateTimeString(date) {
      if (!date || isNaN(date.getTime())) return null;
      const YYYY = date.getFullYear();
      const MM = pad(date.getMonth() + 1);
      const DD = pad(date.getDate());
      const hh = pad(date.getHours());
      const mm = pad(date.getMinutes());
      const ss = pad(date.getSeconds());
      return `${YYYY}-${MM}-${DD}T${hh}:${mm}:${ss}`; // Ohne 'Z' oder Offset
    }

    // Formatiert Dezimalstunden in hh:mm
    function formatDecimalToTime(decimalH) {
      if (isNaN(decimalH)) return "0:00";
      const sign = decimalH < 0 ? "-" : "";
      const absVal = Math.abs(decimalH);
      // Wichtig: Hier weiterhin runden für die hh:mm Anzeige
      const totalMinutes = Math.round(absVal * 60);
      const hh = Math.floor(totalMinutes / 60);
      const mm = totalMinutes % 60;
      return `${sign}${hh}:${pad(mm)}`;
    }

    // Schneidet Dezimalzahl nach N Stellen ab (Trunkierung)
    function truncateDecimals(number, digits) {
      const multiplier = Math.pow(10, digits);
      return Math.floor(number * multiplier) / multiplier;
    }

    // Formatiert EZA-Konto in Tage + Stunden
    function formatEzaKonto(totalHours) {
      if (isNaN(totalHours)) return "0 Tage + 0.0h";
      const sollProTag = settings.wochenarbeitszeit / 5;
      if (sollProTag <= 0) return `(${totalHours.toFixed(1)}h)`;

      const sign = totalHours < 0 ? "-" : "";
      const absHours = Math.abs(totalHours);

      const fullDays = Math.floor(absHours / sollProTag);
      const remainingHours = absHours % sollProTag;

      return `${sign}${fullDays} Tag${fullDays !== 1 ? "e" : ""
        } + ${remainingHours.toFixed(1)}h`;
    }

    function storeToLS(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (e) {
        console.error("Error saving to localStorage", e);
        alert(
          "Fehler beim Speichern der Daten. Möglicherweise ist der Speicher voll."
        );
      }
    }

    function getFromLS(key, defaultVal = null) {
      try {
        const val = localStorage.getItem(key);
        return val !== null ? val : defaultVal;
      } catch (e) {
        console.error("Error reading from localStorage", e);
        return defaultVal;
      }
    }

    function getHistory() {
      const history = JSON.parse(getFromLS("history", "[]"));
      history.forEach((entry) => {
        entry.datum = entry.datum || "1970-01-01";
        entry.differenzMs = entry.differenzMs || 0;
        entry.stundenkontoMs = entry.stundenkontoMs || 0;
        entry.kommen = entry.kommen || null;
        entry.gehen = entry.gehen || null;
        entry.urlaub = entry.urlaub || false;
        entry.krank = entry.krank || false;
        entry.schulung = entry.schulung || false;
        entry.glaz = entry.glaz || false;
        entry.pcBuchung = entry.pcBuchung || false;
        entry.buero = entry.buero || false;
        entry.isEzaTag = entry.isEzaTag || false;
        entry.ezaActiveDuringBooking =
          entry.ezaActiveDuringBooking || false;
        entry.zusatzPause = entry.zusatzPause || "";
        // NEU: Stelle sicher, dass historische Sollzeiten vorhanden sind (Fallback)
        entry.usedWochenarbeitszeit = entry.usedWochenarbeitszeit || settings.wochenarbeitszeit; // Fallback auf aktuelle Settings
        entry.usedSollProTag = entry.usedSollProTag || (entry.usedWochenarbeitszeit / 5);

        const datePart = entry.datum || "1970-01-01";
        entry.dateObj = new Date(datePart + "T12:00:00Z"); // UTC für Konsistenz bei Sortierung
      });
      history.sort((a, b) => a.dateObj - b.dateObj);
      history.forEach((entry) => delete entry.dateObj); // Entferne temporäres Objekt
      return history;
    }

    // --- Feiertagslogik (unverändert) ---
    const holidays = {
      NATIONAL: {
        "01-01": "Neujahr",
        "05-01": "Tag der Arbeit",
        "10-03": "Tag der Deutschen Einheit",
        "12-25": "1. Weihnachtstag",
        "12-26": "2. Weihnachtstag",
      },
      BW: { "01-06": "Heilige Drei Könige", "11-01": "Allerheiligen" },
      BY: {
        "01-06": "Heilige Drei Könige",
        "08-15": "Mariä Himmelfahrt",
        "11-01": "Allerheiligen",
      },
      BE: { "03-08": "Internationaler Frauentag" },
      BB: { "10-31": "Reformationstag" },
      HB: { "10-31": "Reformationstag" },
      HH: { "10-31": "Reformationstag" },
      HE: {},
      MV: { "10-31": "Reformationstag" },
      NI: { "10-31": "Reformationstag" },
      NW: { "11-01": "Allerheiligen" },
      RP: { "11-01": "Allerheiligen" },
      SL: { "08-15": "Mariä Himmelfahrt", "11-01": "Allerheiligen" },
      SN: { "10-31": "Reformationstag" },
      ST: { "01-06": "Heilige Drei Könige", "10-31": "Reformationstag" },
      SH: { "10-31": "Reformationstag" },
      TH: { "09-20": "Weltkindertag", "10-31": "Reformationstag" },
    };
    const regionalMovableHolidays = {
      BW: ["fronleichnam"],
      BY: ["fronleichnam"],
      HE: ["fronleichnam"],
      NW: ["fronleichnam"],
      RP: ["fronleichnam"],
      SL: ["fronleichnam"],
      SN: ["bussbettag"],
    };
    function getEasterSunday(year) {
      const a = year % 19,
        b = Math.floor(year / 100),
        c = year % 100;
      const d = Math.floor(b / 4),
        e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4),
        k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31);
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(Date.UTC(year, month - 1, day));
    }
    function getHolidayName(date, bundesland) {
      if (!date || isNaN(date.getTime())) return null;
      const year = date.getUTCFullYear();
      const month = date.getUTCMonth() + 1;
      const day = date.getUTCDate();
      const mmdd = `${pad(month)}-${pad(day)}`;

      if (holidays.NATIONAL[mmdd]) return holidays.NATIONAL[mmdd];
      const regionalFixed = holidays[bundesland] || {};
      if (regionalFixed[mmdd]) return regionalFixed[mmdd];

      const easterSunday = getEasterSunday(year);
      const movableHolidays = {};

      const goodFriday = new Date(easterSunday);
      goodFriday.setUTCDate(easterSunday.getUTCDate() - 2);
      movableHolidays[
        `${pad(goodFriday.getUTCMonth() + 1)}-${pad(goodFriday.getUTCDate())}`
      ] = "Karfreitag";

      const easterMonday = new Date(easterSunday);
      easterMonday.setUTCDate(easterSunday.getUTCDate() + 1);
      movableHolidays[
        `${pad(easterMonday.getUTCMonth() + 1)}-${pad(
          easterMonday.getUTCDate()
        )}`
      ] = "Ostermontag";

      const ascensionDay = new Date(easterSunday);
      ascensionDay.setUTCDate(easterSunday.getUTCDate() + 39);
      movableHolidays[
        `${pad(ascensionDay.getUTCMonth() + 1)}-${pad(
          ascensionDay.getUTCDate()
        )}`
      ] = "Christi Himmelfahrt";

      const whitMonday = new Date(easterSunday);
      whitMonday.setUTCDate(easterSunday.getUTCDate() + 50);
      movableHolidays[
        `${pad(whitMonday.getUTCMonth() + 1)}-${pad(whitMonday.getUTCDate())}`
      ] = "Pfingstmontag";

      if (regionalMovableHolidays[bundesland]?.includes("fronleichnam")) {
        const corpusChristi = new Date(easterSunday);
        corpusChristi.setUTCDate(easterSunday.getUTCDate() + 60);
        movableHolidays[
          `${pad(corpusChristi.getUTCMonth() + 1)}-${pad(
            corpusChristi.getUTCDate()
          )}`
        ] = "Fronleichnam";
      }
      if (regionalMovableHolidays[bundesland]?.includes("bussbettag")) {
        const nov23 = new Date(Date.UTC(year, 10, 23)); // November 23rd UTC
        const dayOfWeekNov23 = nov23.getUTCDay(); // 0=Sun, 1=Mon, ..., 3=Wed, ...
        const daysToSubtract = (dayOfWeekNov23 + 4) % 7;
        const bussBettag = new Date(nov23);
        bussBettag.setUTCDate(nov23.getUTCDate() - daysToSubtract);
        movableHolidays[
          `${pad(bussBettag.getUTCMonth() + 1)}-${pad(
            bussBettag.getUTCDate()
          )}`
        ] = "Buß- und Bettag";
      }
      return movableHolidays[mmdd] || null;
    }
    // --- ENDE Feiertagslogik ---

    // *** NEUE HILFSFUNKTIONEN für Marker ***
    function getBalanceMarkers() {
      const markers = JSON.parse(getFromLS("balanceMarkers", "[]"));
      // Stelle sicher, dass kontostand ein String ist (für Konsistenz)
      markers.forEach(m => m.kontostand = String(m.kontostand || "0"));
      markers.sort((a, b) => a.datum.localeCompare(b.datum)); // Sortiere nach Datum
      return markers;
    }

    function storeBalanceMarkers(markers) {
      markers.sort((a, b) => a.datum.localeCompare(b.datum)); // Immer sortiert speichern
      storeToLS("balanceMarkers", JSON.stringify(markers));
    }

    function loadSettings() {
      settings.wochenarbeitszeit = parseFloat(
        getFromLS("wochenarbeitszeitValue", "38")
      );
      settings.bundesland = getFromLS("bundesland", "NATIONAL");
      settings.allowWochenende = getFromLS("allowWochenende") === "true";
      settings.allowNachtarbeit = getFromLS("allowNachtarbeit") === "true";
      settings.ezaActive = getFromLS("ezaActive") === "true";
      settings.ezaKontoStand = parseFloat(getFromLS("ezaKontoStand", "0"));
      settings.ezaKontoStandMs = decimalHToMs(settings.ezaKontoStand);
      $("wochenarbeitszeit").value = settings.wochenarbeitszeit.toFixed(1);
    }

    function saveSettings() {
      storeToLS(
        "wochenarbeitszeitValue",
        settings.wochenarbeitszeit.toString()
      );
      storeToLS("bundesland", settings.bundesland);
      storeToLS(
        "allowWochenende",
        settings.allowWochenende ? "true" : "false"
      );
      storeToLS(
        "allowNachtarbeit",
        settings.allowNachtarbeit ? "true" : "false"
      );
      storeToLS("ezaActive", settings.ezaActive ? "true" : "false");
      $("wochenarbeitszeit").value = settings.wochenarbeitszeit.toFixed(1);
      // Neuberechnung ist nicht *immer* nötig, nur wenn sich Sollzeit ändert
      // Wird jetzt im Event Listener für wochenarbeitszeit-setting gemacht
      // updateCalculations(); // Nur UI der Hauptseite aktualisieren
      // if (currentView === "history") loadHistory();
      // if (currentView === "month") loadMonthData();
      if (app.view.current === "options") loadOptions(); // Optionen neu laden
      // saveAndReload(getHistory()); // Nicht hier, sonst bei jeder kleinen Änderung Neuberechnung
    }

    function saveEzaKonto() {
      const inputVal = $("eza-konto-input").value;
      const newStand = parseFloat(inputVal);

      if (isNaN(newStand)) {
        alert("Bitte einen gültigen Zahlenwert für das EZA-Konto eingeben.");
        $("eza-konto-input").value = settings.ezaKontoStand.toFixed(2);
        return;
      }

      settings.ezaKontoStand = newStand;
      settings.ezaKontoStandMs = decimalHToMs(newStand);
      storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
      storeToLS("ezaKontoStandMs", settings.ezaKontoStandMs.toString());
      updateEzaKontoDisplay();
      alert("EZA-Kontostand gespeichert.");
      // EZA-Kontostand-Änderung erfordert keine Neuberechnung des Hauptkontos
    }

    function updateEzaKontoDisplay() {
      const displayField = $("eza-konto-display");
      if (displayField) {
        displayField.value = formatEzaKonto(settings.ezaKontoStand);
      }
      const inputField = $("eza-konto-input");
      if (inputField) {
        if (document.activeElement !== inputField) {
          inputField.value = settings.ezaKontoStand.toFixed(2);
        }
      }
    }

    // *** GEÄNDERTE init() Funktion ***
    function init() {
      loadSettings();
      app.balanceMarkers = getBalanceMarkers(); // Lade Marker beim Start
      restoreInputsFromLocalStorage();
      const heute = new Date();
      [app.dates.weekYear, app.dates.weekNo] = getWeekNumber(heute);
      app.dates.monthYear = heute.getFullYear();
      app.dates.month = heute.getMonth();

      // Initialen Kontostand laden (wird von saveAndReload ggf. angepasst)
      let lastKontoValueMs = 0;
      const lastKontoStoredMs = getFromLS("aktuellesStundenkontoMs");
      if (lastKontoStoredMs) {
        lastKontoValueMs = parseInt(lastKontoStoredMs, 10);
      } else {
        // Wenn kein aktueller Stand da ist, neu berechnen lassen
        const history = getHistory();
        saveAndReload(history); // Neuberechnung erzwingen
        const updatedHistory = getHistory(); // Neu holen nach Neuberechnung
        if (updatedHistory.length > 0) {
          lastKontoValueMs = parseInt(
            updatedHistory[updatedHistory.length - 1].stundenkontoMs || "0", 10
          );
        } else {
          // Wenn History leer ist, Startwert oder letzten Marker nehmen
          const sortedMarkers = getBalanceMarkers(); // Holen und sortieren
          if (sortedMarkers.length > 0) {
            lastKontoValueMs = decimalHToMs(parseFloat(sortedMarkers[sortedMarkers.length - 1].kontostand));
          } else {
            lastKontoValueMs = decimalHToMs(parseFloat(getFromLS("initialKontoValue", "0")));
          }
        }
        storeToLS("aktuellesStundenkontoMs", lastKontoValueMs.toString());
      }

      $("aktuelles-konto").value = msToDecimalH(lastKontoValueMs).toFixed(2);
      $("aktuelles-konto-time").value = msToTimeString(lastKontoValueMs);

      updateEzaKontoDisplay();
      updateCalculations();
      switchView("main");
      setupEventListeners();
      closeAddDayModal();
      closeDetailModal();
      closeBulkModal();
      closeLegendModal();
      closeAddMarkerModal(); // Sicherstellen, dass es geschlossen ist
    }

    // *** GEÄNDERTE setupEventListeners() Funktion ***
    function setupEventListeners() {
      $("nav-main").addEventListener("click", () => switchView("main"));
      $("nav-history").addEventListener("click", () => switchView("history"));
      $("nav-month").addEventListener("click", () => switchView("month"));
      $("nav-stats").addEventListener("click", () => switchView("stats"));
      $("nav-options").addEventListener("click", () => switchView("options"));
      $("kommen-display").oninput = onInputChange;
      $("gehen-display").oninput = onInputChange;
      $("pc-buchung").onchange = onInputChange; // Trigger update
      $("buero-toggle").onchange = onInputChange;
      $("zusatzliche-pause").oninput = onInputChange;
      document.querySelectorAll(".close-button").forEach((btn) => {
        btn.onclick = () => {
          const modal = btn.closest(".modal");
          if (modal) modal.style.display = "none";
          // Spezifische Close-Handler, falls nötig
          if (modal && modal.id === 'add-marker-modal') closeAddMarkerModal();
        };
      });
      $("stats-period").onchange = () => calculateAndDisplayStats();
      $("urlaub-toggle").onchange = () => toggleSpecialDay("urlaub");
      $("krank-toggle").onchange = () => toggleSpecialDay("krank");
      $("schulung-toggle").onchange = () => toggleSpecialDay("schulung");
      $("glaz-toggle").onchange = () => toggleSpecialDay("glaz");
      $("eza-tag-toggle").onchange = () => toggleSpecialDay("ezaTag");
      $("open-bulk-modal-button").addEventListener("click", showBulkModal);
      $("apply-bulk-modal-button").addEventListener(
        "click",
        applyBulkBooking
      );
      $("bundesland-select").onchange = (e) => {
        settings.bundesland = e.target.value;
        saveSettings();
        // Neuberechnung nicht nötig, nur Feiertagsanzeige betroffen
        if (app.view.current === 'history') loadHistory();
        if (app.view.current === 'month') loadMonthData();
        if (app.view.current === 'stats') calculateAndDisplayStats();
      };
      $("wochenarbeitszeit-setting").onchange = (e) => {
        const val = parseFloat(e.target.value);
        if (!isNaN(val) && val > 0) {
          settings.wochenarbeitszeit = val;
          saveSettings(); // Speichert neuen Wert
          // Wichtig: Neuberechnung anstoßen, da sich Sollzeit für *zukünftige* Einträge ändert
          // saveAndReload berechnet nur Kontostände neu, nicht die Differenzen alter Einträge
          saveAndReload(getHistory());
          updateCalculations(); // Aktualisiert Anzeige auf Hauptseite
        } else {
          e.target.value = settings.wochenarbeitszeit.toFixed(1); // Reset bei ungültiger Eingabe
        }
      };
      $("wochenende-toggle").onchange = (e) => {
        settings.allowWochenende = e.target.checked;
        saveSettings();
        // Neuberechnung nicht nötig, nur Anzeige/Buchung betroffen
        if (app.view.current === 'history') loadHistory();
        if (app.view.current === 'month') loadMonthData();
      };
      $("nachtarbeit-toggle").onchange = (e) => {
        settings.allowNachtarbeit = e.target.checked;
        saveSettings();
        // Neuberechnung nicht nötig, nur Anzeige/Warnungen betroffen
        updateCalculations(); // Aktualisiert Hauptseite (Warnungen)
        if (app.view.current === 'history') loadHistory(); // Aktualisiert Verlauf (Symbole)
        if (app.view.current === 'month') loadMonthData(); // Aktualisiert Monat (Symbole)
      };
      $("export-button-options").addEventListener("click", exportHistoryToJson);
      $("import-button-options").addEventListener("click", importHistoryFromJson);
      $("eza-toggle").onchange = (e) => {
        settings.ezaActive = e.target.checked;
        saveSettings();
        // Neuberechnung anstoßen, da EZA-Logik sich ändert und Differenzen beeinflusst
        saveAndReload(getHistory());
        updateCalculations(); // Aktualisiert Hauptseite
      };
      $("eza-konto-speichern-button").addEventListener("click", saveEzaKonto);
      $("show-legend-button").addEventListener("click", showLegendModal);
      // NEU: Listener für Marker-Button
      $("add-marker-button").addEventListener("click", showAddMarkerModal);
    }

    function restoreInputsFromLocalStorage() {
      const storedKommen = getFromLS("kommenZeitValue");
      const storedGehen = getFromLS("gehenZeitValue");
      if (storedKommen) {
        $("kommen-display").value = storedKommen;
        app.zeit.kommen = parseTime(storedKommen); // Parse original time
      }
      if (storedGehen) {
        $("gehen-display").value = storedGehen;
        app.zeit.gehen = parseTime(storedGehen);
      }
      $("pc-buchung").checked = getFromLS("pcBuchungChecked") === "true";
      $("buero-toggle").checked = getFromLS("bueroChecked") === "true";
      const storedPause = getFromLS("zusatzlichePauseValue");
      if (storedPause) $("zusatzliche-pause").value = storedPause;
    }

    function storeInputsToLocalStorage() {
      storeToLS("kommenZeitValue", $("kommen-display").value);
      storeToLS("gehenZeitValue", $("gehen-display").value);
      storeToLS(
        "pcBuchungChecked",
        $("pc-buchung").checked ? "true" : "false"
      );
      storeToLS(
        "bueroChecked",
        $("buero-toggle").checked ? "true" : "false"
      );
      storeToLS("zusatzlichePauseValue", $("zusatzliche-pause").value);
    }

    function setZeit(type) {
      const now = new Date();
      if (type === "kommen") {
        app.zeit.kommen = now; // Store original time
        $("kommen-display").value = formatTime(app.zeit.kommen);
      } else {
        app.zeit.gehen = now;
        $("gehen-display").value = formatTime(app.zeit.gehen);
      }
      storeInputsToLocalStorage();
      updateCalculations();
    }

    function onInputChange() {
      app.zeit.kommen = parseTime($("kommen-display").value); // Parse original time
      app.zeit.gehen = parseTime($("gehen-display").value);
      storeInputsToLocalStorage();
      updateCalculations();
    }

    // Parst Pauseneingabe (hh:mm oder h.hh) und gibt Dezimalstunden zurück
    function parsePauseInput(inputId) {
      const val = $(inputId).value;
      if (!val) return 0;
      const cleanedVal = val.replace(",", ".");
      if (cleanedVal.includes(":")) {
        const parts = cleanedVal.split(":");
        const hh = parseInt(parts[0], 10) || 0;
        const mm = parseInt(parts[1], 10) || 0;
        return hh + mm / 60;
      } else {
        const decimalHours = parseFloat(cleanedVal);
        return isNaN(decimalHours) ? 0 : decimalHours;
      }
    }

    // Berechnet die reine Anwesenheitszeit (Millisekunden)
    function calculatePresenceMs(start, end) {
      if (!start || !end) return 0;
      let endAdjusted = new Date(end.getTime());
      if (endAdjusted < start)
        endAdjusted.setDate(endAdjusted.getDate() + 1);
      const diffMs = endAdjusted - start;
      return diffMs > 0 ? diffMs : 0;
    }

    // Berechnet Netto-Arbeitszeit in Millisekunden
    function calculateWorkMs(start, end, additionalPauseH, isPcBuchung) {
      const rawMs = calculatePresenceMs(start, end);
      if (rawMs <= 0) return 0;
      // automatische Pause: 30 Min nach 6h Anwesenheit
      const mandatoryPauseMs = rawMs > 6 * MS_PER_HOUR ? 30 * 60000 : 0;
      // manuelle Pause
      const manualPauseMs = decimalHToMs(additionalPauseH);
      let netMs = rawMs - mandatoryPauseMs - manualPauseMs;
      // PC-Buchung +0.13h
      if (isPcBuchung) netMs += decimalHToMs(0.13);
      return Math.max(0, netMs);
    }

    // Utility: Millisekunden in Dezimalstunden
    function msToDecimalH(ms) {
      return ms / MS_PER_HOUR;
    }

    // Utility: Millisekunden in hh:mm Anzeige
    function msToTimeString(ms) {
      const sign = ms < 0 ? '-' : '';
      const absMs = Math.abs(ms);
      const totalMin = Math.round(absMs / 60000);
      const hh = Math.floor(totalMin / 60);
      const mm = totalMin % 60;
      return `${sign}${pad(hh)}:${pad(mm)}`;
    }

    // Berechnet Endzeit (nutzt neue Logik)
    function calculateEndTimeFixpoint(
      desiredNetDecimal, // Gewünschte Netto-AZ (Dezimal)
      start, // Originale Startzeit (Date)
      additionalPauseMainDecimal, // Zus. Pause Hauptseite (Dezimal)
      isPcBuchung // PC-Buchung Hauptseite (Boolean)
    ) {
      if (!start) return "--:--";
      let requiredPresenceDecimal = desiredNetDecimal;
      let calculatedNet = 0;
      let tempEndDate;
      for (let i = 0; i < 15; i++) {
        tempEndDate = new Date(start.getTime());
        tempEndDate.setMinutes(tempEndDate.getMinutes() + Math.round(requiredPresenceDecimal * 60));
        // use calculateWorkMs + msToDecimalH for decimal net
        calculatedNet = msToDecimalH(calculateWorkMs(start, tempEndDate, additionalPauseMainDecimal, isPcBuchung));
        const diff = desiredNetDecimal - calculatedNet;
        if (Math.abs(diff) < 0.002) break;
        requiredPresenceDecimal = Math.max(0, requiredPresenceDecimal + diff);
      }
      const finalEndTime = new Date(start.getTime());
      finalEndTime.setMinutes(finalEndTime.getMinutes() + Math.round(requiredPresenceDecimal * 60));
      return formatTime(finalEndTime);
    }

    function updateEndTimes() {
      const start = app.zeit.kommen;
      const isPc = $("pc-buchung").checked;
      const addPause = parsePauseInput("zusatzliche-pause");
      if (!start) {
        ["soll", "4h", "6h", "9h", "10h"].forEach((id) => {
          const el = $(`end-time-${id}`);
          if (el) el.value = "";
        });
        return;
      }
      [4, 6, 9, 10].forEach((d) => {
        const el = $(`end-time-${d}h`);
        if (el) el.value = calculateEndTimeFixpoint(d, start, addPause, isPc);
      });
      const sollProTagDecimal = settings.wochenarbeitszeit / 5;
      const outS = calculateEndTimeFixpoint(sollProTagDecimal, start, addPause, isPc);
      const elSoll = $("end-time-soll");
      if (elSoll) elSoll.value = `(${sollProTagDecimal.toFixed(2)}h): ${outS}`;
    }

    // Refactor updateCalculations to use milliseconds internally
    function updateCalculations() {
      const start = app.zeit.kommen;
      const end = app.zeit.gehen;
      const isPc = $("pc-buchung").checked;
      const additionalPauseDecimal = parsePauseInput("zusatzliche-pause");

      // ms-basiert
      const presenceMs = calculatePresenceMs(start, end);
      const netWorkMs = calculateWorkMs(start, end, additionalPauseDecimal, isPc);
      // Anzeige der totalen Pause (auto + manuell)
      const mandatoryPauseMsDisp = presenceMs > 6 * MS_PER_HOUR ? 30 * 60000 : 0;
      const totalPauseMs = mandatoryPauseMsDisp + decimalHToMs(additionalPauseDecimal);
      $("pausenzeit").value = `${msToTimeString(totalPauseMs)} (${msToDecimalH(totalPauseMs).toFixed(2)}h)`;

      // Soll in ms und Differenz in ms
      const sollMs = decimalHToMs(settings.wochenarbeitszeit / 5);
      const diffMs = netWorkMs - sollMs;

      // Aktuelles Konto und neues Konto in Millisekunden
      // Load from LS as Ms
      const aktKontoMs = parseInt(getFromLS("aktuellesStundenkontoMs", "0"), 10);
      const newKontoMs = aktKontoMs + diffMs;

      // --- Update Anzeige (Konvertierung nur hier) ---
      const presenceH = msToDecimalH(presenceMs); // For display
      const netH = msToDecimalH(netWorkMs); // For display
      const sollH = msToDecimalH(sollMs); // For display
      const diffHDisplay = msToDecimalH(diffMs); // For display
      const aktKontoH = msToDecimalH(aktKontoMs); // For display
      const newKontoH = msToDecimalH(newKontoMs); // For display

      $("anwesend-zeit").value = `${msToTimeString(presenceMs)} (${presenceH.toFixed(2)}h)`;
      $("arbeitszeit").value = `${msToTimeString(netWorkMs)} (${netH.toFixed(2)}h)`;
      $("sollarbeitszeit-display").value = `${msToTimeString(sollMs)} (${sollH.toFixed(2)}h)`;
      // Display rounded diff for consistency with time format
      const roundedDiffMin = Math.round(diffMs / 60000); // Round minutes
      const diffHRoundedDisplay = roundedDiffMin / 60;
      $("differenz").value = diffHRoundedDisplay.toFixed(2);
      $("differenz-time").value = msToTimeString(diffMs); // Use exact ms for time string
      $("aktuelles-konto").value = aktKontoH.toFixed(2);
      $("aktuelles-konto-time").value = msToTimeString(aktKontoMs);
      $("neues-konto").value = newKontoH.toFixed(2);
      $("neues-konto-time").value = msToTimeString(newKontoMs);

      // Color coding (using display values)
      const fieldsToColor = [
        { id: "differenz", value: diffHRoundedDisplay }, { id: "differenz-time", value: diffHRoundedDisplay },
        { id: "neues-konto", value: newKontoH }, { id: "neues-konto-time", value: newKontoH },
        { id: "aktuelles-konto", value: aktKontoH }, { id: "aktuelles-konto-time", value: aktKontoH },
      ];
      fieldsToColor.forEach((item) => {
        const el = $(item.id);
        if (!el) return;
        el.classList.remove("positive-value", "negative-value", "zero-value");
        // Use a small tolerance for floating point comparisons
        if (item.value > 0.0001) el.classList.add("positive-value");
        else if (item.value < -0.0001) el.classList.add("negative-value");
        else el.classList.add("zero-value");
      });

      // Violation checks (keep using netH for checks like > 10h)
      let hinweisText = "";
      let showKommenMoon = false, showGehenMoon = false, showArbeitszeitMoon = false;
      const violations = checkViolations(start, end, netH);
      if (violations.arbeitszeit && netH > 0) {
        if (settings.allowNachtarbeit) showArbeitszeitMoon = true;
        else hinweisText += "Achtung: Arbeitszeit außerhalb 4-10h!<br>";
      }
      if (violations.kommen) {
        if (settings.allowNachtarbeit) showKommenMoon = true;
        else {
          hinweisText += "Achtung: Kommen außerhalb 06:00-16:00!<br>";
          $("kommen-display").classList.add("invalid-time");
        }
      }
      if (violations.gehen) {
        if (settings.allowNachtarbeit) showGehenMoon = true;
        else {
          hinweisText += "Achtung: Gehen nach 20:00!<br>";
          $("gehen-display").classList.add("invalid-time");
        }
      }
      const hinweis = $("hinweis");
      hinweis.innerHTML = hinweisText;
      hinweis.style.display = hinweisText ? "block" : "none";
      if (showKommenMoon) $("kommen-moon").style.display = "inline";
      if (showGehenMoon) $("gehen-moon").style.display = "inline";
      if (showArbeitszeitMoon) $("arbeitszeit-moon").style.display = "inline";

      updateEndTimes();
    }

    // Refactor saveDay to store milliseconds
    function saveDay() {
      updateCalculations(); // Ensure calculations are fresh
      const today = new Date();
      const dayOfWeek = today.getDay();
      if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) {
        alert("Speichern am Wochenende ist in den Optionen deaktiviert.");
        return;
      }
      const datum = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
      const holidayName = getHolidayName(today, settings.bundesland);
      if (holidayName) {
        alert(`Speichern am Feiertag (${holidayName}) nicht möglich.`);
        return;
      }

      const originalKommenDate = app.zeit.kommen;
      const currentGehen = app.zeit.gehen;
      const isPcBuchung = $("pc-buchung").checked;
      const additionalPauseValue = $("zusatzliche-pause").value || "";
      const isBuero = $("buero-toggle").checked;

      if (!originalKommenDate || !currentGehen) {
        alert("Bitte Kommen- und Gehen-Zeit für die Speicherung angeben.");
        return;
      }

      // Calculate net time in MS
      const netWorkMs = calculateWorkMs(
        originalKommenDate,
        currentGehen,
        parsePauseInput("zusatzliche-pause"),
        isPcBuchung
      );
      const netArbeitszeitDecimal = msToDecimalH(netWorkMs); // Only for violation check

      let gehenCheck = new Date(currentGehen.getTime());
      if (gehenCheck < originalKommenDate)
        gehenCheck.setDate(gehenCheck.getDate() + 1);
      if (gehenCheck < originalKommenDate) {
        alert("Gehen-Zeit liegt vor der Kommen-Zeit!");
        return;
      }

      const violations = checkViolations(
        originalKommenDate,
        gehenCheck,
        netArbeitszeitDecimal // Use decimal for check
      );
      if (violations.any && !settings.allowNachtarbeit) {
        if (
          !confirm(
            "Es liegt ein Verstoß gegen die Gleitzeitregeln vor. Trotzdem speichern?"
          )
        )
          return;
      }

      // Verwende die *aktuellen* Einstellungen für die Sollzeit dieses Eintrags
      const currentWochenAZ = settings.wochenarbeitszeit;
      const currentSollProTag = currentWochenAZ / 5;
      const sollMs = decimalHToMs(currentSollProTag); // Soll in MS

      // Calculate difference in MS
      let mainDifferenceMs = netWorkMs - sollMs;

      const kommenLocalISO = formatLocalDateTimeString(originalKommenDate);
      const gehenLocalISO = formatLocalDateTimeString(currentGehen);

      let history = getHistory();
      const displayDate = today.toLocaleDateString("de-DE");
      const existingIndex = history.findIndex((e) => e.datum === datum);
      const dayData = {
        datum: datum,
        // Store difference in MS
        differenzMs: mainDifferenceMs,
        stundenkontoMs: 0, // Wird von saveAndReload berechnet
        kommen: kommenLocalISO,
        gehen: gehenLocalISO,
        urlaub: false, krank: false, schulung: false, glaz: false, isEzaTag: false,
        ezaActiveDuringBooking: settings.ezaActive,
        pcBuchung: isPcBuchung,
        buero: isBuero,
        zusatzPause: additionalPauseValue,
        // Speichere die zum Zeitpunkt der Buchung gültigen Werte (keep decimal for reference)
        usedWochenarbeitszeit: currentWochenAZ,
        usedSollProTag: currentSollProTag,
      };
      if (existingIndex !== -1) {
        if (!confirm(`Für heute (${displayDate}) existiert bereits ein Eintrag. Überschreiben?`)) return;
        history[existingIndex] = dayData;
      } else {
        history.push(dayData);
      }
      saveAndReload(history); // Recalculates all balances based on stored diffs and markers
      alert("Der Tag wurde gespeichert.");
    }

    // Refactor addManualDay to store milliseconds
    function addManualDay() {
      const dateValStr = $("add-day-modal").getAttribute("data-date"); // YYYY-MM-DD
      if (!dateValStr) { alert("Kein gültiges Datum!"); return; }
      const realDateLocal = new Date(dateValStr + "T00:00:00");
      const realDateUTC = new Date(dateValStr + "T12:00:00Z");

      const holidayName = getHolidayName(realDateUTC, settings.bundesland);
      if (holidayName) { alert(`Speichern am Feiertag (${holidayName}) nicht möglich.`); closeAddDayModal(); return; }
      const dayOfWeek = realDateUTC.getUTCDay();
      if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) { alert("Speichern am Wochenende deaktiviert."); closeAddDayModal(); return; }

      const isUrlaub = $("urlaub-toggle").checked, isKrank = $("krank-toggle").checked,
        isSchulung = $("schulung-toggle").checked, isGlaz = $("glaz-toggle").checked,
        isEzaTag = $("eza-tag-toggle").checked;
      const isBueroAddDay = $("buero-add-day").checked,
        isPcBuchungAddDay = $("pc-buchung-add-day").checked;
      const additionalPauseManualValue = $("add-day-zusatzliche-pause").value;
      let history = getHistory();
      const existingIndex = history.findIndex((e) => e.datum === dateValStr);
      const displayDate = realDateLocal.toLocaleDateString("de-DE");

      // Verwende die *aktuellen* Einstellungen für die Sollzeit dieses Eintrags
      const currentWochenAZ = settings.wochenarbeitszeit;
      const currentSollProTag = currentWochenAZ / 5;
      const currentSollMs = decimalHToMs(currentSollProTag); // Soll in MS
      const currentEzaActive = settings.ezaActive;
      // Load EZA Stand in MS
      let currentEzaStandMs = parseInt(getFromLS("ezaKontoStandMs", "0"), 10);

      let mainDifferenceMs = 0;
      let ezaDifferenceMs = 0;
      const negPointFourHoursMs = decimalHToMs(-0.4); // -0.4h in MS

      // Berechne Differenzen für Sondertage in MS
      if (currentEzaActive) {
        if (isUrlaub || isSchulung) mainDifferenceMs = negPointFourHoursMs;
        else if (isKrank) ezaDifferenceMs = negPointFourHoursMs;
        else if (isGlaz) mainDifferenceMs = -currentSollMs; // Sollzeit als negative Differenz
        else if (isEzaTag) {
          const neededMs = currentSollMs;
          const availableEzaMs = currentEzaStandMs; // Use MS value
          if (availableEzaMs >= neededMs) ezaDifferenceMs = -neededMs;
          else if (availableEzaMs > 0) {
            ezaDifferenceMs = -availableEzaMs;
            mainDifferenceMs = -(neededMs - availableEzaMs); // Remaining deficit affects main balance
          } else mainDifferenceMs = -neededMs; // Full deficit affects main balance
        }
      } else {
        if (isUrlaub || isKrank || isSchulung || isEzaTag) mainDifferenceMs = 0; // No difference if EZA inactive
        else if (isGlaz) mainDifferenceMs = -currentSollMs; // Full deficit
      }

      // Update EZA balance immediately if affected (using MS)
      if (currentEzaActive && ezaDifferenceMs !== 0) {
        settings.ezaKontoStandMs = parseInt(getFromLS("ezaKontoStandMs", "0"), 10) + ezaDifferenceMs; // Update internal setting state
        storeToLS("ezaKontoStandMs", settings.ezaKontoStandMs.toString()); // Store updated MS value
        updateEzaKontoDisplay(); // Update UI
      }

      // Basisdaten für Eintrag
      let dayData = {
        datum: dateValStr,
        differenzMs: 0, // Wird gesetzt
        stundenkontoMs: 0, // Wird neu berechnet
        kommen: null, gehen: null,
        urlaub: isUrlaub, krank: isKrank, schulung: isSchulung, glaz: isGlaz, isEzaTag: isEzaTag,
        ezaActiveDuringBooking: currentEzaActive,
        pcBuchung: false, // Wird gesetzt
        buero: isBueroAddDay,
        zusatzPause: "", // Wird gesetzt
        // Speichere die zum Zeitpunkt der Buchung gültigen Werte (keep decimal for reference)
        usedWochenarbeitszeit: currentWochenAZ,
        usedSollProTag: currentSollProTag,
      };

      // --- Fall 1: Sondertag ---
      if (isUrlaub || isKrank || isSchulung || isGlaz || isEzaTag) {
        dayData.differenzMs = mainDifferenceMs; // Store calculated MS difference
        let label = isUrlaub ? "Urlaub" : isKrank ? "Krank" : isSchulung ? "Schulung" : isGlaz ? "GLAZ" : "EZA-Tag";
        if (existingIndex !== -1) history[existingIndex] = dayData;
        else history.push(dayData);
        saveAndReload(history);
        alert(`${label} für ${displayDate} gespeichert.`);
        closeAddDayModal();
        return;
      }

      // --- Fall 2: Normaler Arbeitstag ---
      const kommenVal = $("add-day-kommen").value, gehenVal = $("add-day-gehen").value;
      if (!kommenVal || !gehenVal) { alert("Bitte Kommen- und Gehen-Zeit angeben!"); return; }
      const kommenDateManual = parseTimeForDate(kommenVal, realDateLocal);
      const gehenDateManual = parseTimeForDate(gehenVal, realDateLocal);
      if (!kommenDateManual || !gehenDateManual) { alert("Ungültige Zeitformate!"); return; }
      if (gehenDateManual < kommenDateManual) gehenDateManual.setDate(gehenDateManual.getDate() + 1);

      const additionalPauseManualHoursDecimal = parsePauseInputFromString(additionalPauseManualValue);
      const netManualMs = calculateWorkMs(
        kommenDateManual, gehenDateManual,
        additionalPauseManualHoursDecimal, isPcBuchungAddDay
      );
      const netManualDecimal = msToDecimalH(netManualMs); // Only for violation check

      const violations = checkViolations(kommenDateManual, gehenDateManual, netManualDecimal);
      if (violations.any && !settings.allowNachtarbeit) {
        if (!confirm("Zeiten verstoßen gegen Regeln. Trotzdem speichern?")) return;
      }

      // Berechne Differenz in MS
      const mainDifferenceDecimalManual = netManualMs - currentSollMs;
      dayData.differenzMs = mainDifferenceDecimalManual; // Store MS difference

      dayData.kommen = formatLocalDateTimeString(kommenDateManual);
      dayData.gehen = formatLocalDateTimeString(gehenDateManual);
      dayData.pcBuchung = isPcBuchungAddDay;
      dayData.zusatzPause = additionalPauseManualValue;

      if (existingIndex !== -1) history[existingIndex] = dayData;
      else history.push(dayData);

      saveAndReload(history);
      alert(`Arbeitstag für ${displayDate} gespeichert.`);
      closeAddDayModal();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>

  <style>
    /* CSS (inkl. Marker-Liste und Modal-Styles) */
    :root {
      /* Light Mode */
      --system-background-light: #f2f2f7;
      --system-secondary-background-light: #ffffff;
      --system-tertiary-background-light: #e5e5ea;
      /* Used for marker list bg */
      --text-color-light: #000000;
      --secondary-text-color-light: rgba(60, 60, 67, 0.6);
      --readonly-text-color-light: rgba(0, 0, 0, 0.75);
      --separator-color-light: rgba(60, 60, 67, 0.29);
      --input-border-color-light: rgba(60, 60, 67, 0.2);
      --system-blue-light: #007aff;
      /* Positiv */
      --system-green-light: #34c759;
      /* Null Saldo */
      --system-red-light: #ff3b30;
      /* Krank / Delete */
      --system-orange-light: #ff9500;
      /* Negativ */
      --system-yellow-light: #ffcc00;
      /* GLAZ */
      --system-teal-light: #5ac8fa;
      /* Urlaub */
      --system-purple-light: #af52de;
      --system-indigo-light: #5856d6;
      /* Holiday */
      --system-pink-light: #ff2d55;
      /* EZA-Tag */
      --system-pastel-green-light: #a1e8b5;
      /* Schulung */
      --system-gray-light: #8e8e93;
      --system-gray2-light: #aeaeb2;

      /* Dark Mode */
      --system-background-dark: #000000;
      --system-secondary-background-dark: #1c1c1e;
      --system-tertiary-background-dark: #2c2c2e;
      /* Used for marker list bg */
      --text-color-dark: #ffffff;
      --secondary-text-color-dark: rgba(235, 235, 245, 0.6);
      --readonly-text-color-dark: rgba(255, 255, 255, 0.75);
      --separator-color-dark: rgba(84, 84, 88, 0.65);
      --input-border-color-dark: rgba(84, 84, 88, 0.5);
      --system-blue-dark: #0a84ff;
      /* Positiv */
      --system-green-dark: #30d158;
      /* Null Saldo */
      --system-red-dark: #ff453a;
      /* Krank / Delete */
      --system-orange-dark: #ff9f0a;
      /* Negativ */
      --system-yellow-dark: #ffd60a;
      /* GLAZ */
      --system-teal-dark: #64d2ff;
      /* Urlaub */
      --system-purple-dark: #bf5af2;
      --system-indigo-dark: #5e5ce6;
      /* Holiday */
      --system-pink-dark: #ff375f;
      /* EZA-Tag */
      --system-pastel-green-dark: #4f8a61;
      /* Schulung */
      --system-gray-dark: #8e8e93;
      --system-gray2-dark: #3a3a3c;

      /* Semantic Colors */
      --background-color: var(--system-background-light);
      --card-background-color: var(--system-secondary-background-light);
      --input-background-color: var(--system-tertiary-background-light);
      --text-color: var(--text-color-light);
      --secondary-text-color: var(--secondary-text-color-light);
      --readonly-text-color: var(--readonly-text-color-light);
      --separator-color: var(--separator-color-light);
      --input-border-color: var(--input-border-color-light);
      --button-background-color: var(--system-blue-light);
      --button-text-color: #ffffff;
      --positive-value-bg: var(--system-blue-light);
      --negative-value-bg: var(--system-orange-light);
      --zero-value-bg: var(--system-green-light);
      --hint-color: var(--system-red-light);
      --delete-button-bg: var(--system-red-light);
      --special-day-urlaub-bg: var(--system-teal-light);
      --special-day-krank-bg: var(--system-red-light);
      --special-day-glaz-bg: var(--system-yellow-light);
      --special-day-schulung-bg: var(--system-pastel-green-light);
      --special-day-eza-bg: var(--system-pink-light);
      --holiday-bg: var(--system-indigo-light);
      --special-day-text: #000000;
      --special-day-krank-text: #ffffff;
      --special-day-glaz-text: #000000;
      --special-day-schulung-text: #000000;
      --special-day-eza-text: #ffffff;
      --holiday-text: #ffffff;
      --nav-background: var(--system-secondary-background-light);
      --nav-icon-color: var(--system-gray-light);
      --nav-icon-active-color: var(--system-blue-light);
      --slider-bg-color: var(--system-gray2-light);
      --slider-checked-bg-color: var(--system-green-light);
      --outline-color: var(--secondary-text-color-light);
      --inactive-indicator-color: var(--secondary-text-color-light);
      --marker-list-bg: var(--system-tertiary-background-light);

      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: var(--system-background-dark);
        --card-background-color: var(--system-secondary-background-dark);
        --input-background-color: var(--system-tertiary-background-dark);
        --text-color: var(--text-color-dark);
        --secondary-text-color: var(--secondary-text-color-dark);
        --readonly-text-color: var(--readonly-text-color-dark);
        --separator-color: var(--separator-color-dark);
        --input-border-color: var(--input-border-color-dark);
        --button-background-color: var(--system-blue-dark);
        --positive-value-bg: var(--system-blue-dark);
        --negative-value-bg: var(--system-orange-dark);
        --zero-value-bg: var(--system-green-dark);
        --hint-color: var(--system-red-dark);
        --delete-button-bg: var(--system-red-dark);
        --special-day-urlaub-bg: var(--system-teal-dark);
        --special-day-krank-bg: var(--system-red-dark);
        --special-day-glaz-bg: var(--system-yellow-dark);
        --special-day-schulung-bg: var(--system-pastel-green-dark);
        --special-day-eza-bg: var(--system-pink-dark);
        --holiday-bg: var(--system-indigo-dark);
        --special-day-text: #000000;
        --special-day-krank-text: #ffffff;
        --special-day-glaz-text: #000000;
        --special-day-schulung-text: #ffffff;
        --special-day-eza-text: #ffffff;
        --holiday-text: #ffffff;
        --nav-background: var(--system-secondary-background-dark);
        --nav-icon-color: var(--system-gray-dark);
        --nav-icon-active-color: var(--system-blue-dark);
        --slider-bg-color: var(--system-gray2-dark);
        --slider-checked-bg-color: var(--system-green-dark);
        --outline-color: var(--secondary-text-color-dark);
        --inactive-indicator-color: var(--secondary-text-color-dark);
        --marker-list-bg: var(--system-tertiary-background-dark);
      }
    }

    html,
    body {
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      height: 100%;
      overflow: hidden;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .page {
      flex-grow: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: var(--safe-area-top) calc(15px + var(--safe-area-left)) calc(105px + var(--safe-area-bottom)) calc(15px + var(--safe-area-right));
      /* Adjusted bottom padding */
      display: none;
    }

    .page.active {
      display: block;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding-bottom: 0;
    }

    h1 {
      font-size: 34px;
      font-weight: 700;
      margin: 10px 0 20px 0;
    }

    h2 {
      font-size: 22px;
      font-weight: 600;
      margin: 25px 0 15px 0;
      border-bottom: 1px solid var(--separator-color);
      padding-bottom: 8px;
    }

    h3 {
      font-size: 17px;
      font-weight: 600;
      margin: 0 0 10px 0;
      color: var(--secondary-text-color);
      text-transform: uppercase;
    }

    label {
      font-size: 15px;
      font-weight: 400;
      color: var(--secondary-text-color);
      display: block;
      margin-bottom: 5px;
    }

    p {
      font-size: 17px;
      line-height: 1.4;
      margin: 5px 0 15px 0;
    }

    .section {
      background-color: var(--card-background-color);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      .section {
        box-shadow: none;
      }
    }

    .button,
    .inline-button,
    .delete-button,
    .add-button,
    .link-button {
      background-color: var(--button-background-color);
      color: var(--button-text-color);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      box-sizing: border-box;
      line-height: 1.2em;
      text-align: center;
      transition: background-color 0.1s ease-in-out;
      -webkit-appearance: none;
      appearance: none;
    }

    .button {
      width: 100%;
      padding: 12px 15px;
      font-size: 17px;
      min-height: 44px;
      margin-bottom: 10px;
    }

    .inline-button,
    .delete-button,
    .add-button {
      font-size: 15px;
      padding: 8px 12px;
      min-height: 36px;
    }

    .delete-button {
      background-color: var(--delete-button-bg);
    }

    .add-button {
      background-color: var(--system-green-light);
    }

    @media (prefers-color-scheme: dark) {
      .add-button {
        background-color: var(--system-green-dark);
      }
    }

    .link-button {
      background: none;
      color: var(--button-background-color);
      padding: 5px 0;
      font-size: 15px;
      text-decoration: none;
      display: inline-block;
      margin-top: 10px;
    }

    .button:active,
    .inline-button:active,
    .delete-button:active,
    .add-button:active,
    .link-button:active {
      filter: brightness(0.85);
    }

    input[type="time"],
    input[type="number"],
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 12px 15px;
      font-size: 17px;
      border: 1px solid var(--input-border-color);
      border-radius: 8px;
      margin-bottom: 10px;
      background-color: var(--input-background-color);
      color: var(--text-color);
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      line-height: 1.2em;
      min-height: 44px;
    }

    #korrektur-datum,
    #korrektur-wert,
    #eza-konto-input,
    #eza-konto-display,
    #marker-date,
    #marker-balance {
      height: 44px;
      box-sizing: border-box;
    }

    /* Ensure consistent height */
    input:read-only {
      background-color: var(--card-background-color);
      color: var(--readonly-text-color);
      cursor: default;
      border: 1px solid var(--input-border-color);
    }

    input:disabled {
      background-color: var(--system-tertiary-background-light);
      color: var(--secondary-text-color);
      opacity: 0.7;
      cursor: not-allowed;
    }

    @media (prefers-color-scheme: dark) {
      input:disabled {
        background-color: var(--system-tertiary-background-dark);
      }
    }

    input[type="time"]::-webkit-calendar-picker-indicator,
    input[type="date"]::-webkit-calendar-picker-indicator {
      display: none;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: flex-end;
    }

    .column {
      flex: 1;
    }

    .column-auto {
      flex: 0 0 auto;
      margin-bottom: 10px;
    }

    .time-button-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
      position: relative;
    }

    .time-button-row input[type="time"],
    .time-button-row .button {
      flex: 1;
      margin-bottom: 0;
    }

    .time-button-row input[type="time"] {
      text-align: center;
    }

    .time-button-row .button {
      padding: 12px 15px;
    }

    .moon-indicator {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      display: none;
      pointer-events: none;
    }

    .moon-mark {
      font-size: 1em;
      vertical-align: baseline;
    }

    .moon-mark-calendar {
      font-size: 0.7em;
      vertical-align: super;
      margin-left: 1px;
    }

    .switch-container {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      min-height: 44px;
    }

    .switch-container span {
      margin-left: 10px;
      font-size: 17px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 65px;
      height: 31px;
      flex-shrink: 0;
    }

    /* iOS Standard Size */
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--slider-bg-color);
      transition: .4s;
      border-radius: 15.5px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    input:checked+.slider {
      background-color: var(--slider-checked-bg-color);
    }

    input:checked+.slider:before {
      transform: translateX(24px);
    }

    /* 51 - 27 - 2*2 = 20 */
    .diff-badge {
      padding: 3px 6px;
      border-radius: 5px;
      font-size: 15px;
      font-weight: 500;
      display: inline-block;
      vertical-align: middle;
    }

    input[readonly].positive-value,
    input[readonly].negative-value,
    input[readonly].zero-value {
      font-size: 17px;
    }

    .positive-value {
      background-color: var(--positive-value-bg) !important;
      color: var(--button-text-color) !important;
    }

    .negative-value {
      background-color: var(--negative-value-bg) !important;
      color: #000000 !important;
    }

    .zero-value {
      background-color: var(--zero-value-bg) !important;
      color: #000000 !important;
    }

    #hinweis {
      color: var(--hint-color);
      font-weight: 500;
      font-size: 15px;
      display: none;
      margin-top: 10px;
      padding: 10px;
      background-color: rgba(255, 59, 48, 0.1);
      border-radius: 8px;
    }

    .invalid-time {
      border-color: var(--hint-color) !important;
      background-color: rgba(255, 59, 48, 0.1) !important;
    }

    #history-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      background-color: var(--card-background-color);
      border-radius: 10px;
      overflow: hidden;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      min-height: 60px;
      border-bottom: 1px solid var(--separator-color);
      gap: 10px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-entry-content {
      flex-grow: 1;
      padding: 5px;
      border-radius: 6px;
      background-color: transparent;
      border-left: 3px solid transparent;
      transition: background-color 0.2s ease;
    }

    .history-entry-content.holiday-day {
      background-color: var(--holiday-bg);
      color: var(--holiday-text);
    }

    .history-entry-content.special-day.special-day-urlaub-bg {
      background-color: var(--special-day-urlaub-bg);
    }

    .history-entry-content.special-day.special-day-krank-bg {
      background-color: var(--special-day-krank-bg);
    }

    .history-entry-content.special-day.special-day-schulung-bg {
      background-color: var(--special-day-schulung-bg);
    }

    .history-entry-content.special-day.special-day-eza-bg {
      background-color: var(--special-day-eza-bg);
    }

    .history-entry-content.special-day.special-day-glaz-bg {
      background-color: var(--special-day-glaz-bg);
    }

    .history-entry-content.special-day[style*="--special-day-text"] {
      color: var(--special-day-text);
    }

    .history-entry-content.special-day[style*="--special-day-krank-text"] {
      color: var(--special-day-krank-text);
    }

    .history-entry-content.special-day[style*="--special-day-glaz-text"] {
      color: var(--special-day-glaz-text);
    }

    .history-entry-content.special-day[style*="--special-day-schulung-text"] {
      color: var(--special-day-schulung-text);
    }

    .history-entry-content.special-day[style*="--special-day-eza-text"] {
      color: var(--special-day-eza-text);
    }

    .history-entry-content.holiday-day div:last-child {
      color: var(--holiday-text);
    }

    .history-entry-content.violation-day {
      border-left: 3px solid var(--hint-color);
      background-color: rgba(255, 59, 48, 0.05);
    }

    .history-entry-content.no-data {
      color: var(--secondary-text-color);
    }

    .history-entry-content div:first-child {
      font-weight: 500;
    }

    .history-entry-content div:last-child {
      font-size: 15px;
      color: var(--secondary-text-color);
      margin-top: 4px;
    }

    .history-entry-content.special-day[style*="--special-day-text"] div:last-child {
      color: var(--special-day-text);
    }

    .history-entry-content.special-day[style*="--special-day-krank-text"] div:last-child {
      color: var(--special-day-krank-text);
    }

    .history-entry-content.special-day[style*="--special-day-glaz-text"] div:last-child {
      color: var(--special-day-glaz-text);
    }

    .history-entry-content.special-day[style*="--special-day-schulung-text"] div:last-child {
      color: var(--special-day-schulung-text);
    }

    .history-entry-content.special-day[style*="--special-day-eza-text"] div:last-child {
      color: var(--special-day-eza-text);
    }

    .history-entry-content.holiday-day div:last-child {
      color: var(--holiday-text);
    }

    .violation-mark {
      color: var(--hint-color);
      font-weight: bold;
    }

    .history-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .history-actions .inline-button,
    .history-actions .delete-button {
      font-size: 20px;
      padding: 5px 8px;
    }

    .eza-related-diff.inactive,
    .eza-tag-label.inactive {
      opacity: 0.6;
      font-style: italic;
    }

    .eza-tag-label.inactive::after {
      content: " (i)";
      font-size: 0.8em;
      vertical-align: super;
      opacity: 0.8;
    }

    .eza-hint-inline {
      font-size: 0.9em;
      color: var(--secondary-text-color);
      cursor: help;
    }

    .history-entry-content.eza-booked-outline-history {
      outline: 1px solid var(--outline-color);
      outline-offset: -2px;
    }

    #weekly-summary,
    #month-summary {
      padding: 15px;
      background-color: var(--card-background-color);
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      font-size: 17px;
      font-weight: 500;
    }

    #pagination,
    #month-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-content {
      background-color: var(--card-background-color);
      border-radius: 14px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      margin: auto;
      color: var(--text-color);
      box-sizing: border-box;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 15px;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--system-gray2-light);
      border: none;
      color: var(--secondary-text-color);
      font-size: 14px;
      font-weight: bold;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      line-height: 1;
      padding: 0;
    }

    @media (prefers-color-scheme: dark) {
      .close-button {
        background: var(--system-gray2-dark);
      }
    }

    .close-button:active {
      filter: brightness(0.85);
    }

    #detail-modal-actions .button {
      font-size: 17px;
    }

    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .calendar-header {
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: var(--secondary-text-color);
      padding-bottom: 10px;
    }

    .calendar-day {
      display: flex;
      justify-content: center;
      align-items: center;
      aspect-ratio: 1 / 1;
      font-size: 16px;
      position: relative;
      cursor: default;
    }

    .calendar-day.empty {
      visibility: hidden;
    }

    .calendar-day.weekend .calendar-day-content {
      color: var(--secondary-text-color);
    }

    .calendar-day.no-entry {
      cursor: pointer;
    }

    .calendar-day.has-entry {
      cursor: pointer;
    }

    .calendar-day.holiday {
      cursor: help;
    }

    .calendar-day-content {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 85%;
      height: 85%;
      border-radius: 50%;
      transition: transform 0.1s ease;
      position: relative;
      box-sizing: border-box;
    }

    .calendar-day-content.positive-value {
      color: var(--button-text-color);
    }

    .calendar-day-content.negative-value {
      color: #000000;
    }

    .calendar-day-content.zero-value {
      color: #000000;
    }

    .calendar-day-content.special-day-urlaub-bg {
      background-color: var(--special-day-urlaub-bg);
      color: var(--special-day-text) !important;
    }

    .calendar-day-content.special-day-krank-bg {
      background-color: var(--special-day-krank-bg);
      color: var(--special-day-krank-text) !important;
    }

    .calendar-day-content.special-day-schulung-bg {
      background-color: var(--special-day-schulung-bg);
      color: var(--special-day-schulung-text) !important;
    }

    .calendar-day-content.special-day-eza-bg {
      background-color: var(--special-day-eza-bg);
      color: var(--special-day-eza-text) !important;
    }

    .calendar-day-content.special-day-glaz-bg {
      background-color: var(--special-day-glaz-bg);
      color: var(--special-day-glaz-text) !important;
    }

    .calendar-day-content.holiday-day {
      background-color: var(--holiday-bg);
      color: var(--holiday-text) !important;
    }

    .calendar-day-content.today {
      font-weight: bold;
      border: 2px solid var(--button-background-color);
    }

    .calendar-day.has-entry .calendar-day-content.today {
      border: 2px solid var(--text-color);
    }

    .calendar-day:active .calendar-day-content {
      transform: scale(0.95);
    }

    .calendar-day-content.eza-booked-outline {
      box-shadow: inset 0 0 0 3px var(--outline-color);
    }

    #stats-content {
      list-style: none;
      padding: 0;
      margin: 0;
      background-color: var(--card-background-color);
      border-radius: 10px;
      overflow: hidden;
    }

    #stats-content li {
      display: flex;
      justify-content: space-between;
      padding: 12px 15px;
      font-size: 17px;
      border-bottom: 1px solid var(--separator-color);
    }

    #stats-content li:last-child {
      border-bottom: none;
    }

    #stats-content li span:last-child {
      font-weight: 500;
      color: var(--secondary-text-color);
    }

    .import-export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .import-export-buttons .button {
      margin-bottom: 0;
    }

    #legend-modal .modal-content {
      max-width: 450px;
    }

    .legend-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .legend-color-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .legend-outline-indicator {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
      border: 3px solid var(--outline-color);
      box-sizing: border-box;
      background-color: var(--card-background-color);
    }

    .legend-text {
      flex-grow: 1;
    }

    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background-color: var(--nav-background);
      border-top: 0.5px solid var(--separator-color);
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      padding-top: 5px;
      padding-bottom: var(--safe-area-bottom);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      color: var(--nav-icon-color);
      text-decoration: none;
      font-size: 10px;
      cursor: pointer;
      padding: 0 2px;
      text-align: center;
      height: 45px;
      box-sizing: border-box;
    }

    .nav-item svg {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
      fill: currentColor;
    }

    .nav-item.active {
      color: var(--nav-icon-active-color);
    }

    /* NEU: Styling für die Marker-Liste in den Optionen */
    .marker-list {
      list-style: none;
      padding: 0;
      margin: 0;
      background-color: var(--marker-list-bg);
      /* Etwas abgesetzt */
      border-radius: 8px;
      padding: 10px;
    }

    .marker-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 5px;
      font-size: 15px;
      border-bottom: 1px solid var(--separator-color);
    }

    .marker-list li:last-child {
      border-bottom: none;
    }

    .marker-list li span {
      flex-grow: 1;
      margin-right: 10px;
    }

    .marker-list li span .diff-badge {
      /* Style für Badge in der Liste */
      margin-left: 5px;
    }

    .marker-list .delete-button {
      flex-shrink: 0;
      /* Verhindert Schrumpfen */
      padding: 4px 8px;
      /* Kleinere Buttons */
      font-size: 14px;
      min-height: auto;
    }

    /* NEU: Styling für das Marker-Modal (nutzt bestehende Modal-Styles) */
    #add-marker-modal .modal-content {
      max-width: 350px;
      /* Etwas schmaler als Detail-Modal */
    }
  </style>
</head>

<body>
  <div id="app-container">
    <!-- Main Page -->
    <div id="main-page" class="page active">
      <div class="container">
        <h1>Arbeitszeit</h1>

        <div class="section">
          <h3>Zeiterfassung</h3>
          <div class="time-button-row">
            <input type="time" id="kommen-display" oninput="onInputChange()" />
            <span id="kommen-moon" class="moon-indicator">🌙</span>
            <button class="button" onclick="setZeit('kommen')">Kommen</button>
          </div>
          <div class="time-button-row">
            <input type="time" id="gehen-display" oninput="onInputChange()" />
            <span id="gehen-moon" class="moon-indicator">🌙</span>
            <button class="button" onclick="setZeit('gehen')">Gehen</button>
          </div>
          <div class="switch-container" style="margin-top: 15px">
            <label class="switch">
              <input type="checkbox" id="pc-buchung" onchange="onInputChange()" />
              <span class="slider"></span>
            </label>
            <span>PC-Buchung (-0.13h)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="buero-toggle" onchange="onInputChange()" />
              <span class="slider"></span>
            </label>
            <span>Im Büro</span>
          </div>
          <p id="hinweis"></p>
        </div>

        <div class="section">
          <h3>Übersicht (Aktuell)</h3>
          <div class="row">
            <div class="column">
              <label for="wochenarbeitszeit">Wochen-AZ (Std):</label>
              <input type="number" id="wochenarbeitszeit" readonly />
            </div>
            <div class="column">
              <label for="zusatzliche-pause">Zus. Pause (hh:mm / h.hh):</label>
              <input type="text" id="zusatzliche-pause" placeholder="z.B. 0:15 oder 0.25" oninput="onInputChange()" />
            </div>
          </div>
          <div class="row">
            <div class="column">
              <label for="aktuelles-konto">Aktuelles Konto (Std):</label>
              <input type="text" id="aktuelles-konto" value="0.00" readonly />
            </div>
            <div class="column">
              <label>Konto (Zeit):</label>
              <input type="text" id="aktuelles-konto-time" readonly />
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Zeitenübersicht (Heute)</h3>
          <div class="row">
            <div class="column">
              <label>Anwesenheit:</label>
              <input type="text" id="anwesend-zeit" readonly />
            </div>
            <div class="column">
              <label>Pause/Freeze (Ges.+Zus.):</label>
              <input type="text" id="pausenzeit" readonly />
            </div>
          </div>
          <div class="row">
            <div class="column" style="position: relative">
              <label>Netto-Arbeitszeit:</label>
              <input type="text" id="arbeitszeit" readonly />
              <span id="arbeitszeit-moon" class="moon-indicator" style="right: 15px">🌙</span>
            </div>
            <div class="column">
              <label>Soll-Arbeitszeit:</label>
              <input type="text" id="sollarbeitszeit-display" readonly />
            </div>
          </div>
          <div class="row">
            <div class="column">
              <label>Differenz (Std):</label>
              <input type="text" id="differenz" readonly />
            </div>
            <div class="column">
              <label>Differenz (Zeit):</label>
              <input type="text" id="differenz-time" readonly />
            </div>
          </div>
          <div class="row">
            <div class="column">
              <label>Neues Konto (Std):</label>
              <input type="text" id="neues-konto" readonly />
            </div>
            <div class="column">
              <label>Neues Konto (Zeit):</label>
              <input type="text" id="neues-konto-time" readonly />
            </div>
          </div>
          <button class="button" onclick="saveDay()">Tag speichern</button>
        </div>

        <div class="section">
          <h3>Ausstempelzeiten</h3>
          <div class="row">
            <div class="column">
              <label>Soll:</label>
              <input type="text" id="end-time-soll" readonly />
            </div>
            <div class="column">
              <label>10h (Max):</label>
              <input type="text" id="end-time-10h" readonly />
            </div>
          </div>
          <div class="row">
            <div class="column">
              <label>4h (Min):</label>
              <input type="text" id="end-time-4h" readonly />
            </div>
            <div class="column">
              <label>6h (+Pause):</label>
              <input type="text" id="end-time-6h" readonly />
            </div>
            <div class="column">
              <label>9h (+Pause):</label>
              <input type="text" id="end-time-9h" readonly />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Page -->
    <div id="history-page" class="page">
      <div class="container">
        <h1>Verlauf</h1>
        <h2 id="week-info"></h2>
        <p id="week-range"
          style="text-align: center; color: var(--secondary-text-color); margin-top: -10px; margin-bottom: 15px;"></p>
        <div id="pagination"></div>
        <ul id="history-list"></ul>
        <div id="weekly-summary">
          <span id="weekly-summary-content">Gesamtdifferenz: --</span>
        </div>
      </div>
    </div>

    <!-- Month Page -->
    <div id="month-page" class="page">
      <div class="container">
        <h1>Monatsübersicht</h1>
        <div id="month-pagination" style="align-items: center">
          <button id="prev-month" class="inline-button">‹</button>
          <h2 id="month-year-display" style="margin: 0; border: none; text-align: center"></h2>
          <button id="next-month" class="inline-button">›</button>
        </div>
        <div id="calendar-grid"></div>
        <div id="month-summary">
          <span id="month-summary-content">Monatsdifferenz: --</span>
        </div>
        <div style="text-align: center">
          <button id="show-legend-button" class="link-button">Legende anzeigen</button>
        </div>
        <button id="open-bulk-modal-button" class="button" style="margin-top: 20px">Bulk-Buchung / Löschen</button>
      </div>
    </div>

    <!-- Stats Page -->
    <div id="stats-page" class="page">
      <div class="container">
        <h1>Statistik</h1>
        <div class="section">
          <label for="stats-period">Zeitraum:</label>
          <select id="stats-period">
            <option value="current_month">Aktueller Monat</option>
            <option value="last_month">Letzter Monat</option>
            <option value="current_year">Aktuelles Jahr</option>
            <option value="last_year">Letztes Jahr</option>
            <option value="all_time">Gesamter Zeitraum</option>
          </select>
        </div>
        <ul id="stats-content">
          <li>Lade Statistik...</li>
        </ul>
      </div>
    </div>

    <!-- Options Page -->
    <div id="options-page" class="page">
      <div class="container">
        <h1>Optionen</h1>
        <div class="section">
          <h3>Allgemein</h3>
          <div style="margin-bottom: 15px">
            <label for="wochenarbeitszeit-setting">Wochenarbeitszeit (Std):</label>
            <input type="number" id="wochenarbeitszeit-setting" step="0.1" />
          </div>
          <div style="margin-bottom: 15px">
            <label for="bundesland-select">Bundesland (für Feiertage):</label>
            <select id="bundesland-select">
              <option value="NATIONAL">Bundesweit</option>
              <option value="BW">Baden-Württemberg</option>
              <option value="BY">Bayern</option>
              <option value="BE">Berlin</option>
              <option value="BB">Brandenburg</option>
              <option value="HB">Bremen</option>
              <option value="HH">Hamburg</option>
              <option value="HE">Hessen</option>
              <option value="MV">Mecklenburg-Vorpommern</option>
              <option value="NI">Niedersachsen</option>
              <option value="NW">Nordrhein-Westfalen</option>
              <option value="RP">Rheinland-Pfalz</option>
              <option value="SL">Saarland</option>
              <option value="SN">Sachsen</option>
              <option value="ST">Sachsen-Anhalt</option>
              <option value="SH">Schleswig-Holstein</option>
              <option value="TH">Thüringen</option>
            </select>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="wochenende-toggle" />
              <span class="slider"></span>
            </label>
            <span>Wochenendarbeit erlauben (Sa/So anzeigen & buchen)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="nachtarbeit-toggle" />
              <span class="slider"></span>
            </label>
            <span>Nacht-/Randzeiten tolerieren (keine Warnung, 🌙 statt !)</span>
          </div>
        </div>

        <div class="section">
          <h3>EZA-Regelung</h3>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="eza-toggle" />
              <span class="slider"></span>
            </label>
            <span>EZA-Regelung aktiv (-0.4h bei U/S, EZA-Konto)</span>
          </div>
          <div class="row">
            <div class="column">
              <label for="eza-konto-input">EZA-Konto (Std):</label>
              <input type="number" id="eza-konto-input" step="0.1" />
            </div>
            <div class="column">
              <label>EZA-Konto (Tage):</label>
              <input type="text" id="eza-konto-display" readonly />
            </div>
            <div class="column-auto">
              <button id="eza-konto-speichern-button" class="inline-button" style="min-height: 44px">Setzen</button>
            </div>
          </div>
          <p style="font-size: 14px; color: var(--secondary-text-color); margin-top: 0px;">
            Aktuellen Stand des EZA-Kontos in Stunden eingeben und setzen.
          </p>
        </div>

        <!-- NEU: Abschnitt für Kontostand-Marker -->
        <div class="section">
          <h3>Kontostand-Marker</h3>
          <p style="font-size: 14px; color: var(--secondary-text-color); margin-top: 0; margin-bottom: 15px;">
            Setze Ankerpunkte (Datum + Kontostand), ab denen der Kontostand neu berechnet wird. Berechnungen vor dem
            letzten Marker bleiben unberührt.
          </p>
          <ul id="balance-marker-list" class="marker-list">
            <!-- Marker werden hier per JS eingefügt -->
            <li>Keine Marker gesetzt.</li>
          </ul>
          <button id="add-marker-button" class="button" style="margin-top: 15px">
            Marker hinzufügen
          </button>
        </div>


        <div class="section">
          <h3>Daten</h3>
          <div class="import-export-buttons">
            <button id="export-button-options" class="button">Export</button>
            <button id="import-button-options" class="button">Import</button>
          </div>
          <p style="font-size: 14px; color: var(--secondary-text-color); margin-top: 10px;">
            Beim Import werden alle vorhandenen Daten überschrieben. Der Export enthält den Verlauf, Marker und die
            aktuellen Einstellungen.
          </p>
        </div>
      </div>
    </div>

    <!-- Detail-Modal -->
    <div id="detail-modal" class="modal" style="display: none">
      <div class="modal-content">
        <button class="close-button">×</button>
        <h3 id="detail-modal-title">Details</h3>
        <div id="detail-content"></div>
        <div id="detail-modal-actions" style="display: flex; gap: 10px; margin-top: 20px">
          <button id="detail-edit-button" class="button">Ändern</button>
          <button id="detail-delete-button" class="button delete-button">Löschen</button>
        </div>
      </div>
    </div>

    <!-- Add Day Modal -->
    <div id="add-day-modal" class="modal" data-date="" style="display: none">
      <div class="modal-content">
        <button class="close-button">×</button>
        <h3 id="add-day-modal-title">Manuelle Buchung</h3>
        <div class="row">
          <div class="column">
            <label for="add-day-kommen">Kommen:</label>
            <input type="time" id="add-day-kommen" />
          </div>
          <div class="column">
            <label for="add-day-gehen">Gehen:</label>
            <input type="time" id="add-day-gehen" />
          </div>
        </div>
        <div style="margin-top: 10px">
          <label for="add-day-zusatzliche-pause">Zus. Pause (hh:mm / h.hh):</label>
          <input type="text" id="add-day-zusatzliche-pause" placeholder="z.B. 0:15 oder 0.25" />
        </div>
        <div class="switch-container" style="margin-top: 15px">
          <label class="switch">
            <input type="checkbox" id="pc-buchung-add-day" />
            <span class="slider"></span>
          </label>
          <span>PC-Buchung (-0.13h)</span>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="buero-add-day" />
            <span class="slider"></span>
          </label>
          <span>Im Büro</span>
        </div>
        <h3 style="margin-top: 20px">Sondertag?</h3>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="urlaub-toggle" onchange="toggleSpecialDay('urlaub')" />
            <span class="slider"></span>
          </label>
          <span>Urlaub</span>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="krank-toggle" onchange="toggleSpecialDay('krank')" />
            <span class="slider"></span>
          </label>
          <span>Krank</span>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="schulung-toggle" onchange="toggleSpecialDay('schulung')" />
            <span class="slider"></span>
          </label>
          <span>Schulung</span>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="glaz-toggle" onchange="toggleSpecialDay('glaz')" />
            <span class="slider"></span>
          </label>
          <span>GLAZ (Gleitzeitabbau)</span>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="eza-tag-toggle" onchange="toggleSpecialDay('ezaTag')" />
            <span class="slider"></span>
          </label>
          <span>EZA-Tag</span>
        </div>
        <button class="button" onclick="addManualDay()" style="margin-top: 20px">Speichern</button>
      </div>
    </div>

    <!-- Bulk Booking Modal -->
    <div id="bulk-booking-modal" class="modal" style="display: none">
      <div class="modal-content">
        <button class="close-button">×</button>
        <h3 id="bulk-modal-title">Bulk-Buchung / Löschen</h3>
        <p style="font-size: 14px; color: var(--secondary-text-color); margin-bottom: 15px;">
          Aktion für Mo-Fr (keine Feiertage). Bestehende Einträge im Zeitraum werden überschrieben oder gelöscht.
          EZA-Logik wird angewendet, falls global aktiv. Die zum Zeitpunkt der Bulk-Buchung gültige Soll-Arbeitszeit
          wird verwendet.
        </p>
        <div class="row">
          <div class="column">
            <label for="bulk-modal-start-date">Von:</label>
            <input type="date" id="bulk-modal-start-date" />
          </div>
          <div class="column">
            <label for="bulk-modal-end-date">Bis:</label>
            <input type="date" id="bulk-modal-end-date" />
          </div>
        </div>
        <div style="margin-bottom: 15px">
          <label for="bulk-modal-special-day-type">Aktion / Typ:</label>
          <select id="bulk-modal-special-day-type">
            <option value="" disabled selected>Aktion auswählen...</option>
            <option value="urlaub">Urlaub buchen</option>
            <option value="krank">Krank buchen</option>
            <option value="schulung">Schulung buchen</option>
            <option value="glaz">GLAZ buchen</option>
            <option value="ezaTag">EZA-Tag buchen</option>
            <option value="delete" style="color: var(--hint-color)">Einträge löschen</option>
          </select>
        </div>
        <button id="apply-bulk-modal-button" class="button" style="margin-top: 10px">Aktion anwenden</button>
      </div>
    </div>

    <!-- Legend Modal -->
    <div id="legend-modal" class="modal" style="display: none">
      <div class="modal-content">
        <button class="close-button">×</button>
        <h3>Legende (Monatsansicht)</h3>
        <ul class="legend-list">
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--special-day-urlaub-bg)"></span><span class="legend-text">Urlaub</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--special-day-krank-bg)"></span><span class="legend-text">Krank</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--special-day-schulung-bg)"></span><span class="legend-text">Schulung</span>
          </li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--special-day-eza-bg)"></span><span class="legend-text">EZA-Tag</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--special-day-glaz-bg)"></span><span class="legend-text">GLAZ</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--positive-value-bg)"></span><span class="legend-text">Positiver Saldo
              (Arbeitstag)</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--negative-value-bg)"></span><span class="legend-text">Negativer Saldo
              (Arbeitstag)</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--zero-value-bg)"></span><span class="legend-text">Null-Saldo
              (Arbeitstag)</span></li>
          <li class="legend-item"><span class="legend-color-dot"
              style="background-color: var(--holiday-bg)"></span><span class="legend-text">Feiertag</span></li>
          <li class="legend-item"><span class="legend-outline-indicator"></span><span class="legend-text">EZA-Regel bei
              Buchung aktiv</span></li>
        </ul>
      </div>
    </div>

    <!-- NEUES Modal für Marker -->
    <div id="add-marker-modal" class="modal" style="display: none">
      <div class="modal-content">
        <button class="close-button" onclick="closeAddMarkerModal()">×</button>
        <h3 id="add-marker-modal-title">Kontostand-Marker hinzufügen/ändern</h3>
        <div style="margin-bottom: 15px">
          <label for="marker-date">Datum:</label>
          <input type="date" id="marker-date" />
        </div>
        <div style="margin-bottom: 15px">
          <label for="marker-balance">Neuer Kontostand (Std) ab Datum:</label>
          <input type="number" id="marker-balance" step="0.01" placeholder="z.B. 15.75" />
        </div>
        <button class="button" onclick="saveBalanceMarker()" style="margin-top: 10px">
          Marker speichern
        </button>
      </div>
    </div>


    <!-- Bottom Navigation -->
    <nav id="bottom-nav">
      <a id="nav-main" class="nav-item active">
        <svg viewBox="0 0 24 24">
          <path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z" />
        </svg>
        <span>Rechner</span>
      </a>
      <a id="nav-history" class="nav-item">
        <svg viewBox="0 0 24 24">
          <path
            d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z" />
        </svg>
        <span>Verlauf</span>
      </a>
      <a id="nav-month" class="nav-item">
        <svg viewBox="0 0 24 24">
          <path
            d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z" />
        </svg>
        <span>Monat</span>
      </a>
      <a id="nav-stats" class="nav-item">
        <svg viewBox="0 0 24 24">
          <path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z" />
        </svg>
        <span>Statistik</span>
      </a>
      <a id="nav-options" class="nav-item">
        <svg viewBox="0 0 24 24">
          <path
            d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52-.4 1.08-.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" />
        </svg>
        <span>Optionen</span>
      </a>
    </nav>
  </div>
</body>

</html>