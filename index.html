<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta
      name="theme-color"
      content="#f2f2f7"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#000000"
      media="(prefers-color-scheme: dark)"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="default"
    />
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit" />
    <link
      rel="apple-touch-icon"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="apple-touch-startup-image"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://NuclearMeltdown.github.io/favicon.png"
    />
    <meta name="application-name" content="Arbeitszeitrechner" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="msapplication-TileImage"
      content="https://NuclearMeltdown.github.io/mstile-144x144.png"
    />

    <title>Arbeitszeitrechner</title>

    <script>
      // Globale Variablen
      let kommenZeit = null,
        gehenZeit = null;
      let currentWeekYear = null,
        currentWeekNo = null;
      let currentMonthYear = null,
        currentMonth = null;
      let currentView = "main"; // main, history, month, stats

      // Hilfsfunktionen
      const $ = (id) => document.getElementById(id);
      const pad = (num) => num.toString().padStart(2, "0");

      function parseTime(str) {
        if (!str) return null;
        const match = str.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        const now = new Date();
        now.setHours(hh, mm, 0, 0);
        return now;
      }

      function formatTime(date) {
        if (!date || isNaN(date.getTime())) return "--:--";
        const hours = date.getHours();
        const minutes = date.getMinutes();
        return `${pad(hours)}:${pad(minutes)}`;
      }

      function formatDecimalToTime(decimalH) {
        if (isNaN(decimalH)) return "0:00";
        const absVal = Math.abs(decimalH);
        const hh = Math.floor(absVal);
        const mm = Math.round((absVal - hh) * 60);
        return `${decimalH < 0 ? "-" : ""}${hh}:${pad(mm)}`;
      }

      function storeToLS(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.error("Error saving to localStorage", e);
          alert(
            "Fehler beim Speichern der Daten. M√∂glicherweise ist der Speicher voll."
          );
        }
      }

      function getFromLS(key, defaultVal = null) {
        try {
          const val = localStorage.getItem(key);
          return val !== null ? val : defaultVal;
        } catch (e) {
          console.error("Error reading from localStorage", e);
          return defaultVal;
        }
      }

      function getHistory() {
        const history = JSON.parse(getFromLS("history", "[]"));
        // Ensure boolean flags exist for older entries
        history.forEach((entry) => {
          entry.urlaub = entry.urlaub || false;
          entry.krank = entry.krank || false;
          entry.schulung = entry.schulung || false;
          entry.glaz = entry.glaz || false; // Add default for GLAZ
          entry.pcBuchung = entry.pcBuchung || false;
          entry.buero = entry.buero || false;
          entry.dateObj = new Date(entry.datum + "T00:00:00");
        });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj);
        return history;
      }

      function init() {
        restoreInputsFromLocalStorage();
        const heute = new Date();
        [currentWeekYear, currentWeekNo] = getWeekNumber(heute);
        currentMonthYear = heute.getFullYear();
        currentMonth = heute.getMonth();

        const lastKonto = getFromLS("aktuellesStundenkonto");
        if (lastKonto) {
          $("aktuelles-konto").value = parseFloat(lastKonto).toFixed(2);
        } else {
          const history = getHistory();
          if (history.length > 0) {
            const lastEntry = history[history.length - 1];
            if (lastEntry.stundenkonto) {
              $("aktuelles-konto").value = parseFloat(
                lastEntry.stundenkonto
              ).toFixed(2);
              storeToLS("aktuellesStundenkonto", lastEntry.stundenkonto);
            }
          }
        }

        updateCalculations();
        switchView("main");
        setupEventListeners();
        closeAddDayModal();
        closeDetailModal();
      }

      function setupEventListeners() {
        $("nav-main").addEventListener("click", () => switchView("main"));
        $("nav-history").addEventListener("click", () => switchView("history"));
        $("nav-month").addEventListener("click", () => switchView("month"));
        $("nav-stats").addEventListener("click", () => switchView("stats"));

        $("kommen-display").oninput = onInputChange;
        $("gehen-display").oninput = onInputChange;
        $("pc-buchung").onchange = onInputChange;
        $("buero-toggle").onchange = onInputChange;
        $("wochenarbeitszeit").onchange = onInputChange;
        $("zusatzliche-pause").oninput = onInputChange;
        $("aktuelles-konto").onchange = onInputChange;

        document.querySelectorAll(".close-button").forEach((btn) => {
          btn.onclick = () => (btn.closest(".modal").style.display = "none");
        });

        $("stats-period").onchange = () => calculateAndDisplayStats();

        $("export-button").addEventListener("click", exportHistoryToJson);
        $("import-button").addEventListener("click", importHistoryFromJson);

        // Event listener for special day toggles in modal
        $("urlaub-toggle").onchange = () => toggleSpecialDay("urlaub");
        $("krank-toggle").onchange = () => toggleSpecialDay("krank");
        $("schulung-toggle").onchange = () => toggleSpecialDay("schulung");
        $("glaz-toggle").onchange = () => toggleSpecialDay("glaz"); // Add listener for GLAZ
      }

      function restoreInputsFromLocalStorage() {
        const storedKommen = getFromLS("kommenZeitValue");
        const storedGehen = getFromLS("gehenZeitValue");
        if (storedKommen) {
          $("kommen-display").value = storedKommen;
          kommenZeit = parseTime(storedKommen);
        }
        if (storedGehen) {
          $("gehen-display").value = storedGehen;
          gehenZeit = parseTime(storedGehen);
        }
        $("pc-buchung").checked = getFromLS("pcBuchungChecked") === "true";
        $("buero-toggle").checked = getFromLS("bueroChecked") === "true";
        const storedPause = getFromLS("zusatzlichePauseValue");
        if (storedPause) $("zusatzliche-pause").value = storedPause;
        const storedWochenAZ = getFromLS("wochenarbeitszeitValue");
        if (storedWochenAZ) $("wochenarbeitszeit").value = storedWochenAZ;
      }

      function storeInputsToLocalStorage() {
        storeToLS("kommenZeitValue", $("kommen-display").value);
        storeToLS("gehenZeitValue", $("gehen-display").value);
        storeToLS("pcBuchungChecked", $("pc-buchung").checked ? "true" : "false");
        storeToLS("bueroChecked", $("buero-toggle").checked ? "true" : "false");
        storeToLS("zusatzlichePauseValue", $("zusatzliche-pause").value);
        storeToLS("wochenarbeitszeitValue", $("wochenarbeitszeit").value);
        storeToLS("aktuellesStundenkonto", $("aktuelles-konto").value);
      }

      function setZeit(type) {
        const now = new Date();
        if (type === "kommen") {
          kommenZeit = now;
          $("kommen-display").value = formatTime(kommenZeit);
        } else {
          gehenZeit = now;
          $("gehen-display").value = formatTime(gehenZeit);
        }
        storeInputsToLocalStorage();
        updateCalculations();
      }

      function onInputChange() {
        kommenZeit = parseTime($("kommen-display").value);
        gehenZeit = parseTime($("gehen-display").value);
        storeInputsToLocalStorage();
        updateCalculations();
      }

      // Helper to parse pause input (hh:mm or h.hh)
      function parsePauseInput(inputId) {
        const val = $(inputId).value;
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          return hh + mm / 60;
        } else {
          const decimalHours = parseFloat(cleanedVal);
          return isNaN(decimalHours) ? 0 : decimalHours;
        }
      }

      function getAdjustedKommenZeit() {
        if (!kommenZeit) return null;
        const adjusted = new Date(kommenZeit.getTime());
        if ($("pc-buchung").checked) {
          adjusted.setMinutes(adjusted.getMinutes() - 8);
        }
        return adjusted;
      }

      function calculateWorkingTime() {
        const ak = getAdjustedKommenZeit();
        if (!ak || !gehenZeit)
          return { hours: 0, minutes: 0, totalHours: 0 };
        let gehenAdjusted = new Date(gehenZeit.getTime());
        if (gehenAdjusted < ak) {
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
        }
        const diffMs = gehenAdjusted - ak;
        if (diffMs < 0) return { hours: 0, minutes: 0, totalHours: 0 };
        const totalMinutes = Math.floor(diffMs / (1000 * 60));
        const hh = Math.floor(totalMinutes / 60);
        const mm = totalMinutes % 60;
        const totalH = totalMinutes / 60;
        return { hours: hh, minutes: mm, totalHours: totalH };
      }

      // Calculates total pause (automatic + additional from main view)
      function calculateGesamtPause(totalHours) {
        let pausen = parsePauseInput("zusatzliche-pause"); // Use main view input
        if (totalHours > 9) pausen += 0.75;
        else if (totalHours > 6) pausen += 0.5;
        return pausen;
      }

      function calculateArbeitszeit() {
        const wTime = calculateWorkingTime();
        if (wTime.totalHours <= 0) return 0;
        const pausen = calculateGesamtPause(wTime.totalHours);
        const netArbeitszeit = wTime.totalHours - pausen;
        return Math.max(0, netArbeitszeit);
      }

      function calculateEndTimeFixpoint(desiredNet) {
        const ak = getAdjustedKommenZeit();
        if (!ak) return "--:--";
        let presence = desiredNet;
        const additionalPauseMain = parsePauseInput("zusatzliche-pause"); // Use main view input
        for (let i = 0; i < 5; i++) {
          const prevPresence = presence;
          let pausen = additionalPauseMain; // Start with additional pause
          if (prevPresence > 9) pausen += 0.75;
          else if (prevPresence > 6) pausen += 0.5;
          presence = desiredNet + pausen;
          if (Math.abs(presence - prevPresence) < 1e-9) break;
        }
        const endTime = new Date(ak.getTime());
        endTime.setMinutes(endTime.getMinutes() + Math.round(presence * 60));
        return formatTime(endTime);
      }

      function updateEndTimes() {
        if (!kommenZeit) {
          ["soll", "4h", "6h", "9h", "10h"].forEach((id) => {
            const el = $(`end-time-${id}`);
            if (el) el.value = "";
          });
          return;
        }
        [4, 6, 9, 10].forEach((d) => {
          const el = $(`end-time-${d}h`);
          if (el) el.value = calculateEndTimeFixpoint(d);
        });
        const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
        const sollProTag = wAZ / 5;
        const outS = calculateEndTimeFixpoint(sollProTag);
        const elSoll = $("end-time-soll");
        if (elSoll) elSoll.value = `(${sollProTag.toFixed(2)}h): ${outS}`;
      }

      function updateCalculations() {
        const netArbeitszeit = calculateArbeitszeit();
        const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
        const sollProTag = wAZ / 5;
        let diff =
          netArbeitszeit > 0
            ? parseFloat((netArbeitszeit - sollProTag).toFixed(2))
            : 0;
        const aktKontoVal = parseFloat($("aktuelles-konto").value) || 0;
        let newKto = parseFloat((aktKontoVal + diff).toFixed(2));
        const wTime = calculateWorkingTime();
        const pausen = calculateGesamtPause(wTime.totalHours); // Use function for total pause
        const pausenMin = Math.round(pausen * 60);
        $("anwesend-zeit").value = `${wTime.hours}:${pad(wTime.minutes)} (${wTime.totalHours.toFixed(2)}h)`;
        $("pausenzeit").value = `${pausenMin} Min (${pausen.toFixed(2)}h)`;
        $("arbeitszeit").value = `${formatDecimalToTime(netArbeitszeit)} (${netArbeitszeit.toFixed(2)}h)`;
        $("sollarbeitszeit-display").value = `${formatDecimalToTime(sollProTag)} (${sollProTag.toFixed(2)}h)`;
        $("differenz").value = diff.toFixed(2);
        $("differenz-time").value = formatDecimalToTime(diff);
        $("neues-konto").value = newKto.toFixed(2);
        $("neues-konto-time").value = formatDecimalToTime(newKto);
        $("aktuelles-konto-time").value = formatDecimalToTime(aktKontoVal);
        const fieldsToColor = [
          { id: "differenz", value: diff },
          { id: "differenz-time", value: diff },
          { id: "neues-konto", value: newKto },
          { id: "neues-konto-time", value: newKto },
          { id: "aktuelles-konto-time", value: aktKontoVal },
        ];
        fieldsToColor.forEach((item) => {
          const el = $(item.id);
          if (!el) return;
          el.classList.remove("positive-value", "negative-value", "zero-value");
          if (item.value > 0.001) el.classList.add("positive-value");
          else if (item.value < -0.001) el.classList.add("negative-value");
          else el.classList.add("zero-value");
        });
        let hinweisText = "";
        const ak = getAdjustedKommenZeit();
        const kommenField = $("kommen-display");
        const gehenField = $("gehen-display");
        kommenField.classList.remove("invalid-time");
        gehenField.classList.remove("invalid-time");
        if (netArbeitszeit > 0 && (netArbeitszeit < 4 || netArbeitszeit > 10)) {
          hinweisText += "Achtung: Arbeitszeit au√üerhalb 4-10h!<br>";
        }
        if (ak) {
          const kStunde = ak.getHours() + ak.getMinutes() / 60;
          if (kStunde < 6 || kStunde > 16) {
            hinweisText += "Achtung: Kommen au√üerhalb 06:00-16:00!<br>";
            kommenField.classList.add("invalid-time");
          }
        }
        if (gehenZeit) {
          let gehenAdjusted = new Date(gehenZeit.getTime());
          if (ak && gehenAdjusted < ak) {
            gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
          }
          const gStunde = gehenAdjusted.getHours() + gehenAdjusted.getMinutes() / 60;
          if (gStunde > 20) {
            hinweisText += "Achtung: Gehen nach 20:00!<br>";
            gehenField.classList.add("invalid-time");
          }
        }
        const hinweis = $("hinweis");
        hinweis.innerHTML = hinweisText;
        hinweis.style.display = hinweisText ? "block" : "none";
        updateEndTimes();
      }

      // Calculates pause based ONLY on duration (for entry data and manual modal)
      function calculateAutoPauseForDuration(totalHours) {
        if (totalHours > 9) return 0.75;
        if (totalHours > 6) return 0.5;
        return 0;
      }

      function checkViolations(kommenDate, gehenDate, arbeitszeit) {
        if (!kommenDate || !gehenDate) return false;
        let gehenAdjusted = new Date(gehenDate.getTime());
        if (gehenAdjusted < kommenDate) {
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
        }
        const kommenStunde = kommenDate.getHours() + kommenDate.getMinutes() / 60;
        const gehenStunde =
          gehenAdjusted.getHours() + gehenAdjusted.getMinutes() / 60;
        return (
          kommenStunde < 6 ||
          kommenStunde > 16 ||
          gehenStunde > 20 ||
          (arbeitszeit > 0 && arbeitszeit < 4) ||
          arbeitszeit > 10
        );
      }

      function saveDay() {
        updateCalculations();
        const today = new Date();
        const dayOfWeek = today.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          alert("Speichern am Wochenende nicht vorgesehen.");
          return;
        }
        const adjustedKommen = getAdjustedKommenZeit();
        const netArbeitszeit = calculateArbeitszeit();
        const currentGehen = gehenZeit ? new Date(gehenZeit.getTime()) : null;
        if (adjustedKommen && currentGehen) {
          let gehenCheck = new Date(currentGehen.getTime());
          if (gehenCheck < adjustedKommen) {
            gehenCheck.setDate(gehenCheck.getDate() + 1);
          }
          if (gehenCheck < adjustedKommen) {
            alert(
              "Gehen-Zeit liegt vor der (ggf. angepassten) Kommen-Zeit!"
            );
            return;
          }
          if (checkViolations(adjustedKommen, gehenCheck, netArbeitszeit)) {
            if (
              !confirm(
                "Es liegt ein Versto√ü gegen die Gleitzeitregeln vor. Trotzdem speichern?"
              )
            ) {
              return;
            }
          }
        } else if (!adjustedKommen || !currentGehen) {
          alert(
            "Bitte Kommen- und Gehen-Zeit f√ºr die Speicherung angeben."
          );
          return;
        }
        const diffVal = parseFloat($("differenz").value) || 0;
        const diffTime = $("differenz-time").value || "0:00";
        const newVal = parseFloat($("neues-konto").value) || 0;
        const datum = today.toISOString().split("T")[0];
        const kommenStr = adjustedKommen ? adjustedKommen.toISOString() : null;
        const gehenStr = currentGehen ? currentGehen.toISOString() : null;
        const isBuero = $("buero-toggle").checked;
        const isPcBuchung = $("pc-buchung").checked;
        // Get additional pause value from main view for saving
        const additionalPauseValue = $("zusatzliche-pause").value || "";

        let history = getHistory();
        const displayDate = today.toLocaleDateString("de-DE");
        const existingIndex = history.findIndex((e) => e.datum === datum);
        const dayData = {
          datum: datum,
          differenz: diffVal.toFixed(2),
          differenzTime: diffTime,
          stundenkonto: newVal.toFixed(2),
          kommen: kommenStr,
          gehen: gehenStr,
          urlaub: false,
          krank: false,
          schulung: false,
          glaz: false, // Add GLAZ flag
          pcBuchung: isPcBuchung,
          buero: isBuero,
          zusatzPause: additionalPauseValue, // Save additional pause value
        };
        if (existingIndex !== -1) {
          if (
            !confirm(
              `F√ºr heute (${displayDate}) existiert bereits ein Eintrag. √úberschreiben?`
            )
          ) {
            return;
          }
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }
        saveAndReload(history);
        alert("Der Tag wurde gespeichert.");
      }

      function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return [d.getUTCFullYear(), weekNo];
      }
      function getDateOfISOWeek(w, y) {
        const simple = new Date(Date.UTC(y, 0, 4 + (w - 1) * 7));
        const dow = simple.getUTCDay() || 7;
        const ISOweekStart = new Date(simple);
        ISOweekStart.setUTCDate(simple.getUTCDate() - dow + 1);
        return ISOweekStart;
      }

      function switchView(viewId) {
        currentView = viewId;
        ["main", "history", "month", "stats"].forEach((id) => {
          const page = $(`${id}-page`);
          const navItem = $(`nav-${id}`);
          if (page) page.style.display = id === viewId ? "block" : "none";
          if (navItem) navItem.classList.toggle("active", id === viewId);
        });
        if (viewId === "history") loadHistory();
        else if (viewId === "month") loadMonthData();
        else if (viewId === "stats") calculateAndDisplayStats();
      }

      function loadHistory() {
        const historyList = $("history-list");
        historyList.innerHTML = "";
        let history = getHistory();
        const weekStartDateUTC = getDateOfISOWeek(currentWeekNo, currentWeekYear);
        const weekEndDate = new Date(weekStartDateUTC);
        weekEndDate.setUTCDate(weekStartDateUTC.getUTCDate() + 4);
        const optionsDate = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          timeZone: "Europe/Berlin",
        };
        const weekRange = `${weekStartDateUTC.toLocaleDateString("de-DE", optionsDate)} - ${weekEndDate.toLocaleDateString("de-DE", optionsDate)}`;
        $("week-info").textContent = `KW ${currentWeekNo} / ${currentWeekYear}`;
        $("week-range").textContent = weekRange;
        const weekdays = [0, 1, 2, 3, 4];
        const optionsWeekday = { weekday: "long", timeZone: "Europe/Berlin" };
        let weeklyTotalDiff = 0;
        weekdays.forEach((dayOffset) => {
          const currentDateUTC = new Date(weekStartDateUTC.getTime());
          currentDateUTC.setUTCDate(weekStartDateUTC.getUTCDate() + dayOffset);
          const currentDateStr = currentDateUTC.toISOString().split("T")[0];
          const displayDate = currentDateUTC.toLocaleDateString(
            "de-DE",
            optionsDate
          );
          const weekdayName = currentDateUTC.toLocaleDateString(
            "de-DE",
            optionsWeekday
          );
          const entry = history.find((e) => e.datum === currentDateStr);
          const li = document.createElement("li");
          li.classList.add("history-item");
          const entryContentDiv = document.createElement("div");
          entryContentDiv.classList.add("history-entry-content");
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("history-actions");
          if (entry) {
            let locationEmoji = entry.buero ? "üè¢" : "üè†";
            let specialDayText = entry.urlaub
              ? "Urlaub"
              : entry.krank
                ? "Krank"
                : entry.schulung
                  ? "Schulung"
                  : entry.glaz // Check for GLAZ
                    ? "GLAZ"
                    : "";
            const diffVal = parseFloat(entry.differenz) || 0; // Always get diff
            weeklyTotalDiff += diffVal; // Always add to weekly total
            const diffClass =
              diffVal > 0.001
                ? "positive-value"
                : diffVal < -0.001
                  ? "negative-value"
                  : "zero-value";

            if (specialDayText) {
              let bgColor = entry.krank
                ? "var(--special-day-krank-bg)"
                : entry.glaz // Style GLAZ like Urlaub
                  ? "var(--special-day-urlaub-bg)"
                  : "var(--special-day-urlaub-bg)";
              entryContentDiv.classList.add("special-day");
              entryContentDiv.style.backgroundColor = bgColor;
              entryContentDiv.style.color = "var(--special-day-text)";
              // Show difference for GLAZ
              const diffDisplay = entry.glaz
                ? `<span class="diff-badge ${diffClass}" style="margin-left: 8px;">${entry.differenzTime}</span>`
                : "";
              entryContentDiv.innerHTML = `
                <div><strong>${weekdayName}</strong> (${displayDate})</div>
                <div>${specialDayText} ${locationEmoji} ${diffDisplay}</div>`;
            } else {
              // Regular work day
              const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
              const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
              // Pass saved additional pause to calculation
              const additionalPauseSaved = parsePauseInputFromString(
                entry.zusatzPause || ""
              );
              const netTime = calculateNetArbeitszeitFromEntryData(
                kommenLokal,
                gehenLokal,
                additionalPauseSaved
              );
              const isViolation = checkViolations(kommenLokal, gehenLokal, netTime);
              const violationMark = isViolation
                ? ' <span class="violation-mark">!</span>'
                : "";
              if (isViolation) entryContentDiv.classList.add("violation-day");
              entryContentDiv.innerHTML = `
                <div><strong>${weekdayName}</strong> (${displayDate})</div>
                <div>
                  ${formatTime(kommenLokal)} - ${formatTime(gehenLokal)} ${locationEmoji}
                  <span class="diff-badge ${diffClass}" style="margin-left: 8px;">${entry.differenzTime}</span>
                  ${violationMark}
                </div>`;
            }
            actionsDiv.innerHTML = `
              <button class="inline-button" onclick="showDayDetails('${entry.datum}')">i</button>
              <button class="delete-button" onclick="deleteEntryByDate('${entry.datum}')">√ó</button>`;
          } else {
            entryContentDiv.classList.add("no-data");
            entryContentDiv.innerHTML = `
              <div><strong>${weekdayName}</strong> (${displayDate})</div>
              <div>Kein Eintrag</div>`;
            actionsDiv.innerHTML = `
               <button class="inline-button add-button" onclick="showAddDayModal('${currentDateStr}')">+</button>`;
          }
          li.appendChild(entryContentDiv);
          li.appendChild(actionsDiv);
          historyList.appendChild(li);
        });
        const diffClassSummary =
          weeklyTotalDiff > 0.001
            ? "positive-value"
            : weeklyTotalDiff < -0.001
              ? "negative-value"
              : "zero-value";
        $("weekly-summary-content").innerHTML = `
        Gesamtdifferenz:
           <span class="diff-badge ${diffClassSummary}">${formatDecimalToTime(weeklyTotalDiff)} (${weeklyTotalDiff.toFixed(2)}h)</span>`;
        updateWeekNavigation();
      }

      // Helper to parse pause string (like from saved data)
      function parsePauseInputFromString(val) {
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          return hh + mm / 60;
        } else {
          const decimalHours = parseFloat(cleanedVal);
          return isNaN(decimalHours) ? 0 : decimalHours;
        }
      }

      // Updated to accept additional pause value
      function calculateNetArbeitszeitFromEntryData(
        kommenLokal,
        gehenLokal,
        additionalPauseHours = 0
      ) {
        if (!kommenLokal || !gehenLokal) return 0;
        let gehenAdjusted = new Date(gehenLokal.getTime());
        if (gehenAdjusted < kommenLokal) {
          gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
        }
        const diffMs = gehenAdjusted - kommenLokal;
        if (diffMs < 0) return 0;
        const totalH = diffMs / (1000 * 60 * 60);
        const autoPause = calculateAutoPauseForDuration(totalH);
        const totalPause = autoPause + additionalPauseHours; // Combine auto + saved additional
        return Math.max(0, totalH - totalPause);
      }

      function deleteEntryByDate(dateStr) {
        let history = getHistory();
        const index = history.findIndex((e) => e.datum === dateStr);
        if (index !== -1) {
          const displayDate = new Date(
            dateStr + "T00:00:00"
          ).toLocaleDateString("de-DE");
          if (
            confirm(
              `M√∂chten Sie den Eintrag f√ºr ${displayDate} wirklich l√∂schen?`
            )
          ) {
            history.splice(index, 1);
            saveAndReload(history);
          }
        }
      }

      function updateWeekNavigation() {
        const pagination = $("pagination");
        pagination.innerHTML = "";
        const createButton = (text, onClick) => {
          const btn = document.createElement("button");
          btn.textContent = text;
          btn.onclick = onClick;
          btn.classList.add("inline-button"); // Einheitlicher Style
          return btn;
        };
        const prevWeekBtn = createButton("‚Äπ Vorige KW", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() - 7);
          [currentWeekYear, currentWeekNo] = getWeekNumber(d);
          loadHistory();
        });
        const nextWeekBtn = createButton("N√§chste KW ‚Ä∫", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() + 7);
          [currentWeekYear, currentWeekNo] = getWeekNumber(d);
          loadHistory();
        });
        pagination.appendChild(prevWeekBtn);
        pagination.appendChild(nextWeekBtn);
      }

      function showAddDayModal(dateStr) {
        const dateVal = new Date(dateStr + "T00:00:00");
        const displayDate = dateVal.toLocaleDateString("de-DE");
        const weekdayName = dateVal.toLocaleDateString("de-DE", {
          weekday: "long",
        });
        $("add-day-modal-title").textContent = `Buchung f√ºr ${weekdayName}, ${displayDate}`;
        $("add-day-kommen").value = "";
        $("add-day-gehen").value = "";
        $("add-day-zusatzliche-pause").value = ""; // Clear pause input
        $("pc-buchung-add-day").checked =
          getFromLS("pcBuchungChecked") === "true";
        $("buero-add-day").checked = getFromLS("bueroChecked") === "true";
        $("urlaub-toggle").checked = false;
        $("krank-toggle").checked = false;
        $("schulung-toggle").checked = false;
        $("glaz-toggle").checked = false; // Clear GLAZ toggle
        toggleTimeFieldsDisabled(false); // Enable fields initially
        $("add-day-modal").setAttribute("data-date", dateStr);
        $("add-day-modal").style.display = "flex";
      }

      function toggleSpecialDay(type) {
        const types = ["urlaub", "krank", "schulung", "glaz"]; // Include GLAZ
        const isChecked = $(type + "-toggle").checked;
        types.forEach((t) => {
          if (t !== type && isChecked) $(t + "-toggle").checked = false;
        });
        // Disable time/pause fields if ANY special day is checked
        const anySpecialChecked = types.some((t) => $(t + "-toggle").checked);
        toggleTimeFieldsDisabled(anySpecialChecked);
      }

      function toggleTimeFieldsDisabled(disabled) {
        $("add-day-kommen").disabled = disabled;
        $("add-day-gehen").disabled = disabled;
        $("add-day-zusatzliche-pause").disabled = disabled; // Disable pause input too
        $("pc-buchung-add-day").disabled = disabled;
      }

      function addManualDay() {
        const dateVal = $("add-day-modal").getAttribute("data-date");
        if (!dateVal) {
          alert("Kein g√ºltiges Datum f√ºr die Buchung!");
          return;
        }
        const realDate = new Date(dateVal + "T00:00:00");
        const dayOfWeek = realDate.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          alert("Samstag und Sonntag sind nicht zul√§ssig!");
          return;
        }
        const isUrlaub = $("urlaub-toggle").checked;
        const isKrank = $("krank-toggle").checked;
        const isSchulung = $("schulung-toggle").checked;
        const isGlaz = $("glaz-toggle").checked; // Check GLAZ
        const isBueroAddDay = $("buero-add-day").checked;
        const isPcBuchungAddDay = $("pc-buchung-add-day").checked;
        const additionalPauseManualValue = $("add-day-zusatzliche-pause").value; // Get pause value

        let history = getHistory();
        const existingIndex = history.findIndex((e) => e.datum === dateVal);
        const displayDate = realDate.toLocaleDateString("de-DE");
        const wAZ = parseFloat($("wochenarbeitszeit").value) || 38;
        const sollProTag = wAZ / 5;
        const lastKonto = findLastKontoBeforeDate(
          history,
          dateVal,
          existingIndex
        );

        let dayData = {
          datum: dateVal,
          differenz: "0.00",
          differenzTime: "0:00",
          stundenkonto: lastKonto.toFixed(2), // Start with previous balance
          kommen: null,
          gehen: null,
          urlaub: isUrlaub,
          krank: isKrank,
          schulung: isSchulung,
          glaz: isGlaz, // Set GLAZ flag
          pcBuchung: false, // Default for special days
          buero: isBueroAddDay,
          zusatzPause: "", // Default pause value
        };

        // Handle Urlaub, Krank, Schulung (Difference = 0)
        if (isUrlaub || isKrank || isSchulung) {
          let label = isUrlaub
            ? "Urlaub"
            : isKrank
              ? "Krank"
              : "Schulung";
          if (existingIndex !== -1) {
            if (
              !confirm(
                `Eintrag f√ºr ${displayDate} existiert. Mit ${label} √ºberschreiben?`
              )
            )
              return;
            history[existingIndex] = dayData;
          } else {
            history.push(dayData);
          }
          saveAndReload(history);
          alert(`${label} f√ºr ${displayDate} eingetragen.`);
          return;
        }

        // Handle GLAZ (Difference = -sollProTag)
        if (isGlaz) {
          const diffValGlaz = -sollProTag;
          const newKtoGlaz = parseFloat((lastKonto + diffValGlaz).toFixed(2));
          dayData.differenz = diffValGlaz.toFixed(2);
          dayData.differenzTime = formatDecimalToTime(diffValGlaz);
          dayData.stundenkonto = newKtoGlaz.toFixed(2);
          let label = "GLAZ";
          if (existingIndex !== -1) {
            if (
              !confirm(
                `Eintrag f√ºr ${displayDate} existiert. Mit ${label} √ºberschreiben?`
              )
            )
              return;
            history[existingIndex] = dayData;
          } else {
            history.push(dayData);
          }
          saveAndReload(history);
          alert(`${label} f√ºr ${displayDate} eingetragen.`);
          return;
        }

        // Handle regular work day
        const kommenVal = $("add-day-kommen").value;
        const gehenVal = $("add-day-gehen").value;
        if (!kommenVal || !gehenVal) {
          alert("Bitte Kommen- und Gehen-Zeit angeben!");
          return;
        }
        const kommenDateManual = parseTimeForDate(kommenVal, realDate);
        const gehenDateManual = parseTimeForDate(gehenVal, realDate);
        if (!kommenDateManual || !gehenDateManual) {
          alert("Ung√ºltige Zeitformate!");
          return;
        }
        if (gehenDateManual < kommenDateManual) {
          gehenDateManual.setDate(gehenDateManual.getDate() + 1);
        }
        let adjustedKommenManual = new Date(kommenDateManual.getTime());
        if (isPcBuchungAddDay) {
          adjustedKommenManual.setMinutes(
            adjustedKommenManual.getMinutes() - 8
          );
        }
        const diffMsManual = gehenDateManual - adjustedKommenManual;
        if (diffMsManual < 0) {
          alert(
            "Angepasste Kommen-Zeit (PC-Buchung) liegt nach der Gehen-Zeit!"
          );
          return;
        }
        const totalHManual = diffMsManual / (1000 * 60 * 60);
        // Calculate pause for manual entry: auto pause + modal's additional pause
        const additionalPauseManualHours = parsePauseInput(
          "add-day-zusatzliche-pause"
        );
        const autoPauseManual = calculateAutoPauseForDuration(totalHManual);
        const pausenManual = autoPauseManual + additionalPauseManualHours;
        const netManual = Math.max(0, totalHManual - pausenManual);

        if (checkViolations(adjustedKommenManual, gehenDateManual, netManual)) {
          if (
            !confirm(
              "Die eingegebenen Zeiten versto√üen gegen die Gleitzeitregeln. Trotzdem speichern?"
            )
          ) {
            return;
          }
        }

        const diffValManual = parseFloat((netManual - sollProTag).toFixed(2));
        const newKtoManual = parseFloat((lastKonto + diffValManual).toFixed(2));
        const diffTimeManual = formatDecimalToTime(diffValManual);

        dayData.differenz = diffValManual.toFixed(2);
        dayData.differenzTime = diffTimeManual;
        dayData.stundenkonto = newKtoManual.toFixed(2);
        dayData.kommen = adjustedKommenManual.toISOString();
        dayData.gehen = gehenDateManual.toISOString();
        dayData.pcBuchung = isPcBuchungAddDay;
        dayData.zusatzPause = additionalPauseManualValue; // Save the entered pause value
        dayData.urlaub = false; // Ensure these are false for work day
        dayData.krank = false;
        dayData.schulung = false;
        dayData.glaz = false;

        if (existingIndex !== -1) {
          if (!confirm(`Eintrag f√ºr ${displayDate} existiert. √úberschreiben?`))
            return;
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }
        saveAndReload(history);
        alert(`Arbeitstag f√ºr ${displayDate} gespeichert.`);
      }

      function parseTimeForDate(timeStr, targetDate) {
        if (!timeStr || !targetDate) return null;
        const match = timeStr.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        const resultDate = new Date(targetDate.getTime());
        resultDate.setHours(hh, mm, 0, 0);
        return resultDate;
      }

      function findLastKontoBeforeDate(history, dateStr, excludeIndex = -1) {
        const targetDate = new Date(dateStr + "T00:00:00");
        const relevantHistory = history
          .filter(
            (entry, index) =>
              index !== excludeIndex &&
              new Date(entry.datum + "T00:00:00") < targetDate
          )
          .sort((a, b) => new Date(b.datum) - new Date(a.datum));
        if (
          relevantHistory.length > 0 &&
          relevantHistory[0].stundenkonto !== undefined
        ) {
          return parseFloat(relevantHistory[0].stundenkonto) || 0;
        }
        // Fallback to global setting if no prior history entry found
        return parseFloat(getFromLS("aktuellesStundenkonto", "0")) || 0;
      }

      function saveAndReload(history) {
        history.forEach((entry) => {
          entry.dateObj = new Date(entry.datum + "T00:00:00");
        });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj);
        storeToLS("history", JSON.stringify(history));
        const latestEntry = history.length > 0 ? history[history.length - 1] : null;
        const latestKonto = latestEntry
          ? parseFloat(latestEntry.stundenkonto || 0)
          : parseFloat(getFromLS("aktuellesStundenkonto", "0")) || 0; // Use global if history empty
        $("aktuelles-konto").value = latestKonto.toFixed(2);
        storeToLS("aktuellesStundenkonto", latestKonto.toFixed(2));
        updateCalculations(); // Update main view calculations
        closeAddDayModal();
        if (currentView === "history") loadHistory();
        if (currentView === "month") loadMonthData();
        if (currentView === "stats") calculateAndDisplayStats();
      }

      function closeAddDayModal() {
        const modal = $("add-day-modal");
        if (modal) modal.style.display = "none";
      }

      function showDayDetails(dateStr) {
        const history = getHistory();
        const entry = history.find((e) => e.datum === dateStr);
        if (!entry) return;
        const entryDate = new Date(dateStr + "T00:00:00");
        const dispDate = entryDate.toLocaleDateString("de-DE");
        const weekdayName = entryDate.toLocaleDateString("de-DE", {
          weekday: "long",
        });
        $("detail-modal-title").textContent = `Details: ${weekdayName}, ${dispDate}`;
        let detailsHTML = "";
        let pausenLabel = "N/A";
        let anwesenheitLabel = "N/A";
        let nettoLabel = "N/A";
        let pcBuchungChecked = !!entry.pcBuchung;
        let bueroEmoji = entry.buero ? "üè¢ B√ºro" : "üè† Homeoffice";
        const diffVal = parseFloat(entry.differenz) || 0;
        const diffClass =
          diffVal > 0.001
            ? "positive-value"
            : diffVal < -0.001
              ? "negative-value"
              : "zero-value";
        const kontoFormatted = formatDecimalToTime(
          parseFloat(entry.stundenkonto || 0)
        );
        const kontoDecimal = parseFloat(entry.stundenkonto || 0).toFixed(2);

        if (entry.urlaub || entry.krank || entry.schulung || entry.glaz) {
          const statusText = entry.urlaub
            ? "Urlaub"
            : entry.krank
              ? "Krank"
              : entry.schulung
                ? "Schulung"
                : "GLAZ"; // Show GLAZ status
          detailsHTML = `
          <p><strong>Status:</strong> ${statusText} ${bueroEmoji}</p>
          <p><strong>Kommen:</strong> --:--</p>
          <p><strong>Gehen:</strong> --:--</p>
          <p><strong>Differenz:</strong> <span class="diff-badge ${diffClass}">${entry.differenzTime} (${entry.differenz}h)</span></p>
          <p><strong>Stundenkonto danach:</strong> ${kontoFormatted} (${kontoDecimal}h)</p>`;
          pcBuchungChecked = false;
        } else {
          // Regular work day details
          const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
          const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
          const kommenFormatted = formatTime(kommenLokal);
          const gehenFormatted = formatTime(gehenLokal);
          const additionalPauseSaved = parsePauseInputFromString(
            entry.zusatzPause || ""
          );

          if (kommenLokal && gehenLokal) {
            let gehenAdjusted = new Date(gehenLokal.getTime());
            if (gehenAdjusted < kommenLokal) {
              gehenAdjusted.setDate(gehenAdjusted.getDate() + 1);
            }
            const diffMs = gehenAdjusted - kommenLokal;
            if (diffMs >= 0) {
              const totalH = diffMs / (1000 * 60 * 60);
              anwesenheitLabel = `${Math.floor(totalH)}:${pad(Math.round((totalH % 1) * 60))} (${totalH.toFixed(2)}h)`;
              const netCalculated = calculateNetArbeitszeitFromEntryData(
                kommenLokal,
                gehenLokal,
                additionalPauseSaved
              );
              nettoLabel = `${formatDecimalToTime(netCalculated)} (${netCalculated.toFixed(2)}h)`;
              const pausenVal = totalH - netCalculated;
              pausenLabel =
                pausenVal > 0
                  ? `${Math.round(pausenVal * 60)} Min (${pausenVal.toFixed(2)}h)`
                  : "0 Min";
              // Add detail about additional pause if present
              if (additionalPauseSaved > 0) {
                pausenLabel += ` (inkl. ${formatDecimalToTime(additionalPauseSaved)} manuell)`;
              }
            }
          }
          detailsHTML = `
          <p><strong>Ort:</strong> ${bueroEmoji}</p>
          <p><strong>Kommen:</strong> ${kommenFormatted} ${pcBuchungChecked ? "(PC-Buchung aktiv)" : ""}</p>
          <p><strong>Gehen:</strong> ${gehenFormatted}</p>
          <p><strong>Anwesenheit:</strong> ${anwesenheitLabel}</p>
          <p><strong>Pause:</strong> ${pausenLabel}</p>
          <p><strong>Netto-Arbeitszeit:</strong> ${nettoLabel}</p>
          <p><strong>Differenz:</strong> <span class="diff-badge ${diffClass}">${entry.differenzTime} (${entry.differenz}h)</span></p>
          <p><strong>Stundenkonto danach:</strong> ${kontoFormatted} (${kontoDecimal}h)</p>`;
        }
        $("detail-content").innerHTML = detailsHTML;
        $("detail-modal").style.display = "flex";
      }

      function closeDetailModal() {
        const modal = $("detail-modal");
        if (modal) modal.style.display = "none";
      }

      const monthNames = [
        "Januar",
        "Februar",
        "M√§rz",
        "April",
        "Mai",
        "Juni",
        "Juli",
        "August",
        "September",
        "Oktober",
        "November",
        "Dezember",
      ];
      function getFirstDayOfMonth(year, month) {
        return new Date(year, month, 1).getDay();
      }
      function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
      }
      function loadMonthData() {
        const history = getHistory();
        const monthData = history.filter((entry) => {
          const entryDate = new Date(entry.datum + "T00:00:00");
          return (
            entryDate.getFullYear() === currentMonthYear &&
            entryDate.getMonth() === currentMonth
          );
        });
        renderCalendar(monthData);
        updateMonthNavigation();
      }
      function renderCalendar(monthData) {
        const calendarGrid = $("calendar-grid");
        calendarGrid.innerHTML = "";
        $("month-year-display").textContent = `${monthNames[currentMonth]} ${currentMonthYear}`;
        const daysInMonth = getDaysInMonth(currentMonthYear, currentMonth);
        let firstDayIndex = getFirstDayOfMonth(currentMonthYear, currentMonth);
        firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
        const weekdays = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
        weekdays.forEach((wd) => {
          const headerCell = document.createElement("div");
          headerCell.classList.add("calendar-header");
          headerCell.textContent = wd;
          calendarGrid.appendChild(headerCell);
        });
        for (let i = 0; i < firstDayIndex; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.classList.add("calendar-day", "empty");
          calendarGrid.appendChild(emptyCell);
        }
        let monthlyTotalDiff = 0;
        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.classList.add("calendar-day");
          const cellContent = document.createElement("div");
          cellContent.classList.add("calendar-day-content");
          cellContent.textContent = day;
          cell.appendChild(cellContent);
          const currentDateStr = `${currentMonthYear}-${pad(currentMonth + 1)}-${pad(day)}`;
          const currentDateObj = new Date(currentMonthYear, currentMonth, day);
          const dayOfWeek = currentDateObj.getDay();
          const entry = monthData.find((e) => e.datum === currentDateStr);
          if (entry) {
            cell.classList.add("has-entry");
            const diffVal = parseFloat(entry.differenz) || 0;
            monthlyTotalDiff += diffVal;
            let diffClass = "";
            let titleText = "";

            if (entry.urlaub || entry.krank || entry.schulung || entry.glaz) {
              diffClass = entry.krank
                ? "special-day-krank-bg"
                : entry.glaz // Style GLAZ like Urlaub
                  ? "special-day-glaz-bg" // Use a specific class for GLAZ styling
                  : "special-day-urlaub-bg";
              titleText = entry.urlaub
                ? "Urlaub"
                : entry.krank
                  ? "Krank"
                  : entry.schulung
                    ? "Schulung"
                    : `GLAZ (${entry.differenzTime})`; // Show diff in title for GLAZ
            } else {
              // Regular work day
              if (diffVal > 0.001) diffClass = "positive-value";
              else if (diffVal < -0.001) diffClass = "negative-value";
              else diffClass = "zero-value";
              titleText = `Differenz: ${entry.differenzTime}`;
            }
            cellContent.classList.add(diffClass);
            cellContent.title = titleText;
            cell.onclick = () => showDayDetails(currentDateStr);
          } else if (dayOfWeek === 0 || dayOfWeek === 6) {
            cell.classList.add("weekend");
            cellContent.classList.add("weekend-text");
          } else {
            cell.classList.add("no-entry");
            cell.onclick = () => showAddDayModal(currentDateStr);
            cellContent.title = "Klicken zum Hinzuf√ºgen";
          }
          const today = new Date();
          if (
            currentDateObj.getFullYear() === today.getFullYear() &&
            currentDateObj.getMonth() === today.getMonth() &&
            currentDateObj.getDate() === today.getDate()
          ) {
            cellContent.classList.add("today");
          }
          calendarGrid.appendChild(cell);
        }
        const diffClassSummary =
          monthlyTotalDiff > 0.001
            ? "positive-value"
            : monthlyTotalDiff < -0.001
              ? "negative-value"
              : "zero-value";
        $("month-summary-content").innerHTML = `
            Monatsdifferenz: <span class="diff-badge ${diffClassSummary}">${formatDecimalToTime(monthlyTotalDiff)} (${monthlyTotalDiff.toFixed(2)}h)</span>`;
      }
      function updateMonthNavigation() {
        $("prev-month").onclick = () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentMonthYear--;
          }
          loadMonthData();
        };
        $("next-month").onclick = () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentMonthYear++;
          }
          loadMonthData();
        };
      }

      function calculateAndDisplayStats() {
        const period = $("stats-period").value;
        const history = getHistory();
        const today = new Date();
        let startDate, endDate;
        today.setHours(12, 0, 0, 0);
        switch (period) {
          case "current_month":
            startDate = new Date(today.getFullYear(), today.getMonth(), 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 12, 0, 0, 0);
            break;
          case "last_month":
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0, 12, 0, 0, 0);
            break;
          case "current_year":
            startDate = new Date(today.getFullYear(), 0, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear(), 11, 31, 12, 0, 0, 0);
            break;
          case "last_year":
            startDate = new Date(today.getFullYear() - 1, 0, 1, 12, 0, 0, 0);
            endDate = new Date(today.getFullYear() - 1, 11, 31, 12, 0, 0, 0);
            break;
          case "all_time":
          default:
            if (history.length === 0) {
              startDate = new Date(today);
              endDate = new Date(today);
            } else {
              startDate = new Date(history[0].datum + "T12:00:00");
              endDate = new Date(history[history.length - 1].datum + "T12:00:00");
            }
            break;
        }
        const filteredHistory = history.filter((entry) => {
          const entryDate = new Date(entry.datum + "T12:00:00");
          return (
            entryDate.setHours(0, 0, 0, 0) >= startDate.setHours(0, 0, 0, 0) &&
            entryDate.setHours(0, 0, 0, 0) <= endDate.setHours(0, 0, 0, 0)
          );
        });
        let totalNetHours = 0;
        let totalDiff = 0;
        let workDays = 0;
        let officeDays = 0;
        let homeDays = 0;
        let vacationDays = 0;
        let sickDays = 0;
        let trainingDays = 0;
        let glazDays = 0; // Counter for GLAZ days

        filteredHistory.forEach((entry) => {
          totalDiff += parseFloat(entry.differenz || 0); // Always add difference

          if (entry.urlaub) vacationDays++;
          else if (entry.krank) sickDays++;
          else if (entry.schulung) trainingDays++;
          else if (entry.glaz) glazDays++; // Count GLAZ days
          else if (entry.kommen && entry.gehen) {
            // Regular work day
            workDays++;
            const kommenLokal = new Date(entry.kommen);
            const gehenLokal = new Date(entry.gehen);
            const additionalPauseSaved = parsePauseInputFromString(
              entry.zusatzPause || ""
            );
            const netHours = calculateNetArbeitszeitFromEntryData(
              kommenLokal,
              gehenLokal,
              additionalPauseSaved
            );
            totalNetHours += netHours;
            if (entry.buero) officeDays++;
            else homeDays++;
          }
        });
        const avgDailyHours = workDays > 0 ? totalNetHours / workDays : 0;
        const statsContent = $("stats-content");
        if (filteredHistory.length === 0) {
          statsContent.innerHTML = `<li>Keine Daten f√ºr den ausgew√§hlten Zeitraum vorhanden.</li>`;
          return;
        }
        statsContent.innerHTML = `
            <li>Gesamt Netto-Arbeitszeit: <span>${formatDecimalToTime(totalNetHours)} (${totalNetHours.toFixed(2)}h)</span></li>
            <li>Durchschnittl. t√§gl. Arbeitszeit: <span>${formatDecimalToTime(avgDailyHours)} (${avgDailyHours.toFixed(2)}h)</span></li>
            <li>Gesamte Differenz: <span class="diff-badge ${totalDiff > 0.001 ? "positive-value" : totalDiff < -0.001 ? "negative-value" : "zero-value"}">${formatDecimalToTime(totalDiff)} (${totalDiff.toFixed(2)}h)</span></li>
            <li>Arbeitstage gesamt: <span>${workDays}</span></li>
            <li>&nbsp;&nbsp;&nbsp;davon B√ºro: <span>${officeDays}</span></li>
            <li>&nbsp;&nbsp;&nbsp;davon Homeoffice: <span>${homeDays}</span></li>
            <li>Urlaubstage: <span>${vacationDays}</span></li>
            <li>Krankheitstage: <span>${sickDays}</span></li>
            <li>Schulungstage: <span>${trainingDays}</span></li>
            <li>GLAZ-Tage: <span>${glazDays}</span></li>`; // Add GLAZ to stats
      }

      function exportHistoryToJson() {
        const history = getHistory();
        if (history.length === 0) {
          alert("Keine Daten zum Exportieren vorhanden.");
          return;
        }
        // Remove temporary dateObj before export if it exists
        const exportHistory = history.map((entry) => {
          const { dateObj, ...rest } = entry;
          return rest;
        });
        const jsonData = JSON.stringify(exportHistory, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const todayStr = new Date().toISOString().split("T")[0];
        a.href = url;
        a.download = `arbeitszeit_export_${todayStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Verlauf wurde als JSON-Datei exportiert.");
      }

      function importHistoryFromJson() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.style.display = "none";
        input.onchange = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);
              if (!Array.isArray(importedData)) {
                throw new Error("Importierte Datei ist kein g√ºltiges JSON-Array.");
              }
              // Basic validation for expected structure
              if (
                importedData.length > 0 &&
                (importedData[0].datum === undefined ||
                  importedData[0].stundenkonto === undefined ||
                  importedData[0].differenz === undefined)
              ) {
                throw new Error(
                  "Struktur der importierten Daten scheint ung√ºltig zu sein (datum, stundenkonto, differenz fehlen?)."
                );
              }
              // Add default values for potentially missing fields during import
              const sanitizedData = importedData.map((entry) => ({
                datum: entry.datum,
                differenz: entry.differenz || "0.00",
                differenzTime: entry.differenzTime || "0:00",
                stundenkonto: entry.stundenkonto || "0.00",
                kommen: entry.kommen || null,
                gehen: entry.gehen || null,
                urlaub: entry.urlaub || false,
                krank: entry.krank || false,
                schulung: entry.schulung || false,
                glaz: entry.glaz || false, // Add default for GLAZ
                pcBuchung: entry.pcBuchung || false,
                buero: entry.buero || false,
                zusatzPause: entry.zusatzPause || "", // Add default for pause
              }));

              if (
                confirm(
                  `M√∂chten Sie wirklich ${sanitizedData.length} Eintr√§ge importieren? ACHTUNG: Alle vorhandenen Daten werden √ºberschrieben!`
                )
              ) {
                saveAndReload(sanitizedData); // Save the sanitized data
                alert("Verlauf erfolgreich importiert.");
              }
            } catch (error) {
              console.error("Fehler beim Importieren:", error);
              alert(`Import fehlgeschlagen: ${error.message}`);
            } finally {
              document.body.removeChild(input);
            }
          };
          reader.onerror = (e) => {
            console.error("Fehler beim Lesen der Datei:", e);
            alert("Fehler beim Lesen der Datei.");
            document.body.removeChild(input);
          };
          reader.readAsText(file);
        };
        document.body.appendChild(input);
        input.click();
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>

    <style>
      :root {
        /* Light Mode */
        --system-background-light: #f2f2f7;
        --system-secondary-background-light: #ffffff;
        --system-tertiary-background-light: #e5e5ea;
        --text-color-light: #000000;
        --secondary-text-color-light: rgba(60, 60, 67, 0.6);
        --readonly-text-color-light: rgba(0, 0, 0, 0.75);
        --separator-color-light: rgba(60, 60, 67, 0.29);
        --input-border-color-light: rgba(60, 60, 67, 0.2);
        --system-blue-light: #007aff;
        --system-green-light: #34c759;
        --system-red-light: #ff3b30;
        --system-orange-light: #ff9500;
        --system-yellow-light: #ffcc00;
        --system-teal-light: #5ac8fa;
        --system-purple-light: #af52de; /* Added for GLAZ */
        --system-gray-light: #8e8e93;
        --system-gray2-light: #aeaeb2;

        /* Dark Mode */
        --system-background-dark: #000000;
        --system-secondary-background-dark: #1c1c1e;
        --system-tertiary-background-dark: #2c2c2e;
        --text-color-dark: #ffffff;
        --secondary-text-color-dark: rgba(235, 235, 245, 0.6);
        --readonly-text-color-dark: rgba(255, 255, 255, 0.75);
        --separator-color-dark: rgba(84, 84, 88, 0.65);
        --input-border-color-dark: rgba(84, 84, 88, 0.5);
        --system-blue-dark: #0a84ff;
        --system-green-dark: #30d158;
        --system-red-dark: #ff453a;
        --system-orange-dark: #ff9f0a;
        --system-yellow-dark: #ffd60a;
        --system-teal-dark: #64d2ff;
        --system-purple-dark: #bf5af2; /* Added for GLAZ */
        --system-gray-dark: #8e8e93;
        --system-gray2-dark: #3a3a3c;

        /* Semantic Colors */
        --background-color: var(--system-background-light);
        --card-background-color: var(--system-secondary-background-light);
        --input-background-color: var(--system-tertiary-background-light);
        --text-color: var(--text-color-light);
        --secondary-text-color: var(--secondary-text-color-light);
        --readonly-text-color: var(--readonly-text-color-light);
        --separator-color: var(--separator-color-light);
        --input-border-color: var(--input-border-color-light);
        --button-background-color: var(--system-blue-light);
        --button-text-color: #ffffff;
        --positive-value-bg: var(--system-blue-light);
        --negative-value-bg: var(--system-orange-light);
        --zero-value-bg: var(--system-green-light);
        --hint-color: var(--system-red-light);
        --special-day-urlaub-bg: var(--system-teal-light);
        --special-day-krank-bg: var(--system-yellow-light);
        --special-day-glaz-bg: var(--system-purple-light); /* Added for GLAZ */
        --special-day-text: #000000; /* Default text for special days */
        --special-day-glaz-text: #ffffff; /* White text for GLAZ */
        --nav-background: var(--system-secondary-background-light);
        --nav-icon-color: var(--system-gray-light);
        --nav-icon-active-color: var(--system-blue-light);
        --slider-bg-color: var(--system-gray2-light);
        --slider-checked-bg-color: var(--system-green-light);

        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        --safe-area-left: env(safe-area-inset-left, 0px);
        --safe-area-right: env(safe-area-inset-right, 0px);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: var(--system-background-dark);
          --card-background-color: var(--system-secondary-background-dark);
          --input-background-color: var(--system-tertiary-background-dark);
          --text-color: var(--text-color-dark);
          --secondary-text-color: var(--secondary-text-color-dark);
          --readonly-text-color: var(--readonly-text-color-dark);
          --separator-color: var(--separator-color-dark);
          --input-border-color: var(--input-border-color-dark);
          --button-background-color: var(--system-blue-dark);
          --positive-value-bg: var(--system-blue-dark);
          --negative-value-bg: var(--system-orange-dark);
          --zero-value-bg: var(--system-green-dark);
          --hint-color: var(--system-red-dark);
          --special-day-urlaub-bg: var(--system-teal-dark);
          --special-day-krank-bg: var(--system-yellow-dark);
          --special-day-glaz-bg: var(--system-purple-dark); /* Added for GLAZ */
          --nav-background: var(--system-secondary-background-dark);
          --nav-icon-color: var(--system-gray-dark);
          --nav-icon-active-color: var(--system-blue-dark);
          --slider-bg-color: var(--system-gray2-dark);
          --slider-checked-bg-color: var(--system-green-dark);
        }
      }

      html,
      body {
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        height: 100%;
        overflow: hidden;
      }

      #app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .page {
        flex-grow: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: var(--safe-area-top) calc(15px + var(--safe-area-left))
          calc(105px + var(--safe-area-bottom)) /* Adjusted for nav height */
          calc(15px + var(--safe-area-right));
        display: none;
      }
      .page.active {
        display: block;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 0;
      }

      h1 {
        font-size: 34px;
        font-weight: 700;
        margin: 10px 0 20px 0;
      }
      h2 {
        font-size: 22px;
        font-weight: 600;
        margin: 25px 0 15px 0;
        border-bottom: 1px solid var(--separator-color);
        padding-bottom: 8px;
      }
      h3 {
        font-size: 17px;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: var(--secondary-text-color);
        text-transform: uppercase;
      }
      label {
        font-size: 15px;
        font-weight: 400;
        color: var(--secondary-text-color);
        display: block;
        margin-bottom: 5px;
      }
      p {
        font-size: 17px;
        line-height: 1.4;
        margin: 5px 0 15px 0;
      }

      .section {
        background-color: var(--card-background-color);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      @media (prefers-color-scheme: dark) {
        .section {
          box-shadow: none;
        }
      }

      .button,
      .inline-button,
      .delete-button,
      .add-button {
        background-color: var(--button-background-color);
        color: var(--button-text-color);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        box-sizing: border-box;
        line-height: 1.2em;
        text-align: center;
        transition: background-color 0.1s ease-in-out;
        -webkit-appearance: none;
        appearance: none;
      }
      .button {
        width: 100%;
        padding: 12px 15px;
        font-size: 17px;
        min-height: 44px;
        margin-bottom: 10px;
      }
      .inline-button,
      .delete-button,
      .add-button {
        font-size: 15px;
        padding: 8px 12px;
        min-height: 36px;
      }
      .delete-button {
        background-color: var(--hint-color);
      }
      .add-button {
        background-color: var(--system-green-light);
      }
      @media (prefers-color-scheme: dark) {
        .add-button {
          background-color: var(--system-green-dark);
        }
      }
      .button:active,
      .inline-button:active,
      .delete-button:active,
      .add-button:active {
        filter: brightness(0.85);
      }

      input[type="time"],
      input[type="number"],
      input[type="text"],
      select {
        width: 100%;
        padding: 12px 15px;
        font-size: 17px;
        border: 1px solid var(--input-border-color);
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: var(--input-background-color);
        color: var(--text-color);
        box-sizing: border-box;
        -webkit-appearance: none;
        appearance: none;
        line-height: 1.2em;
        min-height: 44px;
      }
      input:read-only {
        background-color: var(--card-background-color);
        color: var(--readonly-text-color);
      }
      input:disabled {
        background-color: var(--system-tertiary-background-light);
        color: var(--secondary-text-color);
        opacity: 0.7;
        cursor: not-allowed;
      }
      @media (prefers-color-scheme: dark) {
        input:disabled {
          background-color: var(--system-tertiary-background-dark);
        }
      }
      input[type="time"]::-webkit-calendar-picker-indicator {
        display: none;
      }

      .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .column {
        flex: 1;
      }

      .time-button-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .time-button-row input[type="time"],
      .time-button-row .button {
        flex: 1;
        margin-bottom: 0;
      }
      .time-button-row input[type="time"] {
        text-align: center;
      }
      .time-button-row .button {
        padding: 12px 15px;
      }

      .switch-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        min-height: 44px;
      }
      .switch-container span {
        margin-left: 10px;
        font-size: 17px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 65px; /* Standard iOS width */
        height: 31px;
        flex-shrink: 0;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--slider-bg-color);
        transition: 0.4s;
        border-radius: 15.5px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 27px;
        width: 27px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input:checked + .slider {
        background-color: var(--slider-checked-bg-color);
      }
      input:checked + .slider:before {
        transform: translateX(24px); /* Adjusted for 51px width */
      }

      .diff-badge {
        padding: 3px 6px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 500;
        display: inline-block;
        vertical-align: middle;
      }
      .positive-value {
        background-color: var(--positive-value-bg) !important;
        color: var(--button-text-color) !important;
      }
      .negative-value {
        background-color: var(--negative-value-bg) !important;
        color: #000000 !important;
      }
      .zero-value {
        background-color: var(--zero-value-bg) !important;
        color: #000000 !important;
      }

      #hinweis {
        color: var(--hint-color);
        font-weight: 500;
        font-size: 15px;
        display: none;
        margin-top: 10px;
        padding: 10px;
        background-color: rgba(255, 59, 48, 0.1);
        border-radius: 8px;
      }
      .invalid-time {
        border-color: var(--hint-color) !important;
        background-color: rgba(255, 59, 48, 0.1) !important;
      }

      #history-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        background-color: var(--card-background-color);
        border-radius: 10px;
        overflow: hidden;
      }
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        min-height: 60px;
        border-bottom: 1px solid var(--separator-color);
        gap: 10px;
      }
      .history-item:last-child {
        border-bottom: none;
      }
      .history-entry-content {
        flex-grow: 1;
        padding: 5px;
        border-radius: 6px;
        background-color: transparent;
        border-left: 3px solid transparent;
        transition: background-color 0.2s ease;
      }
      .history-entry-content.special-day {
        /* Base style for special days */
      }
      /* Specific background colors for special days */
      .history-entry-content.special-day[style*="--special-day-krank-bg"] {
        background-color: var(--special-day-krank-bg);
        color: var(--special-day-text);
      }
      .history-entry-content.special-day[style*="--special-day-urlaub-bg"] {
        background-color: var(--special-day-urlaub-bg);
        color: var(--special-day-text);
      }
      .history-entry-content.special-day[style*="--special-day-glaz-bg"] {
        background-color: var(--special-day-glaz-bg);
        color: var(--special-day-glaz-text); /* Use specific text color for GLAZ */
      }
      .history-entry-content.violation-day {
        border-left: 3px solid var(--hint-color);
        background-color: rgba(255, 59, 48, 0.05);
      }
      .history-entry-content.no-data {
        color: var(--secondary-text-color);
      }
      .history-entry-content div:first-child {
        font-weight: 500;
      }
      .history-entry-content div:last-child {
        font-size: 15px;
        color: var(--secondary-text-color);
      }
      /* Ensure text color is correct for special days */
      .history-entry-content.special-day[style*="--special-day-krank-bg"] div:last-child,
      .history-entry-content.special-day[style*="--special-day-urlaub-bg"] div:last-child {
        color: var(--special-day-text);
      }
      .history-entry-content.special-day[style*="--special-day-glaz-bg"] div:last-child {
        color: var(--special-day-glaz-text);
      }
      .violation-mark {
        color: var(--hint-color);
        font-weight: bold;
      }
      .history-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }
      .history-actions .inline-button,
      .history-actions .delete-button {
        font-size: 20px;
        padding: 5px 8px;
      }

      #weekly-summary,
      #month-summary {
        padding: 15px;
        background-color: var(--card-background-color);
        border-radius: 10px;
        margin-top: 20px;
        text-align: center;
        font-size: 17px;
        font-weight: 500;
      }
      #pagination,
      #month-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
      }
      #month-pagination button {
        /* Style comes from .inline-button */
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
      }
      .modal-content {
        background-color: var(--card-background-color);
        border-radius: 14px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        margin: auto;
        color: var(--text-color);
        box-sizing: border-box;
        position: relative;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .modal-content h3 {
        margin-top: 0;
      }
      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--system-gray2-light);
        border: none;
        color: var(--secondary-text-color);
        font-size: 14px;
        font-weight: bold;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
        padding: 0;
      }
      @media (prefers-color-scheme: dark) {
        .close-button {
          background: var(--system-gray2-dark);
        }
      }
      .close-button:active {
        filter: brightness(0.85);
      }

      #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 15px;
      }
      .calendar-header {
        text-align: center;
        font-size: 13px;
        font-weight: 500;
        color: var(--secondary-text-color);
        padding-bottom: 10px;
      }
      .calendar-day {
        display: flex;
        justify-content: center;
        align-items: center;
        aspect-ratio: 1 / 1;
        font-size: 16px;
        position: relative;
        cursor: default;
      }
      .calendar-day.empty {
        visibility: hidden;
      }
      .calendar-day.weekend .calendar-day-content {
        color: var(--secondary-text-color);
      }
      .calendar-day.no-entry {
        cursor: pointer;
      }
      .calendar-day.has-entry {
        cursor: pointer;
      }
      .calendar-day-content {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 85%;
        height: 85%;
        border-radius: 50%;
        transition: transform 0.1s ease;
      }
      /* Calendar Text/Background Colors */
      .calendar-day.has-entry .calendar-day-content.positive-value {
        color: var(--button-text-color);
      }
      .calendar-day.has-entry .calendar-day-content.negative-value,
      .calendar-day.has-entry .calendar-day-content.zero-value {
        color: #000000;
      }
      .calendar-day-content.special-day-krank-bg {
        background-color: var(--special-day-krank-bg);
        color: var(--special-day-text) !important;
      }
      .calendar-day-content.special-day-urlaub-bg {
        background-color: var(--special-day-urlaub-bg);
        color: var(--special-day-text) !important;
      }
      .calendar-day-content.special-day-glaz-bg {
        background-color: var(--special-day-glaz-bg);
        color: var(--special-day-glaz-text) !important; /* Specific text color */
      }
      .calendar-day-content.today {
        font-weight: bold;
        border: 2px solid var(--button-background-color);
      }
      .calendar-day.has-entry .calendar-day-content.today {
        border: 2px solid var(--text-color);
      }
      .calendar-day:active .calendar-day-content {
        transform: scale(0.95);
      }

      #stats-content {
        list-style: none;
        padding: 0;
        margin: 0;
        background-color: var(--card-background-color);
        border-radius: 10px;
        overflow: hidden;
      }
      #stats-content li {
        display: flex;
        justify-content: space-between;
        padding: 12px 15px;
        font-size: 17px;
        border-bottom: 1px solid var(--separator-color);
      }
      #stats-content li:last-child {
        border-bottom: none;
      }
      #stats-content li span:last-child {
        font-weight: 500;
        color: var(--secondary-text-color);
      }
      #stats-content li span.diff-badge {
        /* Colors come from .positive/negative/zero-value */
      }

      .import-export-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .import-export-buttons .button {
        margin-bottom: 0;
      }

      #bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: calc(30px + var(--safe-area-bottom)); /* Standard iOS Tab Bar height */
        background-color: var(--nav-background);
        border-top: 0.5px solid var(--separator-color);
        display: flex;
        justify-content: space-around;
        align-items: flex-start; /* Align items to top for padding */
        padding-top: 5px; /* Padding above icons */
        /*padding-bottom: var(--safe-area-bottom);*/
        z-index: 1000;
      }
      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Center content vertically */
        flex: 1;
        color: var(--nav-icon-color);
        text-decoration: none;
        font-size: 10px;
        cursor: pointer;
        padding: 0 5px;
        text-align: center;
        height: 100%; /* Ensure item takes full height */
        box-sizing: border-box;
      }
      .nav-item svg {
        width: 24px;
        height: 24px;
        margin-bottom: 2px;
        fill: currentColor;
      }
      .nav-item.active {
        color: var(--nav-icon-active-color);
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- Main Page -->
      <div id="main-page" class="page active">
        <div class="container">
          <h1>Arbeitszeit</h1>

          <div class="section">
            <h3>Zeiterfassung</h3>
            <div class="time-button-row">
              <input type="time" id="kommen-display" oninput="onInputChange()" />
              <button class="button" onclick="setZeit('kommen')">Kommen</button>
            </div>
            <div class="time-button-row">
              <input type="time" id="gehen-display" oninput="onInputChange()" />
              <button class="button" onclick="setZeit('gehen')">Gehen</button>
            </div>
            <div class="switch-container" style="margin-top: 15px">
              <label class="switch">
                <input
                  type="checkbox"
                  id="pc-buchung"
                  onchange="onInputChange()"
                />
                <span class="slider"></span>
              </label>
              <span>PC-Buchung (-8 Min)</span>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input
                  type="checkbox"
                  id="buero-toggle"
                  onchange="onInputChange()"
                />
                <span class="slider"></span>
              </label>
              <span>Im B√ºro</span>
            </div>
            <p id="hinweis"></p>
          </div>

          <div class="section">
            <h3>Einstellungen</h3>
            <div class="row">
              <div class="column">
                <label for="wochenarbeitszeit">Wochen-AZ (Std):</label>
                <input
                  type="number"
                  id="wochenarbeitszeit"
                  value="38"
                  step="0.5"
                  onchange="onInputChange()"
                />
              </div>
              <div class="column">
                <label for="zusatzliche-pause"
                  >Zus. Pause (hh:mm / h.hh):</label
                >
                <input
                  type="text"
                  id="zusatzliche-pause"
                  placeholder="z.B. 0:15 oder 0.25"
                  oninput="onInputChange()"
                />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label for="aktuelles-konto">Aktuelles Konto (Std):</label>
                <input
                  type="number"
                  id="aktuelles-konto"
                  value="0"
                  step="0.01"
                  onchange="onInputChange()"
                />
              </div>
              <div class="column">
                <label>Konto (Zeit):</label>
                <input type="text" id="aktuelles-konto-time" readonly />
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Zeiten√ºbersicht (Heute)</h3>
            <div class="row">
              <div class="column">
                <label>Anwesenheit:</label>
                <input type="text" id="anwesend-zeit" readonly />
              </div>
              <div class="column">
                <label>Pause:</label>
                <input type="text" id="pausenzeit" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Netto-Arbeitszeit:</label>
                <input type="text" id="arbeitszeit" readonly />
              </div>
              <div class="column">
                <label>Soll-Arbeitszeit:</label>
                <input type="text" id="sollarbeitszeit-display" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Differenz (Std):</label>
                <input type="text" id="differenz" readonly />
              </div>
              <div class="column">
                <label>Differenz (Zeit):</label>
                <input type="text" id="differenz-time" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Neues Konto (Std):</label>
                <input type="text" id="neues-konto" readonly />
              </div>
              <div class="column">
                <label>Neues Konto (Zeit):</label>
                <input type="text" id="neues-konto-time" readonly />
              </div>
            </div>
            <button class="button" onclick="saveDay()">Tag speichern</button>
          </div>

          <div class="section">
            <h3>Ausstempelzeiten</h3>
            <div class="row">
              <div class="column">
                <label>Soll:</label>
                <input type="text" id="end-time-soll" readonly />
              </div>
              <div class="column">
                <label>10h (Max):</label>
                <input type="text" id="end-time-10h" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>4h (Min):</label>
                <input type="text" id="end-time-4h" readonly />
              </div>
              <div class="column">
                <label>6h (+Pause):</label>
                <input type="text" id="end-time-6h" readonly />
              </div>
              <div class="column">
                <label>9h (+Pause):</label>
                <input type="text" id="end-time-9h" readonly />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- History Page -->
      <div id="history-page" class="page">
        <div class="container">
          <h1>Verlauf</h1>
          <h2 id="week-info"></h2>
          <p
            id="week-range"
            style="
              text-align: center;
              color: var(--secondary-text-color);
              margin-top: -10px;
              margin-bottom: 15px;
            "
          ></p>
          <div id="pagination"></div>
          <ul id="history-list"></ul>
          <div id="weekly-summary">
            <span id="weekly-summary-content">Gesamtdifferenz: --</span>
          </div>
        </div>
      </div>

      <!-- Month Page -->
      <div id="month-page" class="page">
        <div class="container">
          <h1>Monats√ºbersicht</h1>
          <div id="month-pagination" style="align-items: center">
            <button id="prev-month" class="inline-button">‚Äπ</button>
            <h2
              id="month-year-display"
              style="margin: 0; border: none; text-align: center"
            ></h2>
            <button id="next-month" class="inline-button">‚Ä∫</button>
          </div>
          <div id="calendar-grid"></div>
          <div id="month-summary">
            <span id="month-summary-content">Monatsdifferenz: --</span>
          </div>
        </div>
      </div>

      <!-- Stats Page -->
      <div id="stats-page" class="page">
        <div class="container">
          <h1>Statistik</h1>
          <div class="section">
            <label for="stats-period">Zeitraum:</label>
            <select id="stats-period">
              <option value="current_month">Aktueller Monat</option>
              <option value="last_month">Letzter Monat</option>
              <option value="current_year">Aktuelles Jahr</option>
              <option value="last_year">Letztes Jahr</option>
              <option value="all_time">Gesamter Zeitraum</option>
            </select>
          </div>
          <ul id="stats-content">
            <li>Lade Statistik...</li>
          </ul>
          <div class="import-export-buttons section">
            <button id="export-button" class="button">
              Verlauf exportieren (JSON)
            </button>
            <button id="import-button" class="button">
              Verlauf importieren (JSON)
            </button>
          </div>
        </div>
      </div>

      <!-- Detail-Modal -->
      <div id="detail-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button" onclick="closeDetailModal()">√ó</button>
          <h3 id="detail-modal-title">Details</h3>
          <div id="detail-content"></div>
        </div>
      </div>

      <!-- Add Day Modal -->
      <div id="add-day-modal" class="modal" data-date="" style="display: none">
        <div class="modal-content">
          <button class="close-button" onclick="closeAddDayModal()">√ó</button>
          <h3 id="add-day-modal-title">Manuelle Buchung</h3>
          <div class="row">
            <div class="column">
              <label for="add-day-kommen">Kommen:</label>
              <input type="time" id="add-day-kommen" />
            </div>
            <div class="column">
              <label for="add-day-gehen">Gehen:</label>
              <input type="time" id="add-day-gehen" />
            </div>
          </div>
          <!-- NEU: Zus√§tzliche Pause Input -->
          <div style="margin-top: 10px">
            <label for="add-day-zusatzliche-pause"
              >Zus. Pause (hh:mm / h.hh):</label
            >
            <input
              type="text"
              id="add-day-zusatzliche-pause"
              placeholder="z.B. 0:15 oder 0.25"
            />
          </div>
          <div class="switch-container" style="margin-top: 15px">
            <label class="switch">
              <input type="checkbox" id="pc-buchung-add-day" />
              <span class="slider"></span>
            </label>
            <span>PC-Buchung (-8 Min)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="buero-add-day" />
              <span class="slider"></span>
            </label>
            <span>Im B√ºro</span>
          </div>
          <h3 style="margin-top: 20px">Sondertag?</h3>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="urlaub-toggle" />
              <span class="slider"></span>
            </label>
            <span>Urlaub</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="krank-toggle" />
              <span class="slider"></span>
            </label>
            <span>Krank</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="schulung-toggle" />
              <span class="slider"></span>
            </label>
            <span>Schulung</span>
          </div>
          <!-- NEU: GLAZ Toggle -->
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="glaz-toggle" />
              <span class="slider"></span>
            </label>
            <span>GLAZ (Gleitzeitabbau)</span>
          </div>
          <button
            class="button"
            onclick="addManualDay()"
            style="margin-top: 20px"
          >
            Speichern
          </button>
        </div>
      </div>

      <!-- Bottom Navigation -->
      <nav id="bottom-nav">
        <a id="nav-main" class="nav-item active">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"
            />
          </svg>
          <span>Rechner</span>
        </a>
        <a id="nav-history" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path
              d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z"
            />
          </svg>
          <span>Verlauf</span>
        </a>
        <a id="nav-month" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path
              d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"
            />
          </svg>
          <span>Monat</span>
        </a>
        <a id="nav-stats" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z" />
          </svg>
          <span>Statistik</span>
        </a>
      </nav>
    </div>
    <!-- End #app-container -->
  </body>
</html>
