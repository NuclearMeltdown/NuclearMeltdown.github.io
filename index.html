<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#f2f2f7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Arbeitszeitrechner">

  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://NuclearMeltdown.github.io/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://NuclearMeltdown.github.io/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://NuclearMeltdown.github.io/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://NuclearMeltdown.github.io/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://NuclearMeltdown.github.io/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://NuclearMeltdown.github.io/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://NuclearMeltdown.github.io/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://NuclearMeltdown.github.io/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon-196x196.png" sizes="196x196" />
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="https://NuclearMeltdown.github.io/favicon-128.png" sizes="128x128" />
  <meta name="application-name" content="Arbeitszeitrechner"/>
  <meta name="msapplication-TileColor" content="#000000" />
  <meta name="msapplication-TileImage" content="https://NuclearMeltdown.github.io/mstile-144x144.png" />
  <meta name="msapplication-square70x70logo" content="https://NuclearMeltdown.github.io/mstile-70x70.png" />
  <meta name="msapplication-square150x150logo" content="https://NuclearMeltdown.github.io/mstile-150x150.png" />
  <meta name="msapplication-wide310x150logo" content="https://NuclearMeltdown.github.io/mstile-310x150.png" />
  <meta name="msapplication-square310x310logo" content="https://NuclearMeltdown.github.io/mstile-310x310.png" />

  <title>Arbeitszeitrechner</title>
  <script>
    let kommenZeit = null;
    let gehenZeit = null;
    let currentWeekYear = null;
    let currentWeekNo = null;

    function getAdjustedKommenZeit() {
      if (!kommenZeit) return null;
      const isPcBuchung = document.getElementById('pc-buchung').checked;
      const adjusted = new Date(kommenZeit.getTime());
      if (isPcBuchung) {
        adjusted.setMinutes(adjusted.getMinutes() - 8);
      }
      return adjusted;
    }

    function checkViolations(kommenDate, gehenDate, arbeitszeit) {
      const kommenStunde = kommenDate.getHours() + (kommenDate.getMinutes() / 60);
      const gehenStunde = gehenDate.getHours() + (gehenDate.getMinutes() / 60);
      if (kommenStunde < 6 || kommenStunde > 16) return true;
      if (gehenStunde > 20) return true;
      if (arbeitszeit < 4) return true;
      return false;
    }

    function init() {
      const aktuellesKonto = localStorage.getItem('aktuellesStundenkonto');
      if (aktuellesKonto !== null) {
        document.getElementById('aktuelles-konto').value = parseFloat(aktuellesKonto);
      }
      updateCalculations();
      const today = new Date();
      [currentWeekYear, currentWeekNo] = getWeekNumber(today);
    }

    function setKommen() {
      const now = new Date();
      kommenZeit = now;
      document.getElementById("kommen-display").value = formatTime(kommenZeit);
      updateCalculations();
    }

    function setGehen() {
      const now = new Date();
      gehenZeit = now;
      document.getElementById("gehen-display").value = formatTime(gehenZeit);
      updateCalculations();
    }

    function updateKommenFromInput() {
      const value = document.getElementById("kommen-display").value;
      kommenZeit = parseTime(value);
      updateCalculations();
    }

    function updateGehenFromInput() {
      const value = document.getElementById("gehen-display").value;
      gehenZeit = parseTime(value);
      updateCalculations();
    }

    function parseTime(timeStr) {
      if (!timeStr) return null;
      const [hours, minutes] = timeStr.split(":").map(Number);
      const now = new Date();
      now.setHours(hours, minutes, 0, 0);
      return now;
    }

    function formatTime(date) {
      if (!date) return "--:--";
      return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    function pad(num) {
      return num.toString().padStart(2, "0");
    }

    function calculateWorkingTime() {
      const ak = getAdjustedKommenZeit();
      if (ak && gehenZeit) {
        const diffMs = gehenZeit - ak;
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        return { hours, minutes };
      }
      return { hours: 0, minutes: 0 };
    }

    function parseAdditionalPause() {
      const value = document.getElementById("zusatzliche-pause").value;
      if (!value) return 0;
      const [hours, minutes] = value.split(":").map(Number);
      return (hours || 0) + ((minutes || 0) / 60);
    }

    function calculatePausen(totalHours) {
      let pausen = 0;
      if (totalHours > 6) pausen += 0.5;
      if (totalHours > 9) pausen += 0.25;
      pausen += parseAdditionalPause();
      return pausen;
    }

    function calculateArbeitszeit() {
      const workTime = calculateWorkingTime();
      const totalHours = workTime.hours + (workTime.minutes / 60);
      const pausen = calculatePausen(totalHours);
      return totalHours - pausen;
    }

    function formatDecimalToTime(decimalHours) {
      const absVal = Math.abs(decimalHours);
      const hours = Math.floor(absVal);
      const minutes = Math.round((absVal % 1) * 60);
      const sign = decimalHours < 0 ? "-" : "";
      return `${sign}${hours}:${pad(minutes)}`;
    }

    function calculateEndTime(durationHours) {
      const ak = getAdjustedKommenZeit();
      if (!ak) return "--:--";
      const pausenInMinuten = calculatePausen(durationHours)*60;
      const totalMinutes = durationHours * 60;
      const endTime = new Date(ak.getTime());
      endTime.setMinutes(endTime.getMinutes() + totalMinutes + pausenInMinuten);
      return formatTime(endTime);
    }

    function updateEndTimes() {
      if (!kommenZeit) return;
      const durations = [4, 6, 9, 10];
      durations.forEach(duration => {
        const endTime = calculateEndTime(duration);
        document.getElementById(`end-time-${duration}h`).value = endTime;
      });
      const wochenarbeitszeitValue = parseFloat(document.getElementById("wochenarbeitszeit").value) || 38;
      const sollArbeitszeit = wochenarbeitszeitValue / 5;
      const sollEndTime = calculateEndTime(sollArbeitszeit);
      document.getElementById("end-time-soll").value = `(${sollArbeitszeit.toFixed(2)}h): ${sollEndTime}`;
    }

    function updateCalculations() {
      const workTime = calculateWorkingTime();
      const totalHours = workTime.hours + (workTime.minutes / 60);
      const pausen = calculatePausen(totalHours);
      const arbeitszeit = totalHours - pausen; // nur einmal definiert

      const wochenarbeitszeitValue = parseFloat(document.getElementById("wochenarbeitszeit").value) || 38;
      const sollArbeitszeit = wochenarbeitszeitValue / 5;
      const differenz = arbeitszeit - sollArbeitszeit;

      const aktuellesKonto = parseFloat(document.getElementById("aktuelles-konto").value) || 0;
      const neuesStundenkonto = aktuellesKonto + differenz;

      document.getElementById("anwesend-zeit").value = `${workTime.hours}:${pad(workTime.minutes)} (${totalHours.toFixed(2)}h)`;
      document.getElementById("pausenzeit").value = `${(calculatePausen(totalHours)*60).toFixed(0)} Min`;
      document.getElementById("arbeitszeit").value = `${formatDecimalToTime(arbeitszeit)} (${arbeitszeit.toFixed(2)}h)`;
      document.getElementById("sollarbeitszeit-display").value = `${formatDecimalToTime(sollArbeitszeit)} (${sollArbeitszeit.toFixed(2)}h)`;

      document.getElementById("differenz").value = differenz.toFixed(2);
      document.getElementById("differenz-time").value = formatDecimalToTime(differenz);
      document.getElementById("neues-konto").value = neuesStundenkonto.toFixed(2);
      document.getElementById("neues-konto-time").value = formatDecimalToTime(neuesStundenkonto);
      document.getElementById("aktuelles-konto-time").value = formatDecimalToTime(aktuellesKonto);

      const differenzField = document.getElementById("differenz");
      const neuesKontoField = document.getElementById("neues-konto");
      const differenzTimeField = document.getElementById("differenz-time");
      const neuesKontoTimeField = document.getElementById("neues-konto-time");

      differenzField.classList.remove("positive-value", "negative-value", "zero-value");
      neuesKontoField.classList.remove("positive-value", "negative-value", "zero-value");
      differenzTimeField.classList.remove("positive-value", "negative-value", "zero-value");
      neuesKontoTimeField.classList.remove("positive-value", "negative-value", "zero-value");

      if (differenz > 0) {
        differenzField.classList.add("positive-value");
        neuesKontoField.classList.add("positive-value");
        differenzTimeField.classList.add("positive-value");
        neuesKontoTimeField.classList.add("positive-value");
      } else if (differenz < 0) {
        differenzField.classList.add("negative-value");
        neuesKontoField.classList.add("negative-value");
        differenzTimeField.classList.add("negative-value");
        neuesKontoTimeField.classList.add("negative-value");
      } else {
        differenzField.classList.add("zero-value");
        neuesKontoField.classList.add("zero-value");
        differenzTimeField.classList.add("zero-value");
        neuesKontoTimeField.classList.add("zero-value");
      }

      const hinweis = document.getElementById("hinweis");
      let hinweisText = "";

      const ak = getAdjustedKommenZeit();
      // Keine zweite Deklaration von arbeitszeit!
      // Wir verwenden die bereits deklarierte Variable arbeitszeit.
      if (arbeitszeit < 4 || arbeitszeit > 10) {
        hinweisText += "Achtung: Die Arbeitszeit liegt außerhalb des zulässigen Bereichs (4-10 Stunden)!<br>";
      }

      const kommenField = document.getElementById("kommen-display");
      kommenField.classList.remove("invalid-time");
      if (ak) {
        const kommenStunde = ak.getHours() + ak.getMinutes()/60;
        if (kommenStunde < 6 || kommenStunde > 16) {
          hinweisText += "Achtung: Die Kommen-Zeit liegt außerhalb der Gleitzeitbandbreite (06:00 - 16:00 Uhr)!<br>";
          kommenField.classList.add("invalid-time");
        }
        if (arbeitszeit >= 4 && kommenStunde > 16) {
          hinweisText += "Achtung: Bei einer Mindestarbeitszeit von 4h darf die Kommen-Zeit nicht nach 16:00 Uhr liegen!<br>";
          kommenField.classList.add("invalid-time");
        }
      }

      const gehenField = document.getElementById("gehen-display");
      gehenField.classList.remove("invalid-time");
      if (gehenZeit) {
        const gehenStunde = gehenZeit.getHours() + gehenZeit.getMinutes()/60;
        if (gehenStunde > 20) {
          hinweisText += "Achtung: Die Gehen-Zeit liegt außerhalb der Gleitzeitbandbreite (bis 20:00 Uhr)!<br>";
          gehenField.classList.add("invalid-time");
        }
      }

      if (hinweisText !== "") {
        hinweis.innerHTML = hinweisText;
        hinweis.style.display = "block";
      } else {
        hinweis.style.display = "none";
      }

      updateEndTimes();
    }

    function saveDay() {
      updateCalculations();
      const adjustedKommen = getAdjustedKommenZeit(); // nur einmal im saveDay

      if (adjustedKommen && gehenZeit) {
        const diffMs = gehenZeit - adjustedKommen;
        const hourMs = 1000 * 60 * 60;
        const totalHours = Math.floor(diffMs/hourMs) + ((Math.floor((diffMs % hourMs)/(1000*60)))/60);
        const pausen = calculatePausen(totalHours);
        const arbeitszeit = totalHours - pausen; // nur einmal
        if (checkViolations(adjustedKommen, gehenZeit, arbeitszeit)) {
          if (!confirm("Es gibt Verstöße gegen die Gleitzeitregeln. Trotzdem speichern?")) {
            return;
          }
        }
      }

      const differenz = parseFloat(document.getElementById("differenz").value) || 0;
      const differenzTime = document.getElementById("differenz-time").value;
      const neuesStundenkonto = parseFloat(document.getElementById("neues-konto").value) || 0;

      const today = new Date();
      const datum = today.toISOString().split('T')[0];

      const kommenStr = adjustedKommen ? adjustedKommen.toISOString() : null;
      const gehenStr = gehenZeit ? gehenZeit.toISOString() : null;

      const dayData = {
        datum: datum,
        differenz: differenz.toFixed(2),
        differenzTime: differenzTime,
        stundenkonto: neuesStundenkonto.toFixed(2),
        kommen: kommenStr,
        gehen: gehenStr
      };

      let history = JSON.parse(localStorage.getItem('history')) || [];
      const existingIndex = history.findIndex(entry => entry.datum === datum);
      const displayDate = new Date(datum).toLocaleDateString('de-DE');
      if (existingIndex !== -1) {
        if (!confirm(`Für den Tag ${displayDate} existiert bereits ein Eintrag. Möchten Sie ihn ersetzen?`)) {
          return;
        }
        history[existingIndex] = dayData;
      } else {
        history.push(dayData);
      }

      localStorage.setItem('history', JSON.stringify(history));
      document.getElementById('aktuelles-konto').value = neuesStundenkonto.toFixed(2);
      localStorage.setItem('aktuellesStundenkonto', neuesStundenkonto.toFixed(2));
      updateCalculations();
      alert("Der Tag wurde gespeichert.");
    }

    function showHistory() {
      document.getElementById('main-page').style.display = 'none';
      document.getElementById('history-page').style.display = 'block';
      loadHistory();
    }

    function showMainPage() {
      document.getElementById('history-page').style.display = 'none';
      document.getElementById('main-page').style.display = 'block';
    }

    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7);
      return [d.getUTCFullYear(),weekNo];
    }

    function getDateOfISOWeek(w,y){
      const simple=new Date(Date.UTC(y,0,4+(w-1)*7));
      const dow=simple.getDay();
      const ISOweekStart=new Date(simple);
      ISOweekStart.setDate(simple.getDate()-((dow+6)%7));
      return ISOweekStart;
    }

    function calcArbeitszeitFromEntry(entry){
      if(!entry.kommen||!entry.gehen)return 0;
      const kommenDate=new Date(entry.kommen);
      const gehenDate=new Date(entry.gehen);
      const diffMs=gehenDate-kommenDate;
      if(diffMs<0)return 0;
      const hourMs=1000*60*60;
      const hours=Math.floor(diffMs/hourMs);
      const minutes=Math.floor((diffMs%hourMs)/(1000*60));
      const totalHours=hours+(minutes/60);
      let pausen=0;
      if(totalHours>6)pausen+=0.5;
      if(totalHours>9)pausen+=0.25;
      const arbeitszeit=totalHours-pausen;
      return arbeitszeit;
    }

    function checkEntryViolationsForHistory(entry){
      if(!entry.kommen||!entry.gehen)return false;
      const kommenDate=new Date(entry.kommen);
      const gehenDate=new Date(entry.gehen);
      const arbeitszeit=calcArbeitszeitFromEntry(entry);
      return checkViolations(kommenDate,gehenDate,arbeitszeit);
    }

    function deleteEntryByDate(dateStr){
      let history=JSON.parse(localStorage.getItem('history'))||[];
      const index=history.findIndex(e=>e.datum===dateStr);
      if(index!==-1){
        const displayDate=new Date(dateStr).toLocaleDateString('de-DE');
        if(confirm(`Möchten Sie den Eintrag für ${displayDate} wirklich löschen?`)){
          history.splice(index,1);
          localStorage.setItem('history',JSON.stringify(history));
          loadHistory();
        }
      }
    }

    function showAddDayModal(weekday,index){
      const dateVal = new Date(getDateOfISOWeek(currentWeekNo,currentWeekYear));
      dateVal.setDate(dateVal.getDate()+(weekday-1));
      const displayDate = dateVal.toLocaleDateString('de-DE');

      document.getElementById('add-day-modal-title').textContent = `Manuelle Buchung für ${displayDate}`;
      document.getElementById('add-day-kommen').value="";
      document.getElementById('add-day-gehen').value="";
      document.getElementById('pc-buchung-add-day').checked=false;

      document.getElementById('add-day-modal').setAttribute('data-date', dateVal.toISOString().split('T')[0]);
      document.getElementById('add-day-modal').style.display='block';
    }

    function addManualDay(){
      const dateVal=document.getElementById('add-day-modal').getAttribute('data-date');
      const kommenVal=document.getElementById('add-day-kommen').value;
      const gehenVal=document.getElementById('add-day-gehen').value;
      const isPcBuchungAddDay=document.getElementById('pc-buchung-add-day').checked;

      if(!dateVal||!kommenVal||!gehenVal){
        alert("Bitte Kommen- und Gehen-Zeit angeben.");
        return;
      }

      const wochenarbeitszeit=parseFloat(document.getElementById("wochenarbeitszeit").value)||38;
      const sollArbeitszeit=wochenarbeitszeit/5;
      const aktuellesKonto=parseFloat(document.getElementById('aktuelles-konto').value)||0;

      const kommenDate=parseTime(kommenVal);
      const gehenDate=parseTime(gehenVal);

      let adjusted=new Date(kommenDate.getTime());
      if(isPcBuchungAddDay){
        adjusted.setMinutes(adjusted.getMinutes()-8);
      }

      const diffMs=gehenDate-adjusted;
      const hourMs=1000*60*60;
      const totalHours=Math.floor(diffMs/hourMs)+((Math.floor((diffMs%hourMs)/(1000*60)))/60);

      const pausen=calculatePausen(totalHours);
      const arbeitszeit=totalHours-pausen; // nur einmal definiert
      const differenz=arbeitszeit-sollArbeitszeit;
      const differenzTime=formatDecimalToTime(differenz);
      const neuesStundenkonto=aktuellesKonto+differenz;

      if(checkViolations(adjusted,gehenDate,arbeitszeit)){
        if(!confirm("Es gibt Verstöße gegen die Gleitzeitregeln. Trotzdem speichern?")){
          return;
        }
      }

      const dayData={
        datum:dateVal,
        differenz:differenz.toFixed(2),
        differenzTime:differenzTime,
        stundenkonto:neuesStundenkonto.toFixed(2),
        kommen:adjusted.toISOString(),
        gehen:gehenDate.toISOString()
      };

      let history=JSON.parse(localStorage.getItem('history'))||[];
      const existingIndex=history.findIndex(e=>e.datum===dateVal);
      const displayDate=new Date(dateVal).toLocaleDateString('de-DE');
      if(existingIndex!==-1){
        if(!confirm(`Für den Tag ${displayDate} existiert bereits ein Eintrag. Möchten Sie ihn ersetzen?`)){
          return;
        }
        history[existingIndex]=dayData;
      } else {
        history.push(dayData);
      }

      localStorage.setItem('history',JSON.stringify(history));
      document.getElementById('aktuelles-konto').value=neuesStundenkonto.toFixed(2);
      localStorage.setItem('aktuellesStundenkonto',neuesStundenkonto.toFixed(2));
      updateCalculations();
      closeAddDayModal();
      loadHistory();
      alert("Der Tag wurde nachgetragen.");
    }

    function closeAddDayModal(){
      document.getElementById('add-day-modal').style.display='none';
    }

    function showDayDetails(dateStr){
      const history=JSON.parse(localStorage.getItem('history'))||[];
      const entry=history.find(e=>e.datum===dateStr);
      if(!entry)return;
      const displayDate=new Date(dateStr).toLocaleDateString('de-DE');

      const kommen=entry.kommen?new Date(entry.kommen):null;
      const gehen=entry.gehen?new Date(entry.gehen):null;

      document.getElementById('detail-date').textContent=displayDate;
      document.getElementById('detail-kommen').textContent=kommen?formatTime(kommen):"--:--";
      document.getElementById('detail-gehen').textContent=gehen?formatTime(gehen):"--:--";
      document.getElementById('detail-differenz').textContent=`${entry.differenz}h (${entry.differenzTime})`;

      document.getElementById('detail-modal').style.display='block';
    }

    function closeDetailModal(){
      document.getElementById('detail-modal').style.display='none';
    }

    function loadHistory(){
      const historyList=document.getElementById('history-list');
      historyList.innerHTML='';

      let history=JSON.parse(localStorage.getItem('history'))||[];

      const [year,week]=[currentWeekYear,currentWeekNo];
      const weekStartDate=getDateOfISOWeek(week,year);
      const weekEndDate=new Date(weekStartDate);
      weekEndDate.setDate(weekStartDate.getDate()+4);
      const weekRange=`${weekStartDate.toLocaleDateString('de-DE')} - ${weekEndDate.toLocaleDateString('de-DE')}`;

      const weekInfo=document.getElementById('week-info');
      weekInfo.textContent=`KW ${week} (${weekRange})`;

      const weekdays=[1,2,3,4,5];
      const weekdayNames=['Montag','Dienstag','Mittwoch','Donnerstag','Freitag'];

      let totalDifferenz=0;

      weekdays.forEach((weekday,idx)=>{
        const entry=history.find(e=>{
          const entryDate=new Date(e.datum);
          const [eYear,eWeekNo]=getWeekNumber(entryDate);
          return eYear===year&&eWeekNo===week&&entryDate.getDay()===weekday;
        });

        const listItem=document.createElement('li');
        listItem.classList.add('history-item');

        if(entry){
          const differenzValue=parseFloat(entry.differenz);
          totalDifferenz+=differenzValue;
          const differenzClass=differenzValue>0?'positive-value':(differenzValue<0?'negative-value':'zero-value');
          const displayDate=new Date(entry.datum).toLocaleDateString('de-DE');
          const violation=checkEntryViolationsForHistory(entry);

          let violationStyle = "flex:1;";
          if(violation) {
            violationStyle += "background-color:#ff3b30;color:#ffffff;border-radius:8px;padding:5px;";
          }

          const violationMarks=violation?' !!!':'';
          const differenzSpanClass = violation ? '' : differenzClass;

          listItem.innerHTML=`
            <div class="history-entry" style="${violationStyle}">
              <div><strong>${weekdayNames[idx]}</strong> (${displayDate})</div>
              <div>Differenz: <span class="${differenzSpanClass}">${entry.differenz}h (${entry.differenzTime})${violationMarks}</span></div>
            </div>
            <div style="display:flex;align-items:center;justify-content:flex-end;gap:5px;">
              <button class="inline-button" onclick="showDayDetails('${entry.datum}')">Details</button>
              <button class="delete-button" onclick="deleteEntryByDate('${entry.datum}')">Löschen</button>
            </div>
          `;
        } else {
          listItem.innerHTML=`
            <div class="history-entry" style="flex:1;">
              <div><strong>${weekdayNames[idx]}</strong></div>
              <div>Keine Daten vorhanden</div>
            </div>
            <div style="display:flex;align-items:center;justify-content:flex-end;gap:5px;">
              <button class="inline-button" onclick="showAddDayModal('${weekday}','${idx}')">Manuelle Buchung</button>
            </div>
          `;
        }
        historyList.appendChild(listItem);
      });

      const weeklySummary=document.getElementById('weekly-summary');
      const totalDifferenzClass=totalDifferenz>0?'positive-value':(totalDifferenz<0?'negative-value':'zero-value');
      weeklySummary.innerHTML=`
        <h3>Wöchentliche Zusammenfassung</h3>
        <p>Gesamte Differenz: <span class="${totalDifferenzClass}">${totalDifferenz.toFixed(2)}h (${formatDecimalToTime(totalDifferenz)})</span></p>
      `;

      updateWeekNavigation();
    }

    function updateWeekNavigation(){
      const pagination=document.getElementById('pagination');
      pagination.innerHTML='';

      const navContainer=document.createElement('div');
      navContainer.classList.add('nav-container');

      const prevYearButton=document.createElement('button');
      prevYearButton.textContent='«';
      prevYearButton.onclick=()=>{
        currentWeekYear--;
        loadHistory();
      };
      navContainer.appendChild(prevYearButton);

      const prevButton=document.createElement('button');
      prevButton.textContent='‹';
      prevButton.onclick=()=>{
        const date=getDateOfISOWeek(currentWeekNo,currentWeekYear);
        date.setDate(date.getDate()-7);
        [currentWeekYear,currentWeekNo]=getWeekNumber(date);
        loadHistory();
      };
      navContainer.appendChild(prevButton);

      const weekSelect=document.createElement('select');
      weekSelect.id='week-select';
      for(let i=1;i<=53;i++){
        const option=document.createElement('option');
        option.value=i;
        const startDate=getDateOfISOWeek(i,currentWeekYear);
        option.textContent=`KW ${i} (${startDate.toLocaleDateString('de-DE')})`;
        if(i===currentWeekNo){
          option.selected=true;
        }
        weekSelect.appendChild(option);
      }

      weekSelect.onchange=()=>{
        currentWeekNo=parseInt(weekSelect.value);
        loadHistory();
      };
      navContainer.appendChild(weekSelect);

      const nextButton=document.createElement('button');
      nextButton.textContent='›';
      nextButton.onclick=()=>{
        const date=getDateOfISOWeek(currentWeekNo,currentWeekYear);
        date.setDate(date.getDate()+7);
        [currentWeekYear,currentWeekNo]=getWeekNumber(date);
        loadHistory();
      };
      navContainer.appendChild(nextButton);

      const nextYearButton=document.createElement('button');
      nextYearButton.textContent='»';
      nextYearButton.onclick=()=>{
        currentWeekYear++;
        loadHistory();
      };
      navContainer.appendChild(nextYearButton);

      pagination.appendChild(navContainer);
    }

    function showDayDetails(dateStr){
      const history=JSON.parse(localStorage.getItem('history'))||[];
      const entry=history.find(e=>e.datum===dateStr);
      if(!entry)return;
      const displayDate=new Date(dateStr).toLocaleDateString('de-DE');

      const kommen=entry.kommen?new Date(entry.kommen):null;
      const gehen=entry.gehen?new Date(entry.gehen):null;

      document.getElementById('detail-date').textContent=displayDate;
      document.getElementById('detail-kommen').textContent=kommen?formatTime(kommen):"--:--";
      document.getElementById('detail-gehen').textContent=gehen?formatTime(gehen):"--:--";
      document.getElementById('detail-differenz').textContent=`${entry.differenz}h (${entry.differenzTime})`;

      document.getElementById('detail-modal').style.display='block';
    }

    function closeDetailModal(){
      document.getElementById('detail-modal').style.display='none';
    }
  </script>
  <style>
    :root {
      --background-color: #f2f2f7;
      --text-color: #000000;
      --card-background-color: #ffffff;
      --input-background-color: #ffffff;
      --input-border-color: #c7c7cc;
      --button-background-color: #007aff;
      --button-text-color: #ffffff;
      --hint-color: #ff3b30;
      --positive-background-color: #007aff;
      --negative-background-color: #ff9500;
      --zero-background-color: #34c759;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #000000;
        --text-color: #ffffff;
        --card-background-color: #1c1c1e;
        --input-background-color: #2c2c2e;
        --input-border-color: #3a3a3c;
        --button-background-color: #0a84ff;
        --button-text-color: #ffffff;
        --hint-color: #ff453a;
        --positive-background-color: #0a84ff;
        --negative-background-color: #ff9500;
        --zero-background-color: #30d158;
      }
    }

    html, body {
      background-color: var(--background-color);
      color: var(--text-color);
      margin:0; padding:0;
      font-family:'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body::before {
      content:"";
      position:fixed;top:0;left:0;right:0;
      height:env(safe-area-inset-top);
      background-color:var(--background-color);
    }

    body::after {
      content:"";
      position:fixed;bottom:0;left:0;right:0;
      height:env(safe-area-inset-bottom);
      background-color:var(--background-color);
    }

    .container {
      max-width:600px;margin:auto;padding:20px;
    }

    h1 {
      font-weight:600;font-size:28px;margin-bottom:20px;
    }

    h2 {
      font-size:24px;font-weight:600;margin-bottom:20px;
    }

    h3 {
      font-size:20px;font-weight:600;margin-bottom:10px;
    }

    .section { margin-bottom:30px; }

    .button {
      width:100%;padding:15px;
      background-color:var(--button-background-color);color:var(--button-text-color);
      border:none;border-radius:12px;font-size:17px;font-weight:600;
      text-align:center;margin-bottom:10px;cursor:pointer;
      box-shadow:0 2px 5px rgba(0,0,0,0.15);
      box-sizing:border-box;
      height:56px;
      line-height:1.2em;
    }

    .button:active { background-color:rgba(10,132,255,0.8); }

    .inline-button,
    .delete-button {
      font-size:15px;font-weight:600;cursor:pointer;
      border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.15);
      border:none;padding:10px 15px;
      box-sizing:border-box;
      line-height:1.2em;
    }

    .inline-button {
      background-color:var(--button-background-color);color:#ffffff;
    }

    .inline-button:active {
      background-color:rgba(10,132,255,0.8);
    }

    .delete-button {
      background-color:var(--hint-color);color:#ffffff;
    }

    .delete-button:active {
      background-color:rgba(255,59,48,0.8);
    }

    input,select {
      width:100%;
      padding:15px;
      font-size:17px;
      border:none;
      border-radius:12px;
      margin-bottom:10px;
      background-color:var(--input-background-color);
      color:var(--text-color);
      box-sizing:border-box;
      -webkit-appearance:none;appearance:none;
      line-height:1.2em;
      height:56px;
    }

    input:read-only {
      border:none;
      border-radius:12px;
      background-color:var(--input-background-color);
      color:var(--text-color);
    }

    input[type=time]::-webkit-calendar-picker-indicator {
      display:none;
    }

    #hinweis {
      color:var(--hint-color);font-weight:600;font-size:15px;
      display:none;margin-top:10px;
    }

    ul {
      list-style-type:none;padding-left:0;margin:0;
    }

    li {
      font-size:17px;padding:5px 0;
      border-bottom:1px solid var(--input-border-color);
      display:flex;justify-content:space-between;align-items:center;
    }

    .history-item { min-height:70px; }
    .history-entry { flex:1;margin-right:10px; }

    p {font-size:17px;margin:5px 0;}

    .positive-value,.negative-value,.zero-value {
      padding:2px 4px;border-radius:5px;color:#ffffff !important;
    }

    .positive-value {background-color:var(--positive-background-color)!important;}
    .negative-value {background-color:var(--negative-background-color)!important;}
    .zero-value {background-color:var(--zero-background-color)!important;}

    .invalid-time {
      background-color:var(--hint-color)!important;color:#ffffff!important;
    }

    #history-page {display:none;}

    .nav-button {width:auto;padding:10px 20px;margin-bottom:20px;}

    .row {
      display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;
    }

    .column {
      flex:1;margin-right:10px;display:flex;flex-direction:column;
    }

    .column:last-child {margin-right:0;}

    #pagination {
      display:flex;justify-content:center;align-items:center;flex-wrap:wrap;
      margin-top:20px;margin-bottom:20px;
    }

    #pagination .nav-container {
      display:flex;align-items:center;flex-wrap:wrap;
    }

    #pagination button,
    #pagination select {
      background-color:var(--button-background-color);color:var(--button-text-color);
      border:none;border-radius:12px;padding:12px;margin:5px;
      cursor:pointer;font-size:16px;
      box-sizing:border-box;
      line-height:1.2em;
      height:auto;
    }

    #pagination button:disabled {
      background-color:#cccccc;cursor:not-allowed;
    }

    #pagination select {
      width:auto;max-width:200px;flex:1;
    }

    #history-page .container {
      display:block;padding-bottom:20px;
    }

    .switch-container {
      display:flex;align-items:center;margin-bottom:10px;
    }

    .switch {
      position:relative;display:inline-block;width:50px;height:28px;margin-right:10px;
    }

    .switch input {opacity:0;width:0;height:0;}

    .slider {
      position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
      background-color:#ccc;transition:0.4s;border-radius:14px;
    }

    .slider:before {
      position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;
      background-color:white;transition:0.4s;border-radius:50%;
    }

    input:checked + .slider {background-color:var(--button-background-color);}
    input:checked + .slider:before {transform:translateX(22px);}

    #history-list {overflow-y:visible;}

    .modal {
      display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;
      overflow:auto;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;
    }

    .modal-content {
      background-color:var(--card-background-color);
      border-radius:12px;padding:20px;
      max-width:400px;margin:50px auto;color:var(--text-color);
      box-sizing:border-box;
    }

    .close-button {
      background:none;border:none;color:var(--text-color);
      font-size:20px;font-weight:bold;float:right;cursor:pointer;
    }
  </style>
</head>
<body onload="init()">
  <div id="main-page">
    <div class="container">
      <h1>Arbeitszeitrechner</h1>
      <button class="button nav-button" onclick="showHistory()">Verlauf anzeigen</button>
      
      <div class="section">
        <div class="row">
          <div class="column">
            <input type="time" id="kommen-display" onchange="updateKommenFromInput()">
          </div>
          <div class="column">
            <button class="button" onclick="setKommen()">Kommen (Jetzt)</button>
          </div>
        </div>
        <div class="switch-container">
          <label class="switch">
            <input type="checkbox" id="pc-buchung" onchange="updateCalculations()">
            <span class="slider"></span>
          </label>
          <span>PC-Buchung</span>
        </div>
        <div class="row">
          <div class="column">
            <input type="time" id="gehen-display" onchange="updateGehenFromInput()">
          </div>
          <div class="column">
            <button class="button" onclick="setGehen()">Gehen (Jetzt)</button>
          </div>
        </div>
        <p id="hinweis"></p>
      </div>
      
      <div class="section">
        <div class="row">
          <div class="column">
            <label for="wochenarbeitszeit">Wochenarbeitszeit (Std.):</label>
            <input type="number" id="wochenarbeitszeit" value="38" onchange="updateCalculations()">
          </div>
          <div class="column">
            <label for="zusatzliche-pause">Zusätzliche Pausenzeiten (z.B. 0:15):</label>
            <input type="text" id="zusatzliche-pause" onchange="updateCalculations()">
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>Zeitenübersicht</h3>
        <div class="row">
          <div class="column">
            <label>Anwesenheitszeit:</label>
            <input type="text" id="anwesend-zeit" readonly>
          </div>
          <div class="column">
            <label>Pausen:</label>
            <input type="text" id="pausenzeit" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>Arbeitszeit:</label>
            <input type="text" id="arbeitszeit" readonly>
          </div>
          <div class="column">
            <label>Sollarbeitszeit:</label>
            <input type="text" id="sollarbeitszeit-display" readonly>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>Stundenkonto</h3>
        <div class="row">
          <div class="column">
            <label>Aktuelles Stundenkonto:</label>
            <input type="number" id="aktuelles-konto" value="0" onchange="updateCalculations()">
          </div>
          <div class="column">
            <label>In Zeit:</label>
            <input type="text" id="aktuelles-konto-time" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>Differenz:</label>
            <input type="text" id="differenz" readonly>
          </div>
          <div class="column">
            <label>In Zeit:</label>
            <input type="text" id="differenz-time" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>Neues Stundenkonto:</label>
            <input type="text" id="neues-konto" readonly>
          </div>
          <div class="column">
            <label>In Zeit:</label>
            <input type="text" id="neues-konto-time" readonly>
          </div>
        </div>
        <button class="button" onclick="saveDay()">Tag speichern</button>
      </div>
      
      <div class="section">
        <h3>Berechnete Ausstempelzeiten (inkl. Pausen):</h3>
        <div class="row">
          <div class="column">
            <label>Sollarbeitszeit:</label>
            <input type="text" id="end-time-soll" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>4h:</label>
            <input type="text" id="end-time-4h" readonly>
          </div>
          <div class="column">
            <label>6h:</label>
            <input type="text" id="end-time-6h" readonly>
          </div>
        </div>
        <div class="row">
          <div class="column">
            <label>9h:</label>
            <input type="text" id="end-time-9h" readonly>
          </div>
          <div class="column">
            <label>10h:</label>
            <input type="text" id="end-time-10h" readonly>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="history-page">
    <div class="container">
      <h1>Verlauf</h1>
      <button class="button nav-button" onclick="showMainPage()">Zurück</button>
      <h2 id="week-info"></h2>
      <ul id="history-list"></ul>
      <div id="weekly-summary"></div>
      <div id="pagination"></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="closeDetailModal()">×</button>
      <h3>Details für <span id="detail-date"></span></h3>
      <p>Kommen: <span id="detail-kommen"></span></p>
      <p>Gehen: <span id="detail-gehen"></span></p>
      <p>Differenz: <span id="detail-differenz"></span></p>
    </div>
  </div>

  <!-- Add Day Modal -->
  <div id="add-day-modal" class="modal" data-date="">
    <div class="modal-content">
      <button class="close-button" onclick="closeAddDayModal()">×</button>
      <h3 id="add-day-modal-title">Manuelle Buchung</h3>
      <div class="row">
        <div class="column">
          <label for="add-day-kommen">Kommen:</label>
          <input type="time" id="add-day-kommen">
        </div>
        <div class="column">
          <label for="add-day-gehen">Gehen:</label>
          <input type="time" id="add-day-gehen">
        </div>
      </div>
      <div class="switch-container" style="margin-top:10px;">
        <label class="switch">
          <input type="checkbox" id="pc-buchung-add-day">
          <span class="slider"></span>
        </label>
        <span>PC-Buchung</span>
      </div>
      <button class="button" onclick="addManualDay()">Speichern</button>
    </div>
  </div>
</body>
</html>
