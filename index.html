<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta
      name="theme-color"
      content="#f2f2f7"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#000000"
      media="(prefers-color-scheme: dark)"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="default"
    />
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit" />
    <link
      rel="apple-touch-icon"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="apple-touch-startup-image"
      href="https://NuclearMeltdown.github.io/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://NuclearMeltdown.github.io/favicon.png"
    />
    <meta name="application-name" content="Arbeitszeitrechner" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta
      name="msapplication-TileImage"
      content="https://NuclearMeltdown.github.io/mstile-144x144.png"
    />

    <title>Arbeitszeitrechner</title>

    <script>
      // Globale Variablen (Date Objekte f√ºr UI-Interaktion)
      let kommenZeit = null,
        gehenZeit = null;
      // Globale Variablen f√ºr Berechnungen (Dezimalstunden)
      let kommenDecimal = null,
        gehenDecimal = null;

      let currentWeekYear = null,
        currentWeekNo = null;
      let currentMonthYear = null,
        currentMonth = null;
      let currentView = "main"; // main, history, month, stats, options

      // Globale Einstellungen (werden aus LS geladen)
      let settings = {
        wochenarbeitszeit: 38,
        bundesland: "NATIONAL",
        allowWochenende: false,
        allowNachtarbeit: false,
        ezaActive: false,
        ezaKontoStand: 0, // EZA-Konto in Stunden (decimal)
      };

      // Hilfsfunktionen
      const $ = (id) => document.getElementById(id);
      const pad = (num) => num.toString().padStart(2, "0");
      const PC_BOOKING_ADJUSTMENT_DECIMAL = 8 / 60; // ca. 0.1333...

      // --- NEUE/ANGEPASSTE Zeit-Konvertierungsfunktionen ---
      function parseTimeToDate(timeStr) {
        // Gibt ein Date-Objekt zur√ºck (f√ºr UI und Speicherung)
        if (!timeStr) return null;
        const match = timeStr.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        const now = new Date();
        now.setHours(hh, mm, 0, 0);
        return now;
      }

      function parseTimeToDecimal(timeStr) {
        // Gibt Dezimalstunden zur√ºck
        if (!timeStr) return null;
        const match = timeStr.match(/^(\d{2}):(\d{2})$/);
        if (!match) return null;
        const hh = parseInt(match[1], 10);
        const mm = parseInt(match[2], 10);
        if (isNaN(hh) || isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59)
          return null;
        return hh + mm / 60;
      }

      function dateToDecimalHours(dateObj) {
          // Konvertiert Date-Objekt zu Dezimalstunden
          if (!dateObj || isNaN(dateObj.getTime())) return null;
          return dateObj.getHours() + dateObj.getMinutes() / 60;
      }

      function formatTime(date) {
        // Formatiert Date-Objekt zu hh:mm
        if (!date || isNaN(date.getTime())) return "--:--";
        const hours = date.getHours();
        const minutes = date.getMinutes();
        return `${pad(hours)}:${pad(minutes)}`;
      }

      function formatDecimalToTime(decimalH) {
        // Formatiert Dezimalstunden zu hh:mm (gerundet)
        if (isNaN(decimalH) || decimalH === null) return "0:00";
        const absVal = Math.abs(decimalH);
        const totalMinutes = Math.round(absVal * 60);
        const hh = Math.floor(totalMinutes / 60);
        const mm = totalMinutes % 60;
        return `${decimalH < 0 ? "-" : ""}${hh}:${pad(mm)}`;
      }
      // --- Ende Zeit-Konvertierungsfunktionen ---

      function formatEzaKonto(totalHours) {
        if (isNaN(totalHours)) return "0 Tage + 0.0h";
        const sollProTag = settings.wochenarbeitszeit / 5;
        if (sollProTag <= 0) return `(${totalHours.toFixed(1)}h)`;

        const sign = totalHours < 0 ? "-" : "";
        const absHours = Math.abs(totalHours);

        const fullDays = Math.floor(absHours / sollProTag);
        // Runde Reststunden kaufm√§nnisch auf eine Nachkommastelle
        const remainingHours = parseFloat((absHours % sollProTag).toFixed(1));

        return `${sign}${fullDays} Tag${
          fullDays !== 1 ? "e" : ""
        } + ${remainingHours}h`;
      }

      function storeToLS(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.error("Error saving to localStorage", e);
          alert(
            "Fehler beim Speichern der Daten. M√∂glicherweise ist der Speicher voll."
          );
        }
      }

      function getFromLS(key, defaultVal = null) {
        try {
          const val = localStorage.getItem(key);
          return val !== null ? val : defaultVal;
        } catch (e) {
          console.error("Error reading from localStorage", e);
          return defaultVal;
        }
      }

      function getHistory() {
        const history = JSON.parse(getFromLS("history", "[]"));
        history.forEach((entry) => {
          entry.urlaub = entry.urlaub || false;
          entry.krank = entry.krank || false;
          entry.schulung = entry.schulung || false;
          entry.glaz = entry.glaz || false;
          entry.pcBuchung = entry.pcBuchung || false;
          entry.buero = entry.buero || false;
          entry.isEzaTag = entry.isEzaTag || false;
          entry.ezaActiveDuringBooking =
            entry.ezaActiveDuringBooking || false;
          entry.originalKommen = entry.originalKommen || null;
          entry.dateObj = new Date(entry.datum + "T00:00:00");
        });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj);
        return history;
      }

      // --- Feiertagslogik (unver√§ndert) ---
      const holidays = { NATIONAL:{"01-01":"Neujahr","05-01":"Tag der Arbeit","10-03":"Tag der Deutschen Einheit","12-25":"1. Weihnachtstag","12-26":"2. Weihnachtstag"}, BW:{"01-06":"Heilige Drei K√∂nige","11-01":"Allerheiligen"}, BY:{"01-06":"Heilige Drei K√∂nige","08-15":"Mari√§ Himmelfahrt","11-01":"Allerheiligen"}, BE:{"03-08":"Internationaler Frauentag"}, BB:{"10-31":"Reformationstag"}, HB:{"10-31":"Reformationstag"}, HH:{"10-31":"Reformationstag"}, HE:{}, MV:{"10-31":"Reformationstag"}, NI:{"10-31":"Reformationstag"}, NW:{"11-01":"Allerheiligen"}, RP:{"11-01":"Allerheiligen"}, SL:{"08-15":"Mari√§ Himmelfahrt","11-01":"Allerheiligen"}, SN:{"10-31":"Reformationstag"}, ST:{"01-06":"Heilige Drei K√∂nige","10-31":"Reformationstag"}, SH:{"10-31":"Reformationstag"}, TH:{"09-20":"Weltkindertag","10-31":"Reformationstag"} };
      const regionalMovableHolidays = { BW:["fronleichnam"], BY:["fronleichnam"], HE:["fronleichnam"], NW:["fronleichnam"], RP:["fronleichnam"], SL:["fronleichnam"], SN:["bussbettag"] };
      function getEasterSunday(year) { const a=year%19,b=Math.floor(year/100),c=year%100; const d=Math.floor(b/4),e=b%4; const f=Math.floor((b+8)/25); const g=Math.floor((b-f+1)/3); const h=(19*a+b-d-g+15)%30; const i=Math.floor(c/4),k=c%4; const l=(32+2*e+2*i-h-k)%7; const m=Math.floor((a+11*h+22*l)/451); const month=Math.floor((h+l-7*m+114)/31); const day=((h+l-7*m+114)%31)+1; return new Date(Date.UTC(year,month-1,day)); }
      function getHolidayName(date, bundesland) { if (!date || isNaN(date.getTime())) return null; const year=date.getFullYear(); const month=date.getMonth()+1; const day=date.getDate(); const mmdd=`${pad(month)}-${pad(day)}`; if (holidays.NATIONAL[mmdd]) return holidays.NATIONAL[mmdd]; const regionalFixed=holidays[bundesland]||{}; if (regionalFixed[mmdd]) return regionalFixed[mmdd]; const easterSunday=getEasterSunday(year); const movableHolidays={}; const goodFriday=new Date(easterSunday); goodFriday.setUTCDate(easterSunday.getUTCDate()-2); movableHolidays[`${pad(goodFriday.getUTCMonth()+1)}-${pad(goodFriday.getUTCDate())}`]="Karfreitag"; const easterMonday=new Date(easterSunday); easterMonday.setUTCDate(easterSunday.getUTCDate()+1); movableHolidays[`${pad(easterMonday.getUTCMonth()+1)}-${pad(easterMonday.getUTCDate())}`]="Ostermontag"; const ascensionDay=new Date(easterSunday); ascensionDay.setUTCDate(easterSunday.getUTCDate()+39); movableHolidays[`${pad(ascensionDay.getUTCMonth()+1)}-${pad(ascensionDay.getUTCDate())}`]="Christi Himmelfahrt"; const whitMonday=new Date(easterSunday); whitMonday.setUTCDate(easterSunday.getUTCDate()+50); movableHolidays[`${pad(whitMonday.getUTCMonth()+1)}-${pad(whitMonday.getUTCDate())}`]="Pfingstmontag"; if (regionalMovableHolidays[bundesland]?.includes("fronleichnam")) { const corpusChristi=new Date(easterSunday); corpusChristi.setUTCDate(easterSunday.getUTCDate()+60); movableHolidays[`${pad(corpusChristi.getUTCMonth()+1)}-${pad(corpusChristi.getUTCDate())}`]="Fronleichnam"; } if (regionalMovableHolidays[bundesland]?.includes("bussbettag")) { const nov23=new Date(Date.UTC(year,10,23)); const dayOfWeekNov23=nov23.getUTCDay(); const daysToSubtract=(dayOfWeekNov23+4)%7; const bussBettag=new Date(nov23); bussBettag.setUTCDate(nov23.getUTCDate()-daysToSubtract); movableHolidays[`${pad(bussBettag.getUTCMonth()+1)}-${pad(bussBettag.getUTCDate())}`]="Bu√ü- und Bettag"; } return movableHolidays[mmdd]||null; }
      // --- ENDE Feiertagslogik ---

      function loadSettings() {
        settings.wochenarbeitszeit = parseFloat(
          getFromLS("wochenarbeitszeitValue", "38")
        );
        settings.bundesland = getFromLS("bundesland", "NATIONAL");
        settings.allowWochenende = getFromLS("allowWochenende") === "true";
        settings.allowNachtarbeit = getFromLS("allowNachtarbeit") === "true";
        settings.ezaActive = getFromLS("ezaActive") === "true";
        settings.ezaKontoStand = parseFloat(getFromLS("ezaKontoStand", "0"));
        $("wochenarbeitszeit").value = settings.wochenarbeitszeit.toFixed(1);
      }

      function saveSettings() {
        storeToLS(
          "wochenarbeitszeitValue",
          settings.wochenarbeitszeit.toString()
        );
        storeToLS("bundesland", settings.bundesland);
        storeToLS(
          "allowWochenende",
          settings.allowWochenende ? "true" : "false"
        );
        storeToLS(
          "allowNachtarbeit",
          settings.allowNachtarbeit ? "true" : "false"
        );
        storeToLS("ezaActive", settings.ezaActive ? "true" : "false");
        $("wochenarbeitszeit").value = settings.wochenarbeitszeit.toFixed(1);
        updateCalculations();
        if (currentView === "history") loadHistory();
        if (currentView === "month") loadMonthData();
        if (currentView === "options") loadOptions();
      }

      function saveEzaKonto() {
        const inputVal = $("eza-konto-input").value;
        const newStand = parseFloat(inputVal);

        if (isNaN(newStand)) {
          alert("Bitte einen g√ºltigen Zahlenwert f√ºr das EZA-Konto eingeben.");
          $("eza-konto-input").value = settings.ezaKontoStand.toFixed(2);
          return;
        }

        settings.ezaKontoStand = newStand;
        storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
        updateEzaKontoDisplay();
        alert("EZA-Kontostand gespeichert.");
      }

      function updateEzaKontoDisplay() {
        const displayField = $("eza-konto-display");
        if (displayField) {
          displayField.value = formatEzaKonto(settings.ezaKontoStand);
        }
        const inputField = $("eza-konto-input");
        if (inputField) {
          if (document.activeElement !== inputField) {
            inputField.value = settings.ezaKontoStand.toFixed(2);
          }
        }
      }

      // ANGEPASST: init() - Initialisiert Dezimalwerte
      function init() {
        loadSettings();
        restoreInputsFromLocalStorage(); // Stellt kommenZeit/gehenZeit (Date) wieder her
        // Initialisiere Dezimalwerte aus Date-Objekten
        kommenDecimal = kommenZeit ? dateToDecimalHours(kommenZeit) : null;
        gehenDecimal = gehenZeit ? dateToDecimalHours(gehenZeit) : null;

        const heute = new Date();
        [currentWeekYear, currentWeekNo] = getWeekNumber(heute);
        currentMonthYear = heute.getFullYear();
        currentMonth = heute.getMonth();

        let lastKontoValue = 0;
        const lastKontoStored = getFromLS("aktuellesStundenkonto");
        if (lastKontoStored) {
          lastKontoValue = parseFloat(lastKontoStored);
        } else {
          const history = getHistory();
          if (history.length > 0) {
            const lastEntry = history[history.length - 1];
            if (lastEntry.stundenkonto) {
              lastKontoValue = parseFloat(lastEntry.stundenkonto);
              storeToLS("aktuellesStundenkonto", lastEntry.stundenkonto);
            }
          }
        }
        $("aktuelles-konto").value = lastKontoValue.toFixed(2);

        updateEzaKontoDisplay();
        updateCalculations(); // Berechnet alles neu basierend auf Dezimalwerten
        switchView("main");
        setupEventListeners();
        closeAddDayModal();
        closeDetailModal();
        closeBulkModal();
        closeLegendModal();
      }

      function setupEventListeners() {
        $("nav-main").addEventListener("click", () => switchView("main"));
        $("nav-history").addEventListener("click", () => switchView("history"));
        $("nav-month").addEventListener("click", () => switchView("month"));
        $("nav-stats").addEventListener("click", () => switchView("stats"));
        $("nav-options").addEventListener("click", () => switchView("options"));
        $("kommen-display").oninput = onInputChange; // Beh√§lt oninput f√ºr UI-Updates
        $("gehen-display").oninput = onInputChange; // Beh√§lt oninput f√ºr UI-Updates
        $("pc-buchung").onchange = onInputChange; // L√∂st Neuberechnung aus
        $("buero-toggle").onchange = onInputChange; // Nur f√ºr Speicherung relevant
        $("zusatzliche-pause").oninput = onInputChange; // L√∂st Neuberechnung aus
        document.querySelectorAll(".close-button").forEach((btn) => {
          btn.onclick = () => {
            const modal = btn.closest(".modal");
            if (modal) modal.style.display = "none";
          };
        });
        $("stats-period").onchange = () => calculateAndDisplayStats();
        $("urlaub-toggle").onchange = () => toggleSpecialDay("urlaub");
        $("krank-toggle").onchange = () => toggleSpecialDay("krank");
        $("schulung-toggle").onchange = () => toggleSpecialDay("schulung");
        $("glaz-toggle").onchange = () => toggleSpecialDay("glaz");
        $("eza-tag-toggle").onchange = () => toggleSpecialDay("ezaTag");
        $("open-bulk-modal-button").addEventListener("click", showBulkModal);
        $("apply-bulk-modal-button").addEventListener(
          "click",
          applyBulkBooking
        );
        $("bundesland-select").onchange = (e) => {
          settings.bundesland = e.target.value;
          saveSettings();
        };
        $("wochenarbeitszeit-setting").onchange = (e) => {
          const val = parseFloat(e.target.value);
          if (!isNaN(val) && val > 0) {
            settings.wochenarbeitszeit = val;
            saveSettings();
          } else {
            e.target.value = settings.wochenarbeitszeit.toFixed(1);
          }
        };
        $("wochenende-toggle").onchange = (e) => {
          settings.allowWochenende = e.target.checked;
          saveSettings();
        };
        $("nachtarbeit-toggle").onchange = (e) => {
          settings.allowNachtarbeit = e.target.checked;
          saveSettings();
        };
        $("export-button-options").addEventListener("click", exportHistoryToJson);
        $("import-button-options").addEventListener("click", importHistoryFromJson);
        $("korrektur-anwenden-button").addEventListener(
          "click",
          applyBalanceCorrection
        );
        $("eza-toggle").onchange = (e) => {
          settings.ezaActive = e.target.checked;
          saveSettings();
        };
        $("eza-konto-speichern-button").addEventListener("click", saveEzaKonto);
        $("show-legend-button").addEventListener("click", showLegendModal);
      }

      function restoreInputsFromLocalStorage() {
        const storedKommen = getFromLS("kommenZeitValue");
        const storedGehen = getFromLS("gehenZeitValue");
        if (storedKommen) {
          $("kommen-display").value = storedKommen;
          kommenZeit = parseTimeToDate(storedKommen); // Date Objekt f√ºr UI
        }
        if (storedGehen) {
          $("gehen-display").value = storedGehen;
          gehenZeit = parseTimeToDate(storedGehen); // Date Objekt f√ºr UI
        }
        $("pc-buchung").checked = getFromLS("pcBuchungChecked") === "true";
        $("buero-toggle").checked = getFromLS("bueroChecked") === "true";
        const storedPause = getFromLS("zusatzlichePauseValue");
        if (storedPause) $("zusatzliche-pause").value = storedPause;
      }

      function storeInputsToLocalStorage() {
        storeToLS("kommenZeitValue", $("kommen-display").value);
        storeToLS("gehenZeitValue", $("gehen-display").value);
        storeToLS(
          "pcBuchungChecked",
          $("pc-buchung").checked ? "true" : "false"
        );
        storeToLS(
          "bueroChecked",
          $("buero-toggle").checked ? "true" : "false"
        );
        storeToLS("zusatzlichePauseValue", $("zusatzliche-pause").value);
      }

      // ANGEPASST: setZeit() - Aktualisiert auch Dezimalwerte
      function setZeit(type) {
        const now = new Date();
        if (type === "kommen") {
          kommenZeit = now; // Date Objekt f√ºr UI
          $("kommen-display").value = formatTime(kommenZeit);
          kommenDecimal = dateToDecimalHours(kommenZeit); // Dezimal f√ºr Berechnung
        } else {
          gehenZeit = now; // Date Objekt f√ºr UI
          $("gehen-display").value = formatTime(gehenZeit);
          gehenDecimal = dateToDecimalHours(gehenZeit); // Dezimal f√ºr Berechnung
        }
        storeInputsToLocalStorage();
        updateCalculations();
      }

      // =========================================================================
      // ANGEPASSTE FUNKTION: onInputChange() - Aktualisiert Dezimalwerte
      // =========================================================================
      function onInputChange() {
        // Aktualisiere Date-Objekte f√ºr die Speicherung des UI-Status
        kommenZeit = parseTimeToDate($("kommen-display").value);
        gehenZeit = parseTimeToDate($("gehen-display").value);
        // Aktualisiere Dezimalwerte f√ºr Berechnungen
        kommenDecimal = parseTimeToDecimal($("kommen-display").value);
        gehenDecimal = parseTimeToDecimal($("gehen-display").value);

        storeInputsToLocalStorage(); // Speichert die hh:mm Strings
        updateCalculations(); // L√∂st Neuberechnung aus
      }

      function parsePauseInput(inputId) {
        // Gibt direkt Dezimalstunden zur√ºck (unver√§ndert)
        const val = $(inputId).value;
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          return hh + mm / 60;
        } else {
          const decimalHours = parseFloat(cleanedVal);
          return isNaN(decimalHours) ? 0 : decimalHours;
        }
      }

      // =========================================================================
      // NEUE FUNKTION: getAdjustedKommenDecimal() - Gibt angepasste Dezimalzeit zur√ºck
      // =========================================================================
      function getAdjustedKommenDecimal() {
        if (kommenDecimal === null) return null;
        let adjusted = kommenDecimal;
        if ($("pc-buchung").checked) {
          adjusted -= PC_BOOKING_ADJUSTMENT_DECIMAL;
        }
        return adjusted;
      }

      // =========================================================================
      // REFAKTORIERTE FUNKTION: calculatePresenceDecimal() - Berechnet Anwesenheit in Dezimal
      // =========================================================================
      function calculatePresenceDecimal() {
        const adjustedKommenDec = getAdjustedKommenDecimal();
        const gehenDec = gehenDecimal; // Verwende globale Dezimalvariable

        if (adjustedKommenDec === null || gehenDec === null) {
          return 0;
        }

        let presence = gehenDec - adjustedKommenDec;
        if (presence < 0) {
          // Annahme: √úbernachtarbeit
          presence += 24;
        }
        return presence;
      }

      // =========================================================================
      // REFAKTORIERTE FUNKTION: calculateTotalPauseDecimal() - Berechnet Pause in Dezimal
      // =========================================================================
      function calculateTotalPauseDecimal(presenceDecimal) {
        let additionalPause = parsePauseInput("zusatzliche-pause");
        let statutoryPause = 0;
        // Wichtig: Schwellenwerte f√ºr Pausen basieren auf Anwesenheit
        if (presenceDecimal > 9) {
          statutoryPause = 0.75; // 45 min
        } else if (presenceDecimal > 6) {
          statutoryPause = 0.5; // 30 min
        }
        return additionalPause + statutoryPause;
      }

      // =========================================================================
      // REFAKTORIERTE FUNKTION: calculateNetArbeitszeitDecimal() - Berechnet Nettozeit in Dezimal
      // =========================================================================
      function calculateNetArbeitszeitDecimal() {
        const presenceDecimal = calculatePresenceDecimal();
        if (presenceDecimal <= 0) return 0;

        // Gesetzliche Pause basierend auf Anwesenheit (f√ºr Netto-Berechnung relevant)
        let statutoryPauseForNet = 0;
        if (presenceDecimal > 9.75) { // Ab 9:46 Anwesenheit
            statutoryPauseForNet = 0.75;
        } else if (presenceDecimal > 6.5) { // Ab 6:31 Anwesenheit
            statutoryPauseForNet = 0.5;
        }

        const additionalPauseDecimal = parsePauseInput("zusatzliche-pause");
        let netArbeitszeitDecimal = presenceDecimal - additionalPauseDecimal - statutoryPauseForNet;

        // EZA-Freeze-Logik (angepasst f√ºr Dezimal)
        if (presenceDecimal > 6.0 && presenceDecimal <= 6.5) {
            // Anwesenheit 6:01 bis 6:30 -> Netto max 6.0
            netArbeitszeitDecimal = Math.min(netArbeitszeitDecimal, 6.0);
        } else if (presenceDecimal > 9.5 && presenceDecimal <= 9.75) {
            // Anwesenheit 9:31 bis 9:45 -> Netto max 9.0
            netArbeitszeitDecimal = Math.min(netArbeitszeitDecimal, 9.0);
        }

        return Math.max(0, netArbeitszeitDecimal);
      }


      // =========================================================================
      // REFAKTORIERTE FUNKTION: calculateEndTimeFixpoint() - Arbeitet intern mit Dezimal
      // =========================================================================
      function calculateEndTimeFixpoint(desiredNetDecimal) {
        const adjustedKommenDec = getAdjustedKommenDecimal();
        if (adjustedKommenDec === null) return "--:--";

        let presenceDecimal = desiredNetDecimal; // Start guess
        const additionalPauseDecimal = parsePauseInput("zusatzliche-pause");

        for (let i = 0; i < 5; i++) {
          const prevPresenceDecimal = presenceDecimal;
          let statutoryPauseDecimal = 0;

          // Pausenlogik basierend auf *gesch√§tzter* Anwesenheit
          if (desiredNetDecimal === 9) { // Spezialfall 9h Netto
            // Hier nur 0.5h Pause ber√ºcksichtigen, da die 0.75h erst nach 9h Netto relevant werden
            if (prevPresenceDecimal > 6) statutoryPauseDecimal = 0.5;
          } else { // Standardfall
            // Hier die volle Pausenlogik anwenden
            if (prevPresenceDecimal > 9) statutoryPauseDecimal = 0.75;
            else if (prevPresenceDecimal > 6) statutoryPauseDecimal = 0.5;
          }

          const totalPauseDecimal = additionalPauseDecimal + statutoryPauseDecimal;
          presenceDecimal = desiredNetDecimal + totalPauseDecimal; // Update presence guess

          // Konvergenzpr√ºfung (ca. 0.1 Min)
          if (Math.abs(presenceDecimal - prevPresenceDecimal) < 1 / 600) break;
        }

        // Endzeit berechnen: Kommen (Dezimal) + Anwesenheit (Dezimal)
        let endDecimal = adjustedKommenDec + presenceDecimal;
        // √úberlauf √ºber Mitternacht behandeln (optional, falls relevant)
        // endDecimal %= 24; // Einfacher Modulo, falls Zeiten > 24 nicht gew√ºnscht

        // Umwandlung zur√ºck in hh:mm Format
        const endH = Math.floor(endDecimal);
        const endM = Math.round((endDecimal - endH) * 60);
        // Umgang mit √úberlauf > 23:59 (z.B. 24:00 wird 00:00)
        const finalH = endH % 24;
        const finalM = endM % 60; // Sollte durch Math.round schon passen

        // Date-Objekt nur f√ºr die Formatierung erstellen
        const endDate = new Date();
        endDate.setHours(finalH, finalM, 0, 0);

        return formatTime(endDate);
      }


      function updateEndTimes() {
        if (kommenDecimal === null) {
          ["soll", "4h", "6h", "9h", "10h"].forEach((id) => {
            const el = $(`end-time-${id}`);
            if (el) el.value = "";
          });
          return;
        }
        // Rufe mit Dezimal-Zielwerten auf
        [4, 6, 9, 10].forEach((d) => {
          const el = $(`end-time-${d}h`);
          if (el) el.value = calculateEndTimeFixpoint(d);
        });
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        const outS = calculateEndTimeFixpoint(sollProTagDecimal);
        const elSoll = $("end-time-soll");
        if (elSoll) elSoll.value = `(${sollProTagDecimal.toFixed(2)}h): ${outS}`;
      }

      // =========================================================================
      // ANGEPASSTE FUNKTION: updateCalculations() - Verwendet Dezimal-Funktionen
      // =========================================================================
      function updateCalculations() {
        const netArbeitszeitDecimal = calculateNetArbeitszeitDecimal();
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        let diffDecimal = 0;
        if (netArbeitszeitDecimal > 0) {
            // Runde die Differenz kaufm√§nnisch auf 2 Nachkommastellen f√ºr Konsistenz
            diffDecimal = parseFloat((netArbeitszeitDecimal - sollProTagDecimal).toFixed(2));
        }


        const aktKontoVal =
          parseFloat(getFromLS("aktuellesStundenkonto", "0")) || 0;
        // Runde das neue Konto ebenfalls
        let newKtoDecimal = parseFloat((aktKontoVal + diffDecimal).toFixed(2));

        $("aktuelles-konto").value = aktKontoVal.toFixed(2);

        const presenceDecimal = calculatePresenceDecimal();
        // Wichtig: Die *angezeigte* Pause basiert auf der vollen Anwesenheit
        const totalPauseDecimal = calculateTotalPauseDecimal(presenceDecimal);

        // Update UI Felder
        $("anwesend-zeit").value = `${formatDecimalToTime(
          presenceDecimal
        )} (${presenceDecimal.toFixed(2)}h)`;
        $("pausenzeit").value = `${Math.round(totalPauseDecimal * 60)} Min (${totalPauseDecimal.toFixed(2)}h)`;
        $("arbeitszeit").value = `${formatDecimalToTime(
          netArbeitszeitDecimal
        )} (${netArbeitszeitDecimal.toFixed(2)}h)`;
        $("sollarbeitszeit-display").value = `${formatDecimalToTime(
          sollProTagDecimal
        )} (${sollProTagDecimal.toFixed(2)}h)`;
        $("differenz").value = diffDecimal.toFixed(2);
        $("differenz-time").value = formatDecimalToTime(diffDecimal);
        $("neues-konto").value = newKtoDecimal.toFixed(2);
        $("neues-konto-time").value = formatDecimalToTime(newKtoDecimal);
        $("aktuelles-konto-time").value = formatDecimalToTime(aktKontoVal);

        const fieldsToColor = [
          { id: "differenz", value: diffDecimal },
          { id: "differenz-time", value: diffDecimal },
          { id: "neues-konto", value: newKtoDecimal },
          { id: "neues-konto-time", value: newKtoDecimal },
          { id: "aktuelles-konto", value: aktKontoVal },
          { id: "aktuelles-konto-time", value: aktKontoVal },
        ];
        fieldsToColor.forEach((item) => {
          const el = $(item.id);
          if (!el) return;
          el.classList.remove(
            "positive-value",
            "negative-value",
            "zero-value"
          );
          // Toleranz f√ºr Flie√ükommavergleiche
          if (item.value > 0.001) el.classList.add("positive-value");
          else if (item.value < -0.001) el.classList.add("negative-value");
          else el.classList.add("zero-value");
        });

        // Violation Check (ben√∂tigt Date-Objekte oder muss angepasst werden)
        let hinweisText = "";
        let showKommenMoon = false,
          showGehenMoon = false,
          showArbeitszeitMoon = false;
        // Hole Date-Objekte f√ºr den Check (ggf. angepasst)
        const adjustedKommenDate = getAdjustedKommenZeit(); // Holt Date-Objekt f√ºr Check
        const gehenDate = gehenZeit; // Holt Date-Objekt f√ºr Check
        const kommenField = $("kommen-display");
        const gehenField = $("gehen-display");
        kommenField.classList.remove("invalid-time");
        gehenField.classList.remove("invalid-time");
        $("kommen-moon").style.display = "none";
        $("gehen-moon").style.display = "none";
        $("arbeitszeit-moon").style.display = "none";

        // Violation Check braucht ggf. Anpassung oder bleibt bei Date-Objekten
        const violations = checkViolations(adjustedKommenDate, gehenDate, netArbeitszeitDecimal);

        if (violations.arbeitszeit && netArbeitszeitDecimal > 0) {
          if (settings.allowNachtarbeit) showArbeitszeitMoon = true;
          else hinweisText += "Achtung: Arbeitszeit au√üerhalb 4-10h!<br>";
        }
        if (violations.kommen) {
          if (settings.allowNachtarbeit) showKommenMoon = true;
          else {
            hinweisText += "Achtung: Kommen au√üerhalb 06:00-16:00!<br>";
            kommenField.classList.add("invalid-time");
          }
        }
        if (violations.gehen) {
          if (settings.allowNachtarbeit) showGehenMoon = true;
          else {
            hinweisText += "Achtung: Gehen nach 20:00!<br>";
            gehenField.classList.add("invalid-time");
          }
        }

        const hinweis = $("hinweis");
        hinweis.innerHTML = hinweisText;
        hinweis.style.display = hinweisText ? "block" : "none";
        if (showKommenMoon) $("kommen-moon").style.display = "inline";
        if (showGehenMoon) $("gehen-moon").style.display = "inline";
        if (showArbeitszeitMoon) $("arbeitszeit-moon").style.display = "inline";

        updateEndTimes();
      }

      function calculateAutoPauseForDuration(presenceDecimal) {
        // Nimmt Dezimal-Anwesenheit
        if (presenceDecimal > 9) return 0.75;
        if (presenceDecimal > 6) return 0.5;
        return 0;
      }

      // =========================================================================
      // ANGEPASSTE FUNKTION: checkViolations() - Nimmt Date-Objekte (oder muss umgebaut werden)
      // =========================================================================
      function checkViolations(kommenDate, gehenDate, netArbeitszeitDecimal) {
        // kommenDate ist hier die ggf. angepasste Zeit als Date-Objekt
        const violations = {
          kommen: false,
          gehen: false,
          arbeitszeit: false,
          any: false,
        };
        if (!kommenDate || !gehenDate) return violations;

        // Konvertiere zu Dezimal f√ºr Vergleich (oder behalte Date-Logik bei)
        const kommenDecimalCheck = dateToDecimalHours(kommenDate);
        let gehenDecimalCheck = dateToDecimalHours(gehenDate);
        if (gehenDecimalCheck < kommenDecimalCheck) gehenDecimalCheck += 24; // √úbernacht

        if (kommenDecimalCheck < 6 || kommenDecimalCheck > 16) {
          violations.kommen = true;
          violations.any = true;
        }
        if (gehenDecimalCheck > 20) { // Gehen nach 20:00
          violations.gehen = true;
          violations.any = true;
        }
        // Nettoarbeitszeit ist bereits dezimal
        if ((netArbeitszeitDecimal > 0 && netArbeitszeitDecimal < 4) || netArbeitszeitDecimal > 10) {
          violations.arbeitszeit = true;
          violations.any = true;
        }
        return violations;
      }


      // =========================================================================
      // ANGEPASSTE FUNKTION: saveDay() - Verwendet Dezimalberechnung f√ºr Differenz
      // =========================================================================
      function saveDay() {
        // Stelle sicher, dass globale Dezimalwerte aktuell sind
        kommenDecimal = parseTimeToDecimal($("kommen-display").value);
        gehenDecimal = parseTimeToDecimal($("gehen-display").value);
        updateCalculations(); // Berechnet alles neu

        const today = new Date();
        const dayOfWeek = today.getDay();
        if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) {
          alert("Speichern am Wochenende ist in den Optionen deaktiviert.");
          return;
        }
        const datum = today.toISOString().split("T")[0];
        const holidayName = getHolidayName(today, settings.bundesland);
        if (holidayName) {
          alert(`Speichern am Feiertag (${holidayName}) nicht m√∂glich.`);
          return;
        }

        // Hole Original und angepasste Date-Objekte f√ºr Speicherung und Checks
        const originalKommenDate = kommenZeit ? new Date(kommenZeit.getTime()) : null;
        const adjustedKommenDate = getAdjustedKommenZeit(); // Date-Objekt
        const currentGehenDate = gehenZeit ? new Date(gehenZeit.getTime()) : null; // Date-Objekt

        if (!adjustedKommenDate || !currentGehenDate) {
          alert("Bitte Kommen- und Gehen-Zeit f√ºr die Speicherung angeben.");
          return;
        }
        let gehenCheck = new Date(currentGehenDate.getTime());
        if (gehenCheck < adjustedKommenDate) gehenCheck.setDate(gehenCheck.getDate() + 1);
        if (gehenCheck < adjustedKommenDate) {
          alert("Gehen-Zeit liegt vor der (ggf. angepassten) Kommen-Zeit!");
          return;
        }

        // Berechne Nettozeit und Differenz dezimal
        const netArbeitszeitDecimal = calculateNetArbeitszeitDecimal();
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        const mainDifferenceDecimal = parseFloat((netArbeitszeitDecimal - sollProTagDecimal).toFixed(2));

        // Violation Check mit Date-Objekten
        const violations = checkViolations(adjustedKommenDate, gehenCheck, netArbeitszeitDecimal);
        let needsConfirmation = false;
        if (violations.any && !settings.allowNachtarbeit) needsConfirmation = true;
        if (needsConfirmation) {
          if (!confirm("Es liegt ein Versto√ü gegen die Gleitzeitregeln vor. Trotzdem speichern?")) return;
        }

        // EZA-Logik (hier nicht relevant f√ºr normalen Arbeitstag)
        // const ezaDifference = 0;
        // settings.ezaKontoStand += ezaDifference;
        // storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
        // updateEzaKontoDisplay();

        // Aktuellen Hauptkontostand holen und neuen berechnen
        const aktKontoVal = parseFloat(getFromLS("aktuellesStundenkonto", "0")) || 0;
        const newValDecimal = parseFloat((aktKontoVal + mainDifferenceDecimal).toFixed(2));

        // Daten f√ºr Speicherung vorbereiten
        const isPcBuchung = $("pc-buchung").checked;
        const kommenISO = adjustedKommenDate.toISOString(); // Angepasste Zeit
        const originalKommenISO = isPcBuchung && originalKommenDate ? originalKommenDate.toISOString() : null;
        const gehenISO = currentGehenDate.toISOString();
        const isBuero = $("buero-toggle").checked;
        const additionalPauseValue = $("zusatzliche-pause").value || "";

        let history = getHistory();
        const displayDate = today.toLocaleDateString("de-DE");
        const existingIndex = history.findIndex((e) => e.datum === datum);
        const dayData = {
          datum: datum,
          differenz: mainDifferenceDecimal.toFixed(2), // Dezimalwert speichern
          differenzTime: formatDecimalToTime(mainDifferenceDecimal), // Formatierte Zeit f√ºr Kompatibilit√§t? (Optional)
          stundenkonto: newValDecimal.toFixed(2), // Dezimalwert speichern
          kommen: kommenISO,
          originalKommen: originalKommenISO,
          gehen: gehenISO,
          urlaub: false, krank: false, schulung: false, glaz: false, isEzaTag: false,
          ezaActiveDuringBooking: settings.ezaActive,
          pcBuchung: isPcBuchung,
          buero: isBuero,
          zusatzPause: additionalPauseValue,
        };

        if (existingIndex !== -1) {
          if (!confirm(`F√ºr heute (${displayDate}) existiert bereits ein Eintrag. √úberschreiben?`)) return;
          history[existingIndex] = dayData;
        } else {
          history.push(dayData);
        }
        saveAndReload(history); // Berechnet Hauptkonto neu
        alert("Der Tag wurde gespeichert.");
      }


      function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return [d.getUTCFullYear(), weekNo];
      }
      function getDateOfISOWeek(w, y) {
        const simple = new Date(Date.UTC(y, 0, 4 + (w - 1) * 7));
        const dow = simple.getUTCDay() || 7;
        const ISOweekStart = new Date(simple);
        ISOweekStart.setUTCDate(simple.getUTCDate() - dow + 1);
        return ISOweekStart;
      }

      function switchView(viewId) {
        currentView = viewId;
        ["main", "history", "month", "stats", "options"].forEach((id) => {
          const page = $(`${id}-page`);
          const navItem = $(`nav-${id}`);
          if (page) page.style.display = id === viewId ? "block" : "none";
          if (navItem) navItem.classList.toggle("active", id === viewId);
        });
        if (viewId === "history") loadHistory();
        else if (viewId === "month") loadMonthData();
        else if (viewId === "stats") calculateAndDisplayStats();
        else if (viewId === "options") loadOptions();
      }

      function loadOptions() {
        $("bundesland-select").value = settings.bundesland;
        $("wochenarbeitszeit-setting").value =
          settings.wochenarbeitszeit.toFixed(1);
        $("wochenende-toggle").checked = settings.allowWochenende;
        $("nachtarbeit-toggle").checked = settings.allowNachtarbeit;
        $("eza-toggle").checked = settings.ezaActive;
        $("eza-konto-input").value = settings.ezaKontoStand.toFixed(2);
        updateEzaKontoDisplay();
      }

      // ANGEPASST: loadHistory() - Verwendet Dezimalwerte f√ºr Anzeige
      function loadHistory() {
        const historyList = $("history-list");
        historyList.innerHTML = "";
        let history = getHistory();
        const weekStartDateUTC = getDateOfISOWeek(
          currentWeekNo,
          currentWeekYear
        );
        const daysToShow = settings.allowWochenende ? 6 : 4;
        const weekEndDate = new Date(weekStartDateUTC);
        weekEndDate.setUTCDate(weekStartDateUTC.getUTCDate() + daysToShow);
        const optionsDate = { year: "numeric", month: "2-digit", day: "2-digit", timeZone: "Europe/Berlin" };
        const weekRange = `${weekStartDateUTC.toLocaleDateString("de-DE", optionsDate)} - ${weekEndDate.toLocaleDateString("de-DE", optionsDate)}`;
        $("week-info").textContent = `KW ${currentWeekNo} / ${currentWeekYear}`;
        $("week-range").textContent = weekRange;
        const optionsWeekday = { weekday: "long", timeZone: "Europe/Berlin" };
        let weeklyTotalDiff = 0;
        for (let dayOffset = 0; dayOffset <= daysToShow; dayOffset++) {
          const currentDateUTC = new Date(weekStartDateUTC.getTime());
          currentDateUTC.setUTCDate(weekStartDateUTC.getUTCDate() + dayOffset);
          const currentDateStr = currentDateUTC.toISOString().split("T")[0];
          const displayDate = currentDateUTC.toLocaleDateString("de-DE", optionsDate);
          const weekdayName = currentDateUTC.toLocaleDateString("de-DE", optionsWeekday);
          const entry = history.find((e) => e.datum === currentDateStr);
          const holidayName = getHolidayName(currentDateUTC, settings.bundesland);
          const li = document.createElement("li");
          li.classList.add("history-item");
          const entryContentDiv = document.createElement("div");
          entryContentDiv.classList.add("history-entry-content");
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("history-actions");
          if (holidayName) {
            entryContentDiv.classList.add("holiday-day");
            entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div>${holidayName}</div>`;
          } else if (entry) {
            let locationEmoji = entry.buero ? "üè¢" : "üè†";
            let specialDayText = "";
            let bgColorClass = "";
            let textColorVar = "--special-day-text";

            if (entry.urlaub) { specialDayText = "Urlaub"; bgColorClass = "special-day-urlaub-bg"; }
            else if (entry.krank) { specialDayText = "Krank"; bgColorClass = "special-day-krank-bg"; textColorVar = "--special-day-krank-text"; }
            else if (entry.schulung) { specialDayText = "Schulung"; bgColorClass = "special-day-schulung-bg"; textColorVar = "--special-day-schulung-text"; }
            else if (entry.isEzaTag) { specialDayText = "EZA-Tag"; bgColorClass = "special-day-eza-bg"; textColorVar = "--special-day-eza-text"; }
            else if (entry.glaz) { specialDayText = "GLAZ"; bgColorClass = "special-day-glaz-bg"; textColorVar = "--special-day-glaz-text"; }

            const diffVal = parseFloat(entry.differenz) || 0; // Differenz ist jetzt immer Dezimal
            weeklyTotalDiff += diffVal;
            const diffClass = diffVal > 0.001 ? "positive-value" : diffVal < -0.001 ? "negative-value" : "zero-value";

            let ezaIndicatorClass = "";
            let ezaTagIndicatorClass = "";
            if (entry.ezaActiveDuringBooking && !settings.ezaActive) {
              if (entry.urlaub || entry.schulung) ezaIndicatorClass = "eza-related-diff inactive";
              else if (entry.isEzaTag) ezaTagIndicatorClass = "eza-tag-label inactive";
            }

            if (specialDayText) {
              entryContentDiv.classList.add("special-day", bgColorClass);
              entryContentDiv.style.color = `var(${textColorVar})`;
              // Verwende formatDecimalToTime f√ºr die Anzeige der Differenz
              const diffDisplay = (entry.glaz || entry.urlaub || entry.schulung) ? `<span class="diff-badge ${diffClass} ${ezaIndicatorClass}" style="margin-left: 8px;">${formatDecimalToTime(diffVal)}</span>` : "";
              const tagLabelClass = entry.isEzaTag ? ezaTagIndicatorClass : "";
              entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div><span class="${tagLabelClass}">${specialDayText}</span> ${locationEmoji} ${diffDisplay}</div>`;
            } else {
              // Normale Arbeitstage
              const kommenLokal = entry.kommen ? new Date(entry.kommen) : null; // Angepasste Zeit
              const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
              const originalKommenLokal = entry.originalKommen ? new Date(entry.originalKommen) : null; // Originale Zeit

              // Nettozeit-Berechnung f√ºr Violation Check (k√∂nnte auch Dezimal erfolgen)
              const netTimeDecimal = calculateNetArbeitszeitDecimalFromEntryData(kommenLokal, gehenLokal, parsePauseInputFromString(entry.zusatzPause || ""));
              const violations = checkViolations(kommenLokal, gehenLokal, netTimeDecimal); // Check mit angepasster Zeit

              let violationMark = "", moonMark = "";
              if (violations.any) {
                if (settings.allowNachtarbeit) {
                  if (violations.kommen || violations.gehen || violations.arbeitszeit) moonMark = ' <span class="moon-mark">üåô</span>';
                } else {
                  violationMark = ' <span class="violation-mark">!</span>';
                  entryContentDiv.classList.add("violation-day");
                }
              }
              if (entry.ezaActiveDuringBooking) {
                entryContentDiv.classList.add("eza-booked-outline-history");
              }

              // Anzeige der Kommen-Zeit: Original oder angepasst
              const kommenTimeToDisplayStr = originalKommenLokal ? formatTime(originalKommenLokal) : formatTime(kommenLokal);

              entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div>${kommenTimeToDisplayStr} - ${formatTime(gehenLokal)} ${locationEmoji}<span class="diff-badge ${diffClass}" style="margin-left: 8px;">${formatDecimalToTime(diffVal)}</span>${violationMark} ${moonMark}</div>`;
            }
            actionsDiv.innerHTML = `<button class="inline-button" onclick="showDayDetails('${entry.datum}')">i</button><button class="delete-button" onclick="deleteEntryByDate('${entry.datum}')">√ó</button>`;
          } else {
            entryContentDiv.classList.add("no-data");
            entryContentDiv.innerHTML = `<div><strong>${weekdayName}</strong> (${displayDate})</div><div>Kein Eintrag</div>`;
            actionsDiv.innerHTML = `<button class="inline-button add-button" onclick="showAddDayModal('${currentDateStr}')">+</button>`;
          }
          li.appendChild(entryContentDiv);
          li.appendChild(actionsDiv);
          historyList.appendChild(li);
        }
        const diffClassSummary = weeklyTotalDiff > 0.001 ? "positive-value" : weeklyTotalDiff < -0.001 ? "negative-value" : "zero-value";
        $("weekly-summary-content").innerHTML = `Gesamtdifferenz: <span class="diff-badge ${diffClassSummary}">${formatDecimalToTime(weeklyTotalDiff)} (${weeklyTotalDiff.toFixed(2)}h)</span>`;
        updateWeekNavigation();
      }


      function parsePauseInputFromString(val) {
        // Gibt Dezimalstunden zur√ºck (unver√§ndert)
        if (!val) return 0;
        const cleanedVal = val.replace(",", ".");
        if (cleanedVal.includes(":")) {
          const parts = cleanedVal.split(":");
          const hh = parseInt(parts[0], 10) || 0;
          const mm = parseInt(parts[1], 10) || 0;
          return hh + mm / 60;
        } else {
          const decimalHours = parseFloat(cleanedVal);
          return isNaN(decimalHours) ? 0 : decimalHours;
        }
      }

      // =========================================================================
      // REFAKTORIERTE FUNKTION: calculateNetArbeitszeitDecimalFromEntryData()
      // =========================================================================
      function calculateNetArbeitszeitDecimalFromEntryData(
        kommenDate, // Angepasste Zeit als Date-Objekt
        gehenDate,  // Gehen-Zeit als Date-Objekt
        additionalPauseDecimal = 0
      ) {
        if (!kommenDate || !gehenDate) return 0;

        // Konvertiere zu Dezimal f√ºr Berechnung
        const kommenDec = dateToDecimalHours(kommenDate);
        let gehenDec = dateToDecimalHours(gehenDate);

        if (gehenDec < kommenDec) gehenDec += 24; // √úbernacht

        const presenceDecimal = gehenDec - kommenDec;
        if (presenceDecimal < 0) return 0; // Sollte nicht passieren nach √úbernacht-Check

        // Gesetzliche Pause basierend auf Dezimal-Anwesenheit (f√ºr Netto relevant)
        let statutoryPauseForNet = 0;
        if (presenceDecimal > 9.75) statutoryPauseForNet = 0.75;
        else if (presenceDecimal > 6.5) statutoryPauseForNet = 0.5;

        // Nettozeit berechnen
        let netArbeitszeitDecimal = presenceDecimal - additionalPauseDecimal - statutoryPauseForNet;

        // EZA-Freeze-Logik (wie in calculateNetArbeitszeitDecimal)
        if (presenceDecimal > 6.0 && presenceDecimal <= 6.5) {
            netArbeitszeitDecimal = Math.min(netArbeitszeitDecimal, 6.0);
        } else if (presenceDecimal > 9.5 && presenceDecimal <= 9.75) {
            netArbeitszeitDecimal = Math.min(netArbeitszeitDecimal, 9.0);
        }


        return Math.max(0, netArbeitszeitDecimal);
      }


      function deleteEntryByDate(dateStr) {
        let history = getHistory();
        const index = history.findIndex((e) => e.datum === dateStr);
        if (index !== -1) {
          const displayDate = new Date(
            dateStr + "T00:00:00"
          ).toLocaleDateString("de-DE");
          if (
            confirm(
              `M√∂chten Sie den Eintrag f√ºr ${displayDate} wirklich l√∂schen?`
            )
          ) {
            history.splice(index, 1);
            saveAndReload(history);
          }
        }
      }

      function updateWeekNavigation() {
        const pagination = $("pagination");
        pagination.innerHTML = "";
        const createButton = (text, onClick) => {
          const btn = document.createElement("button");
          btn.textContent = text;
          btn.onclick = onClick;
          btn.classList.add("inline-button");
          return btn;
        };
        const prevWeekBtn = createButton("‚Äπ", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() - 7);
          [currentWeekYear, currentWeekNo] = getWeekNumber(d);
          loadHistory();
        });
        const nextWeekBtn = createButton("‚Ä∫", () => {
          const d = getDateOfISOWeek(currentWeekNo, currentWeekYear);
          d.setUTCDate(d.getUTCDate() + 7);
          [currentWeekYear, currentWeekNo] = getWeekNumber(d);
          loadHistory();
        });
        pagination.appendChild(prevWeekBtn);
        pagination.appendChild(nextWeekBtn);
      }

      function showAddDayModal(dateStr) {
        const dateVal = new Date(dateStr + "T12:00:00");
        const displayDate = dateVal.toLocaleDateString("de-DE");
        const weekdayName = dateVal.toLocaleDateString("de-DE", {
          weekday: "long",
        });
        const holidayName = getHolidayName(dateVal, settings.bundesland);
        if (holidayName) {
          alert(`Buchung am Feiertag (${holidayName}) nicht m√∂glich.`);
          return;
        }
        const dayOfWeek = dateVal.getDay();
        if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) {
          alert("Buchung am Wochenende ist in den Optionen deaktiviert.");
          return;
        }
        const history = getHistory();
        const entry = history.find((e) => e.datum === dateStr);
        $("add-day-modal-title").textContent = entry
          ? `Buchung √§ndern: ${weekdayName}, ${displayDate}`
          : `${weekdayName}, ${displayDate}`;

        $("urlaub-toggle").checked = false;
        $("krank-toggle").checked = false;
        $("schulung-toggle").checked = false;
        $("glaz-toggle").checked = false;
        $("eza-tag-toggle").checked = false;

        if (entry) {
          if (entry.originalKommen) {
              $("add-day-kommen").value = formatTime(new Date(entry.originalKommen));
          } else {
              $("add-day-kommen").value = entry.kommen ? formatTime(new Date(entry.kommen)) : "";
          }
          $("add-day-gehen").value = entry.gehen ? formatTime(new Date(entry.gehen)) : "";
          $("add-day-zusatzliche-pause").value = entry.zusatzPause || "";
          $("pc-buchung-add-day").checked = entry.pcBuchung || false;
          $("buero-add-day").checked = entry.buero || false;
          $("urlaub-toggle").checked = entry.urlaub || false;
          $("krank-toggle").checked = entry.krank || false;
          $("schulung-toggle").checked = entry.schulung || false;
          $("glaz-toggle").checked = entry.glaz || false;
          $("eza-tag-toggle").checked = entry.isEzaTag || false;

          const isSpecial =
            entry.urlaub ||
            entry.krank ||
            entry.schulung ||
            entry.glaz ||
            entry.isEzaTag;
          toggleTimeFieldsDisabled(isSpecial);
        } else {
          $("add-day-kommen").value = "";
          $("add-day-gehen").value = "";
          $("add-day-zusatzliche-pause").value = "";
          $("pc-buchung-add-day").checked =
            getFromLS("pcBuchungChecked") === "true";
          $("buero-add-day").checked = getFromLS("bueroChecked") === "true";
          toggleTimeFieldsDisabled(false);
        }
        $("add-day-modal").setAttribute("data-date", dateStr);
        $("add-day-modal").style.display = "flex";
      }

      function toggleSpecialDay(type) {
        const types = ["urlaub", "krank", "schulung", "glaz", "ezaTag"];
        const isChecked = $(type.replace("Tag", "-tag") + "-toggle").checked;
        types.forEach((t) => {
          if (t !== type && isChecked)
            $(t.replace("Tag", "-tag") + "-toggle").checked = false;
        });
        const anySpecialChecked = types.some((t) =>
          $(t.replace("Tag", "-tag") + "-toggle").checked
        );
        toggleTimeFieldsDisabled(anySpecialChecked);
      }

      function toggleTimeFieldsDisabled(disabled) {
        $("add-day-kommen").disabled = disabled;
        $("add-day-gehen").disabled = disabled;
        $("add-day-zusatzliche-pause").disabled = disabled;
        $("pc-buchung-add-day").disabled = disabled;
      }

      // =========================================================================
      // ANGEPASSTE FUNKTION: addManualDay() - Verwendet Dezimalberechnung, speichert originalKommen
      // =========================================================================
      function addManualDay() {
        const dateValStr = $("add-day-modal").getAttribute("data-date");
        if (!dateValStr) { alert("Kein g√ºltiges Datum!"); return; }
        const dateParts = dateValStr.split("-");
        const realDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
        const holidayName = getHolidayName(realDate, settings.bundesland);
        if (holidayName) { alert(`Speichern am Feiertag (${holidayName}) nicht m√∂glich.`); closeAddDayModal(); return; }
        const dayOfWeek = realDate.getDay();
        if (!settings.allowWochenende && (dayOfWeek === 0 || dayOfWeek === 6)) { alert("Speichern am Wochenende deaktiviert."); closeAddDayModal(); return; }

        const isUrlaub = $("urlaub-toggle").checked, isKrank = $("krank-toggle").checked, isSchulung = $("schulung-toggle").checked, isGlaz = $("glaz-toggle").checked, isEzaTag = $("eza-tag-toggle").checked;
        const isBueroAddDay = $("buero-add-day").checked, isPcBuchungAddDay = $("pc-buchung-add-day").checked;
        const additionalPauseManualValue = $("add-day-zusatzliche-pause").value;
        let history = getHistory();
        const existingIndex = history.findIndex((e) => e.datum === dateValStr);
        const displayDate = realDate.toLocaleDateString("de-DE");
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;

        let mainDifferenceDecimal = 0;
        let ezaDifference = 0;
        const currentEzaActive = settings.ezaActive;

        // EZA-Logik f√ºr Differenzen
        if (currentEzaActive) {
          if (isUrlaub || isSchulung) mainDifferenceDecimal = -0.4;
          else if (isKrank) ezaDifference = -0.4;
          else if (isGlaz) mainDifferenceDecimal = -sollProTagDecimal;
          else if (isEzaTag) {
            const neededHours = sollProTagDecimal;
            const availableEza = settings.ezaKontoStand;
            if (availableEza >= neededHours) ezaDifference = -neededHours;
            else if (availableEza > 0) { ezaDifference = -availableEza; mainDifferenceDecimal = -(neededHours - availableEza); }
            else mainDifferenceDecimal = -neededHours;
          }
        } else {
          if (isUrlaub || isKrank || isSchulung || isEzaTag) mainDifferenceDecimal = 0;
          else if (isGlaz) mainDifferenceDecimal = -sollProTagDecimal;
        }

        // EZA-Konto aktualisieren
        if (currentEzaActive && ezaDifference !== 0) {
          settings.ezaKontoStand += ezaDifference;
          storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
          updateEzaKontoDisplay();
        }

        // Basisdaten
        let dayData = {
          datum: dateValStr, differenz: "0.00", differenzTime: "0:00", stundenkonto: "0.00",
          kommen: null, originalKommen: null, gehen: null,
          urlaub: isUrlaub, krank: isKrank, schulung: isSchulung, glaz: isGlaz, isEzaTag: isEzaTag,
          ezaActiveDuringBooking: currentEzaActive, pcBuchung: false, buero: isBueroAddDay, zusatzPause: "",
        };

        // Fall: Sondertag
        if (isUrlaub || isKrank || isSchulung || isGlaz || isEzaTag) {
          dayData.differenz = mainDifferenceDecimal.toFixed(2);
          dayData.differenzTime = formatDecimalToTime(mainDifferenceDecimal);
          let label = isUrlaub ? "Urlaub" : isKrank ? "Krank" : isSchulung ? "Schulung" : isGlaz ? "GLAZ" : "EZA-Tag";
          if (existingIndex !== -1) history[existingIndex] = dayData; else history.push(dayData);
          saveAndReload(history);
          alert(`${label} f√ºr ${displayDate} gespeichert.`);
          closeAddDayModal();
          return;
        }

        // Fall: Normaler Arbeitstag
        const kommenVal = $("add-day-kommen").value, gehenVal = $("add-day-gehen").value;
        if (!kommenVal || !gehenVal) { alert("Bitte Kommen- und Gehen-Zeit angeben!"); return; }
        const kommenDateManual = parseTimeToDate(kommenVal); // Date f√ºr Speicherung
        const gehenDateManual = parseTimeToDate(gehenVal);   // Date f√ºr Speicherung
        if (!kommenDateManual || !gehenDateManual) { alert("Ung√ºltige Zeitformate!"); return; }
        if (gehenDateManual < kommenDateManual) gehenDateManual.setDate(gehenDateManual.getDate() + 1);

        // Dezimalwerte f√ºr Berechnung
        const kommenDec = parseTimeToDecimal(kommenVal);
        let gehenDec = parseTimeToDecimal(gehenVal);
        if (gehenDec < kommenDec) gehenDec += 24; // √úbernacht

        let adjustedKommenDec = kommenDec;
        let originalKommenISO = null;
        if (isPcBuchungAddDay) {
          originalKommenISO = kommenDateManual.toISOString(); // Original Date -> ISO
          adjustedKommenDec -= PC_BOOKING_ADJUSTMENT_DECIMAL;
        }
        // Angepasstes Date-Objekt f√ºr Speicherung von 'kommen'
        const adjustedKommenDate = new Date(kommenDateManual.getTime());
        if(isPcBuchungAddDay) adjustedKommenDate.setMinutes(adjustedKommenDate.getMinutes() - 8);
        const kommenISO = adjustedKommenDate.toISOString();


        const presenceDecimal = gehenDec - adjustedKommenDec;
        if (presenceDecimal < 0) { alert("Angepasste Kommen-Zeit liegt nach Gehen-Zeit!"); return; } // Sollte nicht passieren

        const additionalPauseDecimal = parsePauseInputFromString(additionalPauseManualValue);
        // Nettozeit Dezimal berechnen (mit Freeze-Logik)
        let statutoryPauseForNet = 0;
        if (presenceDecimal > 9.75) statutoryPauseForNet = 0.75;
        else if (presenceDecimal > 6.5) statutoryPauseForNet = 0.5;
        let netArbeitszeitDecimal = presenceDecimal - additionalPauseDecimal - statutoryPauseForNet;
        if (presenceDecimal > 6.0 && presenceDecimal <= 6.5) netArbeitszeitDecimal = Math.min(netArbeitszeitDecimal, 6.0);
        else if (presenceDecimal > 9.5 && presenceDecimal <= 9.75) netArbeitszeitDecimal = Math.min(netArbeitszeitDecimal, 9.0);
        netArbeitszeitDecimal = Math.max(0, netArbeitszeitDecimal);


        // Violation Check (mit Date-Objekten der angepassten Zeit)
        const violations = checkViolations(adjustedKommenDate, gehenDateManual, netArbeitszeitDecimal);
        let needsConfirmation = false;
        if (violations.any && !settings.allowNachtarbeit) needsConfirmation = true;
        if (needsConfirmation) { if (!confirm("Zeiten versto√üen gegen Regeln. Trotzdem speichern?")) return; }

        // Differenz f√ºr normalen Arbeitstag
        mainDifferenceDecimal = parseFloat((netArbeitszeitDecimal - sollProTagDecimal).toFixed(2));

        // Daten setzen
        dayData.differenz = mainDifferenceDecimal.toFixed(2);
        dayData.differenzTime = formatDecimalToTime(mainDifferenceDecimal);
        dayData.kommen = kommenISO; // Angepasste Zeit
        dayData.originalKommen = originalKommenISO; // Originale Zeit
        dayData.gehen = gehenDateManual.toISOString();
        dayData.pcBuchung = isPcBuchungAddDay;
        dayData.zusatzPause = additionalPauseManualValue;

        // Speichern
        if (existingIndex !== -1) history[existingIndex] = dayData; else history.push(dayData);
        saveAndReload(history);
        alert(`Arbeitstag f√ºr ${displayDate} gespeichert.`);
        closeAddDayModal();
      }


      function parseTimeForDate(timeStr, targetDate) {
        // Beh√§lt Funktionalit√§t f√ºr Datumskontext bei Bedarf
        if (!timeStr || !targetDate) return null;
        const date = parseTimeToDate(timeStr); // Nutzt die Basis-Funktion
        if (!date) return null;
        // Setze das Datum vom targetDate
        date.setFullYear(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
        return date;
      }

      function applyBalanceCorrection() {
        const korrekturDatumStr = $("korrektur-datum").value;
        const korrekturWertInput = $("korrektur-wert").value;

        if (!korrekturDatumStr) { alert("Bitte geben Sie das Datum an, f√ºr das die Korrektur gelten soll."); return; }
        if (korrekturWertInput === "" || isNaN(parseFloat(korrekturWertInput))) { alert("Bitte geben Sie einen g√ºltigen numerischen Kontostand ein."); return; }

        const korrekturWert = parseFloat(korrekturWertInput);
        const korrekturDate = new Date(korrekturDatumStr + "T12:00:00");

        if (!confirm(`Soll das Stundenkonto am Ende des ${korrekturDate.toLocaleDateString("de-DE")} wirklich auf ${korrekturWert.toFixed(2)} Stunden gesetzt werden?\n\nACHTUNG: Alle nachfolgenden Eintr√§ge im Verlauf werden unwiderruflich neu berechnet!`)) return;

        let history = getHistory();
        const correctionIndex = history.findIndex((e) => e.datum === korrekturDatumStr);

        if (correctionIndex === -1) { alert("Fehler: F√ºr das angegebene Datum wurde kein Eintrag im Verlauf gefunden. Die Korrektur kann derzeit nur auf einen existierenden Tag angewendet werden."); return; }

        history[correctionIndex].stundenkonto = korrekturWert.toFixed(2);

        for (let i = correctionIndex + 1; i < history.length; i++) {
          const currentEntry = history[i];
          const previousEntry = history[i - 1];
          const baseKonto = parseFloat(previousEntry.stundenkonto || "0");
          const diff = parseFloat(currentEntry.differenz || 0); // Differenz ist bereits Dezimal
          currentEntry.stundenkonto = parseFloat((baseKonto + diff).toFixed(2)).toFixed(2); // Berechne und speichere als String
        }

        storeToLS("history", JSON.stringify(history));

        const latestEntry = history.length > 0 ? history[history.length - 1] : null;
        let kontoBeforeFirst = 0;
        if (history.length > 0) {
          const firstDate = new Date(history[0].datum + "T00:00:00");
          const originalHistory = JSON.parse(getFromLS("history", "[]"));
          const relevantOriginalHistory = originalHistory.filter((entry) => new Date(entry.datum + "T00:00:00") < firstDate);
          if (relevantOriginalHistory.length > 0) {
            relevantOriginalHistory.sort((a, b) => new Date(b.datum) - new Date(a.datum));
            kontoBeforeFirst = parseFloat(relevantOriginalHistory[0].stundenkonto || "0");
          } else {
            kontoBeforeFirst = parseFloat(getFromLS("initialKontoValue", "0"));
          }
        } else {
           kontoBeforeFirst = parseFloat(getFromLS("initialKontoValue", "0"));
        }
        const latestKonto = latestEntry ? parseFloat(latestEntry.stundenkonto || "0") : kontoBeforeFirst;

        $("aktuelles-konto").value = latestKonto.toFixed(2);
        storeToLS("aktuellesStundenkonto", latestKonto.toFixed(2));

        $("korrektur-datum").value = "";
        $("korrektur-wert").value = "";

        alert(`Stundenkonto erfolgreich korrigiert und Verlauf ab ${new Date(korrekturDatumStr + "T12:00:00").toLocaleDateString("de-DE")} neu berechnet.`);

        updateCalculations();
        closeAddDayModal(); closeDetailModal(); closeBulkModal();
        if (currentView === "history") loadHistory();
        if (currentView === "month") loadMonthData();
        if (currentView === "stats") calculateAndDisplayStats();
      }

      // ANGEPASST: saveAndReload() - Verwendet Dezimalwerte
      function saveAndReload(history) {
        history.forEach((entry) => { entry.dateObj = new Date(entry.datum + "T00:00:00"); });
        history.sort((a, b) => a.dateObj - b.dateObj);
        history.forEach((entry) => delete entry.dateObj);

        let previousKonto = 0;
        if (history.length > 0) {
          const firstDateStr = history[0].datum;
          const firstDate = new Date(firstDateStr + "T00:00:00");
          const originalHistory = JSON.parse(getFromLS("history", "[]"));
          const relevantOriginalHistory = originalHistory.filter((entry) => new Date(entry.datum + "T00:00:00") < firstDate);
          if (relevantOriginalHistory.length > 0) {
            relevantOriginalHistory.sort((a, b) => new Date(b.datum) - new Date(a.datum));
            previousKonto = parseFloat(relevantOriginalHistory[0].stundenkonto || "0");
          } else {
            previousKonto = parseFloat(getFromLS("initialKontoValue", "0"));
          }
        } else {
          previousKonto = parseFloat(getFromLS("initialKontoValue", "0"));
        }

        for (let i = 0; i < history.length; i++) {
          const entry = history[i];
          const diff = parseFloat(entry.differenz || 0); // Differenz ist Dezimal
          let baseKonto;
          if (i === 0) baseKonto = previousKonto;
          else baseKonto = parseFloat(history[i - 1].stundenkonto || "0");
          // Berechne und speichere als String mit 2 Nachkommastellen
          entry.stundenkonto = parseFloat((baseKonto + diff).toFixed(2)).toFixed(2);
        }

        storeToLS("history", JSON.stringify(history));

        const latestEntry = history.length > 0 ? history[history.length - 1] : null;
        const latestKonto = latestEntry ? parseFloat(latestEntry.stundenkonto || "0") : previousKonto;
        $("aktuelles-konto").value = latestKonto.toFixed(2);
        storeToLS("aktuellesStundenkonto", latestKonto.toFixed(2));

        updateCalculations();
        closeAddDayModal(); closeDetailModal(); closeBulkModal();
        if (currentView === "history") loadHistory();
        if (currentView === "month") loadMonthData();
        if (currentView === "stats") calculateAndDisplayStats();
      }


      function closeAddDayModal() {
        const modal = $("add-day-modal");
        if (modal) modal.style.display = "none";
      }

      // ANGEPASST: showDayDetails() - Verwendet Dezimalwerte und originalKommen
      function showDayDetails(dateStr) {
        const history = getHistory();
        const entry = history.find((e) => e.datum === dateStr);
        if (!entry) return;
        const entryDate = new Date(dateStr + "T12:00:00");
        const dispDate = entryDate.toLocaleDateString("de-DE");
        const weekdayName = entryDate.toLocaleDateString("de-DE", { weekday: "long" });
        $("detail-modal-title").textContent = `Details: ${weekdayName}, ${dispDate}`;
        let detailsHTML = "", pausenLabel = "N/A", anwesenheitLabel = "N/A", nettoLabel = "N/A";
        let pcBuchungChecked = !!entry.pcBuchung;
        let bueroEmoji = entry.buero ? "üè¢ B√ºro" : "üè† Homeoffice";
        const diffVal = parseFloat(entry.differenz) || 0; // Ist Dezimal
        const diffClass = diffVal > 0.001 ? "positive-value" : diffVal < -0.001 ? "negative-value" : "zero-value";
        const kontoVal = parseFloat(entry.stundenkonto || 0); // Ist Dezimal
        const kontoFormatted = formatDecimalToTime(kontoVal);
        const kontoDecimal = kontoVal.toFixed(2);
        const holidayName = getHolidayName(entryDate, settings.bundesland);

        let ezaIndicatorClass = "";
        let ezaTagIndicatorClass = "";
        if (entry.ezaActiveDuringBooking && !settings.ezaActive) {
          if (entry.urlaub || entry.schulung) ezaIndicatorClass = "eza-related-diff inactive";
          else if (entry.isEzaTag) ezaTagIndicatorClass = "eza-tag-label inactive";
        }

        if (holidayName) {
          detailsHTML = `<p><strong>Datum:</strong> ${dispDate}</p><p><strong>Status:</strong> ${holidayName} (Feiertag)</p>`;
          $("detail-edit-button").style.display = "none";
          $("detail-delete-button").style.display = "none";
        } else if (entry.urlaub || entry.krank || entry.schulung || entry.glaz || entry.isEzaTag) {
          const statusText = entry.urlaub ? "Urlaub" : entry.krank ? "Krank" : entry.schulung ? "Schulung" : entry.glaz ? "GLAZ" : "EZA-Tag";
          const tagLabelClass = entry.isEzaTag ? ezaTagIndicatorClass : "";
          // Verwende formatDecimalToTime f√ºr die Anzeige der Differenz
          const diffDisplay = (entry.glaz || entry.urlaub || entry.schulung) ? `<span class="diff-badge ${diffClass} ${ezaIndicatorClass}">${formatDecimalToTime(diffVal)} (${diffVal.toFixed(2)}h)</span>` : "";
          detailsHTML = `<p><strong>Status:</strong> <span class="${tagLabelClass}">${statusText}</span> ${bueroEmoji}</p><p><strong>Kommen:</strong> --:--</p><p><strong>Gehen:</strong> --:--</p><p><strong>Differenz:</strong> ${diffDisplay}</p><p><strong>Stundenkonto danach:</strong> ${kontoFormatted} (${kontoDecimal}h)</p>`;
          $("detail-edit-button").style.display = "block";
          $("detail-delete-button").style.display = "block";
        } else {
          // Normale Arbeitstage
          let kommenTimeToDisplayStr;
          let kommenHinweis = "";
          if (entry.originalKommen) {
            kommenTimeToDisplayStr = formatTime(new Date(entry.originalKommen));
            kommenHinweis = "(PC-Buchung aktiv)";
          } else {
            kommenTimeToDisplayStr = formatTime(entry.kommen ? new Date(entry.kommen) : null);
          }

          const kommenLokalFuerBerechnung = entry.kommen ? new Date(entry.kommen) : null; // Angepasste Zeit
          const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
          const gehenFormatted = formatTime(gehenLokal);
          const additionalPauseDecimal = parsePauseInputFromString(entry.zusatzPause || "");

          // Berechne Werte f√ºr Anzeige basierend auf gespeicherten Zeiten
          let presenceDecimal = 0;
          let netCalculatedDecimal = 0;
          let totalPauseDecimal = 0;

          if (kommenLokalFuerBerechnung && gehenLokal) {
              const kommenDec = dateToDecimalHours(kommenLokalFuerBerechnung);
              let gehenDec = dateToDecimalHours(gehenLokal);
              if(gehenDec < kommenDec) gehenDec += 24;
              presenceDecimal = gehenDec - kommenDec;

              if(presenceDecimal >= 0) {
                  totalPauseDecimal = calculateAutoPauseForDuration(presenceDecimal) + additionalPauseDecimal;
                  // Netto f√ºr Anzeige (mit Freeze)
                  netCalculatedDecimal = calculateNetArbeitszeitDecimalFromEntryData(kommenLokalFuerBerechnung, gehenLokal, additionalPauseDecimal);

                  anwesenheitLabel = `${formatDecimalToTime(presenceDecimal)} (${presenceDecimal.toFixed(2)}h)`;
                  nettoLabel = `${formatDecimalToTime(netCalculatedDecimal)} (${netCalculatedDecimal.toFixed(2)}h)`;
                  pausenLabel = `${Math.round(totalPauseDecimal * 60)} Min (${totalPauseDecimal.toFixed(2)}h)`;
                  if (additionalPauseDecimal > 0) pausenLabel += ` (inkl. ${formatDecimalToTime(additionalPauseDecimal)} manuell)`;
              }
          }


          const violations = checkViolations(kommenLokalFuerBerechnung, gehenLokal, netCalculatedDecimal);
          let kommenMoon = violations.kommen && settings.allowNachtarbeit ? ' <span class="moon-mark">üåô</span>' : "";
          let gehenMoon = violations.gehen && settings.allowNachtarbeit ? ' <span class="moon-mark">üåô</span>' : "";
          let nettoMoon = violations.arbeitszeit && netCalculatedDecimal > 0 && settings.allowNachtarbeit ? ' <span class="moon-mark">üåô</span>' : "";
          const ezaBookedHint = entry.ezaActiveDuringBooking ? ' <span class="eza-hint-inline" title="EZA-Regel bei Buchung aktiv">(E)</span>' : "";

          detailsHTML = `<p><strong>Ort:</strong> ${bueroEmoji}</p><p><strong>Kommen:</strong> ${kommenTimeToDisplayStr} ${kommenHinweis}${kommenMoon}</p><p><strong>Gehen:</strong> ${gehenFormatted}${gehenMoon}</p><p><strong>Anwesenheit:</strong> ${anwesenheitLabel}</p><p><strong>Pause:</strong> ${pausenLabel}</p><p><strong>Netto-Arbeitszeit:</strong> ${nettoLabel}${nettoMoon}</p><p><strong>Differenz:</strong> <span class="diff-badge ${diffClass}">${formatDecimalToTime(diffVal)} (${diffVal.toFixed(2)}h)</span>${ezaBookedHint}</p><p><strong>Stundenkonto danach:</strong> ${kontoFormatted} (${kontoDecimal}h)</p>`;
          $("detail-edit-button").style.display = "block";
          $("detail-delete-button").style.display = "block";
        }
        $("detail-content").innerHTML = detailsHTML;
        const editBtn = $("detail-edit-button");
        const deleteBtn = $("detail-delete-button");
        editBtn.onclick = () => { closeDetailModal(); showAddDayModal(dateStr); };
        deleteBtn.onclick = () => { closeDetailModal(); deleteEntryByDate(dateStr); };
        $("detail-modal").style.display = "flex";
      }


      function closeDetailModal() {
        const modal = $("detail-modal");
        if (modal) modal.style.display = "none";
      }

      function showBulkModal() {
        $("bulk-modal-start-date").value = "";
        $("bulk-modal-end-date").value = "";
        $("bulk-modal-special-day-type").value = "";
        $("bulk-booking-modal").style.display = "flex";
      }

      function closeBulkModal() {
        const modal = $("bulk-booking-modal");
        if (modal) modal.style.display = "none";
      }

      const monthNames = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
      function getFirstDayOfMonth(year, month) { return new Date(Date.UTC(year, month, 1)).getUTCDay(); }
      function getDaysInMonth(year, month) { return new Date(Date.UTC(year, month + 1, 0)).getUTCDate(); }
      function loadMonthData() {
        const history = getHistory();
        const monthData = history.filter((entry) => {
          const entryDate = new Date(entry.datum + "T12:00:00");
          return (entryDate.getFullYear() === currentMonthYear && entryDate.getMonth() === currentMonth);
        });
        renderCalendar(monthData);
        updateMonthNavigation();
      }

      // ANGEPASST: renderCalendar() - Verwendet Dezimalwerte
      function renderCalendar(monthData) {
        const calendarGrid = $("calendar-grid");
        calendarGrid.innerHTML = "";
        $("month-year-display").textContent = `${monthNames[currentMonth]} ${currentMonthYear}`;
        const daysInMonth = getDaysInMonth(currentMonthYear, currentMonth);
        let firstDayIndex = getFirstDayOfMonth(currentMonthYear, currentMonth);
        firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
        const weekdays = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
        calendarGrid.style.gridTemplateColumns = `repeat(7, 1fr)`;

        weekdays.forEach((wd) => { const headerCell = document.createElement("div"); headerCell.classList.add("calendar-header"); headerCell.textContent = wd; calendarGrid.appendChild(headerCell); });
        for (let i = 0; i < firstDayIndex; i++) { const emptyCell = document.createElement("div"); emptyCell.classList.add("calendar-day", "empty"); calendarGrid.appendChild(emptyCell); }

        let monthlyTotalDiff = 0;
        for (let day = 1; day <= daysInMonth; day++) {
          const currentDateObj = new Date(Date.UTC(currentMonthYear, currentMonth, day));
          const dayOfWeek = currentDateObj.getUTCDay();
          const cell = document.createElement("div"); cell.classList.add("calendar-day");
          const cellContent = document.createElement("div"); cellContent.classList.add("calendar-day-content"); cellContent.textContent = day; cell.appendChild(cellContent);
          const currentDateStr = `${currentMonthYear}-${pad(currentMonth + 1)}-${pad(day)}`;
          const entry = monthData.find((e) => e.datum === currentDateStr);
          const holidayName = getHolidayName(currentDateObj, settings.bundesland);
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

          if (holidayName) {
            cell.classList.add("has-entry", "holiday"); cellContent.classList.add("holiday-day"); cellContent.title = holidayName;
            cell.onclick = () => alert(`${currentDateObj.toLocaleDateString("de-DE")}: ${holidayName}`);
          } else if (entry) {
            cell.classList.add("has-entry");
            const diffVal = parseFloat(entry.differenz) || 0; // Ist Dezimal
            monthlyTotalDiff += diffVal;
            let bgColorClass = "", titleText = "", moonMark = "";

            if (entry.urlaub) bgColorClass = "special-day-urlaub-bg";
            else if (entry.krank) bgColorClass = "special-day-krank-bg";
            else if (entry.schulung) bgColorClass = "special-day-schulung-bg";
            else if (entry.isEzaTag) bgColorClass = "special-day-eza-bg";
            else if (entry.glaz) bgColorClass = "special-day-glaz-bg";
            else { if (diffVal > 0.001) bgColorClass = "positive-value"; else if (diffVal < -0.001) bgColorClass = "negative-value"; else bgColorClass = "zero-value"; }

            if (entry.urlaub) titleText = "Urlaub";
            else if (entry.krank) titleText = "Krank";
            else if (entry.schulung) titleText = "Schulung";
            else if (entry.isEzaTag) titleText = "EZA-Tag";
            else if (entry.glaz) titleText = `GLAZ (${formatDecimalToTime(diffVal)})`; // Zeige Zeitformat
            else titleText = `Differenz: ${formatDecimalToTime(diffVal)}`; // Zeige Zeitformat

            if (!entry.urlaub && !entry.krank && !entry.schulung && !entry.isEzaTag && !entry.glaz) {
              const kommenLokal = entry.kommen ? new Date(entry.kommen) : null;
              const gehenLokal = entry.gehen ? new Date(entry.gehen) : null;
              const netTimeDecimal = calculateNetArbeitszeitDecimalFromEntryData(kommenLokal, gehenLokal, parsePauseInputFromString(entry.zusatzPause || ""));
              const violations = checkViolations(kommenLokal, gehenLokal, netTimeDecimal);
              if (violations.any && settings.allowNachtarbeit) { if (violations.kommen || violations.gehen || violations.arbeitszeit) moonMark = ' <span class="moon-mark-calendar">üåô</span>'; }
            }

            cellContent.classList.add(bgColorClass); cellContent.title = titleText; cellContent.innerHTML = day + moonMark;
            if (entry.ezaActiveDuringBooking) cellContent.classList.add("eza-booked-outline");
            cell.onclick = () => showDayDetails(currentDateStr);
          } else if (isWeekend) {
            cell.classList.add("weekend"); cellContent.classList.add("weekend-text");
            if (settings.allowWochenende) { cell.classList.add("no-entry"); cell.onclick = () => showAddDayModal(currentDateStr); cellContent.title = "Klicken zum Hinzuf√ºgen"; }
            else { cellContent.title = "Wochenende"; cell.style.cursor = "default"; }
          } else {
            cell.classList.add("no-entry"); cell.onclick = () => showAddDayModal(currentDateStr); cellContent.title = "Klicken zum Hinzuf√ºgen";
          }
          const today = new Date(); today.setHours(0, 0, 0, 0);
          const cellDate = new Date(currentDateObj); cellDate.setHours(0, 0, 0, 0);
          if (cellDate.getTime() === today.getTime()) cellContent.classList.add("today");
          calendarGrid.appendChild(cell);
        }
        const diffClassSummary = monthlyTotalDiff > 0.001 ? "positive-value" : monthlyTotalDiff < -0.001 ? "negative-value" : "zero-value";
        $("month-summary-content").innerHTML = `Monatsdifferenz: <span class="diff-badge ${diffClassSummary}">${formatDecimalToTime(monthlyTotalDiff)} (${monthlyTotalDiff.toFixed(2)}h)</span>`;
      }


      function updateMonthNavigation() {
        $("prev-month").onclick = () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentMonthYear--; } loadMonthData(); };
        $("next-month").onclick = () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentMonthYear++; } loadMonthData(); };
      }

      // =========================================================================
      // ANGEPASSTE FUNKTION: applyBulkBooking() - Verwendet Dezimalberechnung
      // =========================================================================
      function applyBulkBooking() {
        const startDateStr = $("bulk-modal-start-date").value, endDateStr = $("bulk-modal-end-date").value, specialType = $("bulk-modal-special-day-type").value;
        if (!startDateStr || !endDateStr || !specialType) { alert("Bitte Start, Ende und Typ ausw√§hlen."); return; }
        const startDate = new Date(startDateStr + "T12:00:00"), endDate = new Date(endDateStr + "T12:00:00");
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) { alert("Ung√ºltiges Datum."); return; }
        if (endDate < startDate) { alert("Enddatum vor Startdatum."); return; }

        let history = getHistory();
        const historyMap = new Map(history.map((entry) => [entry.datum, entry]));
        let modified = false; let skippedDays = 0; let processedCount = 0;
        let currentDate = new Date(startDate.getTime());
        const sollProTagDecimal = settings.wochenarbeitszeit / 5;
        const currentEzaActive = settings.ezaActive;
        let currentEzaStand = settings.ezaKontoStand;

        const typeLabel = { urlaub: "Urlaub", krank: "Krank", schulung: "Schulung", glaz: "GLAZ", ezaTag: "EZA-Tag", delete: "L√∂schen" }[specialType];
        if (!confirm(`Wirklich f√ºr ${startDate.toLocaleDateString("de-DE")} bis ${endDate.toLocaleDateString("de-DE")} Aktion "${typeLabel}" f√ºr Mo-Fr (keine Feiertage) durchf√ºhren?\n\nACHTUNG: Bestehende Eintr√§ge werden √ºberschrieben oder gel√∂scht!`)) return;

        while (currentDate <= endDate) {
          const dayOfWeek = currentDate.getDay();
          const holidayName = getHolidayName(currentDate, settings.bundesland);
          const currentDateStr = currentDate.toISOString().split("T")[0];

          if (dayOfWeek >= 1 && dayOfWeek <= 5 && !holidayName) {
            if (specialType === "delete") {
              if (historyMap.has(currentDateStr)) { historyMap.delete(currentDateStr); modified = true; processedCount++; }
              else skippedDays++;
            } else {
              let mainDifferenceDecimal = 0; let ezaDifference = 0;
              let isUrlaub = false, isKrank = false, isSchulung = false, isGlaz = false, isEzaTag = false;
              switch (specialType) {
                case "urlaub": isUrlaub = true; break; case "krank": isKrank = true; break; case "schulung": isSchulung = true; break;
                case "glaz": isGlaz = true; break; case "ezaTag": isEzaTag = true; break;
              }

              if (currentEzaActive) {
                if (isUrlaub || isSchulung) mainDifferenceDecimal = -0.4;
                else if (isKrank) ezaDifference = -0.4;
                else if (isGlaz) mainDifferenceDecimal = -sollProTagDecimal;
                else if (isEzaTag) {
                  const neededHours = sollProTagDecimal; const availableEza = currentEzaStand;
                  if (availableEza >= neededHours) ezaDifference = -neededHours;
                  else if (availableEza > 0) { ezaDifference = -availableEza; mainDifferenceDecimal = -(neededHours - availableEza); }
                  else mainDifferenceDecimal = -neededHours;
                }
              } else {
                if (isUrlaub || isKrank || isSchulung || isEzaTag) mainDifferenceDecimal = 0;
                else if (isGlaz) mainDifferenceDecimal = -sollProTagDecimal;
              }

              currentEzaStand += ezaDifference; // Update running EZA balance

              const existingEntry = historyMap.get(currentDateStr);
              const dayData = {
                datum: currentDateStr, differenz: mainDifferenceDecimal.toFixed(2), differenzTime: formatDecimalToTime(mainDifferenceDecimal), stundenkonto: "0.00",
                kommen: null, originalKommen: null, gehen: null,
                urlaub: isUrlaub, krank: isKrank, schulung: isSchulung, glaz: isGlaz, isEzaTag: isEzaTag,
                ezaActiveDuringBooking: currentEzaActive, pcBuchung: false,
                buero: existingEntry ? existingEntry.buero : $("buero-toggle").checked, zusatzPause: "",
              };
              historyMap.set(currentDateStr, dayData);
              modified = true; processedCount++;
            }
          } else skippedDays++;
          currentDate.setDate(currentDate.getDate() + 1);
        }

        if (modified) {
          settings.ezaKontoStand = currentEzaStand; // Save final EZA balance
          storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
          updateEzaKontoDisplay();
          const updatedHistory = Array.from(historyMap.values());
          saveAndReload(updatedHistory); // Recalculate main balance
          alert(`Bulk-Aktion "${typeLabel}" erfolgreich f√ºr ${processedCount} Tage angewendet. ${skippedDays > 0 ? `(${skippedDays} Tage √ºbersprungen)` : ""}`);
          closeBulkModal();
        } else {
          alert(`Keine Eintr√§ge zum ${specialType === "delete" ? "L√∂schen" : "Buchen"} im ausgew√§hlten Zeitraum gefunden.`);
          closeBulkModal();
        }
      }


      // =========================================================================
      // ANGEPASSTE FUNKTION: calculateAndDisplayStats() - Verwendet Dezimalberechnung
      // =========================================================================
      function calculateAndDisplayStats() {
        const period = $("stats-period").value;
        const history = getHistory();
        const today = new Date();
        let startDate, endDate;
        today.setHours(12, 0, 0, 0);
        switch (period) {
          case "current_month": startDate = new Date(today.getFullYear(), today.getMonth(), 1, 12, 0, 0, 0); endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 12, 0, 0, 0); break;
          case "last_month": startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1, 12, 0, 0, 0); endDate = new Date(today.getFullYear(), today.getMonth(), 0, 12, 0, 0, 0); break;
          case "current_year": startDate = new Date(today.getFullYear(), 0, 1, 12, 0, 0, 0); endDate = new Date(today.getFullYear(), 11, 31, 12, 0, 0, 0); break;
          case "last_year": startDate = new Date(today.getFullYear() - 1, 0, 1, 12, 0, 0, 0); endDate = new Date(today.getFullYear() - 1, 11, 31, 12, 0, 0, 0); break;
          case "all_time": default: if (history.length === 0) { startDate = new Date(today); endDate = new Date(today); } else { startDate = new Date(history[0].datum + "T12:00:00"); endDate = new Date(history[history.length - 1].datum + "T12:00:00"); } break;
        }
        const filteredHistory = history.filter((entry) => { const entryDate = new Date(entry.datum + "T12:00:00"); return (entryDate.setHours(0, 0, 0, 0) >= startDate.setHours(0, 0, 0, 0) && entryDate.setHours(0, 0, 0, 0) <= endDate.setHours(0, 0, 0, 0)); });
        let totalNetHoursDecimal = 0, totalDiffDecimal = 0, workDays = 0, officeDays = 0, homeDays = 0, vacationDays = 0, sickDays = 0, trainingDays = 0, glazDays = 0, ezaDays = 0, holidayCount = 0;
        let currentDate = new Date(startDate);
        const endCheckDate = new Date(endDate);
        const dateMap = new Map(filteredHistory.map((e) => [e.datum, e]));
        while (currentDate <= endCheckDate) {
          const currentDateStr = currentDate.toISOString().split("T")[0];
          const entry = dateMap.get(currentDateStr);
          const holidayName = getHolidayName(currentDate, settings.bundesland);
          const dayOfWeek = currentDate.getDay();
          if (holidayName && dayOfWeek !== 0 && dayOfWeek !== 6) holidayCount++;
          if (entry) {
            totalDiffDecimal += parseFloat(entry.differenz || 0); // Ist Dezimal
            if (entry.urlaub) vacationDays++;
            else if (entry.krank) sickDays++;
            else if (entry.schulung) trainingDays++;
            else if (entry.glaz) glazDays++;
            else if (entry.isEzaTag) ezaDays++;
            else if (entry.kommen && entry.gehen) {
              workDays++;
              const kommenLokal = new Date(entry.kommen); // Angepasste Zeit
              const gehenLokal = new Date(entry.gehen);
              const additionalPauseDecimal = parsePauseInputFromString(entry.zusatzPause || "");
              // Berechne Nettozeit dezimal
              const netHoursDecimal = calculateNetArbeitszeitDecimalFromEntryData(kommenLokal, gehenLokal, additionalPauseDecimal);
              totalNetHoursDecimal += netHoursDecimal;
              if (entry.buero) officeDays++; else homeDays++;
            }
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
        const avgDailyHoursDecimal = workDays > 0 ? totalNetHoursDecimal / workDays : 0;
        const statsContent = $("stats-content");
        if (filteredHistory.length === 0 && holidayCount === 0) { statsContent.innerHTML = `<li>Keine Daten f√ºr Zeitraum.</li>`; return; }
        statsContent.innerHTML = `<li>Gesamt Netto: <span>${formatDecimalToTime(totalNetHoursDecimal)} (${totalNetHoursDecimal.toFixed(2)}h)</span></li><li>√ò Netto / Tag: <span>${formatDecimalToTime(avgDailyHoursDecimal)} (${avgDailyHoursDecimal.toFixed(2)}h)</span></li><li>Gesamt Diff: <span class="diff-badge ${totalDiffDecimal > 0.001 ? "positive-value" : totalDiffDecimal < -0.001 ? "negative-value" : "zero-value"}">${formatDecimalToTime(totalDiffDecimal)} (${totalDiffDecimal.toFixed(2)}h)</span></li><li>Arbeitstage: <span>${workDays}</span></li><li>&nbsp;&nbsp;&nbsp;B√ºro: <span>${officeDays}</span></li><li>&nbsp;&nbsp;&nbsp;Home: <span>${homeDays}</span></li><li>Urlaub: <span>${vacationDays}</span></li><li>Krank: <span>${sickDays}</span></li><li>Schulung: <span>${trainingDays}</span></li><li>GLAZ: <span>${glazDays}</span></li><li>EZA-Tage: <span>${ezaDays}</span></li><li>Feiertage (Mo-Fr): <span>${holidayCount}</span></li>`;
      }


      function exportHistoryToJson() {
        const history = getHistory();
        if (history.length === 0) { alert("Keine Daten zum Export."); return; }
        const exportHistory = history.map((entry) => {
          const { dateObj, ...rest } = entry;
          if (rest.originalKommen === null) delete rest.originalKommen;
          return rest;
        });
        const exportData = {
          settings: {
            wochenarbeitszeit: settings.wochenarbeitszeit, bundesland: settings.bundesland,
            allowWochenende: settings.allowWochenende, allowNachtarbeit: settings.allowNachtarbeit,
            ezaActive: settings.ezaActive, ezaKontoStand: settings.ezaKontoStand,
          },
          history: exportHistory,
        };
        const jsonData = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const todayStr = new Date().toISOString().split("T")[0];
        a.href = url; a.download = `arbeitszeit_export_${todayStr}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("Verlauf & Optionen exportiert.");
      }

      function importHistoryFromJson() {
        const input = document.createElement("input");
        input.type = "file"; input.accept = ".json"; input.style.display = "none";
        input.onchange = (event) => {
          const file = event.target.files[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedJson = JSON.parse(e.target.result);
              let importedHistory = [], importedSettings = null;
              if (Array.isArray(importedJson)) { importedHistory = importedJson; alert("Altes Exportformat erkannt (nur Verlauf). Einstellungen werden nicht importiert."); }
              else if (typeof importedJson === "object" && importedJson !== null && Array.isArray(importedJson.history) && typeof importedJson.settings === "object") { importedHistory = importedJson.history; importedSettings = importedJson.settings || {}; }
              else { throw new Error("Unbekanntes oder ung√ºltiges Importformat."); }
              if (importedHistory.length > 0 && (importedHistory[0].datum === undefined || importedHistory[0].stundenkonto === undefined || importedHistory[0].differenz === undefined)) { throw new Error("Ung√ºltige Verlaufsdaten im Import."); }

              const sanitizedHistory = importedHistory.map((entry) => ({
                datum: entry.datum, differenz: entry.differenz || "0.00", differenzTime: entry.differenzTime || "0:00", stundenkonto: entry.stundenkonto || "0.00",
                kommen: entry.kommen || null, originalKommen: entry.originalKommen || null, gehen: entry.gehen || null,
                urlaub: entry.urlaub || false, krank: entry.krank || false, schulung: entry.schulung || false, glaz: entry.glaz || false, isEzaTag: entry.isEzaTag || false,
                ezaActiveDuringBooking: entry.ezaActiveDuringBooking || false, pcBuchung: entry.pcBuchung || false, buero: entry.buero || false, zusatzPause: entry.zusatzPause || "",
              }));

              let confirmationMessage = `Wirklich ${sanitizedHistory.length} Eintr√§ge importieren? ACHTUNG: Alle vorhandenen Daten werden √ºberschrieben!`;
              if (importedSettings) confirmationMessage += "\n\nGespeicherte Einstellungen werden ebenfalls √ºbernommen.";

              if (confirm(confirmationMessage)) {
                if (importedSettings) {
                  settings.wochenarbeitszeit = parseFloat(importedSettings.wochenarbeitszeit || 38);
                  settings.bundesland = importedSettings.bundesland || "NATIONAL";
                  settings.allowWochenende = !!importedSettings.allowWochenende;
                  settings.allowNachtarbeit = !!importedSettings.allowNachtarbeit;
                  settings.ezaActive = !!importedSettings.ezaActive;
                  settings.ezaKontoStand = parseFloat(importedSettings.ezaKontoStand || 0);
                  saveSettings();
                  storeToLS("ezaKontoStand", settings.ezaKontoStand.toString());
                  updateEzaKontoDisplay();
                }
                saveAndReload(sanitizedHistory);
                alert("Daten erfolgreich importiert.");
                switchView("main");
              }
            } catch (error) { console.error("Importfehler:", error); alert(`Import fehlgeschlagen: ${error.message}`); }
            finally { document.body.removeChild(input); }
          };
          reader.onerror = (e) => { console.error("Fehler beim Lesen:", e); alert("Fehler beim Lesen der Datei."); document.body.removeChild(input); };
          reader.readAsText(file);
        };
        document.body.appendChild(input); input.click();
      }


      function showLegendModal() {
        const modal = $("legend-modal");
        if (modal) modal.style.display = "flex";
      }

      function closeLegendModal() {
        const modal = $("legend-modal");
        if (modal) modal.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>

    <style>
      :root {
        /* Light Mode */
        --system-background-light: #f2f2f7;
        --system-secondary-background-light: #ffffff;
        --system-tertiary-background-light: #e5e5ea;
        --text-color-light: #000000;
        --secondary-text-color-light: rgba(60, 60, 67, 0.6);
        --readonly-text-color-light: rgba(0, 0, 0, 0.75);
        --separator-color-light: rgba(60, 60, 67, 0.29);
        --input-border-color-light: rgba(60, 60, 67, 0.2);
        --system-blue-light: #007aff; /* Positiv */
        --system-green-light: #34c759; /* Null Saldo */
        --system-red-light: #ff3b30; /* Krank */
        --system-orange-light: #ff9500; /* Negativ */
        --system-yellow-light: #ffcc00; /* GLAZ */
        --system-teal-light: #5ac8fa; /* Urlaub */
        --system-purple-light: #af52de; /* (War GLAZ, jetzt frei) */
        --system-indigo-light: #5856d6; /* Holiday */
        --system-pink-light: #ff2d55; /* EZA-Tag */
        --system-pastel-green-light: #a1e8b5; /* Schulung */
        --system-gray-light: #8e8e93;
        --system-gray2-light: #aeaeb2;

        /* Dark Mode */
        --system-background-dark: #000000;
        --system-secondary-background-dark: #1c1c1e;
        --system-tertiary-background-dark: #2c2c2e;
        --text-color-dark: #ffffff;
        --secondary-text-color-dark: rgba(235, 235, 245, 0.6);
        --readonly-text-color-dark: rgba(255, 255, 255, 0.75);
        --separator-color-dark: rgba(84, 84, 88, 0.65);
        --input-border-color-dark: rgba(84, 84, 88, 0.5);
        --system-blue-dark: #0a84ff; /* Positiv */
        --system-green-dark: #30d158; /* Null Saldo */
        --system-red-dark: #ff453a; /* Krank */
        --system-orange-dark: #ff9f0a; /* Negativ */
        --system-yellow-dark: #ffd60a; /* GLAZ */
        --system-teal-dark: #64d2ff; /* Urlaub */
        --system-purple-dark: #bf5af2; /* (War GLAZ, jetzt frei) */
        --system-indigo-dark: #5e5ce6; /* Holiday */
        --system-pink-dark: #ff375f; /* EZA-Tag */
        --system-pastel-green-dark: #4f8a61; /* Schulung */
        --system-gray-dark: #8e8e93;
        --system-gray2-dark: #3a3a3c;

        /* Semantic Colors */
        --background-color: var(--system-background-light);
        --card-background-color: var(--system-secondary-background-light);
        --input-background-color: var(--system-tertiary-background-light);
        --text-color: var(--text-color-light);
        --secondary-text-color: var(--secondary-text-color-light);
        --readonly-text-color: var(--readonly-text-color-light);
        --separator-color: var(--separator-color-light);
        --input-border-color: var(--input-border-color-light);
        --button-background-color: var(--system-blue-light);
        --button-text-color: #ffffff;
        --positive-value-bg: var(--system-blue-light);
        --negative-value-bg: var(--system-orange-light);
        --zero-value-bg: var(--system-green-light);
        --hint-color: var(--system-red-light);
        --special-day-urlaub-bg: var(--system-teal-light);
        --special-day-krank-bg: var(--system-red-light); /* NEU: Krank = Rot */
        --special-day-glaz-bg: var(--system-yellow-light); /* NEU: GLAZ = Gelb */
        --special-day-schulung-bg: var(--system-pastel-green-light); /* NEU: Schulung = Pastellgr√ºn */
        --special-day-eza-bg: var(--system-pink-light); /* NEU: EZA = Pink */
        --holiday-bg: var(--system-indigo-light);
        /* Textfarben f√ºr Sondertage anpassen */
        --special-day-text: #000000; /* Default f√ºr helle BG (Urlaub, Gelb, Pastellgr√ºn) */
        --special-day-krank-text: #ffffff; /* F√ºr Rot */
        --special-day-glaz-text: #000000; /* F√ºr Gelb */
        --special-day-schulung-text: #000000; /* F√ºr Pastellgr√ºn */
        --special-day-eza-text: #ffffff; /* F√ºr Pink */
        --holiday-text: #ffffff;
        --nav-background: var(--system-secondary-background-light);
        --nav-icon-color: var(--system-gray-light);
        --nav-icon-active-color: var(--system-blue-light);
        --slider-bg-color: var(--system-gray2-light);
        --slider-checked-bg-color: var(--system-green-light);
        --outline-color: var(--secondary-text-color-light);
        --inactive-indicator-color: var(--secondary-text-color-light);

        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        --safe-area-left: env(safe-area-inset-left, 0px);
        --safe-area-right: env(safe-area-inset-right, 0px);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: var(--system-background-dark);
          --card-background-color: var(--system-secondary-background-dark);
          --input-background-color: var(--system-tertiary-background-dark);
          --text-color: var(--text-color-dark);
          --secondary-text-color: var(--secondary-text-color-dark);
          --readonly-text-color: var(--readonly-text-color-dark);
          --separator-color: var(--separator-color-dark);
          --input-border-color: var(--input-border-color-dark);
          --button-background-color: var(--system-blue-dark);
          --positive-value-bg: var(--system-blue-dark);
          --negative-value-bg: var(--system-orange-dark);
          --zero-value-bg: var(--system-green-dark);
          --hint-color: var(--system-red-dark);
          --special-day-urlaub-bg: var(--system-teal-dark);
          --special-day-krank-bg: var(--system-red-dark); /* NEU */
          --special-day-glaz-bg: var(--system-yellow-dark); /* NEU */
          --special-day-schulung-bg: var(--system-pastel-green-dark); /* NEU */
          --special-day-eza-bg: var(--system-pink-dark); /* NEU */
          --holiday-bg: var(--system-indigo-dark);
          /* Textfarben f√ºr Dark Mode */
          --special-day-text: #000000; /* Default f√ºr helle BG (Urlaub) */
          --special-day-krank-text: #ffffff; /* F√ºr Rot */
          --special-day-glaz-text: #000000; /* F√ºr Gelb */
          --special-day-schulung-text: #ffffff; /* F√ºr dunkles Pastellgr√ºn */
          --special-day-eza-text: #ffffff; /* F√ºr Pink */
          --holiday-text: #ffffff;
          --nav-background: var(--system-secondary-background-dark);
          --nav-icon-color: var(--system-gray-dark);
          --nav-icon-active-color: var(--system-blue-dark);
          --slider-bg-color: var(--system-gray2-dark);
          --slider-checked-bg-color: var(--system-green-dark);
          --outline-color: var(--secondary-text-color-dark);
          --inactive-indicator-color: var(--secondary-text-color-dark);
        }
      }

      html,
      body {
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        height: 100%;
        overflow: hidden;
      }

      #app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* --- PAGE PADDING (Zur√ºckgesetzt auf Original) --- */
      .page {
        flex-grow: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: var(--safe-area-top) calc(15px + var(--safe-area-left))
          calc(105px + var(--safe-area-bottom)) /* Zur√ºckgesetzt */
          calc(15px + var(--safe-area-right));
        display: none;
      }
      .page.active {
        display: block;
      }
      /* --- END PAGE PADDING --- */

      .container {
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 0;
      }

      h1 {
        font-size: 34px;
        font-weight: 700;
        margin: 10px 0 20px 0;
      }
      h2 {
        font-size: 22px;
        font-weight: 600;
        margin: 25px 0 15px 0;
        border-bottom: 1px solid var(--separator-color);
        padding-bottom: 8px;
      }
      h3 {
        font-size: 17px;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: var(--secondary-text-color);
        text-transform: uppercase;
      }
      label {
        font-size: 15px;
        font-weight: 400;
        color: var(--secondary-text-color);
        display: block;
        margin-bottom: 5px;
      }
      p {
        font-size: 17px;
        line-height: 1.4;
        margin: 5px 0 15px 0;
      }

      .section {
        background-color: var(--card-background-color);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      @media (prefers-color-scheme: dark) {
        .section {
          box-shadow: none;
        }
      }

      .button,
      .inline-button,
      .delete-button,
      .add-button,
      .link-button {
        background-color: var(--button-background-color);
        color: var(--button-text-color);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        box-sizing: border-box;
        line-height: 1.2em;
        text-align: center;
        transition: background-color 0.1s ease-in-out;
        -webkit-appearance: none;
        appearance: none;
      }
      .button {
        width: 100%;
        padding: 12px 15px;
        font-size: 17px;
        min-height: 44px;
        margin-bottom: 10px;
      }
      .inline-button,
      .delete-button,
      .add-button {
        font-size: 15px;
        padding: 8px 12px;
        min-height: 36px;
      }
      .delete-button {
        background-color: var(--hint-color);
      }
      .add-button {
        background-color: var(--system-green-light);
      }
      @media (prefers-color-scheme: dark) {
        .add-button {
          background-color: var(--system-green-dark);
        }
      }
      .link-button {
        background: none;
        color: var(--button-background-color);
        padding: 5px 0;
        font-size: 15px;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
      }
      .button:active,
      .inline-button:active,
      .delete-button:active,
      .add-button:active,
      .link-button:active {
        filter: brightness(0.85);
      }

      input[type="time"],
      input[type="number"],
      input[type="text"],
      input[type="date"],
      select {
        width: 100%;
        padding: 12px 15px;
        font-size: 17px;
        border: 1px solid var(--input-border-color);
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: var(--input-background-color);
        color: var(--text-color);
        box-sizing: border-box;
        -webkit-appearance: none;
        appearance: none;
        line-height: 1.2em;
        min-height: 44px;
      }
      #korrektur-datum,
      #korrektur-wert,
      #eza-konto-input,
      #eza-konto-display {
        height: 44px;
        box-sizing: border-box;
      }
      input:read-only {
        background-color: var(--card-background-color);
        color: var(--readonly-text-color);
        cursor: default;
        border: 1px solid var(--input-border-color);
      }
      input:disabled {
        background-color: var(--system-tertiary-background-light);
        color: var(--secondary-text-color);
        opacity: 0.7;
        cursor: not-allowed;
      }
      @media (prefers-color-scheme: dark) {
        input:disabled {
          background-color: var(--system-tertiary-background-dark);
        }
      }
      input[type="time"]::-webkit-calendar-picker-indicator,
      input[type="date"]::-webkit-calendar-picker-indicator {
        display: none;
      }

      .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: flex-end;
      }
      .column {
        flex: 1;
      }
      .column-auto {
        flex: 0 0 auto;
        margin-bottom: 10px;
      }

      .time-button-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
        position: relative;
      }
      .time-button-row input[type="time"],
      .time-button-row .button {
        flex: 1;
        margin-bottom: 0;
      }
      .time-button-row input[type="time"] {
        text-align: center;
      }
      .time-button-row .button {
        padding: 12px 15px;
      }
      .moon-indicator {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        display: none;
        pointer-events: none;
      }
      .moon-mark {
        font-size: 1em;
        vertical-align: baseline;
      }
      .moon-mark-calendar {
        font-size: 0.7em;
        vertical-align: super;
        margin-left: 1px;
      }

      /* --- SLIDER STYLES (Zur√ºckgesetzt auf Original) --- */
      .switch-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        min-height: 44px;
      }
      .switch-container span {
        margin-left: 10px;
        font-size: 17px;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 65px; /* Zur√ºckgesetzt */
        height: 31px;
        flex-shrink: 0;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--slider-bg-color);
        transition: 0.4s;
        border-radius: 15.5px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 27px;
        width: 27px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      input:checked + .slider {
        background-color: var(--slider-checked-bg-color);
      }
      input:checked + .slider:before {
        transform: translateX(24px); /* Zur√ºckgesetzt */
      }
      /* --- END SLIDER STYLES --- */

      .diff-badge {
        padding: 3px 6px;
        border-radius: 5px;
        font-size: 15px;
        font-weight: 500;
        display: inline-block;
        vertical-align: middle;
      }
      input[readonly].positive-value,
      input[readonly].negative-value,
      input[readonly].zero-value {
        font-size: 17px;
      }
      .positive-value {
        background-color: var(--positive-value-bg) !important;
        color: var(--button-text-color) !important;
      }
      .negative-value {
        background-color: var(--negative-value-bg) !important;
        color: #000000 !important;
      }
      .zero-value {
        background-color: var(--zero-value-bg) !important;
        color: #000000 !important;
      }

      #hinweis {
        color: var(--hint-color);
        font-weight: 500;
        font-size: 15px;
        display: none;
        margin-top: 10px;
        padding: 10px;
        background-color: rgba(255, 59, 48, 0.1);
        border-radius: 8px;
      }
      .invalid-time {
        border-color: var(--hint-color) !important;
        background-color: rgba(255, 59, 48, 0.1) !important;
      }

      #history-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        background-color: var(--card-background-color);
        border-radius: 10px;
        overflow: hidden;
      }
      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        min-height: 60px;
        border-bottom: 1px solid var(--separator-color);
        gap: 10px;
      }
      .history-item:last-child {
        border-bottom: none;
      }
      .history-entry-content {
        flex-grow: 1;
        padding: 5px;
        border-radius: 6px;
        background-color: transparent;
        border-left: 3px solid transparent;
        transition: background-color 0.2s ease;
      }
      .history-entry-content.holiday-day {
        background-color: var(--holiday-bg);
        color: var(--holiday-text);
      }
      .history-entry-content.special-day.special-day-urlaub-bg {
        background-color: var(--special-day-urlaub-bg);
      }
      .history-entry-content.special-day.special-day-krank-bg {
        background-color: var(--special-day-krank-bg);
      }
      .history-entry-content.special-day.special-day-schulung-bg {
        background-color: var(--special-day-schulung-bg);
      }
      .history-entry-content.special-day.special-day-eza-bg {
        background-color: var(--special-day-eza-bg);
      }
      .history-entry-content.special-day.special-day-glaz-bg {
        background-color: var(--special-day-glaz-bg);
      }
      .history-entry-content.special-day[style*="--special-day-text"] {
        color: var(--special-day-text);
      }
      .history-entry-content.special-day[style*="--special-day-krank-text"] {
        color: var(--special-day-krank-text);
      }
      .history-entry-content.special-day[style*="--special-day-glaz-text"] {
        color: var(--special-day-glaz-text);
      }
      .history-entry-content.special-day[style*="--special-day-schulung-text"] {
        color: var(--special-day-schulung-text);
      }
      .history-entry-content.special-day[style*="--special-day-eza-text"] {
        color: var(--special-day-eza-text);
      }

      .history-entry-content.violation-day {
        border-left: 3px solid var(--hint-color);
        background-color: rgba(255, 59, 48, 0.05);
      }
      .history-entry-content.no-data {
        color: var(--secondary-text-color);
      }
      .history-entry-content div:first-child {
        font-weight: 500;
      }
      .history-entry-content div:last-child {
        font-size: 15px;
        color: var(--secondary-text-color);
        margin-top: 4px;
      }
      .history-entry-content.special-day[style*="--special-day-text"]
        div:last-child {
        color: var(--special-day-text);
      }
      .history-entry-content.special-day[style*="--special-day-krank-text"]
        div:last-child {
        color: var(--special-day-krank-text);
      }
      .history-entry-content.special-day[style*="--special-day-glaz-text"]
        div:last-child {
        color: var(--special-day-glaz-text);
      }
      .history-entry-content.special-day[style*="--special-day-schulung-text"]
        div:last-child {
        color: var(--special-day-schulung-text);
      }
      .history-entry-content.special-day[style*="--special-day-eza-text"]
        div:last-child {
        color: var(--special-day-eza-text);
      }
      .history-entry-content.holiday-day div:last-child {
        color: var(--holiday-text);
      }
      .violation-mark {
        color: var(--hint-color);
        font-weight: bold;
      }
      .history-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }
      .history-actions .inline-button,
      .history-actions .delete-button {
        font-size: 20px;
        padding: 5px 8px;
      }
      .history-entry-content.eza-booked-outline-history {
        /* Optional: Eigene Outline f√ºr History, falls gew√ºnscht */
        /* outline: 1px dashed var(--outline-color); */
        /* outline-offset: -3px; */
      }
      .eza-related-diff.inactive,
      .eza-tag-label.inactive {
        opacity: 0.6;
        font-style: italic;
      }
      .eza-tag-label.inactive::after {
        content: " (i)";
        font-size: 0.8em;
        vertical-align: super;
        opacity: 0.8;
      }
      .eza-hint-inline { /* F√ºr (E) Hinweis in Details */
        font-size: 0.9em;
        color: var(--secondary-text-color);
        cursor: help;
      }


      #weekly-summary,
      #month-summary {
        padding: 15px;
        background-color: var(--card-background-color);
        border-radius: 10px;
        margin-top: 20px;
        text-align: center;
        font-size: 17px;
        font-weight: 500;
      }
      #pagination,
      #month-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
      }
      .modal-content {
        background-color: var(--card-background-color);
        border-radius: 14px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        margin: auto;
        color: var(--text-color);
        box-sizing: border-box;
        position: relative;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .modal-content h3 {
        margin-top: 0;
        margin-bottom: 15px;
      }
      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--system-gray2-light);
        border: none;
        color: var(--secondary-text-color);
        font-size: 14px;
        font-weight: bold;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
        padding: 0;
      }
      @media (prefers-color-scheme: dark) {
        .close-button {
          background: var(--system-gray2-dark);
        }
      }
      .close-button:active {
        filter: brightness(0.85);
      }

      #detail-modal-actions .button {
        font-size: 17px;
      }

      #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 15px;
      }
      .calendar-header {
        text-align: center;
        font-size: 13px;
        font-weight: 500;
        color: var(--secondary-text-color);
        padding-bottom: 10px;
      }
      .calendar-day {
        display: flex;
        justify-content: center;
        align-items: center;
        aspect-ratio: 1 / 1;
        font-size: 16px;
        position: relative;
        cursor: default;
      }
      .calendar-day.empty {
        visibility: hidden;
      }
      .calendar-day.weekend .calendar-day-content {
        color: var(--secondary-text-color);
      }
      .calendar-day.no-entry {
        cursor: pointer;
      }
      .calendar-day.has-entry {
        cursor: pointer;
      }
      .calendar-day.holiday {
        cursor: help;
      }
      .calendar-day-content {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 85%;
        height: 85%;
        border-radius: 50%;
        transition: transform 0.1s ease;
        position: relative;
        box-sizing: border-box; /* Wichtig f√ºr inset box-shadow */
      }
      .calendar-day-content.positive-value {
        color: var(--button-text-color);
      }
      .calendar-day-content.negative-value {
        color: #000000;
      }
      .calendar-day-content.zero-value {
        color: #000000;
      }
      .calendar-day-content.special-day-urlaub-bg {
        background-color: var(--special-day-urlaub-bg);
        color: var(--special-day-text) !important;
      }
      .calendar-day-content.special-day-krank-bg {
        background-color: var(--special-day-krank-bg);
        color: var(--special-day-krank-text) !important;
      }
      .calendar-day-content.special-day-schulung-bg {
        background-color: var(--special-day-schulung-bg);
        color: var(--special-day-schulung-text) !important;
      }
      .calendar-day-content.special-day-eza-bg {
        background-color: var(--special-day-eza-bg);
        color: var(--special-day-eza-text) !important;
      }
      .calendar-day-content.special-day-glaz-bg {
        background-color: var(--special-day-glaz-bg);
        color: var(--special-day-glaz-text) !important;
      }
      .calendar-day-content.holiday-day {
        background-color: var(--holiday-bg);
        color: var(--holiday-text) !important;
      }
      .calendar-day-content.today {
        font-weight: bold;
        border: 2px solid var(--button-background-color);
      }
      .calendar-day.has-entry .calendar-day-content.today {
        border: 2px solid var(--text-color);
      }
      .calendar-day:active .calendar-day-content {
        transform: scale(0.95);
      }
      /* NEU: EZA Outline f√ºr Kalender (mit inset box-shadow) */
      .calendar-day-content.eza-booked-outline {
         box-shadow: inset 0 0 0 3px var(--outline-color); /* Dickere, innere Outline */
      }

      #stats-content {
        list-style: none;
        padding: 0;
        margin: 0;
        background-color: var(--card-background-color);
        border-radius: 10px;
        overflow: hidden;
      }
      #stats-content li {
        display: flex;
        justify-content: space-between;
        padding: 12px 15px;
        font-size: 17px;
        border-bottom: 1px solid var(--separator-color);
      }
      #stats-content li:last-child {
        border-bottom: none;
      }
      #stats-content li span:last-child {
        font-weight: 500;
        color: var(--secondary-text-color);
      }

      .import-export-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .import-export-buttons .button {
        margin-bottom: 0;
      }

      #legend-modal .modal-content {
        max-width: 450px;
      }
      .legend-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 15px;
      }
      .legend-color-dot {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        margin-right: 10px;
        flex-shrink: 0;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .legend-outline-indicator {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        margin-right: 10px;
        flex-shrink: 0;
        border: 3px solid var(--outline-color); /* Dickere Outline */
        box-sizing: border-box;
        background-color: var(--card-background-color); /* Hintergrund f√ºr Sichtbarkeit */
      }
      .legend-text {
        flex-grow: 1;
      }

      /* --- BOTTOM NAV STYLES (Zur√ºckgesetzt auf Original) --- */
      #bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px; /* Zur√ºckgesetzt */
        background-color: var(--nav-background);
        border-top: 0.5px solid var(--separator-color);
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        padding-top: 5px;
        padding-bottom: var(--safe-area-bottom);
        z-index: 1000;
      }
      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        color: var(--nav-icon-color);
        text-decoration: none;
        font-size: 10px;
        cursor: pointer;
        padding: 0 2px;
        text-align: center;
        height: 100%;
        box-sizing: border-box;
      }
      .nav-item svg {
        width: 24px;
        height: 24px;
        margin-bottom: 2px;
        fill: currentColor;
      }
      .nav-item.active {
        color: var(--nav-icon-active-color);
      }
      /* --- END BOTTOM NAV STYLES --- */
    </style>
  </head>
  <body>
    <div id="app-container">
      <!-- Main Page -->
      <div id="main-page" class="page active">
        <div class="container">
          <h1>Arbeitszeit</h1>

          <div class="section">
            <h3>Zeiterfassung</h3>
            <div class="time-button-row">
              <input
                type="time"
                id="kommen-display"
                oninput="onInputChange()"
              />
              <span id="kommen-moon" class="moon-indicator">üåô</span>
              <button class="button" onclick="setZeit('kommen')">Kommen</button>
            </div>
            <div class="time-button-row">
              <input type="time" id="gehen-display" oninput="onInputChange()" />
              <span id="gehen-moon" class="moon-indicator">üåô</span>
              <button class="button" onclick="setZeit('gehen')">Gehen</button>
            </div>
            <div class="switch-container" style="margin-top: 15px">
              <label class="switch">
                <input
                  type="checkbox"
                  id="pc-buchung"
                  onchange="onInputChange()"
                />
                <span class="slider"></span>
              </label>
              <span>PC-Buchung (-8 Min)</span>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input
                  type="checkbox"
                  id="buero-toggle"
                  onchange="onInputChange()"
                />
                <span class="slider"></span>
              </label>
              <span>Im B√ºro</span>
            </div>
            <p id="hinweis"></p>
          </div>

          <div class="section">
            <h3>√úbersicht (Aktuell)</h3>
            <div class="row">
              <div class="column">
                <label for="wochenarbeitszeit">Wochen-AZ (Std):</label>
                <input type="number" id="wochenarbeitszeit" readonly />
              </div>
              <div class="column">
                <label for="zusatzliche-pause"
                  >Zus. Pause (hh:mm / h.hh):</label
                >
                <input
                  type="text"
                  id="zusatzliche-pause"
                  placeholder="z.B. 0:15 oder 0.25"
                  oninput="onInputChange()"
                />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label for="aktuelles-konto">Aktuelles Konto (Std):</label>
                <input
                  type="number"
                  id="aktuelles-konto"
                  value="0"
                  step="0.01"
                  readonly
                />
              </div>
              <div class="column">
                <label>Konto (Zeit):</label>
                <input type="text" id="aktuelles-konto-time" readonly />
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Zeiten√ºbersicht (Heute)</h3>
            <div class="row">
              <div class="column">
                <label>Anwesenheit:</label>
                <input type="text" id="anwesend-zeit" readonly />
              </div>
              <div class="column">
                <label>Pause:</label>
                <input type="text" id="pausenzeit" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column" style="position: relative">
                <label>Netto-Arbeitszeit:</label>
                <input type="text" id="arbeitszeit" readonly />
                <span
                  id="arbeitszeit-moon"
                  class="moon-indicator"
                  style="right: 15px"
                  >üåô</span
                >
              </div>
              <div class="column">
                <label>Soll-Arbeitszeit:</label>
                <input type="text" id="sollarbeitszeit-display" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Differenz (Std):</label>
                <input type="text" id="differenz" readonly />
              </div>
              <div class="column">
                <label>Differenz (Zeit):</label>
                <input type="text" id="differenz-time" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>Neues Konto (Std):</label>
                <input type="text" id="neues-konto" readonly />
              </div>
              <div class="column">
                <label>Neues Konto (Zeit):</label>
                <input type="text" id="neues-konto-time" readonly />
              </div>
            </div>
            <button class="button" onclick="saveDay()">Tag speichern</button>
          </div>

          <div class="section">
            <h3>Ausstempelzeiten</h3>
            <div class="row">
              <div class="column">
                <label>Soll:</label>
                <input type="text" id="end-time-soll" readonly />
              </div>
              <div class="column">
                <label>10h (Max):</label>
                <input type="text" id="end-time-10h" readonly />
              </div>
            </div>
            <div class="row">
              <div class="column">
                <label>4h (Min):</label>
                <input type="text" id="end-time-4h" readonly />
              </div>
              <div class="column">
                <label>6h (+Pause):</label>
                <input type="text" id="end-time-6h" readonly />
              </div>
              <div class="column">
                <label>9h (+Pause):</label>
                <input type="text" id="end-time-9h" readonly />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- History Page -->
      <div id="history-page" class="page">
        <div class="container">
          <h1>Verlauf</h1>
          <h2 id="week-info"></h2>
          <p
            id="week-range"
            style="
              text-align: center;
              color: var(--secondary-text-color);
              margin-top: -10px;
              margin-bottom: 15px;
            "
          ></p>
          <div id="pagination"></div>
          <ul id="history-list"></ul>
          <div id="weekly-summary">
            <span id="weekly-summary-content">Gesamtdifferenz: --</span>
          </div>
        </div>
      </div>

      <!-- Month Page -->
      <div id="month-page" class="page">
        <div class="container">
          <h1>Monats√ºbersicht</h1>
          <div id="month-pagination" style="align-items: center">
            <button id="prev-month" class="inline-button">‚Äπ</button>
            <h2
              id="month-year-display"
              style="margin: 0; border: none; text-align: center"
            ></h2>
            <button id="next-month" class="inline-button">‚Ä∫</button>
          </div>
          <div id="calendar-grid"></div>
          <div id="month-summary">
            <span id="month-summary-content">Monatsdifferenz: --</span>
          </div>
          <div style="text-align: center">
            <button id="show-legend-button" class="link-button">
              Legende anzeigen
            </button>
          </div>
          <button
            id="open-bulk-modal-button"
            class="button"
            style="margin-top: 20px"
          >
            Bulk-Buchung / L√∂schen
          </button>
        </div>
      </div>

      <!-- Stats Page -->
      <div id="stats-page" class="page">
        <div class="container">
          <h1>Statistik</h1>
          <div class="section">
            <label for="stats-period">Zeitraum:</label>
            <select id="stats-period">
              <option value="current_month">Aktueller Monat</option>
              <option value="last_month">Letzter Monat</option>
              <option value="current_year">Aktuelles Jahr</option>
              <option value="last_year">Letztes Jahr</option>
              <option value="all_time">Gesamter Zeitraum</option>
            </select>
          </div>
          <ul id="stats-content">
            <li>Lade Statistik...</li>
          </ul>
        </div>
      </div>

      <!-- Options Page -->
      <div id="options-page" class="page">
        <div class="container">
          <h1>Optionen</h1>
          <div class="section">
            <h3>Allgemein</h3>
            <div style="margin-bottom: 15px">
              <label for="wochenarbeitszeit-setting"
                >Wochenarbeitszeit (Std):</label
              >
              <input type="number" id="wochenarbeitszeit-setting" step="0.1" />
            </div>
            <div style="margin-bottom: 15px">
              <label for="bundesland-select"
                >Bundesland (f√ºr Feiertage):</label
              >
              <select id="bundesland-select">
                <option value="NATIONAL">Bundesweit</option>
                <option value="BW">Baden-W√ºrttemberg</option>
                <option value="BY">Bayern</option>
                <option value="BE">Berlin</option>
                <option value="BB">Brandenburg</option>
                <option value="HB">Bremen</option>
                <option value="HH">Hamburg</option>
                <option value="HE">Hessen</option>
                <option value="MV">Mecklenburg-Vorpommern</option>
                <option value="NI">Niedersachsen</option>
                <option value="NW">Nordrhein-Westfalen</option>
                <option value="RP">Rheinland-Pfalz</option>
                <option value="SL">Saarland</option>
                <option value="SN">Sachsen</option>
                <option value="ST">Sachsen-Anhalt</option>
                <option value="SH">Schleswig-Holstein</option>
                <option value="TH">Th√ºringen</option>
              </select>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="wochenende-toggle" />
                <span class="slider"></span>
              </label>
              <span>Wochenendarbeit erlauben (Sa/So anzeigen & buchen)</span>
            </div>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="nachtarbeit-toggle" />
                <span class="slider"></span>
              </label>
              <span
                >Nacht-/Randzeiten tolerieren (keine Warnung, üåô statt !)</span
              >
            </div>
          </div>

          <div class="section">
            <h3>EZA-Regelung</h3>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="eza-toggle" />
                <span class="slider"></span>
              </label>
              <span>EZA-Regelung aktiv (-0.4h bei U/S, EZA-Konto)</span>
            </div>
            <div class="row">
              <div class="column">
                <label for="eza-konto-input">EZA-Konto (Std):</label>
                <input type="number" id="eza-konto-input" step="0.1" />
              </div>
              <div class="column">
                <label>EZA-Konto (Tage):</label>
                <input type="text" id="eza-konto-display" readonly />
              </div>
              <div class="column-auto">
                <button
                  id="eza-konto-speichern-button"
                  class="inline-button"
                  style="min-height: 44px"
                >
                  Setzen
                </button>
              </div>
            </div>
            <p
              style="
                font-size: 14px;
                color: var(--secondary-text-color);
                margin-top: 0px;
              "
            >
              Aktuellen Stand des EZA-Kontos in Stunden eingeben und setzen.
              Wird bei Krankheit (-0.4h) und EZA-Tagen (-Sollzeit)
              automatisch angepasst, wenn EZA-Regel aktiv ist.
            </p>
          </div>

          <div class="section">
            <h3>Stundenkonto korrigieren</h3>
            <p
              style="
                font-size: 14px;
                color: var(--secondary-text-color);
                margin-bottom: 15px;
              "
            >
              Hier k√∂nnen Sie das *Haupt*-Stundenkonto manuell anpassen. Geben
              Sie das Datum an, an dessen *Ende* der neue Kontostand gelten
              soll. Alle nachfolgenden Eintr√§ge im Verlauf werden neu
              berechnet.
            </p>
            <div class="row">
              <div class="column">
                <label for="korrektur-datum">Datum der Korrektur:</label>
                <input type="date" id="korrektur-datum" />
              </div>
              <div class="column">
                <label for="korrektur-wert">Neuer Kontostand (Std):</label>
                <input type="number" id="korrektur-wert" step="0.01" />
              </div>
            </div>
            <button
              id="korrektur-anwenden-button"
              class="button"
              style="margin-top: 10px"
            >
              Korrektur anwenden & Verlauf neu berechnen
            </button>
          </div>

          <div class="section">
            <h3>Daten</h3>
            <div class="import-export-buttons">
              <button id="export-button-options" class="button">Export</button>
              <button id="import-button-options" class="button">Import</button>
            </div>
            <p
              style="
                font-size: 14px;
                color: var(--secondary-text-color);
                margin-top: 10px;
              "
            >
              Beim Import werden alle vorhandenen Daten √ºberschrieben. Der
              Export enth√§lt den Verlauf und die aktuellen Einstellungen.
            </p>
          </div>
        </div>
      </div>

      <!-- Detail-Modal -->
      <div id="detail-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">√ó</button>
          <h3 id="detail-modal-title">Details</h3>
          <div id="detail-content"></div>
          <div
            id="detail-modal-actions"
            style="display: flex; gap: 10px; margin-top: 20px"
          >
            <button id="detail-edit-button" class="button">√Ñndern</button>
            <button id="detail-delete-button" class="button delete-button">
              L√∂schen
            </button>
          </div>
        </div>
      </div>

      <!-- Add Day Modal -->
      <div
        id="add-day-modal"
        class="modal"
        data-date=""
        style="display: none"
      >
        <div class="modal-content">
          <button class="close-button">√ó</button>
          <h3 id="add-day-modal-title">Manuelle Buchung</h3>
          <div class="row">
            <div class="column">
              <label for="add-day-kommen">Kommen:</label>
              <input type="time" id="add-day-kommen" />
            </div>
            <div class="column">
              <label for="add-day-gehen">Gehen:</label>
              <input type="time" id="add-day-gehen" />
            </div>
          </div>
          <div style="margin-top: 10px">
            <label for="add-day-zusatzliche-pause"
              >Zus. Pause (hh:mm / h.hh):</label
            >
            <input
              type="text"
              id="add-day-zusatzliche-pause"
              placeholder="z.B. 0:15 oder 0.25"
            />
          </div>
          <div class="switch-container" style="margin-top: 15px">
            <label class="switch">
              <input type="checkbox" id="pc-buchung-add-day" />
              <span class="slider"></span>
            </label>
            <span>PC-Buchung (-8 Min)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input type="checkbox" id="buero-add-day" />
              <span class="slider"></span>
            </label>
            <span>Im B√ºro</span>
          </div>
          <h3 style="margin-top: 20px">Sondertag?</h3>
          <div class="switch-container">
            <label class="switch">
              <input
                type="checkbox"
                id="urlaub-toggle"
                onchange="toggleSpecialDay('urlaub')"
              />
              <span class="slider"></span>
            </label>
            <span>Urlaub</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input
                type="checkbox"
                id="krank-toggle"
                onchange="toggleSpecialDay('krank')"
              />
              <span class="slider"></span>
            </label>
            <span>Krank</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input
                type="checkbox"
                id="schulung-toggle"
                onchange="toggleSpecialDay('schulung')"
              />
              <span class="slider"></span>
            </label>
            <span>Schulung</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input
                type="checkbox"
                id="glaz-toggle"
                onchange="toggleSpecialDay('glaz')"
              />
              <span class="slider"></span>
            </label>
            <span>GLAZ (Gleitzeitabbau)</span>
          </div>
          <div class="switch-container">
            <label class="switch">
              <input
                type="checkbox"
                id="eza-tag-toggle"
                onchange="toggleSpecialDay('ezaTag')"
              />
              <span class="slider"></span>
            </label>
            <span>EZA-Tag</span>
          </div>
          <button
            class="button"
            onclick="addManualDay()"
            style="margin-top: 20px"
          >
            Speichern
          </button>
        </div>
      </div>

      <!-- Bulk Booking Modal -->
      <div id="bulk-booking-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">√ó</button>
          <h3 id="bulk-modal-title">Bulk-Buchung / L√∂schen</h3>
          <p
            style="
              font-size: 14px;
              color: var(--secondary-text-color);
              margin-bottom: 15px;
            "
          >
            Aktion f√ºr Mo-Fr (keine Feiertage). Bestehende Eintr√§ge im Zeitraum
            werden √ºberschrieben oder gel√∂scht. EZA-Logik wird angewendet,
            falls global aktiv.
          </p>
          <div class="row">
            <div class="column">
              <label for="bulk-modal-start-date">Von:</label>
              <input type="date" id="bulk-modal-start-date" />
            </div>
            <div class="column">
              <label for="bulk-modal-end-date">Bis:</label>
              <input type="date" id="bulk-modal-end-date" />
            </div>
          </div>
          <div style="margin-bottom: 15px">
            <label for="bulk-modal-special-day-type">Aktion / Typ:</label>
            <select id="bulk-modal-special-day-type">
              <option value="" disabled selected>Aktion ausw√§hlen...</option>
              <option value="urlaub">Urlaub buchen</option>
              <option value="krank">Krank buchen</option>
              <option value="schulung">Schulung buchen</option>
              <option value="glaz">GLAZ buchen</option>
              <option value="ezaTag">EZA-Tag buchen</option>
              <option value="delete" style="color: var(--hint-color)">
                Eintr√§ge l√∂schen
              </option>
            </select>
          </div>
          <button
            id="apply-bulk-modal-button"
            class="button"
            style="margin-top: 10px"
          >
            Aktion anwenden
          </button>
        </div>
      </div>

      <!-- Legend Modal -->
      <div id="legend-modal" class="modal" style="display: none">
        <div class="modal-content">
          <button class="close-button">√ó</button>
          <h3>Legende (Monatsansicht)</h3>
          <ul class="legend-list">
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--special-day-urlaub-bg)"
              ></span>
              <span class="legend-text">Urlaub</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--special-day-krank-bg)"
              ></span>
              <span class="legend-text">Krank</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--special-day-schulung-bg)"
              ></span>
              <span class="legend-text">Schulung</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--special-day-eza-bg)"
              ></span>
              <span class="legend-text">EZA-Tag</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--special-day-glaz-bg)"
              ></span>
              <span class="legend-text">GLAZ</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--positive-value-bg)"
              ></span>
              <span class="legend-text">Positiver Saldo (Arbeitstag)</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--negative-value-bg)"
              ></span>
              <span class="legend-text">Negativer Saldo (Arbeitstag)</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--zero-value-bg)"
              ></span>
              <span class="legend-text">Null-Saldo (Arbeitstag)</span>
            </li>
            <li class="legend-item">
              <span
                class="legend-color-dot"
                style="background-color: var(--holiday-bg)"
              ></span>
              <span class="legend-text">Feiertag</span>
            </li>
            <li class="legend-item">
              <span class="legend-outline-indicator"></span>
              <span class="legend-text">EZA-Regel bei Buchung aktiv</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Bottom Navigation (Zur√ºckgesetzt auf Original) -->
      <nav id="bottom-nav">
        <a id="nav-main" class="nav-item active">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"
            />
          </svg>
          <span>Rechner</span>
        </a>
        <a id="nav-history" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path
              d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z"
            />
          </svg>
          <span>Verlauf</span>
        </a>
        <a id="nav-month" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path
              d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"
            />
          </svg>
          <span>Monat</span>
        </a>
        <a id="nav-stats" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z" />
          </svg>
          <span>Statistik</span>
        </a>
        <a id="nav-options" class="nav-item">
          <svg viewBox="0 0 24 24">
            <path
              d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"
            />
          </svg>
          <span>Optionen</span>
        </a>
      </nav>
    </div>
  </body>
</html>